<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ÖĞRENCİ TAKİP PROGRAMI</title>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
    :root{
      --bg:#0f172a; --panel:#1e293b; --muted:#334155; --text:#e2e8f0;
      --accent1:#3b82f6; --accent2:#06b6d4; --warn:#f97316; --ok:#10b981; --danger:#ef4444;
      --export-bg:#0b1427; --export-head:#93c5fd;
      --card:#0b1427; --cardBorder:#263247;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .header{padding:22px;text-align:center;font-size:22px;font-weight:800;color:#93c5fd;text-transform:uppercase}
    .subheader{font-size:16px;color:#cbd5e1;margin-top:4px;font-weight:600;}
    .tabs{display:flex;gap:8px;justify-content:center;max-width:1080px;margin:0 auto 12px;padding:8px;background:var(--panel);border-radius:12px;flex-wrap:wrap}
    .tabs button{flex:1;min-width:160px;padding:12px;border:0;border-radius:10px;background:transparent;color:#cbd5e1;font-weight:700;cursor:pointer}
    .tabs button.active{background:var(--ok);color:#fff}
    /* Odak halkalarını yeşil yap */
    .tabs button:focus,
    .pill:focus,
    .classPick:focus,
    .dayBtn:focus,
    .weekBtn:focus,
    .studentNameBtn:focus,
    .delStuBtn:focus,
    .delStuFloat:focus,
    .delFloat:focus,
    button.action:focus{
      outline:3px solid rgba(16,185,129,.55);
      outline-offset:2px;
    }
    .container{max-width:1080px;margin:16px auto;background:var(--panel);border-radius:16px;padding:22px}
    h3{margin:0 0 14px}
    input,select{width:100%;padding:12px;border:0;border-radius:10px;background:var(--bg);color:#e2e8f0;margin:8px 0}
    button.action{width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:800;cursor:pointer;min-height:48px}
    button.logout{background:var(--warn)}
    table{width:100%;border-collapse:collapse;margin:10px 0}
    th,td{border:1px solid var(--muted);padding:10px;text-align:center}
    .row{display:flex;gap:10px;align-items:center}
    .row>.grow{flex:1}
    /* ---- Sınıf kartları ---- */
    .classGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:14px;
      margin-top:12px;
    }
    .classCard{
      position:relative;
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      padding:14px 14px 48px;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .classCard:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .className{ font-weight:900; font-size:20px; letter-spacing:.3px; margin-bottom:8px; }
    .classPick{
      position:absolute; left:14px; right:14px; bottom:14px;
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      color:#fff; font-weight:800;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    .classPick.active{ outline:3px solid rgba(16,185,129,.40) }
    /* --- Sınıf silme ikonu (zemin üstünde, hover'da flu kırmızı) --- */
    .delFloat{
      position:absolute; top:10px; right:10px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delFloat:hover{ transform:translateY(-1px); }
    .delFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delFloat:hover::before{ opacity:1; }
    /* --- Öğrenci silme: tuş yerine zeminde çöp kovası simgesi --- */
    .studentItem{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;background:#0b1427;margin:6px 0;border-radius:10px; position:relative;}
    .studentItem.hasDel{ padding-right:48px; } /* sağ üstteki ikon için yer aç */
    .delStuFloat{
      position:absolute; top:8px; right:8px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delStuFloat:hover{ transform:translateY(-1px); }
    .delStuFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delStuFloat:hover::before{ opacity:1; }
    /* (Eski) Öğrenci silme butonu – geriye dönük stil, artık kullanılmıyor */
    .delStuBtn{
      background:linear-gradient(180deg,#ef4444,#dc2626);
      border:1px solid #7f1d1d;
      color:#fff; font-weight:800;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      display:flex; align-items:center; gap:6px;
      box-shadow:0 6px 16px rgba(239,68,68,.25), inset 0 1px 0 rgba(255,255,255,.08);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .delStuBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(239,68,68,.35); }
    .delStuBtn:active{ transform:translateY(0); box-shadow:0 4px 12px rgba(239,68,68,.3); }
    .delStuBtn img.trashIcon{ width:16px; height:16px; filter:brightness(10); }
    /* Eski küçük pill stilleri bazı yerlerde hâlâ kullanılıyor */
    .pill{padding:10px 16px;border:0;border-radius:999px;background:#334155;color:#e5e7eb;font-weight:800;cursor:pointer;transition:.2s}
    .pill.active{background:linear-gradient(90deg,var(--accent1),var(--accent2)); box-shadow:0 0 0 3px rgba(16,185,129,.35);}
    .pill:hover{filter:brightness(1.05)}
    .delBtn{padding:8px 10px;border:0;border-radius:10px;background:linear-gradient(90deg,#fb7185,#f43f5e);color:#fff;font-weight:800;cursor:pointer}
    .list{margin-top:14px;background:var(--bg);border-radius:12px;padding:12px}
    .leftGroup{display:flex;align-items:center;gap:8px}
    .studentNameBtn{border:0;background:transparent;color:#e2e8f0;font-weight:800;cursor:pointer;text-align:left}
    .starBtn{border:0;background:transparent;font-size:20px;cursor:pointer;color:#f59e0b}
    .starBtn.off{color:#64748b}
    .sectionTitle{margin:12px 0 6px;font-weight:800;opacity:.9}
    .twoCol{display:grid;grid-template-columns: 300px 1fr; gap:14px}
    .dayBtn,.weekBtn{display:block;width:100%;text-align:left;padding:10px;border:0;border-radius:10px;background:#334155;color:#fff;cursor:pointer;margin-top:8px;min-height:44px}
    .empty{opacity:.7;padding:12px;text-align:center}
    .editBtn{padding:6px 12px;border:0;border-radius:6px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
    .smallRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ghost{opacity:.6}
    #alert{max-width:1080px;margin:0 auto 8px;padding:10px 14px;border-radius:10px;background:#0b1427;color:#ffd6a5;display:none}
    #weekChartWrap{background:#0b1427;border-radius:12px;padding:12px;margin-top:10px}
    #pdfBtns{display:flex;gap:10px;flex-wrap:wrap}
    /* EXPORT (PDF görünümü) */
    #exportArea{
      width:1240px; padding:40px 48px 48px;
      background:var(--export-bg); color:#e5e7eb; font-family:Arial, Helvetica, sans-serif;
    }
    #exportArea h1{margin:0 0 6px;font-size:28px;color:var(--export-head)}
    #exportArea h2{margin:0 0 18px;font-size:18px;font-weight:700;color:#c7d2fe}
    #exportHead{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
    .exportCard{background:#0f1a31;border:1px solid #21314f;border-radius:12px;padding:14px}
    #exportTable table{width:100%;border-collapse:collapse}
    #exportTable th,#exportTable td{border:1px solid #21314f;padding:10px;text-align:center}
    #exportLegend{font-size:12px;opacity:.8;margin-top:6px}
    /* GİRİŞ EKRANI MOBİL OPTİMİZASYON */
    #loginPanel h3{font-size:22px}
    #loginPanel .tabs button{font-size:16px;padding:14px;min-height:48px}
    #loginPanel input,#loginPanel select{font-size:16px;min-height:48px}
    #loginPanel button.action{font-size:16px;min-height:52px}
    @media (max-width: 768px){
      .header{font-size:20px}
      .subheader{font-size:14px}
      #loginPanel .container{padding:18px}
      #loginPanel h3{font-size:24px}
      #loginPanel .tabs{gap:6px}
      #loginPanel .tabs button{font-size:17px;padding:14px 12px}
      #loginPanel input,#loginPanel select{font-size:17px}
      #loginPanel button.action{font-size:17px}
      .twoCol{grid-template-columns:1fr}
    }
    @media (max-width: 480px){
      .header{font-size:18px;padding:18px}
      .subheader{font-size:12px}
      #loginPanel .tabs{padding:6px}
      #loginPanel .tabs button{font-size:18px;min-width:130px;padding:12px}
      #loginPanel h3{font-size:22px;margin-bottom:10px}
      #loginPanel input,#loginPanel select{font-size:18px;padding:14px;min-height:52px}
      #loginPanel button.action{font-size:18px;padding:14px;min-height:56px}
      .container{margin:12px}
    }
    .teacherWelcome{opacity:.8;margin:0 0 10px}
    .favBlock{background:#0b1427;border-radius:12px;padding:10px;margin-top:8px}
    input:focus,
    select:focus,
    textarea:focus {
      outline: 3px solid rgba(34,197,94,.65);
      outline-offset: 2px;
      border-color: rgba(34,197,94,.65);
      box-shadow: 0 0 0 3px rgba(34,197,94,.25);
    }
    /* DÜZELTME: Tekrar eden CSS kuralları birleştirildi. */
    .delFloat img.trashIcon,
    .delStuFloat img.trashIcon {
        width: 22px;
        height: 22px;
        display: block;
        image-rendering: auto;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,.35));
        transition: transform .15s ease, filter .15s ease, opacity .15s ease;
    }
    .delFloat:hover img.trashIcon,
    .delStuFloat:hover img.trashIcon {
        transform: scale(1.12);
        filter: drop-shadow(0 0 8px rgba(239,68,68,.75));
    }
    /* ==== Giriş Türü Seçimi (Öğrenci / Veli) ==== */
    .roleGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:14px;
      margin-top:8px;
    }
    .roleCard{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:22px 16px;
      border:1px solid var(--cardBorder);
      border-radius:14px;
      background:var(--card);
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      text-align:center;
      color:var(--text);
    }
    .roleCard:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .roleCard:focus{
      outline:3px solid rgba(16,185,129,.55);
      outline-offset:2px;
    }
    .roleIcon{
      width:68px; height:68px; display:grid; place-items:center;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(59,130,246,.12), rgba(6,182,212,.12));
      color:#93c5fd;
    }
    .roleIcon svg{ width:36px; height:36px; display:block; }
    .roleCard.parent .roleIcon{ color:#34d399; background:linear-gradient(135deg, rgba(52,211,153,.12), rgba(6,182,212,.12)); }
    .roleTitle{ font-weight:900; letter-spacing:.2px; }
    /* ==== Farklı Hesap ve Çıkış Butonları ==== */
    .smallRow {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .smallRow .pill {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
    }
    .smallRow .pill.account {
      background: #facc15; /* sarı */
      border: none;
      color: #111;
    }
    .smallRow .pill.account:hover {
      background: #eab308;
    }
    .smallRow .pill.exit {
      background: #ef4444; /* kırmızı */
      border: none;
      color: #fff;
    }
    .smallRow .pill.exit:hover {
      background: #dc2626;
    }
    /* ==== Mobil Optimizasyon: Giriş Türü Seçimi ==== */
    @media (max-width: 768px) {
      .roleGrid { grid-template-columns: 1fr; gap: 12px; }
      .roleCard { padding: 18px 14px; }
      .roleIcon { width: 60px; height: 60px; }
      .roleIcon svg { width: 30px; height: 30px; }
      .roleTitle { font-size: 18px; }
      .smallRow { justify-content: center; }
      .smallRow .pill { width: 100%; max-width: 240px; }
    }
    @media (max-width: 480px) {
      .roleCard { padding: 16px 12px; }
      .roleIcon { width: 54px; height: 54px; }
      .roleIcon svg { width: 28px; height: 28px; }
      .roleTitle { font-size: 17px; }
    }
    /* ========= MODERN TAKVİM (Eklendi) ========= */
    .calendarWrap{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .calHeader{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
    }
    .calTitle{font-weight:900;letter-spacing:.2px;text-transform:capitalize}
    .calNav{display:flex;gap:8px;}
    .calBtn{
      border:0;border-radius:10px;background:#0f1a31;color:#e2e8f0;
      padding:8px 10px;cursor:pointer;font-weight:800;
    }
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
    .calWd{opacity:.75;font-size:12px;text-align:center;margin-bottom:2px}
    .calCell{
      position:relative;min-height:42px;border:1px solid #23324a;border-radius:10px;
      display:flex;align-items:flex-start;justify-content:flex-end;padding:8px;cursor:pointer;background:#0f1a31;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .calCell:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .calCell.muted{opacity:.5}
    .calDay{font-weight:800}
    .calDot{
      position:absolute;left:8px;bottom:8px;width:8px;height:8px;border-radius:999px;background:#ef4444;
      box-shadow:0 0 0 2px rgba(239,68,68,.15);
    }
    .calCell.today{outline:2px dashed rgba(59,130,246,.6); outline-offset:2px;}
    .calCell.selected{box-shadow:0 0 0 3px rgba(16,185,129,.45) inset;border-color:#16a34a;}
    @media (max-width:560px){
      .calCell{min-height:38px;padding:6px}
      .calTitle{font-size:14px}
    }
    /* ================================== */
    /* === Bugün butonu + mobil düzenlemeleri === */
    .calHeader{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(11,20,39,.95), rgba(11,20,39,.88)); backdrop-filter:saturate(1.2) blur(4px); border-radius:12px 12px 0 0; padding:8px; }
    .calBtnToday{
      border:0;border-radius:10px;background:#14532d;color:#e2e8f0;
      padding:8px 12px;cursor:pointer;font-weight:900;
    }
    .calBtn:disabled,.calBtnToday:disabled{opacity:.5;cursor:default}
    .calendarWrap{ position:relative; }
    /* Floating "Bugün" on mobile */
    .calFab{
      position:sticky; bottom:8px; left:100%; transform:translateX(-100%);
      margin-top:8px; display:none;
    }
    .calFab button{
      border:0; border-radius:999px; padding:10px 14px; font-weight:900; background:#14532d; color:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,.35);
    }
    /* Touch-friendly cells */
    .calCell{ min-height:48px; }
    @media (max-width:600px){
      .calGrid{ gap:4px; }
      .calWd{ font-size:11px; }
      .calCell{ min-height:44px; padding:6px; }
      .calTitle{ font-size:15px; }
      .calNav .calBtn{ padding:8px 10px; }
      .calFab{ display:block; }
    }
    /* ==== Liste Görünümü V5.4: Soru Sayısı & Hedef Bölgesi Renkli ==== */
    .student-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:12px 0 6px; }
    .densityToggle{
      background: var(--card); color: var(--text); border: 1px solid var(--cardBorder);
      border-radius: 10px; padding: 8px 12px; cursor:pointer;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border-radius:999px; padding:6px 10px; font-weight:800; font-size:12px;
      background:var(--card); border:1px solid var(--cardBorder);
    }
    .chip .dot{ width:10px; height:10px; border-radius:999px; }
    .chip.turkce .dot{ background:#fb923c; }
    .chip.sosyal .dot{ background:#6366f1; }
    .chip.din .dot{ background:#22c55e; }
    .chip.ing .dot{ background:#0ea5e9; }
    .chip.mat .dot{ background:#f43f5e; }
    .chip.fen .dot{ background:#14b8a6; }
    .lessonList.dense{ display:flex; flex-direction:column; gap:8px; margin:10px 0; }
    .lessonRow.dense{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background:var(--card); border:1px solid var(--cardBorder);
      border-radius:12px; padding:6px 10px;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .lessonRow.dense:hover{ border-color:#3b4b6a; box-shadow:0 8px 18px rgba(0,0,0,.22); }
    .lessonControls{ display:flex; align-items:center; gap:8px; margin-left:auto; }
    .lessonControls input[type=number]{
      width:100px; min-height:34px; font-size:14px;
      background:var(--bg); color:var(--text); border:0; border-radius:10px; padding:8px 10px;
    }
    .lessonControls input[type=number]::-webkit-outer-spin-button,
    .lessonControls input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
    .lessonControls input[type=number]{ -moz-appearance:textfield; }
    .numBtn{
      width:34px; height:34px; display:grid; place-items:center; border:0; border-radius:10px;
      background:#334155; color:#fff; font-weight:900; font-size:15px; cursor:pointer;
      transition: transform .08s ease, filter .12s ease;
    }
    .numBtn:hover{ filter:brightness(1.06); }
    .numBtn:active{ transform: translateY(1px); }
    /* === Renkli bölgeler === */
    /* Soru sayısı bölgesi: indigo ton */
    .countWrap{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 6px; border-radius:999px;
      background: rgba(99,102,241,.10);          /* indigo-500 @10% */
      border:1px solid rgba(99,102,241,.35);
      box-shadow: inset 0 0 0 1px rgba(99,102,241,.12);
    }
    .countWrap:focus-within{ box-shadow: 0 0 0 3px rgba(99,102,241,.25); }
    .countWrap .numBtn{ background:#4f46e5; }     /* indigo-600 */
    .countWrap input[type=number]{ background:transparent; }
    /* Hedef bölgesi: sky ton */
    .goalWrap{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 6px; border-radius:999px;
      background: rgba(14,165,233,.10);          /* sky-500 @10% */
      border:1px solid rgba(14,165,233,.35);
      box-shadow: inset 0 0 0 1px rgba(14,165,233,.12);
    }
    .goalWrap:focus-within{ box-shadow: 0 0 0 3px rgba(14,165,233,.25); }
    .goalIcon{ font-size:16px; line-height:1; width:18px; height:18px; display:grid; place-items:center;
    cursor: pointer;}
    .goalInput{
      width:64px; min-height:30px; font-size:14px; border:0; outline:none;
      background:transparent; color:var(--text); text-align:center;
    }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    /* Footer: progress + % badge sağda */
    .rowFooter{ display:flex; align-items:center; gap:8px; width:100%; padding-top:6px; }
    .progressWrap{ position:relative; flex:1 1 auto; min-width:0; height:6px; background:var(--cardBorder);
      border-radius:999px; overflow:hidden; }
    .progressBar{ position:absolute; top:0; left:0; height:100%; width:0%;
      background:linear-gradient(90deg,#22c55e,#0ea5e9); transition: width .15s ease; }
    .pctBadge{
      min-width:44px; height:24px; display:grid; place-items:center;
      padding:0 8px; border-radius:999px; font-weight:800; font-size:12px;
      background:#0b9444; color:#fff; margin-left:auto;
    }
    .pctBadge.low{ background:#eab308; }
    .pctBadge.zero{ background:#6b7280; }
    .totalBar{ display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:8px; font-weight:800; }
    .totalBadge{ min-width:56px; text-align:center; background:#0ea5e9; color:white; border-radius:10px; padding:8px 10px; }
    @media (max-width: 560px){
      .lessonControls{ width:100%; justify-content:flex-end; gap:6px; }
      .countWrap, .goalWrap{ width:100%; justify-content:space-between; }
    }
    /* === Öğretmen Üst Çubuğu ve Küçük Çıkış Düğmesi === */
    .teacherTopbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0 8px;}
    button.exitSmall{border:0;border-radius:10px;padding:6px 10px;min-height:32px;background:#ef4444;color:#fff;font-weight:800;cursor:pointer}
    button.exitSmall:hover{background:#dc2626}
    button.exitSmall:focus{outline:3px solid rgba(16,185,129,.55);outline-offset:2px;}
    /* === Update: Larger Exit Button + Icon === */
    button.exitSmall{padding:8px 12px;min-height:38px;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    button.exitSmall .icon{width:16px;height:16px;line-height:0;display:inline-flex}
    button.exitSmall .icon svg{display:block}
    button.exitSmall .label{line-height:1}
    /* ====== Günlük Rapor Tasarımı (Calendar + Table) — 2025-10-03 ====== */
    /* Kapsamı yalnızca Günlük sekmesine uygula */
    #repTab-daily .calendarWrap{
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.92));
      border: 1px solid var(--cardBorder, #1e293b);
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      padding: 16px;
    }
    /* Başlık çubuğu */
    #repTab-daily .calHeader{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 12px;
    }
    #repTab-daily .calTitle{ font-weight:800; letter-spacing:.2px; }
    #repTab-daily .calNav .calBtn{
      border:1px solid rgba(148,163,184,.25);
      background: rgba(148,163,184,.06);
      border-radius:10px; padding:6px 8px; min-height:32px;
      cursor:pointer; transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    #repTab-daily .calNav .calBtn:hover{ transform: translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); }
    #repTab-daily .calBtnToday{
      background: linear-gradient(180deg, #22c55e, #16a34a);
      color:#fff; font-weight:900; border:0;
      border-radius:12px; padding:6px 12px; min-height:32px;
    }
    /* Takvim ızgarası */
    #repTab-daily .calGrid{ gap: 10px; }
    #repTab-daily .calWd{ opacity:.9; font-weight:700; }
    #repTab-daily .calCell{
      position:relative;
      min-height:56px;
      border:1px solid #23324a;
      border-radius:14px;
      background:#0f1a31;
      display:flex; align-items:flex-start; justify-content:flex-end;
      padding:10px;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    #repTab-daily .calCell:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    #repTab-daily .calCell.today{ outline:2px dashed rgba(59,130,246,.6); outline-offset:2px; }
    #repTab-daily .calCell.selected{
      outline: 2px dashed rgba(16,185,129,.55);
      outline-offset: -4px;
      box-shadow: 0 0 0 3px rgba(16,185,129,.25) inset;
      border-color:#16a34a;
    }
    #repTab-daily .calDay{ font-weight:800; opacity:.95; }
    #repTab-daily .calDot{
      position:absolute; left:10px; top:10px;
      width:7px; height:7px; border-radius:9999px; background:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.15);
    }
    /* Seçilen gün tablosu kartı */
    #repTab-daily #selDayBlock{
      margin-top:14px;
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.92));
      border:1px solid var(--cardBorder,#1e293b);
      border-radius:14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      padding: 16px;
    }
    #repTab-daily #selDayBlock .sectionTitle{
      font-weight:800; margin-bottom:10px;
    }
    /* Tablo görünümü */
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable table{ width:100%; border-collapse:separate; border-spacing:0; }
    #repTab-daily #stuDayTable th, #repTab-daily #tsdDayTable th,
    #repTab-daily #stuDayTable td, #repTab-daily #tsdDayTable td{
      padding:12px 14px;
      border-bottom:1px solid #23324a;
    }
    #repTab-daily #stuDayTable thead th, #repTab-daily #tsdDayTable thead th{
      text-align:left; font-weight:700; background:#0d1628;
    }
    #repTab-daily #stuDayTable tr:last-child td, #repTab-daily #tsdDayTable tr:last-child td{ border-bottom:0; }
    /* Düzenle düğmesi */
    #repTab-daily #stuDayTable .editBtn, #repTab-daily #tsdDayTable .editBtn{
      border:0; border-radius:10px; padding:6px 12px; min-height:32px;
      background: linear-gradient(180deg, #3b82f6, #06b6d4);
      color:#fff; font-weight:800; cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    #repTab-daily #stuDayTable .editBtn:hover, #repTab-daily #tsdDayTable .editBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.25); filter:saturate(1.05); }
    #repTab-daily #stuDayTable .editBtn:focus, #repTab-daily #tsdDayTable .editBtn:focus{ outline:3px solid rgba(16,185,129,.45); outline-offset:2px; }
    /* Küçük ekran ayarı */
    @media (max-width: 560px){
      #repTab-daily .calGrid{ gap:8px; }
      #repTab-daily .calCell{ min-height:44px; padding:8px; }
      #repTab-daily #selDayBlock{ padding:12px; }
      #repTab-daily #stuDayTable th, #repTab-daily #tsdDayTable th, #repTab-daily #stuDayTable td, #repTab-daily #tsdDayTable td{ padding:10px 12px; }
    }
    /* ====== /Günlük Rapor Tasarımı ====== */
    /* === Haftalık Sekme: Açılır Hafta Listesi (Dropdown) === */
    #repTab-weekly #weekControls{ display:flex; align-items:center; gap:12px; }
    #repTab-weekly .weekDropdown{ position:relative; display:inline-block; }
    #repTab-weekly .wdToggle{
      border:0; border-radius:12px; padding:8px 12px; min-height:36px;
      background: linear-gradient(180deg, #3b82f6, #06b6d4);
      color:#fff; font-weight:900; cursor:pointer;
      display:flex; align-items:center; gap:10px;
    }
    #repTab-weekly .wdToggle .chev{ font-weight:900; opacity:.9; }
    #repTab-weekly .wdMenu{
      position:absolute; top:calc(100% + 6px); left:0; z-index:50;
      background:#0f1a31; border:1px solid #23324a; border-radius:12px; padding:8px;
      box-shadow:0 20px 50px rgba(0,0,0,.45); min-width:320px; max-height:280px; overflow:auto;
      display:none;
    }
    #repTab-weekly .wdMenu.open{ display:block; }
    #repTab-weekly .wdItem{
      display:block; width:100%; text-align:left; border:0; background:transparent; color:inherit;
      padding:8px 10px; border-radius:8px; cursor:pointer;
    }
    #repTab-weekly .wdItem:hover{ background:rgba(148,163,184,.08); }
    #repTab-weekly .wdItem.active{ background:rgba(34,197,94,.15); outline:1px dashed rgba(16,185,129,.45); }
    @media (max-width:560px){
      #repTab-weekly .wdMenu{ min-width:260px; }
    }
    /* === /Dropdown CSS === */
    /* === Öğrenci Hoşgeldin Bannerı === */
    .studentWelcomeBanner{
      margin:10px 0 12px;
      padding:12px 14px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(34,197,94,.16), rgba(6,182,212,.10));
      border:1px solid rgba(34,197,94,.35);
      font-weight:800;
      color:#d1fae5;
      text-align:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.25), inset 0 0 0 1px rgba(34,197,94,.15);
    }
    /* === Hedef (daily target) === */
    .targetBtn{
      border:none;background:transparent;cursor:pointer;font-size:20px;line-height:1;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.4));
    }
    .targetBtn:hover{ transform: scale(1.05); }
    .targetInfo{
      margin:6px 0 10px; padding:8px 10px; border-radius:10px;
      background: rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.25);
      font-weight:600; display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .targetInfo small{opacity:.9}
    /* Float target button next to trash */
    .targetFloat{
      position:absolute; top:8px; right:52px; /* 8px (gap) + 36px (trash width) => sit left of trash */
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .targetFloat:hover{ transform:translateY(-1px); }
</style>
<style>
    /* --- Açılır Pencere (Rapor Modal) --- */
    #reportOverlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);z-index:9998;}
    #teacherStudentDetail.asModal{position:fixed;inset:auto auto 5% 50%;transform:translateX(-50%);width:min(920px,92vw);max-height:88vh;overflow:auto;
      background:var(--card,#0b1427);border:1px solid var(--cardBorder,#1e293b);border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.45);padding:16px;z-index:9999;}
    .modalHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;position:sticky;top:0;background:inherit;padding-bottom:8px;}
    .modalTabs{display:flex;gap:8px;align-items:center;}
    .modalTabs .pill{cursor:pointer;}
    .modalClose{margin-left:auto}
    #repTab-daily,#repTab-weekly,#repTab-monthly{display:none;}
    #repTab-daily.active,#repTab-weekly.active,#repTab-monthly.active{display:block;}
    @media (max-width:720px){
      #teacherStudentDetail.asModal{inset:auto auto 2% 50%; width:96vw; }
    }
</style>
<style>
    @media (max-width: 600px){
      /* Goals başlığını header altına taşıdığımızda gp-header içindekini gizle */
      #goalsPage .gp-title{ display: none !important; }
      /* Header altında yeni başlık görünümü */
      .header .header-goals-title{
        display: block;
        margin-top: 6px;
        font-weight: 800;
        font-size: clamp(18px, 5vw, 22px);
        line-height: 1.15;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
</style>
<script>
    (function(){
      function ensureGoalsTitle(){
        try{
          var header = document.querySelector('.header');
          var sub = header && header.querySelector('.subheader');
          var srcTitle = document.querySelector('#goalsPage .gp-title');
          if(!header || !sub || !srcTitle) return;
          var txt = srcTitle.textContent.trim();
          var el = header.querySelector('.header-goals-title');
          if(!el){
            el = document.createElement('div');
            el.className = 'header-goals-title';
            sub.insertAdjacentElement('afterend', el);
          }
          if(el.textContent.trim() !== txt){ el.textContent = txt; }
          // Görünürlüğü sadece goals sayfası görünürken aç
          var gp = document.getElementById('goalsPage');
          var isVisible = gp && gp.offsetParent !== null && window.getComputedStyle(gp).display !== 'none';
          el.style.display = (isVisible ? '' : 'none');
        }catch(e){}
      }
      document.addEventListener('DOMContentLoaded', function(){
        setTimeout(ensureGoalsTitle, 50);
      });
      var mo = new MutationObserver(function(){ setTimeout(ensureGoalsTitle, 50); });
      mo.observe(document.documentElement, {subtree:true, attributes:true, childList:true, attributeFilter:['style','class']});
      window.addEventListener('resize', function(){ setTimeout(ensureGoalsTitle, 100); }, {passive:true});
      window.addEventListener('orientationchange', function(){ setTimeout(ensureGoalsTitle, 200); }, {passive:true});
    })();
</script>
<style>
    /* Hide the Monthly tab button and its content in the teacher modal */
    #teacherStudentDetail #repTabMonthlyBtn,
    #teacherStudentDetail #repTab-monthly{ display:none !important; }
</style>
<script>
    (function(){
      // Force default to weekly when opening the teacher report modal
      if (typeof openReportModal === 'function'){
        const __origOpen = openReportModal;
        window.openReportModal = function(){
          var ov = document.getElementById('reportOverlay');
          var box = document.getElementById('teacherStudentDetail');
          if(ov) ov.style.display='block';
          if(box){ box.style.display='block'; }
          try{ showReportTab('weekly'); }catch(_){}
        };
      }
      // Remove Monthly tab elements entirely (defensive)
      document.addEventListener('DOMContentLoaded', function(){
        try{
          var btn = document.getElementById('repTabMonthlyBtn'); if(btn) btn.remove();
          var pane = document.getElementById('repTab-monthly'); if(pane) pane.remove();
        }catch(e){}
      });
    })();
</script>
<style>
    /* Goals başlığını her boyutta header altına taşı: gp-header içindeki başlık gizlenir */
    #goalsPage .gp-title{ display: none !important; }
    /* Header altına eklenecek başlığın görünümü */
    .header .header-goals-title{
      display: block;
      margin-top: 6px;
      font-weight: 800;
      font-size: clamp(18px, 2.2vw, 24px);
      line-height: 1.15;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
</style>
<script>
    (function(){
      function ensureGoalsTitle(){
        try{
          var header = document.querySelector('.header');
          var sub = header && header.querySelector('.subheader');
          var srcTitle = document.querySelector('#goalsPage .gp-title');
          if(!header || !sub || !srcTitle) return;
          var txt = (srcTitle.textContent || '').trim();
          var el = header.querySelector('.header-goals-title');
          if(!el){
            el = document.createElement('div');
            el.className = 'header-goals-title';
            sub.insertAdjacentElement('afterend', el);
          }
          if((el.textContent || '').trim() !== txt){ el.textContent = txt; }
          // Sadece Goals sayfası görünürken göster
          var gp = document.getElementById('goalsPage');
          var gpVisible = gp && window.getComputedStyle(gp).display !== 'none';
          el.style.display = gpVisible ? '' : 'none';
        }catch(e){/* no-op */}
      }
      document.addEventListener('DOMContentLoaded', function(){ setTimeout(ensureGoalsTitle, 50); });
      var mo = new MutationObserver(function(){ setTimeout(ensureGoalsTitle, 50); });
      mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:['style','class']});
      window.addEventListener('resize', function(){ setTimeout(ensureGoalsTitle, 100); }, {passive:true});
      window.addEventListener('orientationchange', function(){ setTimeout(ensureGoalsTitle, 200); }, {passive:true});
    })();
</script>
<style>
    /* Öğretmen paneli > Favoriler bölümündeki 'Göster' butonlarını kaldır */
    #favoritesSection .editBtn{ display: none !important; }
</style>
<style>
    #chatBubble {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        z-index: 9990;
        transition: transform 0.2s ease;
    }
    #chatBubble:hover {
        transform: scale(1.1);
    }
    #chatBubble svg {
        width: 32px;
        height: 32px;
        color: white;
    }
    #chatPopup {
        position: fixed;
        bottom: 100px;
        right: 25px;
        width: 350px;
        max-width: 90vw;
        height: 500px;
        max-height: 70vh;
        background: var(--panel);
        border: 1px solid var(--cardBorder);
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        z-index: 9991;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg);
        border-bottom: 1px solid var(--cardBorder);
        font-weight: 800;
    }
    .chat-header button {
        background: none;
        border: none;
        color: var(--text);
        font-size: 20px;
        cursor: pointer;
        opacity: 0.8;
    }
     #chatPopupOnlineUsers {
        padding: 8px 16px;
        font-size: 12px;
        background: var(--bg);
        border-bottom: 1px solid var(--cardBorder);
        color: #9ca3af;
        flex-shrink: 0;
    }
    #chatPopupMessages {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    #chatPopupMessages div {
        margin-bottom: 8px;
        line-height: 1.4;
    }
    .chat-input-area {
        display: flex;
        padding: 12px;
        border-top: 1px solid var(--cardBorder);
        gap: 8px;
        background: var(--bg);
    }
    .chat-input-area input {
        flex: 1;
        margin: 0;
    }
    .chat-input-area button {
        padding: 10px 16px;
        border: 0;
        border-radius: 10px;
        background: var(--accent1);
        color: white;
        font-weight: 700;
        cursor: pointer;
    }
</style>
</head>
<style>
/* ===== Ders Hedefleri (Goals Page) — Modern görünüm ===== */
#goalsPage{
  padding: 8px 12px 20px;
}
#goalsPage .gp-header{
  position: sticky; top: 0; z-index: 30;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 0;
  background: linear-gradient(180deg, rgba(11,20,39,.92), rgba(11,20,39,.86));
  border-bottom: 1px solid var(--cardBorder);
  backdrop-filter: saturate(1.1) blur(6px);
}
#goalsPage .gp-left{ display:flex; align-items:center; gap:10px; }
#goalsPage .gp-title{ font-weight:900; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
#goalsPage .gp-actions{ display:flex; align-items:center; gap:8px; }
/* Buton ikon düzeni — mevcut .pill ve .action renklerini kullan */
.gp-btn{ display:inline-flex; align-items:center; gap:8px; }
.gp-btn .icon{ width:16px; height:16px; line-height:0; display:inline-flex; }
.gp-btn .icon svg{ width:16px; height:16px; display:block; }
/* "Tablo" kutusu — satır ızgarası */
.gp-table{
  max-width: 760px; margin: 0 auto;
  background: var(--card);
  border: 1px solid var(--cardBorder);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 16px 40px rgba(0,0,0,.35);
}
.gp-row{
  display: grid; grid-template-columns: 1fr 140px;
  align-items: center; gap: 12px;
  padding: 12px 14px;
  border-top: 1px solid var(--cardBorder);
}
.gp-row:first-child{ border-top:0; }
.gp-row:nth-child(odd){ background: rgba(148,163,184,.05); }
.gp-label{
  display:flex; align-items:center; gap:10px; font-weight:800;
}
.gp-label .dot{ width:10px; height:10px; border-radius:999px; }
.gp-label.turkce    .dot{ background:#fb923c; }
.gp-label.sosyal    .dot{ background:#6366f1; }
.gp-label.din       .dot{ background:#22c55e; }
.gp-label.ing       .dot{ background:#0ea5e9; }
.gp-label.matematik .dot{ background:#f43f5e; }
.gp-label.fen       .dot{ background:#14b8a6; }
.gp-input{
      width:100%;
      min-height:42px; font-size:16px; text-align:center; font-weight:700;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--cardBorder);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .gp-input::-webkit-outer-spin-button,
    .gp-input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .gp-input{ -moz-appearance: textfield; }
    #goalsPage .gp-note{
      max-width:760px; margin:8px auto 0; opacity:.8;
    }
    /* Mobil ayar */
    @media (max-width: 560px){
      .gp-row{ grid-template-columns: 1fr 110px; padding: 10px 12px; }
      .gp-input{ min-height:38px; font-size:15px; }
    }
</style>
<style>
    /* ===== YENİ: PDF Dışa Aktarma Stilleri ===== */
    /* PDF Dışa Aktarma Menüsü */
    #pdfExportModalOverlay {
        position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 10000; display: none;
    }
    #pdfExportModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: var(--panel);
      padding: 22px;
      border-radius: 12px;
      width: min(450px, 90vw);
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      z-index: 10001;
      display: none;
    }
    #pdfExportModal .modal-section { margin-bottom: 16px; }
    #pdfExportModal h4 { margin: 0 0 10px; }
    #pdfExportModal p { margin: 0 0 8px; opacity: 0.9; }
    #pdfExportModal .option-group { display: flex; flex-direction: column; gap: 8px; }
    #pdfExportModal .option-group label {
        display: flex; align-items: center; gap: 10px;
        padding: 12px; background: var(--bg); border-radius: 8px; cursor: pointer;
        border: 1px solid var(--cardBorder);
        transition: border-color .15s ease, background-color .15s ease;
    }
    #pdfExportModal .option-group label:has(input:checked) {
        border-color: var(--ok);
        background: rgba(16,185,129,.1);
    }
    #pdfExportModal .option-group input[type="radio"]{ width: auto; }
    #pdfExportModal select { margin-top: 8px; }

    /* PDF için Beyaz Arka Plan (Yazıcı Dostu) */
    #exportArea.light-theme {
      background: #ffffff;
      color: #000000; /* Yazı rengi siyah */
    }
    #exportArea.light-theme h1,
    #exportArea.light-theme h2,
    #exportArea.light-theme span,
    #exportArea.light-theme div {
        color: #000000 !important;
    }
    #exportArea.light-theme .exportCard {
      background: #fdfdfd; 
      border-color: #dddddd; 
    }
    #exportArea.light-theme #exportTable th,
    #exportArea.light-theme #exportTable td,
    #exportArea.light-theme table th,
    #exportArea.light-theme table td {
      border-color: #dddddd;
    }

    /* === YENİ: Öğrenci Formu Buton Optimizasyonu === */
    #studentTab-entry .form-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    #studentTab-entry .form-actions .action {
      margin-top: 0;
      width: auto;
      flex: 1 1 200px;
      max-width: 250px;
    }
</style>
<body>
<div id="notificationOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: center; justify-content: center;">
    <div style="background: var(--panel); padding: 20px 24px; border-radius: 12px; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,.3);">
        <h3 style="margin-top: 0; color: var(--accent1);">Bildirim</h3>
        <p id="notificationMessage" style="margin: 8px 0 16px; line-height: 1.5;"></p>
        <button class="action" onclick="closeNotificationPopup()">Tamam</button>
    </div>
</div>
<div id="reportOverlay" onclick="closeReportModal()"></div>
<div id="targetModalOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 9998; display: none;"></div>
<div id="targetModal" style="position: fixed; inset: 5% 5% auto; max-width: 600px; margin: 0 auto; background: var(--panel); border-radius: 16px; padding: 22px; box-shadow: 0 20px 50px rgba(0,0,0,.45); z-index: 9999; display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 id="targetModalTitle">Öğrenci Ders Hedefleri</h3>
        <button class="pill modalClose" onclick="closeTargetModal()">Kapat ×</button>
    </div>
    <div id="targetModalContent">
        <div class="gp-table">
            <div class="gp-row">
                <div class="gp-label turkce"><span class="dot"></span>Türkçe</div>
                <input class="gp-input" id="modal-goal-Turkce" type="number" min="1" placeholder="50">
            </div>
            <div class="gp-row">
                <div class="gp-label sosyal"><span class="dot"></span>Sosyal Bilgiler</div>
                <input class="gp-input" id="modal-goal-Sosyal" type="number" min="1" placeholder="50">
            </div>
            <div class="gp-row">
                <div class="gp-label din"><span class="dot"></span>Din Kültürü</div>
                <input class="gp-input" id="modal-goal-Din" type="number" min="1" placeholder="50">
            </div>
            <div class="gp-row">
                <div class="gp-label ing"><span class="dot"></span>İngilizce</div>
                <input class="gp-input" id="modal-goal-Ingilizce" type="number" min="1" placeholder="50">
            </div>
            <div class="gp-row">
                <div class="gp-label matematik"><span class="dot"></span>Matematik</div>
                <input class="gp-input" id="modal-goal-Matematik" type="number" min="1" placeholder="50">
            </div>
            <div class="gp-row">
                <div class="gp-label fen"><span class="dot"></span>Fen Bilimleri</div>
                <input class="gp-input" id="modal-goal-Fen" type="number" min="1" placeholder="50">
            </div>
        </div>
        <button class="action" onclick="saveTargetGoals()" style="margin-top: 20px;">Hedefleri Kaydet</button>
    </div>
</div>
<div class="header">ÖĞRENCİ TAKİP PROGRAMI
    <div class="subheader">Alparslan Ortaokulu</div>
</div>
<div id="alert"></div>
<div id="loginPanel">
<div class="tabs">
<button class="active" id="tabRegister" onclick="showTab('register')" type="button">Öğrenci Kayıt</button>
<button id="tabStudent" onclick="showTab('studentLogin')" type="button">Öğrenci-Veli Giriş</button>
<button id="tabTeacher" onclick="showTab('teacherLogin')" type="button">Öğretmen Giriş</button>
</div>
<div class="container" id="register">
<h3>Öğrenci Kayıt</h3>
<input autocomplete="off" id="rName" placeholder="Ad Soyad" type="text"/>
<select id="rClass"><option value="">Sınıf Seçin</option></select>
<input autocomplete="off" id="rNumber" placeholder="Okul Numarası" type="text"/>
<input autocomplete="new-password" id="rPass" placeholder="Şifre" type="password"/>
<input autocomplete="new-password" id="rPass2" placeholder="Şifre (Tekrar)" type="password"/>
<small id="passMismatchError" style="display:none;color:#ef4444;font-weight:600;margin-top:4px;display:block;">Şifreler eşleşmiyor</small>
<button class="action" id="registerBtn" onclick="studentRegister()" type="button">Kayıt</button>
</div>
<div class="container" id="studentLogin" style="display:none">
<h3>Öğrenci-Veli Giriş</h3>
<input autocomplete="off" id="lNumber" placeholder="Okul Numarası" type="text"/>
<input autocomplete="current-password" id="lPass" placeholder="Şifre" type="password"/>
<div style="display: flex; align-items: center; margin: 12px 0; justify-content: center; user-select: none;">
    <input id="rememberMe" type="checkbox" style="width: auto; height: auto; margin-right: 8px; cursor: pointer;"/>
    <label for="rememberMe" style="cursor: pointer;">Beni Hatırla</label>
</div>
<button class="action" onclick="studentLogin()" type="button">Giriş Yap</button>
</div>
<div class="container" id="roleChoice" style="display:none">
<h3>Giriş Türünü Seçin</h3>
<div class="teacherWelcome" id="roleChoiceHello"></div>
<div class="roleGrid">
<button aria-label="Öğrenci Girişi" class="roleCard" onclick="enterAsStudent()" type="button">
<div aria-hidden="true" class="roleIcon">
<svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 12c2.761 0 5-2.686 5-6s-2.239-6-5-6-5 2.686-5 6 2.239 6 5 6Zm0 2c-4.418 0-8 2.686-8 6v2h16v-2c0-3.314-3.582-6-8-6Z"></path>
</svg>
</div>
<div class="roleTitle">Öğrenci Girişi</div>
</button>
<button aria-label="Veli Girişi" class="roleCard parent" onclick="enterAsParent()" type="button">
<div aria-hidden="true" class="roleIcon">
<svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M16 11c2.209 0 4-2.239 4-5s-1.791-5-4-5-4 2.239-4 5 1.791 5 4 5Zm-8 11c2.209 0 4-2.239 4-5S10.209 1 8 1 4 3.239 4 6s1.791 5 4 5Zm8 2c-2.761 0-5.2.937-6.64 2.378C7.409 14.855 5.132 14 3 14c-1.657 0-3 1.567-3 3.5V21h10v-2c0-1.252.467-2.393 1.256-3.33C12.466 14.646 14.066 14 16 14c3.866 0 7 2.015 7 4.5V21h-8v-1.5c0-2.485-1.79-4.5-4-4.5Z"></path>
</svg>
</div>
<div class="roleTitle">Veli Girişi</div>
</button>
</div>
<div class="smallRow" style="margin-top:10px">
<button aria-label="Geri" class="pill exit" onclick="exitToHome()" type="button"><span aria-hidden="true" class="backIcon">←</span> Geri</button>
</div>
</div>
<div class="container" id="teacherLogin" style="display:none">
<h3>Öğretmen Giriş</h3>
<input autocomplete="name" id="tName" placeholder="Ad Soyad" type="text"/>
<input id="tCode" placeholder="Kod" type="password"/>
<button class="action" onclick="teacherLogin()" type="button">Giriş Yap</button>
</div>
</div>
<div class="container" id="studentPanel" style="display:none">
<h3 id="studentPanelTitle">Öğrenci Paneli</h3>
<div class="studentWelcomeBanner" id="studentWelcome" style="display:none"></div>
<div class="pillTabs" id="studentTabs" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
<button class="pill active" id="stuTabEntryBtn" onclick="showStudentTab('entry')">Soru Girişi</button>
<button class="pill" id="stuTabWeekBtn" onclick="showStudentTab('week')">Haftalık Rapor</button>
<button class="pill" id="stuTabMonthBtn" onclick="showStudentTab('month')">Aylık Rapor</button>
</div>
<div id="studentTab-entry">
<div class="student-toolbar">
<div style="display:flex; gap:8px; align-items:center;">
<strong id="studentPanelToolbarTitle">Öğrenci Paneli</strong>
<span class="chip"><span class="dot" style="background:transparent;border:1px solid var(--cardBorder)"></span>Liste v5.4</span>
</div>
<div style="display:flex; gap:8px;">
<button class="densityToggle" id="densityToggleBtn" title="Yoğun Mod" type="button">Yoğun Mod</button>
</div>
<div class="targetInfo" id="studentTargetInfo" style="display:none">
<div><small>Günlük Hedef</small> <span id="studentTargetValue">—</span> soru</div>
<div>
<button class="pill" onclick="openTargetForCurrent()" type="button">Düzenle</button>
</div>
</div>
</div>
<form id="lessonForm">
<ul class="lessonList dense" role="list">
<li class="lessonRow dense">
<span class="chip turkce"><span class="dot"></span>Türkçe</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Türkçe azalt" class="numBtn" data-step="-1" data-target="Turkce" type="button">−</button>
<input id="Turkce" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Türkçe artır" class="numBtn" data-step="1" data-target="Turkce" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Turkce">Türkçe hedef</label>
<input class="goalInput" id="goal-Turkce" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Turkce"></div></div>
<span class="pctBadge zero" data-pct-for="Turkce">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip sosyal"><span class="dot"></span>Sosyal Bilgiler</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Sosyal Bilgiler azalt" class="numBtn" data-step="-1" data-target="Sosyal" type="button">−</button>
<input id="Sosyal" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Sosyal Bilgiler artır" class="numBtn" data-step="1" data-target="Sosyal" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Sosyal">Sosyal Bilgiler hedef</label>
<input class="goalInput" id="goal-Sosyal" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Sosyal"></div></div>
<span class="pctBadge zero" data-pct-for="Sosyal">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip din"><span class="dot"></span>Din Kültürü</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Din Kültürü azalt" class="numBtn" data-step="-1" data-target="Din" type="button">−</button>
<input id="Din" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Din Kültürü artır" class="numBtn" data-step="1" data-target="Din" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Din">Din Kültürü hedef</label>
<input class="goalInput" id="goal-Din" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Din"></div></div>
<span class="pctBadge zero" data-pct-for="Din">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip ing"><span class="dot"></span>İngilizce</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="İngilizce azalt" class="numBtn" data-step="-1" data-target="Ingilizce" type="button">−</button>
<input id="Ingilizce" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="İngilizce artır" class="numBtn" data-step="1" data-target="Ingilizce" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Ingilizce">İngilizce hedef</label>
<input class="goalInput" id="goal-Ingilizce" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Ingilizce"></div></div>
<span class="pctBadge zero" data-pct-for="Ingilizce">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip mat"><span class="dot"></span>Matematik</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Matematik azalt" class="numBtn" data-step="-1" data-target="Matematik" type="button">−</button>
<input id="Matematik" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Matematik artır" class="numBtn" data-step="1" data-target="Matematik" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Matematik">Matematik hedef</label>
<input class="goalInput" id="goal-Matematik" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Matematik"></div></div>
<span class="pctBadge zero" data-pct-for="Matematik">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip fen"><span class="dot"></span>Fen Bilimleri</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Fen Bilimleri azalt" class="numBtn" data-step="-1" data-target="Fen" type="button">−</button>
<input id="Fen" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Fen Bilimleri artır" class="numBtn" data-step="1" data-target="Fen" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Fen">Fen Bilimleri hedef</label>
<input class="goalInput" id="goal-Fen" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Fen"></div></div>
<span class="pctBadge zero" data-pct-for="Fen">0%</span>
</div>
</li>
</ul>
<div class="totalBar">
<span>Genel Toplam:</span>
<span class="totalBadge" id="globalTotal">0</span>
</div>
<div class="form-actions">
    <button class="action addBtn" onclick="addAll()" type="button">Ekle</button>
    <button class="action" onclick="saveGoalsFromEntryPage()" type="button" style="background: var(--ok);">Hedefleri Kaydet</button>
</div>
</form>
<div class="list" id="studentRecords"></div>
</div> <div id="studentTab-week" style="display:none">
<div class="sectionTitle">Hafta Seç</div>
<select id="stuWeekSelect" onchange="selectStuWeek(this.value)" style="width:100%;max-width:420px;"></select>
<div id="stuWeekChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="stuWeekChart"></canvas>
</div>
<div class="exportCard" id="stuWeekMatrix" style="margin-top:10px"></div>
</div>
<div id="studentTab-month" style="display:none">
<div class="sectionTitle">Ay Seç</div>
<select id="stuMonthSelect" onchange="selectStuMonth(this.value)" style="width:100%;max-width:420px;"></select>
<div id="stuMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="stuMonthChart"></canvas>
</div>
<div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
<div class="exportCard" id="stuMonthTotals"></div>
</div>
<button class="action logout" onclick="logout()" type="button">Çıkış Yap</button>
</div>
<div class="container" id="teacherPanel" style="display:none">
<p class="teacherWelcome" id="teacherWelcome"></p>
<div class="teacherTopbar">
<h3 style="margin:0">Öğretmen Paneli</h3>
<button aria-label="Çıkış" class="exitSmall" onclick="logout()" title="Çıkış" type="button"><span aria-hidden="true" class="icon">
<svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M14 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2"></path>
<path d="M9 12h11"></path>
<path d="M13 8l-4 4l4 4"></path>
</svg>
</span>
<span class="label">Çıkış</span></button>
</div>
<div class="pillTabs" id="teacherTopTabs" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
<button class="pill active" id="tabClasses" onclick="showTeacherSection('classes')">Sınıflar</button>
<button class="pill" id="tabFavorites" onclick="showTeacherSection('favorites')">Favorilerim</button>
<button class="pill" id="tabModeration" onclick="showTeacherSection('moderation')" style="display:none;">Moderasyon</button>
</div>
<div id="classesSection">
<div class="row" style="margin-top:10px; margin-bottom:6px">
<input autocomplete="off" class="grow" id="newClass" placeholder="örn: 8/A" type="text"/>
<button class="action" onclick="addClass()" style="max-width:220px" type="button">Sınıf Ekle</button>
</div>
<div class="classGrid" id="classGrid"></div>
<div class="list" id="classStudents" style="display:none">
<div class="sectionTitle">Öğrenciler</div>
<div id="studentsContainer"></div>
</div>
</div>
<div id="favoritesSection" style="display:none; margin-top:14px">
<div class="list">
<div class="sectionTitle">Favori Öğrencilerim</div>
<div id="favoritesList"></div>
</div>
</div>
<div id="moderationSection" style="display:none; margin-top:14px">
    <div class="list">
        <div class="sectionTitle">Yasaklı Kelimeler</div>
        <div id="badWordsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        <div class="row" style="margin-top:10px;">
            <input autocomplete="off" class="grow" id="newBadWord" placeholder="Yeni kelime ekle" type="text"/>
            <button class="action" onclick="addBadWord()" style="max-width:160px" type="button">Kelime Ekle</button>
        </div>
    </div>
    <div class="list" style="margin-top:14px">
        <div class="sectionTitle">İncelenecek Mesajlar</div>
        <div id="flaggedMessagesList"></div>
    </div>
</div>
</div>
<div class="list asModal" id="teacherStudentDetail" style="display:none;">
<div class="modalHead">
<div class="modalTabs">
<button class="pill active" id="repTabDailyBtn" onclick="showReportTab('daily')">Günlük</button>
<button class="pill" id="repTabWeeklyBtn" onclick="showReportTab('weekly')">Haftalık</button>
<button class="pill" id="repTabMonthlyBtn" onclick="showReportTab('monthly')">Aylık</button>
</div>
<button class="pill modalClose" onclick="closeReportModal()">Kapat ×</button>
</div>
<div class="active" id="repTab-daily">
<div class="sectionTitle" id="tsdTitle"></div>
<div id="tsdDays" class="calendarWrap"></div>
<div id="selDayBlock" style="margin-top:12px">
<div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
<div id="tsdDayTable"></div>
</div>
<div class="sectionTitle" style="margin-top:12px">Genel Toplam (Ders Bazlı)</div>
<div id="tsdTotals"></div>
</div><div id="repTab-weekly" style="display:none;">
<div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
<div class="smallRow" id="weekControls">
<select id="teacherWeekSelect" onchange="selectTeacherWeek(this.value)" style="width:100%;max-width:320px;"></select>
<div id="pdfBtns" style="margin-left:auto">
<button class="action" disabled="" id="btnExportPDF" onclick="openPdfExportMenu()" style="max-width:220px">PDF Dışa Aktar</button>
</div>
</div>
<div id="weekChartWrap"><canvas height="140" id="weekChart"></canvas></div>
<div class="exportCard" id="weekMatrix" style="margin-top:10px"></div>
</div>
<div id="repTab-monthly" style="display:none;">
<div class="sectionTitle">Ay Seç</div>
<select id="tMonthSelect" onchange="selectTeacherMonth(this.value)" style="width:100%;max-width:420px;"></select>
<div id="tMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="tMonthChart"></canvas>
</div>
<div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
<div class="exportCard" id="tMonthTotals"></div>
</div>
</div>

<!-- YENİ: PDF Dışa Aktarma Menüsü -->
<div id="pdfExportModalOverlay" onclick="closePdfExportMenu()"></div>
<div id="pdfExportModal">
    <h4>PDF Dışa Aktarma Seçenekleri</h4>

    <div class="modal-section">
        <p>1. Kimin raporunu oluşturmak istersiniz?</p>
        <div class="option-group">
            <label><input type="radio" name="exportScope" value="student" checked> Sadece Bu Öğrenci</label>
            <label><input type="radio" name="exportScope" value="class"> Tüm Sınıf</label>
        </div>
    </div>

    <div class="modal-section" id="pdfLessonOptions" style="display: none;">
        <p>2. Hangi dersleri dahil etmek istersiniz?</p>
        <div class="option-group">
             <label><input type="radio" name="lessonScope" value="all" checked> Tüm Dersler</label>
             <label><input type="radio" name="lessonScope" value="single"> Tek Bir Ders Seç</label>
        </div>
        <select id="pdfLessonSelect" style="display: none;"></select>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="action" onclick="startPdfExport()" style="flex: 1;">Oluştur</button>
        <button class="pill" onclick="closePdfExportMenu()" style="background: var(--muted);">İptal</button>
    </div>
</div>


<div id="exportArea" style="position:absolute; left:-99999px; top:-99999px;">
<div id="exportHead">
<h1 id="exportTitle">Haftalık Gelişim Raporu</h1>
<span id="exportRange" style="color:#a5b4fc;font-weight:700;"></span>
</div>
<h2 id="exportStudent"></h2>
<div class="exportCard" style="margin-bottom:10px">
<div id="exportTable"></div>
</div>
<div id="exportLegend">Ders × Gün matrisi (Pzt–Paz). Renkler ve tipografi PDF için optimize edilmiştir.</div>
</div>
<div id="chatBubble" style="display: none;" onclick="openChatPopup()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
    </svg>
</div>
<div id="chatPopup" style="display: none;">
    <div class="chat-header">
        <span>Sohbet</span>
        <button onclick="closeChatPopup()">×</button>
    </div>
    <div id="chatPopupOnlineUsers"><strong>Çevrimiçi:</strong> Yükleniyor...</div>
    <div id="chatPopupMessages"></div>
    <div class="chat-input-area">
        <input id="chatPopupInput" type="text" placeholder="Mesajınızı yazın..." onkeydown="if(event.key==='Enter') sendPopupMessage()"/>
        <button onclick="sendPopupMessage()">Gönder</button>
    </div>
</div>
<script>
    // Firebase yapılandırması
    const firebaseConfig = {
      apiKey: "AIzaSyD-D-Jp8GDuoc2b-My7cOpSViRyrcAypX0",
      authDomain: "kocluksistemi-69e89.firebaseapp.com",
      databaseURL: "https://sorutakipsistemi-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "kocluksistemi-69e89",
      storageBucket: "kocluksistemi-69e89.firebasestorage.app",
      messagingSenderId: "1025155254767",
      appId: "1:1025155254767:web:492d53b2d6f36d0ea88e1a",
      measurementId: "G-PZMLQHZP2L"
    };
    // Firebase başlatma
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    /* ============ Global Durum ============ */
    let currentStudent=null;
    let currentStudentName=null; 
    let currentTeacherId=null, currentTeacherName=null;
    let stuWeekChart=null, stuMonthChart=null, tMonthChart = null, _stuWeeks=[], _stuMonths=[];
    let favoritesCache={}, classesMap={}, activeClassName=null, currentDetailNum=null;
    let currentDetailLessons=null, currentWeeks=[], selectedWeekKey=null, weekChart=null;
    let selectClassRenderToken = 0;
    let favRef = null;
    let classesRef = null;
    let chatListenerActive = false;
    let onlineUsersListener = null;
    let notificationListener = null;
    let currentTargetStudent = null;
    let currentTargetStudentName = null;
    /* ============ Yardımcılar ============ */
    function setAlert(msg){
      const a=document.getElementById('alert');
      if(!msg){ a.style.display='none'; a.textContent=''; return; }
      a.textContent=msg; a.style.display='block';
      setTimeout(()=>{ a.style.display='none'; }, 3500);
    }
    function showTab(tab){
      const rc = document.getElementById('roleChoice');
      if (rc) rc.style.display = 'none';
      if (typeof currentStudent !== 'undefined') currentStudent = null;
      ["register","studentLogin","teacherLogin"].forEach(id=>{
        document.getElementById(id).style.display = (id===tab) ? "block" : "none";
      });
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
      if(tab==="register") document.getElementById("tabRegister").classList.add("active");
      if(tab==="studentLogin") document.getElementById("tabStudent").classList.add("active");
      if(tab==="teacherLogin") document.getElementById("tabTeacher").classList.add("active");
    }
    function normalizeId(str){
      if(!str) return "";
      const map={'ç':'c','ğ':'g','ı':'i','i':'i','ö':'o','ş':'s','ü':'u','Ç':'c','Ğ':'g','İ':'i','I':'i','Ö':'o','Ş':'s','Ü':'u'};
      return str.trim().toLowerCase()
        .replace(/[çğıİiöşüÇĞIÖŞÜ]/g, m=>map[m]||m)
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'');
    }
    function escHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'<','>':'>','"':'&quot;',"'":'&#39;' }[m])); }
    function escAttr(s){ return escHTML(s); }
    function toTitleCaseTR(str){
      if(!str) return "";
      return String(str).toLocaleLowerCase('tr-TR')
        .split(/\s+/).map(part=>{
          return part.split('-').map(seg=>{
            if(!seg) return seg;
            return seg.charAt(0).toLocaleUpperCase('tr-TR') + seg.slice(1);
          }).join('-');
        }).join(' ');
    }
    function isPrivilegedTeacher(){
      if(!currentTeacherName) return false;
      const low = s=>s.trim().toLocaleLowerCase('tr-TR');
      return low(currentTeacherName) === low("Emre Demirbaş");
    }
    function isModerator() {
        return currentTeacherName && currentTeacherName.trim().toLowerCase() === "uğur yaşayan";
    }
    /* ============ DÜZELTME: Artı/eksi butonları için event listener'lar ============ */
    function setupNumberButtons() {
        // Tüm numBtn sınıfına sahip butonları seç
        const numberButtons = document.querySelectorAll('.numBtn');
        numberButtons.forEach(button => {
            // Mevcut event listener'ı kaldır (tekrarlanmasını önlemek için)
            button.replaceWith(button.cloneNode(true));
        });
        // Yeni event listener'lar ekle
        document.querySelectorAll('.numBtn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const step = parseInt(this.getAttribute('data-step'));
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (input) {
                    let currentValue = parseInt(input.value) || 0;
                    let newValue = currentValue + step;
                    // Negatif değerlere izin verme
                    if (newValue < 0) newValue = 0;
                    input.value = newValue;
                    // İlgili progress bar'ı güncelle
                    updateProgress(targetId);
                    // Toplamı güncelle
                    updateGlobalTotal();
                }
            });
        });
    }
    /* ============ DÜZELTME: Progress bar ve toplam güncelleme fonksiyonları ============ */
    function updateProgress(lessonId) {
        const input = document.getElementById(lessonId);
        const goalInput = document.getElementById('goal-' + lessonId);
        const progressBar = document.querySelector(`[data-bar-for="${lessonId}"]`);
        const pctBadge = document.querySelector(`[data-pct-for="${lessonId}"]`);
        if (!input || !goalInput || !progressBar || !pctBadge) return;
        const value = parseInt(input.value) || 0;
        const goal = parseInt(goalInput.value) || 50; // Varsayılan 50
        let percentage = 0;
        if (goal > 0) {
            percentage = Math.min(100, Math.round((value / goal) * 100));
        }
        progressBar.style.width = `${percentage}%`;
        pctBadge.textContent = `${percentage}%`;
        // Yüzdeye göre badge rengini güncelle
        pctBadge.className = 'pctBadge';
        if (percentage === 0) {
            pctBadge.classList.add('zero');
        } else if (percentage < 100) {
            pctBadge.classList.add('low');
        }
        // %100 veya üzeri için özel bir sınıf yok, varsayılan yeşil kalır
    }
    function updateGlobalTotal() {
        const lessons = ['Turkce', 'Sosyal', 'Din', 'Ingilizce', 'Matematik', 'Fen'];
        let total = 0;
        lessons.forEach(lesson => {
            const input = document.getElementById(lesson);
            if (input) {
                total += parseInt(input.value) || 0;
            }
        });
        const totalElement = document.getElementById('globalTotal');
        if (totalElement) {
            totalElement.textContent = total;
        }
    }
    /* ============ DÜZELTME: "Beni Hatırla" özelliğini geliştirme ============ */
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const remembered = localStorage.getItem('rememberedStudent');
            if (remembered) {
                const { num, pass } = JSON.parse(remembered);
                if (num && pass) {
                    // Otomatik giriş yap
                    db.ref("students/"+num).get().then(snap=>{
                        if(snap.exists() && snap.val().pass===pass){
                            currentStudent = num;
                            showRoleChoice(snap.val());
                            // Otomatik olarak öğrenci girişine geç
                            setTimeout(() => {
                                enterAsStudent();
                            }, 500);
                        } else {
                            localStorage.removeItem('rememberedStudent');
                        }
                    }).catch(() => {
                        localStorage.removeItem('rememberedStudent');
                    });
                }
            }
        } catch(e) {
            try { localStorage.removeItem('rememberedStudent'); } catch(e2){}
        }
    });
    /* ============ Öğrenci kayıt & giriş ============ */
    function studentRegister(){
      const name=document.getElementById("rName").value.trim();
      const sclass=document.getElementById("rClass").value;
      const num=document.getElementById("rNumber").value.trim();
      const pass=document.getElementById("rPass").value;
      const pass2=document.getElementById("rPass2").value;
      if(!name||!sclass||!num||!pass||!pass2){
        setAlert("Tüm alanları doldurun."); return;
      }
      if(pass!==pass2){
        setAlert("Şifreler eşleşmiyor. Lütfen şifreyi iki kez aynı girin."); return;
      }
      db.ref("students/"+num).get().then(snap=>{
        if(snap.exists()){
          setAlert("Bu okul numarası zaten sisteme kayıtlıdır.");
          return Promise.reject("duplicate");
        }
        return db.ref("students/"+num).set({name,sclass,num,pass});
      }).then(()=>{
        setAlert("Kayıt başarılı! Şimdi giriş yapabilirsiniz.");
        document.getElementById("lNumber").value = num;
        document.getElementById("lPass").value = "";
        showTab("studentLogin");
      }).catch(e=>{
        if(e!=="duplicate") setAlert("Hata: "+e.message);
      });
    }
    function studentLogin(){
      const num=document.getElementById("lNumber").value.trim();
      const pass=document.getElementById("lPass").value;
      const remember = document.getElementById("rememberMe").checked;
      if(!num || !pass) {
        setAlert("Okul numarası ve şifre giriniz.");
        return;
      }
      db.ref("students/"+num).get().then(snap=>{
        if(snap.exists() && snap.val().pass===pass){
          if(remember){
            try { localStorage.setItem('rememberedStudent', JSON.stringify({num: num, pass: pass})); } catch(e){}
          } else {
            try { localStorage.removeItem('rememberedStudent'); } catch(e){}
          }
          currentStudent = num;
          document.getElementById("lPass").value="";
          showRoleChoice(snap.val());
        }else{
          setAlert("Numara veya şifre hatalı.");
        }
      });
    }
    function showRoleChoice(student){
      try{ currentStudentName = (student && student.name) ? student.name : null; }catch(_){}
      const reg=document.getElementById("register");
      const stu=document.getElementById("studentLogin");
      const tea=document.getElementById("teacherLogin");
      const rc =document.getElementById("roleChoice");
      if(reg) reg.style.display="none";
      if(stu) stu.style.display="none";
      if(tea) tea.style.display="none";
      if(rc)  rc.style.display="block";
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
      const prettyName = toTitleCaseTR((student && student.name) ? student.name : "");
      const hello = document.getElementById("roleChoiceHello");
      if(hello){
        if(prettyName){
          hello.textContent = `${prettyName} (${student.num}) olarak giriş yaptınız. Lütfen devam edin.`;
        }else{
          hello.textContent = "Giriş başarılı. Lütfen devam edin.";
        }
      }
    }
    /* ============ DÜZELTME: Öğrenci girişinde artı/eksi butonlarını kurma ============ */
    function enterAsStudent(){
      window.activeRole = 'student';
      document.getElementById("roleChoice").style.display="none";
      document.getElementById("loginPanel").style.display="none";
      document.getElementById("studentPanel").style.display="block";
      document.getElementById('chatBubble').style.display = 'flex';
      setWelcomeStudentBanner();
      loadStudentTarget();
      loadLessonGoals();
      try{ listenForNotifications(); }catch(_){}
      try { setupPresence(); } catch(e) { console.error("Presence setup failed:", e); }
      showStudentTab('entry');
      loadStudentData();
      applyRoleUi();
      // Artı/eksi butonlarını kur
      setTimeout(() => {
          setupNumberButtons();
          // İlk yüklemede tüm progress bar'ları güncelle
          ['Turkce', 'Sosyal', 'Din', 'Ingilizce', 'Matematik', 'Fen'].forEach(lesson => {
              updateProgress(lesson);
          });
          updateGlobalTotal();
      }, 100);
    }
    function enterAsParent(){
      window.activeRole = 'parent';
      document.getElementById("roleChoice").style.display="none";
      document.getElementById("loginPanel").style.display="none";
      document.getElementById("studentPanel").style.display='block';
      showStudentTab('week');
      loadStudentData();
      applyRoleUi();
    }
    function backToLogin(){
      currentStudent = null;
      const rc=document.getElementById("roleChoice"); if(rc) rc.style.display="none";
      showTab("studentLogin");
    }
    function logout(){
      try { localStorage.removeItem('rememberedStudent'); } catch(e){}
      const userId = currentStudent || currentTeacherId;
      if (userId && db) {
          db.ref('/status/' + userId).remove();
      }
      // Tüm dinleyicileri kapat
      if(onlineUsersListener) {
        onlineUsersListener.off();
        onlineUsersListener = null;
      }
      if(chatListenerActive) {
        db.ref('chat').off();
        chatListenerActive = false;
      }
      if(notificationListener) {
        notificationListener.off();
        notificationListener = null;
      }
      const rc=document.getElementById('roleChoice'); if(rc) rc.style.display='none';
      if(classesRef){ classesRef.off(); classesRef=null; }
      if(favRef){ favRef.off(); favRef=null; }
      currentStudent=null; currentDetailNum=null; currentStudentName=null;
      try{ var b=document.getElementById('studentWelcome'); if(b){ b.style.display='none'; b.textContent=''; } }catch(_){ }
      try{ setStudentTargetInfo(null); }catch(_){ }
      currentTeacherId=null; currentTeacherName=null; favoritesCache={};
      ["rName","rNumber","rPass","rPass2","lNumber","lPass","tName","tCode","newClass"].forEach(id=>{const el=document.getElementById(id); if(el) el.value="";});
      ["studentPanel","teacherPanel","teacherStudentDetail","chatBubble", "chatPopup"].forEach(id=>document.getElementById(id).style.display="none");
      document.getElementById("loginPanel").style.display="block";
      showTab("studentLogin");
      destroyAllCharts();
      // Rolü sıfırla
      window.activeRole = 'student';
      window.applyRoleUi();
    }
    /* ============ Öğrenci Paneli ============ */
    function addAll(){
      if(!currentStudent){ setAlert("Oturum bulunamadı."); return; }
      const map={"Türkçe":"Turkce","Sosyal Bilgiler":"Sosyal","Din Kültürü":"Din","İngilizce":"Ingilizce","Matematik":"Matematik","Fen Bilimleri":"Fen"};
      const now=new Date();
      const timeStr=now.toLocaleDateString("tr-TR")+" "+now.toLocaleTimeString("tr-TR");
      const updates = {};
      let hasData = false;
      for(const lesson in map){
        let v=parseInt(document.getElementById(map[lesson]).value, 10);
        if(!isNaN(v) && v > 0){
          hasData = true;
          const newKey = db.ref(`students/${currentStudent}/lessons/${lesson}`).push().key;
          updates[`students/${currentStudent}/lessons/${lesson}/${newKey}`] = {count:v,time:timeStr};
        }
      }
      if(!hasData) {
        setAlert("Lütfen en az bir derse soru sayısı girin.");
        return;
      }
      db.ref().update(updates).then(() => {
        setAlert("Kayıtlar eklendi!");
        document.getElementById("lessonForm").reset();
        // Update progress bars and totals immediately
        ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(id => updateProgress(id));
        updateGlobalTotal();
        loadStudentData();
      }).catch(e => setAlert("Hata: " + e.message));
    }
    /* ============ DÜZELTME: Form resetlendiğinde progress bar'ları sıfırla ============ */
    function loadStudentData(){
      const box=document.getElementById("studentRecords");
      box.innerHTML="<div class='empty'>Yükleniyor...</div>";
      db.ref("students/"+currentStudent+"/lessons").get().then(snap=>{
        const grouped={}; // gün -> { totalPerLesson:{}, keysPerLesson:{} }
        if(snap.exists()){
          const data=snap.val();
          for(const lesson in data){
            for(const key in data[lesson]){
              const e=data[lesson][key];
              const day=(e.time||"").split(" ")[0]||"Bilinmeyen";
              if(!grouped[day]) grouped[day]={ totalPerLesson:{}, keysPerLesson:{} };
              grouped[day].totalPerLesson[lesson]=(grouped[day].totalPerLesson[lesson]||0) + (Number(e.count)||0);
              (grouped[day].keysPerLesson[lesson] ||= []).push(key);
            }
          }
        }
        if(window.activeRole === 'student') {
          box.innerHTML = `
            <div id="calendarWrap" class="calendarWrap"></div>
            <div id="selDayBlock" style="margin-top:12px">
              <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
              <div id="stuDayTable"></div>
            </div>`;
          const allDays = Object.keys(grouped).map(parseTRDateStr).filter(d=>!isNaN(d));
          const latest = allDays.length ? allDays.sort((a,b)=>b-a)[0] : new Date();
          window._calCtx = {
            grouped,
            selectedDate: latest,
            viewMonthStart: new Date(latest.getFullYear(), latest.getMonth(), 1),
            hasSet: new Set(Object.keys(grouped))
          };
          renderStudentCalendar();
          const dayStr = formatTR(latest);
          if(grouped[dayStr]) showDay(dayStr);
          else document.getElementById("stuDayTable").innerHTML = "<div class='empty'>Bu gün için veri yok.</div>";
        } else {
            box.innerHTML = ''; // Veli için bu bölümü boş bırak
        }
        window._studentLessons = snap.exists() ? (snap.val() || {}) : {};
        prepareStudentReports(window._studentLessons);
        // Form resetlendikten sonra progress bar'ları güncelle
        setTimeout(() => {
            setupNumberButtons();
            ['Turkce', 'Sosyal', 'Din', 'Ingilizce', 'Matematik', 'Fen'].forEach(lesson => {
                updateProgress(lesson);
            });
            updateGlobalTotal();
        }, 100);
      }).catch(err => {
          box.innerHTML = `<div class='empty'>Veri yüklenirken hata oluştu: ${err.message}</div>`;
          // Hata durumunda da progress bar'ları güncelle
          setTimeout(() => {
              setupNumberButtons();
              ['Turkce', 'Sosyal', 'Din', 'Ingilizce', 'Matematik', 'Fen'].forEach(lesson => {
                  updateProgress(lesson);
              });
              updateGlobalTotal();
          }, 100);
      });
    }
    function showDay(day){
      const detailsObj = (window._calCtx.grouped && window._calCtx.grouped[day]) ? window._calCtx.grouped[day].totalPerLesson : {};
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html="<table id='daily-log-table'><thead><tr><th>Ders</th><th>O Gün Toplam</th><th>İşlem</th></tr></thead><tbody>";
      dersSirasi.forEach(lesson=>{
        const total = detailsObj[lesson] || 0;
        html += `<tr>
          <td>${escHTML(lesson)}</td>
          <td>${total}</td>
          <td><button type="button" class="editBtn" onclick="editAggregated('${escAttr(day)}','${escAttr(lesson)}',${total})">Düzenle</button></td>
        </tr>`;
      });
      html+="</tbody></table>";
      const el=document.getElementById("stuDayTable");
      el.innerHTML=html;
    }
    function editAggregated(day, lesson, oldTotal){
      let nv = prompt(`${day} günü "${lesson}" dersi için yeni toplam değeri girin:`, oldTotal);
      if(nv===null) return;
      nv = parseInt(nv,10);
      if(isNaN(nv)){ setAlert("Geçersiz sayı."); return; }
      const infoAgg = (window._calCtx.grouped && window._calCtx.grouped[day] && window._calCtx.grouped[day].keysPerLesson && window._calCtx.grouped[day].keysPerLesson[lesson])
                      ? window._calCtx.grouped[day].keysPerLesson[lesson] : [];
      const updates = {};
      infoAgg.forEach(key=>{
        updates[`students/${currentStudent}/lessons/${lesson}/${key}`] = null;
      });
      if (nv > 0) {
        const fakeTime = `${day} 12:00:00`;
        const newKey = db.ref().child(`students/${currentStudent}/lessons/${lesson}`).push().key;
        updates[`students/${currentStudent}/lessons/${lesson}/${newKey}`] = {count:nv, time:fakeTime};
      }
      db.ref().update(updates).then(()=>{
        setAlert("Güncellendi.");
        loadStudentData(); 
      }).catch(e=>setAlert("Hata: "+e.message));
    }
    /* ============ Öğretmen Giriş ============ */
    function teacherLogin(){
      const name=document.getElementById("tName").value.trim();
      const code=document.getElementById("tCode").value;
      if(!name || !code){ setAlert("Ad Soyad ve kod gerekli."); return; }
      // DİKKAT: Bu güvensiz bir yöntemdir. Gerçek bir uygulamada şifreler veritabanında saklanmalıdır.
      if(code!=="703504"){ setAlert("Kod hatalı."); return; }
      currentTeacherName = name;
      currentTeacherId = normalizeId(name);
      if(!currentTeacherId){ setAlert("Geçerli bir ad giriniz."); return; }
      db.ref("teachers/"+currentTeacherId).set({ name: currentTeacherName, createdAt: firebase.database.ServerValue.TIMESTAMP }).catch(()=>{});
      document.getElementById("teacherWelcome").textContent = `Hoş geldiniz, ${toTitleCaseTR(currentTeacherName)}`;
      document.getElementById("loginPanel").style.display="none";
      document.getElementById("teacherPanel").style.display="block";
      document.getElementById('chatBubble').style.display = 'flex';
      if(isModerator()) {
          document.getElementById('tabModeration').style.display = 'inline-flex';
          setupInitialBadWords();
      }
      try { setupPresence(); } catch(e) { console.error("Presence setup failed:", e); }
      listenClasses();
      listenFavorites();
    }
    /* ============ Sınıflar (ortak) ============ */
    function addClass(){
      const cls=document.getElementById("newClass").value.trim();
      if(!cls){ setAlert("Sınıf adı girin (örn: 8/A)."); return; }
      db.ref("classes").orderByChild("name").equalTo(cls).get().then(s=>{
        if(s.exists()){ setAlert("Bu sınıf zaten ekli."); return; }
        return db.ref("classes").push({name:cls,createdAt:firebase.database.ServerValue.TIMESTAMP});
      }).then(()=>{ document.getElementById("newClass").value=""; }).catch(e => setAlert("Hata: "+e.message));
    }
    function deleteClassByName(name){
      if(!isPrivilegedTeacher()){
        setAlert("Bu işlemi yapma yetkiniz yok.");
        return;
      }
      const classId = Object.keys(classesMap).find(key => classesMap[key] === name);
      if(!classId){ setAlert("Sınıf id bulunamadı."); return; }
      if(!confirm(`"${name}" sınıfını silmek istiyor musunuz?`)) return;
      db.ref("classes/"+classId).remove()
        .then(()=>{ setAlert("Sınıf silindi."); if(activeClassName===name){ activeClassName=null; document.getElementById("classStudents").style.display="none"; document.getElementById("teacherStudentDetail").style.display="none"; } })
        .catch(e=>setAlert("Silme hatası: "+e.message));
    }
    function listenClasses(){
      if(classesRef){ classesRef.off(); }
      classesRef = db.ref("classes");
      classesRef.on("value",snap=>{
        classesMap = {};
        const names=[]; 
        snap.forEach(ch=>{const v=ch.val(); if(v&&v.name){ names.push(v.name); classesMap[ch.key]=v.name; }});
        const grid=document.getElementById("classGrid"); 
        if(grid) {
            grid.innerHTML="";
            if(!names.length){ grid.innerHTML="<div class='empty' style='grid-column:1/-1'>Henüz sınıf yok.</div>"; document.getElementById("classStudents").style.display="none"; }
            names.sort((a, b) => a.localeCompare(b, 'tr', {numeric: true})).forEach(name=>{
              const card=document.createElement("div"); card.className="classCard";
              const title=document.createElement("div"); title.className="className"; title.textContent=name;
              const pick=document.createElement("button"); pick.className="classPick"; pick.textContent="Öğrencileri Gör";
              pick.onclick=()=>{
                activeClassName=name;
                document.querySelectorAll(".classPick").forEach(b=>b.classList.remove("active"));
                pick.classList.add("active");
                selectClass(name);
              };
              if(isPrivilegedTeacher()){
                const del=document.createElement("button"); 
                del.className="delFloat"; 
                del.setAttribute("title","Sınıfı Sil");
                del.setAttribute("aria-label","Sınıfı Sil");
                del.innerHTML=`<img class="trashIcon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZWY0NDQ0Ij4KICA8cGF0aCBkPSJNOSAyaDZ2Mmg1djJINFY0aDVWMnptLTMgNmgxMmwtMSAxMmEyIDIgMCAwIDEtMiAySDlhMiAyIDAgMCAxLTItMkw2IDh6bTQgM3Y3aDJ2LTdoLTJ6bTQgMHY3aDJ2LTdoLTJ6Ii8+Cjwvc3ZnPg==" alt="Sil">`;
                del.onclick=(e)=>{ e.stopPropagation(); deleteClassByName(name); };
                card.appendChild(del);
              }
              card.appendChild(title); 
              card.appendChild(pick);
              grid.appendChild(card);
            });
        }
        
        const sel=document.getElementById("rClass"); 
        if (sel) {
            const keep=sel.value;
            sel.innerHTML="<option value=''>Sınıf Seçin</option>";
            names.forEach(n=>{const o=document.createElement("option"); o.value=n; o.text=n; sel.add(o);});
            if(names.includes(keep)) sel.value=keep;
        }

        if(activeClassName && names.includes(activeClassName)){
          const btn=[...document.querySelectorAll(".classPick")].find(b=>b.parentElement.querySelector(".className").textContent===activeClassName);
          if(btn){ 
            btn.classList.add("active"); 
            setTimeout(() => selectClass(activeClassName), 0);
          }
        } else if (document.getElementById("classStudents")) {
            document.getElementById("classStudents").style.display="none";
        }
      });
    }

    function loadClassesForRegistration() {
        const sel = document.getElementById("rClass");
        if (!sel) return;
        db.ref("classes").get().then(snap => {
            if (!snap.exists()) return;
            const names = [];
            snap.forEach(ch => {
                const v = ch.val();
                if (v && v.name) { names.push(v.name); }
            });
            names.sort((a, b) => a.localeCompare(b, 'tr', { numeric: true }));
            sel.innerHTML = "<option value=''>Sınıf Seçin</option>";
            names.forEach(n => {
                const o = document.createElement("option");
                o.value = n;
                o.text = n;
                sel.add(o);
            });
        }).catch(e => console.error("Sınıf listesi yüklenemedi: ", e));
    }

    function selectClass(name){
      activeClassName = name; // 👈 Önce global değişkene ata
      const list=document.getElementById("studentsContainer");
      document.getElementById("classStudents").style.display="block";
      const myToken = ++selectClassRenderToken;
      list.innerHTML = "<div class='empty'>Yükleniyor...</div>";
      db.ref("students").orderByChild("sclass").equalTo(name).get().then(snap=>{
        if(myToken !== selectClassRenderToken) return;
        if(!snap.exists()){
          list.innerHTML=`<div class='empty'>${escHTML(name)} sınıfında kayıtlı öğrenci yok.</div>`;
          return;
        }
        const students = [];
        snap.forEach(ch => {
            const s = ch.val();
            if (s && s.num) {
                students.push({name: s.name || '', num: String(s.num), sclass: s.sclass || ''});
            }
        });
        students.sort((a,b) => (a.name).localeCompare(b.name, 'tr'));
        let html = "";
        students.forEach(s => {
          const isFav=!!favoritesCache[s.num];
          const prettyName = toTitleCaseTR(s.name);
          html += `
          <div class="studentItem hasDel" id="stu-row-${escAttr(s.num)}">
            <div class="leftGroup">
              <button class="studentNameBtn" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)}</button>
              <button class="starBtn ${isFav ? "" : "off"}"
                      title="${isFav ? "Favoriden çıkar" : "Favoriye ekle"}"
                      data-role="fav"
                      data-num="${escAttr(s.num)}"
                      data-name="${escAttr(prettyName)}"
                      data-sclass="${escAttr(s.sclass)}">${isFav ? "★" : "☆"}</button>
            </div>
            <button class="targetFloat" title="Ders Hedefleri" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
            <button class="delStuFloat"
                    title="Öğrenciyi Sil"
                    aria-label="Öğrenciyi Sil"
                    data-role="delStudent"
                    data-num="${escAttr(s.num)}"
                    data-name="${escAttr(prettyName)}">
              <img class="trashIcon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZWY0NDQ0Ij4KICA8cGF0aCBkPSJNOSAyaDZ2Mmg1djJINFY0aDVWMnptLTMgNmgxMmwtMSAxMmEyIDIgMCAwIDEtMiAySDlhMiAyIDAgMCAxLTItMkw2IDh6bTQgM3Y3aDJ2LTdoLTJ6bTQgMHY3aDJ2LTdoLTJ6Ii8+Cjwvc3ZnPg==" alt="Sil">
            </button>
          </div>`;
        });
        if(myToken === selectClassRenderToken){
          list.innerHTML = html;
        }
      }).catch(err => {
        if(myToken === selectClassRenderToken){
          list.innerHTML = `<div class='empty'>Hata: ${err.message}</div>`;
        }
      });
    }
    /* ============ Favoriler ============ */
    function favPath(){ return currentTeacherId ? `teacherData/${currentTeacherId}/favorites` : null; }
    function listenFavorites(){
      const path=favPath(); if(!path) return;
      if(favRef){ favRef.off(); }
      favRef = db.ref(path);
      favRef.on("value",(snap)=>{
        favoritesCache={}; 
        const list=[];
        snap.forEach(ch=>{ const v=ch.val(); if(v&&v.num){ list.push(v); favoritesCache[v.num]=true; }});
        renderFavorites(list);
        if(activeClassName){ selectClass(activeClassName); }
      });
    }
    document.addEventListener("click",function(e){
      const el = e.target.closest("[data-role]");
      if(!el) return;
      const role = el.dataset.role;
      if(role==="fav"){ const {num,name,sclass}=el.dataset; toggleFavorite(num,name,sclass); }
      if(role==="target"){ const {num,name}=el.dataset; openTargetModal(num,name); }
      if(role==="delStudent"){ const {num,name}=el.dataset; deleteStudent(num,name); }
    });
    function toggleFavorite(num,name,sclass){
      const path=favPath(); if(!path){ setAlert("Öğretmen oturumu yok."); return; }
      const ref=db.ref(path+"/"+num);
      if(favoritesCache[num]) ref.remove().catch(e=>setAlert("Favoriden çıkarma hatası: "+e.message));
      else ref.set({num,name,sclass,createdAt:firebase.database.ServerValue.TIMESTAMP})
              .catch(e=>setAlert("Favoriye ekleme hatası: "+e.message));
    }
    function deleteStudent(num,name){
      if(!confirm(`"${name} (${num})" öğrencisini ve tüm verilerini silmek istiyor musunuz? Bu işlem geri alınamaz!`)) return;
      const updates={}; 
      updates[`students/${num}`]=null;
      db.ref("teacherData").get().then(snap=>{
        if(snap.exists()){ snap.forEach(t=>{ updates[`teacherData/${t.key}/favorites/${num}`]=null; }); }
        return db.ref().update(updates);
      }).then(()=>{
        setAlert("Öğrenci silindi.");
        if(currentDetailNum===num){ currentDetailNum=null; closeReportModal(); }
        if(activeClassName){ selectClass(activeClassName); }
      }).catch(e=>setAlert("Öğrenci silme hatası: "+e.message));
    }
    function renderFavorites(items){
      const box=document.getElementById("favoritesList");
      if(!items || !items.length){ box.innerHTML="<div class='empty'>Henüz favori yok.</div>"; return; }
      const uniqueMap = new Map();
      items.forEach(item => {
        if (item && item.num) uniqueMap.set(String(item.num), item);
      });
      const uniq = Array.from(uniqueMap.values());
      uniq.sort((a,b)=> (a.sclass||"").localeCompare(b.sclass||"") || (a.name||"").localeCompare(b.name||""));
      box.innerHTML = uniq.map(s=>{
        const prettyName = toTitleCaseTR(s.name||"");
        return `
        <div class="studentItem" id="fav-row-${escAttr(s.num)}">
          <div class="leftGroup">
            <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)} – <span style="opacity:.8">${escHTML(s.sclass||'')}</span></button>
            <button class="starBtn" title="Favoriden çıkar" data-role="fav" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}" data-sclass="${escAttr(s.sclass||'')}">★</button>
            <button class="targetBtn" title="Ders Hedefleri" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
          </div>
        </div>
        `;
      }).join("");
    }
    /* ============ Moderasyon ============ */
    const initialBadWords = ["kötü", "çirkin", "argo", "küfür", "lan", "aptal", "salak", "enay", "keriz", "damn", "hell", "bitch"];
    function setupInitialBadWords() {
        const badWordsRef = db.ref('moderation/badWords');
        badWordsRef.get().then(snap => {
            if (!snap.exists() || Object.keys(snap.val()).length === 0) {
                const updates = {};
                initialBadWords.forEach(word => {
                    updates[word.toLowerCase()] = true;
                });
                badWordsRef.set(updates);
            }
        });
    }
    function addBadWord() {
        const input = document.getElementById('newBadWord');
        const word = input.value.trim().toLowerCase();
        if (!word) return;
        const safeWord = word.replace(/[.#$[\]]/g, '_');
        db.ref('moderation/badWords/' + safeWord).set(true).then(() => {
            input.value = '';
            loadModerationData();
        });
    }
    function deleteBadWord(word) {
        if (!confirm(`"${word}" kelimesini silmek istediğinizden emin misiniz?`)) return;
        const safeWord = word.replace(/[.#$[\]]/g, '_');
        db.ref('moderation/badWords/' + safeWord).remove().then(() => {
            loadModerationData();
        });
    }
    function loadModerationData() {
        if (!isModerator()) return;
        const badWordsRef = db.ref('moderation/badWords');
        badWordsRef.get().then(snap => {
            const list = document.getElementById('badWordsList');
            if (!snap.exists()) {
                list.innerHTML = '<div class="empty">Henüz yasaklı kelime yok.</div>';
                return;
            }
            const words = Object.keys(snap.val()).sort();
            list.innerHTML = words.map(word => `
                <div class="chip">
                    ${escHTML(word)}
                    <button class="delBtn" style="padding: 2px 6px; font-size: 12px; line-height: 1;" onclick="deleteBadWord('${escAttr(word)}')">×</button>
                </div>
            `).join('');
        });
        const flaggedRef = db.ref('flaggedMessages');
        flaggedRef.get().then(snap => {
            const list = document.getElementById('flaggedMessagesList');
            if (!snap.exists()) {
                list.innerHTML = '<div class="empty">İncelenecek mesaj yok.</div>';
                return;
            }
            const messages = [];
            snap.forEach(child => {
                const msg = child.val();
                messages.push({ id: child.key, ...msg });
            });
            messages.sort((a, b) => b.timestamp - a.timestamp);
            list.innerHTML = messages.map(msg => `
                <div class="studentItem">
                    <div style="flex:1">
                        <strong>${escHTML(msg.senderName)}:</strong> ${escHTML(msg.message)}
                        <div style="font-size:12px; opacity:.7">${new Date(msg.timestamp).toLocaleString('tr-TR')}</div>
                    </div>
                    <button class="editBtn" onclick="approveMessage('${escAttr(msg.id)}')">Onayla</button>
                    <button class="delBtn" onclick="deleteMessage('${escAttr(msg.id)}')">Sil</button>
                </div>
            `).join('');
        });
    }
    function approveMessage(msgId) {
        db.ref('flaggedMessages/' + msgId).remove();
        loadModerationData();
    }
    function deleteMessage(msgId) {
        if (!confirm('Mesajı silmek istediğinizden emin misiniz?')) return;
        db.ref('flaggedMessages/' + msgId).remove();
        loadModerationData();
    }
    function showTeacherSection(section){
      ["classesSection","favoritesSection","moderationSection"].forEach(id=>{
        document.getElementById(id).style.display = (id===section+"Section") ? "block" : "none";
      });
      document.querySelectorAll("#teacherTopTabs .pill").forEach(b=>b.classList.remove("active"));
      document.getElementById("tab"+section.charAt(0).toUpperCase()+section.slice(1)).classList.add("active");
      if (section === 'moderation') {
          loadModerationData();
      }
    }
    /* ============ Öğretmen Öğrenci Detay ============ */
    function teacherShowStudent(num){
      currentDetailNum=num;
      document.getElementById("teacherStudentDetail").style.display="block";
      document.getElementById("reportOverlay").style.display="block";
      db.ref("students/"+num).get().then(s=>{
        if(!s.exists()){ setAlert("Öğrenci bulunamadı."); return; }
        const name=s.val().name||"";
        const studentName = toTitleCaseTR(name);
        document.getElementById("tsdTitle").textContent=`${studentName} (${num})`;
        currentDetailLessons = s.val().lessons || {};
        window._calCtx = { studentName }; // Reset context for new student
        prepareTeacherReports(currentDetailLessons);
        showReportTab('daily');
      });
    }
    function closeReportModal(){
      document.getElementById("teacherStudentDetail").style.display="none";
      document.getElementById("reportOverlay").style.display="none";
      currentDetailNum=null;
    }
    /* ============ Rapor Sekmeleri ============ */
    function showReportTab(tab){
      ["daily","weekly","monthly"].forEach(t=>{
        const el=document.getElementById("repTab-"+t); if(el) el.style.display = t===tab ? "block" : "none";
        const btn=document.getElementById("repTab"+t.charAt(0).toUpperCase()+t.slice(1)+"Btn");
        if(btn) btn.classList.toggle("active", t===tab);
      });
      // The data is already prepared in teacherShowStudent
    }
    function showStudentTab(tab){
      ["entry","week","month"].forEach(t=>{
        const el=document.getElementById("studentTab-"+t); if(el) el.style.display = t===tab ? "block" : "none";
        const btn=document.getElementById("stuTab"+t.charAt(0).toUpperCase()+t.slice(1)+"Btn");
        if(btn) btn.classList.toggle("active", t===tab);
      });
      // Data is prepared in loadStudentData
    }
    /* ============ Tarih Yardımcıları ============ */
    function parseTRDateStr(str){ const [d,m,y]=String(str).split(".").map(Number); return new Date(y,m-1,d); }
    function formatTR(date){ if(!date || isNaN(date)) return ""; const d=date.getDate(),m=date.getMonth()+1,y=date.getFullYear(); return `${d<10?'0':''}${d}.${m<10?'0':''}${m}.${y}`; }
    function getWeekKey(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const day=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-day); const y=d.getUTCFullYear(); const w=Math.ceil((((d-new Date(Date.UTC(y,0,1)))/864e5)+1)/7); return `${y}-W${w<10?'0':''}${w}`; }
    function getMonthKey(date){ return date.getFullYear()+"-"+(date.getMonth()+1); }
    function weekKeyToRange(key){ const [y,w]=key.split("-W").map(Number); const d=new Date(Date.UTC(y,0,1+(w-1)*7)); const day=d.getUTCDay()||7; const start=new Date(d.getTime()-((day-1)*864e5)); const end=new Date(start.getTime()+(6*864e5)); return {start,end}; }
    function monthKeyToRange(key){ const [y,m]=key.split("-").map(Number); return {start:new Date(y,m-1,1),end:new Date(y,m,0)}; }
    /* ============ Takvim Render ============ */
    function renderCalendar(isTeacher=false) {
        const ctx = window._calCtx; if (!ctx) return;
        const boxId = isTeacher ? "tsdDays" : "calendarWrap";
        const box = document.getElementById(boxId);
        if(!box) return;
        const today = new Date();
        const firstDay = new Date(ctx.viewMonthStart.getFullYear(), ctx.viewMonthStart.getMonth(), 1);
        const lastDay = new Date(ctx.viewMonthStart.getFullYear(), ctx.viewMonthStart.getMonth() + 1, 0);
        const startCell = new Date(firstDay); startCell.setDate(firstDay.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
        let html = `<div class="calHeader">
            <div class="calTitle">${firstDay.toLocaleDateString("tr-TR",{month:"long",year:"numeric"})}</div>
            <div class="calNav">
                <button class="calBtn" onclick="calNavigate(-1, ${isTeacher})">←</button>
                <button class="calBtnToday" onclick="calGoToday(${isTeacher})">Bugün</button>
                <button class="calBtn" onclick="calNavigate(1, ${isTeacher})">→</button>
            </div>
        </div>
        <div class="calGrid">
            <div class="calWd">Pzt</div><div class="calWd">Sal</div><div class="calWd">Çar</div><div class="calWd">Per</div><div class="calWd">Cum</div><div class="calWd">Cmt</div><div class="calWd">Paz</div>`;
        let d = new Date(startCell);
        for(let i=0; i<42; i++) {
            const dayStr = formatTR(d);
            const isToday = formatTR(d) === formatTR(today);
            const isSelected = formatTR(d) === formatTR(ctx.selectedDate);
            const hasData = ctx.hasSet.has(dayStr);
            const isMuted = d.getMonth() !== firstDay.getMonth();
            const clickFn = isTeacher ? `calSelectTeacherDate('${dayStr}')` : `calSelectStudentDate('${dayStr}')`;
            html += `<div class="calCell ${isMuted ? "muted" : ""} ${isToday ? "today" : ""} ${isSelected ? "selected" : ""}" onclick="${clickFn}">
                <span class="calDay">${d.getDate()}</span>
                ${hasData ? '<div class="calDot"></div>' : ''}
            </div>`;
            d.setDate(d.getDate() + 1);
        }
        html += `</div>`;
        box.innerHTML = html;
    }
    function renderStudentCalendar() { renderCalendar(false); }
    function renderTeacherCalendar() { renderCalendar(true); }
    function calNavigate(dir, isTeacher) {
        window._calCtx.viewMonthStart.setMonth(window._calCtx.viewMonthStart.getMonth() + dir);
        if(isTeacher) renderTeacherCalendar(); else renderStudentCalendar();
    }
    function calGoToday(isTeacher) {
        const today = new Date();
        window._calCtx.selectedDate = today;
        window._calCtx.viewMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        if(isTeacher) renderTeacherCalendar(); else renderStudentCalendar();
        const dayStr = formatTR(today);
        const tableElId = isTeacher ? "tsdDayTable" : "stuDayTable";
        const tableEl = document.getElementById(tableElId);
        if (window._calCtx.grouped[dayStr]) {
            if(isTeacher) renderTeacherDayTable(dayStr); else showDay(dayStr);
        } else {
            tableEl.innerHTML = "<div class='empty'>Bugün için veri yok.</div>";
        }
    }
    function calSelectStudentDate(dayStr) {
        window._calCtx.selectedDate = parseTRDateStr(dayStr);
        renderStudentCalendar();
        if(window._calCtx.grouped[dayStr]) showDay(dayStr);
        else document.getElementById("stuDayTable").innerHTML = `<div class='empty'>${dayStr} için veri yok.</div>`;
    }
    function calSelectTeacherDate(dayStr) {
        window._calCtx.selectedDate = parseTRDateStr(dayStr);
        renderTeacherCalendar();
        renderTeacherDayTable(dayStr);
    }
    /* ============ Rapor Hazırlama ve Görüntüleme ============ */
    function processLessonData(lessons) {
        const weekMap = {}, monthMap = {}, dayMap = {};
        if(lessons) {
            for(const lesson in lessons) {
                for(const key in lessons[lesson]) {
                    const e = lessons[lesson][key];
                    const date = parseTRDateStr((e.time||"").split(" ")[0]);
                    if(isNaN(date)) continue;
                    const weekKey = getWeekKey(date);
                    const monthKey = getMonthKey(date);
                    const dayKey = formatTR(date);
                    if(!weekMap[weekKey]) weekMap[weekKey] = {};
                    if(!weekMap[weekKey][lesson]) weekMap[weekKey][lesson] = 0;
                    weekMap[weekKey][lesson] += Number(e.count)||0;
                    if(!monthMap[monthKey]) monthMap[monthKey] = {};
                    if(!monthMap[monthKey][lesson]) monthMap[monthKey][lesson] = 0;
                    monthMap[monthKey][lesson] += Number(e.count)||0;
                    if(!dayMap[dayKey]) dayMap[dayKey] = {};
                    if(!dayMap[dayKey][lesson]) dayMap[dayKey][lesson] = 0;
                    dayMap[dayKey][lesson] += Number(e.count)||0;
                }
            }
        }
        return { weekMap, monthMap, dayMap };
    }
    function prepareStudentReports(lessons) {
        const { weekMap, monthMap } = processLessonData(lessons);
        // Haftalık seçenekler
        const weekKeys = Object.keys(weekMap).sort().reverse();
        _stuWeeks = weekKeys;
        const weekSel = document.getElementById("stuWeekSelect");
        weekSel.innerHTML = "";
        weekKeys.forEach(wk=>{
            const {start,end}=weekKeyToRange(wk);
            // DÜZELTME: Tarih formatı "12 Haziran - 19 Haziran 2025" gibi
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const startStr = `${start.getDate()} ${monthNames[start.getMonth()]}`;
            const endStr = `${end.getDate()} ${monthNames[end.getMonth()]} ${end.getFullYear()}`;
            const label = `${startStr} - ${endStr}`;
            const o = document.createElement("option"); o.value = wk; o.textContent = label; weekSel.add(o);
        });
        if(weekKeys.length) selectStuWeek(weekKeys[0]);
        // Aylık seçenekler
        const monthKeys = Object.keys(monthMap).sort().reverse();
        _stuMonths = monthKeys;
        const monthSel = document.getElementById("stuMonthSelect");
        monthSel.innerHTML = "";
        monthKeys.forEach(mk=>{
            const [y,m] = mk.split("-").map(Number);
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const label = `${monthNames[m-1]} ${y}`;
            const o = document.createElement("option"); o.value = mk; o.textContent = label; monthSel.add(o);
        });
        if(monthKeys.length) selectStuMonth(monthKeys[0]);
    }
    function prepareTeacherReports(lessons) {
        const { weekMap, monthMap, dayMap } = processLessonData(lessons);
        // Günlük rapor
        const days = Object.keys(dayMap).sort((a,b)=>parseTRDateStr(b)-parseTRDateStr(a));
        const latestDay = days.length ? days[0] : formatTR(new Date());
        window._calCtx.grouped = dayMap;
        window._calCtx.selectedDate = parseTRDateStr(latestDay);
        window._calCtx.viewMonthStart = new Date(window._calCtx.selectedDate.getFullYear(), window._calCtx.selectedDate.getMonth(), 1);
        window._calCtx.hasSet = new Set(days);
        renderTeacherCalendar();
        renderTeacherDayTable(latestDay);
        // Haftalık rapor
        const weekKeys = Object.keys(weekMap).sort().reverse();
        currentWeeks = weekKeys;
        const weekSel = document.getElementById("teacherWeekSelect");
        weekSel.innerHTML = "";
        weekKeys.forEach(wk=>{
            const {start,end}=weekKeyToRange(wk);
            // DÜZELTME: Tarih formatı "12 Haziran - 19 Haziran 2025" gibi
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const startStr = `${start.getDate()} ${monthNames[start.getMonth()]}`;
            const endStr = `${end.getDate()} ${monthNames[end.getMonth()]} ${end.getFullYear()}`;
            const label = `${startStr} - ${endStr}`;
            const o = document.createElement("option"); o.value = wk; o.textContent = label; weekSel.add(o);
        });
        if(weekKeys.length) selectTeacherWeek(weekKeys[0]);
        // Aylık rapor
        const monthKeys = Object.keys(monthMap).sort().reverse();
        const monthSel = document.getElementById("tMonthSelect");
        if (monthSel) {
            monthSel.innerHTML = "";
            monthKeys.forEach(mk=>{
                const [y,m] = mk.split("-").map(Number);
                const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                const label = `${monthNames[m-1]} ${y}`;
                const o = document.createElement("option"); o.value = mk; o.textContent = label; monthSel.add(o);
            });
            if(monthKeys.length) selectTeacherMonth(monthKeys[0]);
        }
    }
    function renderTeacherDayTable(day) {
        const detailsObj = (window._calCtx.grouped && window._calCtx.grouped[day]) ? window._calCtx.grouped[day] : {};
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        let html = "<table><thead><tr><th>Ders</th><th>O Gün Toplam</th></tr></thead><tbody>";
        dersSirasi.forEach(lesson=>{
            const total = detailsObj[lesson] || 0;
            html += `<tr><td>${escHTML(lesson)}</td><td>${total}</td></tr>`;
        });
        html += "</tbody></table>";
        const totals = dersSirasi.map(lesson => detailsObj[lesson] || 0);
        const totalSum = totals.reduce((a,b)=>a+b,0);
        html += `<div class='sectionTitle' style='margin-top:10px'>Toplam: ${totalSum} soru</div>`;
        document.getElementById("tsdDayTable").innerHTML = html;
        document.getElementById("tsdTotals").innerHTML = `<div class='exportCard'>${renderTotals(detailsObj)}</div>`;
    }
    function renderTotals(detailsObj) {
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        let html = "<table style='width:100%'><thead><tr><th>Ders</th><th>Toplam</th></tr></thead><tbody>";
        dersSirasi.forEach(lesson=>{
            const total = detailsObj[lesson] || 0;
            html += `<tr><td>${escHTML(lesson)}</td><td>${total}</td></tr>`;
        });
        html += "</tbody></table>";
        return html;
    }
    /* ============ DÜZELTME: Grafikleri sütun grafiğe çevirme ve tarih formatlarını güncelleme ============ */
    function selectStuWeek(wk) {
        if(!_stuWeeks.includes(wk)) return;
        db.ref("students/"+currentStudent+"/lessons").get().then(snap=>{
            const data = snap.exists() ? snap.val() : {};
            const { weekMap } = processLessonData(data);
            const weekData = weekMap[wk] || {};
            const {start,end} = weekKeyToRange(wk);
            // DÜZELTME: Tarih formatı "12 Haziran - 19 Haziran 2025" gibi
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const startStr = `${start.getDate()} ${monthNames[start.getMonth()]}`;
            const endStr = `${end.getDate()} ${monthNames[end.getMonth()]} ${end.getFullYear()}`;
            const title = `${startStr} - ${endStr}`;
            const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
            const counts = dersSirasi.map(lesson => weekData[lesson] || 0);
            const ctx = document.getElementById("stuWeekChart").getContext("2d");
            if(stuWeekChart) stuWeekChart.destroy();
            // DÜZELTME: Çizgi grafik yerine sütun grafik
            stuWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dersSirasi,
                    datasets: [{
                        label: 'Haftalık Toplam',
                        data: counts,
                        backgroundColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                        borderColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title, color: '#e2e8f0', font: { size: 16, weight: 'bold' } },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
            document.getElementById("stuWeekMatrix").innerHTML = `<div class='sectionTitle'>Haftalık Toplam (${title})</div>` + renderTotals(weekData);
        });
    }
    function selectStuMonth(mk) {
        if(!_stuMonths.includes(mk)) return;
        db.ref("students/"+currentStudent+"/lessons").get().then(snap=>{
            const data = snap.exists() ? snap.val() : {};
            const { monthMap } = processLessonData(data);
            const monthData = monthMap[mk] || {};
            const [y,m] = mk.split("-").map(Number);
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const title = `${monthNames[m-1]} ${y}`;
            const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
            const counts = dersSirasi.map(lesson => monthData[lesson] || 0);
            const ctx = document.getElementById("stuMonthChart").getContext("2d");
            if(stuMonthChart) stuMonthChart.destroy();
            // DÜZELTME: Çizgi grafik yerine sütun grafik
            stuMonthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dersSirasi,
                    datasets: [{
                        label: 'Aylık Toplam',
                        data: counts,
                        backgroundColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                        borderColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title, color: '#e2e8f0', font: { size: 16, weight: 'bold' } },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
            document.getElementById("stuMonthTotals").innerHTML = `<div class='sectionTitle'>Aylık Toplam (${title})</div>` + renderTotals(monthData);
        });
    }
    function selectTeacherWeek(wk) {
        selectedWeekKey = wk;
        if(!currentDetailLessons) return;
        const { weekMap } = processLessonData(currentDetailLessons);
        const weekData = weekMap[wk] || {};
        const {start,end} = weekKeyToRange(wk);
        // DÜZELTME: Tarih formatı "12 Haziran - 19 Haziran 2025" gibi
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const startStr = `${start.getDate()} ${monthNames[start.getMonth()]}`;
        const endStr = `${end.getDate()} ${monthNames[end.getMonth()]} ${end.getFullYear()}`;
        const title = `${startStr} - ${endStr}`;
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        const counts = dersSirasi.map(lesson => weekData[lesson] || 0);
        const ctx = document.getElementById("weekChart").getContext("2d");
        if(weekChart) weekChart.destroy();
        // DÜZELTME: Çizgi grafik yerine sütun grafik
        weekChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dersSirasi,
                datasets: [{
                    label: 'Haftalık Toplam',
                    data: counts,
                    backgroundColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                    borderColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: title, color: '#e2e8f0', font: { size: 16, weight: 'bold' } },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        });
        document.getElementById("weekMatrix").innerHTML = `<div class='sectionTitle'>Haftalık Toplam (${title})</div>` + renderTotals(weekData);
        document.getElementById("btnExportPDF").disabled = false;
    }
    function selectTeacherMonth(mk) {
        if(!currentDetailLessons) return;
        const { monthMap } = processLessonData(currentDetailLessons);
        const monthData = monthMap[mk] || {};
        const [y,m] = mk.split("-").map(Number);
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const title = `${monthNames[m-1]} ${y}`;
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        const counts = dersSirasi.map(lesson => monthData[lesson] || 0);
        const ctx = document.getElementById("tMonthChart").getContext("2d");
        if(tMonthChart) tMonthChart.destroy();
        // DÜZELTME: Çizgi grafik yerine sütun grafik
        tMonthChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dersSirasi,
                datasets: [{
                    label: 'Aylık Toplam',
                    data: counts,
                    backgroundColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                    borderColor: ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: title, color: '#e2e8f0', font: { size: 16, weight: 'bold' } },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        });
        document.getElementById("tMonthTotals").innerHTML = `<div class='sectionTitle'>Aylık Toplam (${title})</div>` + renderTotals(monthData);
    }
    /* ============ YENİ & GÜNCELLENMİŞ: PDF Dışa Aktarma Fonksiyonları ============ */
    function openPdfExportMenu() {
        if (!selectedWeekKey) {
            setAlert("Lütfen önce bir hafta seçin.");
            return;
        }
        const isStudentView = !!currentDetailNum;
        const isClassView = !!activeClassName;

        document.querySelector('input[name="exportScope"][value="student"]').disabled = !isStudentView;
        document.querySelector('input[name="exportScope"][value="class"]').disabled = !isClassView;

        if (isClassView && !isStudentView) {
            document.querySelector('input[name="exportScope"][value="class"]').checked = true;
        } else {
            document.querySelector('input[name="exportScope"][value="student"]').checked = true;
        }

        document.getElementById('pdfExportModalOverlay').style.display = 'block';
        document.getElementById('pdfExportModal').style.display = 'block';

        const scopeRadios = document.querySelectorAll('input[name="exportScope"]');
        const lessonOptions = document.getElementById('pdfLessonOptions');
        const handleScopeChange = () => {
            if (document.querySelector('input[name="exportScope"]:checked').value === 'class') {
                lessonOptions.style.display = 'block';
            } else {
                lessonOptions.style.display = 'none';
            }
        };
        scopeRadios.forEach(radio => radio.onchange = handleScopeChange);
        handleScopeChange();

        const lessonScopeRadios = document.querySelectorAll('input[name="lessonScope"]');
        const lessonSelect = document.getElementById('pdfLessonSelect');
        const handleLessonScopeChange = () => {
             if (document.querySelector('input[name="lessonScope"]:checked').value === 'single') {
                lessonSelect.style.display = 'block';
            } else {
                lessonSelect.style.display = 'none';
            }
        }
        lessonScopeRadios.forEach(radio => radio.onchange = handleLessonScopeChange);
        handleLessonScopeChange();

        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        lessonSelect.innerHTML = dersSirasi.map(ders => `<option value="${ders}">${ders}</option>`).join('');
    }

    function closePdfExportMenu() {
        document.getElementById('pdfExportModalOverlay').style.display = 'none';
        document.getElementById('pdfExportModal').style.display = 'none';
    }

    function startPdfExport() {
        const scope = document.querySelector('input[name="exportScope"]:checked').value;
        if (scope === 'student') {
            exportSingleStudentPDF();
        } else if (scope === 'class') {
            const lessonScope = document.querySelector('input[name="lessonScope"]:checked').value;
            const selectedLesson = document.getElementById('pdfLessonSelect').value;
            exportClassReportPDF(lessonScope, selectedLesson);
        }
        closePdfExportMenu();
    }

    async function exportSingleStudentPDF() {
        if (!selectedWeekKey || !currentDetailNum) return;
        
        const titleEl = document.getElementById("tsdTitle");
        const studentNameFromTitle = titleEl ? titleEl.textContent : `Öğrenci ${currentDetailNum}`;
        const { start, end } = weekKeyToRange(selectedWeekKey);
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const startStr = `${start.getDate()} ${monthNames[start.getMonth()]}`;
        const endStr = `${end.getDate()} ${monthNames[end.getMonth()]} ${end.getFullYear()}`;
        const rangeStr = `${startStr} - ${endStr}`;

        document.getElementById("exportRange").textContent = rangeStr;
        document.getElementById("exportStudent").textContent = studentNameFromTitle;
        document.getElementById("exportTitle").textContent = "Haftalık Gelişim Raporu";

        const { weekMap } = processLessonData(currentDetailLessons);
        const weekData = weekMap[selectedWeekKey] || {};
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        let html = "<table><thead><tr><th>Ders</th><th>Haftalık Toplam</th></tr></thead><tbody>";
        dersSirasi.forEach(lesson => {
            const total = weekData[lesson] || 0;
            html += `<tr><td>${escHTML(lesson)}</td><td>${total}</td></tr>`;
        });
        html += "</tbody></table>";
        document.getElementById("exportTable").innerHTML = html;

        const elem = document.getElementById("exportArea");
        elem.classList.add('light-theme');

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const canvas = await html2canvas(elem, { scale: 2, useCORS: true, allowTaint: true });
            const imgData = canvas.toDataURL("image/png");
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
            doc.save(`Haftalik_Rapor_${currentDetailNum}_${selectedWeekKey}.pdf`);
        } catch (error) {
            console.error("PDF oluşturma hatası:", error);
            setAlert("PDF oluşturulurken bir hata oluştu.");
        } finally {
            elem.classList.remove('light-theme');
        }
    }

    async function exportClassReportPDF(lessonScope = 'all', singleLesson = '') {
        if (!selectedWeekKey || !activeClassName) {
            setAlert("Lütfen önce bir sınıf ve hafta seçin.");
            return;
        }
        setAlert("Sınıf raporu hazırlanıyor, lütfen bekleyin...");

        try {
            const studentSnap = await db.ref("students").orderByChild("sclass").equalTo(activeClassName).get();
            if (!studentSnap.exists()) {
                setAlert("Bu sınıfta öğrenci bulunamadı.");
                return;
            }

            const students = [];
            studentSnap.forEach(ch => {
                const s = ch.val();
                if (s && s.num) students.push({ name: s.name || '', num: String(s.num) });
            });
            students.sort((a, b) => a.name.localeCompare(b.name, 'tr'));

            const lessonPromises = students.map(s => db.ref(`students/${s.num}/lessons`).get());
            const lessonSnaps = await Promise.all(lessonPromises);

            const { start, end } = weekKeyToRange(selectedWeekKey);
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const startStr = `${start.getDate()} ${monthNames[start.getMonth()]}`;
            const endStr = `${end.getDate()} ${monthNames[end.getMonth()]} ${end.getFullYear()}`;
            const rangeStr = `${startStr} - ${endStr}`;
            
            const dersSirasi = (lessonScope === 'single' && singleLesson) ? [singleLesson] : ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
            
            let fullHtml = "<table><thead><tr><th>Öğrenci</th>";
            dersSirasi.forEach(lesson => {
                fullHtml += `<th>${escHTML(lesson)}</th>`;
            });
            if (lessonScope === 'all') {
                fullHtml += `<th>TOPLAM</th>`;
            }
            fullHtml += "</tr></thead><tbody>";

            const classTotals = {};
            dersSirasi.forEach(l => classTotals[l] = 0);
            let grandTotal = 0;

            lessonSnaps.forEach((lessonSnap, index) => {
                const student = students[index];
                const lessons = lessonSnap.exists() ? lessonSnap.val() : {};
                const { weekMap } = processLessonData(lessons);
                const weekData = weekMap[selectedWeekKey] || {};
                
                fullHtml += `<tr><td>${toTitleCaseTR(student.name)} (${student.num})</td>`;
                
                let studentTotal = 0;
                dersSirasi.forEach(lesson => {
                    const total = weekData[lesson] || 0;
                    studentTotal += total;
                    classTotals[lesson] += total;
                    fullHtml += `<td>${total}</td>`;
                });

                if (lessonScope === 'all') {
                    fullHtml += `<td><strong>${studentTotal}</strong></td>`;
                    grandTotal += studentTotal;
                }
                fullHtml += `</tr>`;
            });
            
            fullHtml += `</tbody>`;

            if (students.length > 1 && lessonScope === 'all') {
                fullHtml += `<tfoot><tr style="font-weight:bold; border-top: 2px solid #ccc;"><td>Sınıf Toplamı</td>`;
                dersSirasi.forEach(lesson => {
                    fullHtml += `<td>${classTotals[lesson]}</td>`;
                });
                fullHtml += `<td>${grandTotal}</td>`;
                fullHtml += `</tr></tfoot>`;
            }

            fullHtml += `</table>`;
            
            const exportContentDiv = document.getElementById("exportTable");
            exportContentDiv.innerHTML = fullHtml;
            document.getElementById("exportRange").textContent = rangeStr;
            document.getElementById("exportTitle").textContent = `${activeClassName} Sınıfı Haftalık Raporu`;
            document.getElementById("exportStudent").textContent = "";

            const elem = document.getElementById("exportArea");
            elem.classList.add('light-theme');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            const canvas = await html2canvas(elem, {
                scale: 2,
                useCORS: true,
                allowTaint: true
            });

            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
            let heightLeft = imgHeight;
            let position = 0;

            doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;

            while (heightLeft > 0) {
                position -= pdfHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            doc.save(`Sinif_Raporu_${activeClassName.replace('/', '-')}_${selectedWeekKey}.pdf`);

        } catch (error) {
            console.error("Sınıf raporu oluşturma hatası:", error);
            setAlert("Sınıf raporu oluşturulurken bir hata oluştu.");
        } finally {
            // Cleanup
            const elem = document.getElementById("exportArea");
            elem.classList.remove('light-theme');
            document.getElementById("exportTitle").textContent = "Haftalık Gelişim Raporu";
            document.getElementById("exportTable").innerHTML = "";
            document.getElementById("exportStudent").textContent = "";
        }
    }
    /* ============ Hedef Yönetimi ============ */
    function openTargetModal(num, name) {
        currentTargetStudent = num;
        currentTargetStudentName = name;
        document.getElementById("targetModalTitle").textContent = `${toTitleCaseTR(name)} (${num}) - Ders Hedefleri`;
        const modal = document.getElementById("targetModal");
        const overlay = document.getElementById("targetModalOverlay");
        modal.style.display = "block";
        overlay.style.display = "block";
        db.ref(`targets/${num}`).get().then(snap => {
            const goals = snap.exists() ? snap.val() : {};
            const lessons = ["Turkce", "Sosyal", "Din", "Ingilizce", "Matematik", "Fen"];
            lessons.forEach(lesson => {
                const input = document.getElementById(`modal-goal-${lesson}`);
                if (input) input.value = goals[lesson] || "";
            });
        });
    }
    function closeTargetModal() {
        document.getElementById("targetModal").style.display = "none";
        document.getElementById("targetModalOverlay").style.display = "none";
        currentTargetStudent = null;
        currentTargetStudentName = null;
    }
    function saveTargetGoals() {
        if (!currentTargetStudent) {
            setAlert("Hedef kaydedilecek öğrenci seçili değil.");
            return;
        }
        const lessons = ["Turkce", "Sosyal", "Din", "Ingilizce", "Matematik", "Fen"];
        const updates = {};
        let hasData = false;
        lessons.forEach(lesson => {
            const input = document.getElementById(`modal-goal-${lesson}`);
            if (input) {
                const value = parseInt(input.value, 10);
                if (!isNaN(value) && value > 0) {
                    updates[lesson] = value;
                    hasData = true;
                } else {
                    updates[lesson] = null; // Değeri olmayan veya 0 olan hedefleri sil
                }
            }
        });

        // Eğer tüm alanlar boşsa, öğrencinin hedeflerini tamamen sil
        const ref = db.ref(`targets/${currentTargetStudent}`);
        const promise = hasData ? ref.update(updates) : ref.remove();

        promise.then(() => {
            setAlert("Hedefler kaydedildi.");
            closeTargetModal();
        }).catch(e => {
            setAlert("Hata: " + e.message);
            console.error("Hedef kaydetme hatası:", e);
        });
    }
    function loadStudentTarget() {
        if (!currentStudent) return;
        db.ref(`targets/${currentStudent}`).get().then(snap => {
            const goals = snap.exists() ? snap.val() : {};
            setStudentTargetInfo(goals);
            applyTargetsToEntryPage(goals);
        });
    }
    function setStudentTargetInfo(goals) {
        const infoEl = document.getElementById("studentTargetInfo");
        const valueEl = document.getElementById("studentTargetValue");
        if (!infoEl || !valueEl) return;
        const lessons = ["Turkce", "Sosyal", "Din", "Ingilizce", "Matematik", "Fen"];
        const total = lessons.reduce((sum, lesson) => sum + (parseInt(goals[lesson]) || 0), 0);
        if (total > 0) {
            valueEl.textContent = total;
            infoEl.style.display = "flex";
        } else {
            infoEl.style.display = "none";
        }
    }
    function applyTargetsToEntryPage(goals) {
        const lessons = ["Turkce", "Sosyal", "Din", "Ingilizce", "Matematik", "Fen"];
        lessons.forEach(lesson => {
            const input = document.getElementById(`goal-${lesson}`);
            if (input && goals[lesson]) {
                input.value = goals[lesson];
            }
        });
    }
    function saveGoalsFromEntryPage() {
        if (!currentStudent) return;
        const lessons = ["Turkce", "Sosyal", "Din", "Ingilizce", "Matematik", "Fen"];
        const updates = {};
        lessons.forEach(lesson => {
            const input = document.getElementById(`goal-${lesson}`);
            const value = parseInt(input.value, 10);
            if (!isNaN(value) && value > 0) {
                updates[lesson] = value;
            }
        });
        db.ref(`targets/${currentStudent}`).update(updates).then(() => {
            setAlert("Hedefler kaydedildi.");
            loadStudentTarget();
        }).catch(e => setAlert("Hata: " + e.message));
    }
    function openTargetForCurrent() {
        if (!currentStudent || !currentStudentName) return;
        openTargetModal(currentStudent, currentStudentName);
    }
    function loadLessonGoals() {
        if (!currentStudent) return;
        db.ref(`targets/${currentStudent}`).get().then(snap => {
            const goals = snap.exists() ? snap.val() : {};
            applyTargetsToEntryPage(goals);
        });
    }
    /* ============ Chart Destroy ============ */
    function destroyAllCharts() {
        [stuWeekChart, stuMonthChart, weekChart, tMonthChart].forEach(ch => { if(ch) ch.destroy(); });
        stuWeekChart = stuMonthChart = weekChart = tMonthChart = null;
    }
    /* ============ UI Rol Ayarları ============ */
    function applyRoleUi() {
        const role = window.activeRole;
        const isStudent = role === 'student';
        const isParent = role === 'parent';
        const entryTab = document.getElementById('stuTabEntryBtn');
        const weekTab = document.getElementById('stuTabWeekBtn');
        const monthTab = document.getElementById('stuTabMonthBtn');
        const panelTitle = document.getElementById('studentPanelTitle');
        const toolbarTitle = document.getElementById('studentPanelToolbarTitle');
        const welcomeBanner = document.getElementById('studentWelcome');
        if (isStudent) {
            if(entryTab) entryTab.style.display = 'inline-flex';
            if(weekTab) weekTab.style.display = 'inline-flex';
            if(monthTab) monthTab.style.display = 'inline-flex';
            if(panelTitle) panelTitle.textContent = 'Öğrenci Paneli';
            if(toolbarTitle) toolbarTitle.textContent = 'Öğrenci Paneli';
            if(welcomeBanner) {
                welcomeBanner.textContent = `Hoş geldin, ${toTitleCaseTR(currentStudentName || '')}!`;
                welcomeBanner.style.display = 'block';
            }
        } else if (isParent) {
            if(entryTab) entryTab.style.display = 'none';
            if(weekTab) weekTab.style.display = 'inline-flex';
            if(monthTab) monthTab.style.display = 'inline-flex';
            if(panelTitle) panelTitle.textContent = 'Veli Paneli';
            if(toolbarTitle) toolbarTitle.textContent = 'Veli Paneli';
            if(welcomeBanner) {
                welcomeBanner.textContent = `Hoş geldiniz, ${toTitleCaseTR(currentStudentName || '')} velisi!`;
                welcomeBanner.style.display = 'block';
            }
        }
    }
    function setWelcomeStudentBanner() {
        const banner = document.getElementById('studentWelcome');
        if (banner && currentStudentName) {
            banner.textContent = `Hoş geldin, ${toTitleCaseTR(currentStudentName)}!`;
            banner.style.display = 'block';
        }
    }
    function exitToHome() {
        document.getElementById('roleChoice').style.display = 'none';
        showTab('studentLogin');
    }
    /* ============ Sohbet Sistemi ============ */
    function openChatPopup() {
        document.getElementById('chatPopup').style.display = 'flex';
        loadChatMessages();
        loadOnlineUsers();
    }
    function closeChatPopup() {
        document.getElementById('chatPopup').style.display = 'none';
    }
    function loadChatMessages() {
        if (chatListenerActive) return;
        chatListenerActive = true;
        db.ref('chat').orderByChild('timestamp').limitToLast(50).on('value', snap => {
            const messages = [];
            snap.forEach(child => {
                const msg = child.val();
                messages.push({ id: child.key, ...msg });
            });
            messages.sort((a, b) => a.timestamp - b.timestamp);
            const container = document.getElementById('chatPopupMessages');
            container.innerHTML = messages.map(msg => `
                <div>
                    <strong>${escHTML(msg.senderName)}:</strong> ${escHTML(msg.message)}
                    <div style="font-size:11px; opacity:.7">${new Date(msg.timestamp).toLocaleString('tr-TR')}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        });
    }
    function loadOnlineUsers() {
        if (onlineUsersListener) return;
        onlineUsersListener = db.ref('status').on('value', snap => {
            const users = [];
            snap.forEach(child => {
                const user = child.val();
                if (user.state === 'online' && user.name) {
                    users.push(user.name);
                }
            });
            const el = document.getElementById('chatPopupOnlineUsers');
            el.innerHTML = `<strong>Çevrimiçi:</strong> ${users.length ? users.join(', ') : 'Kimse yok'}`;
        });
    }
    function sendPopupMessage() {
        const input = document.getElementById('chatPopupInput');
        const message = input.value.trim();
        if (!message) return;
        const senderName = currentStudentName || currentTeacherName;
        if (!senderName) {
            setAlert('Mesaj göndermek için giriş yapmalısınız.');
            return;
        }
        const userId = currentStudent || currentTeacherId;
        const newMessage = {
            message: message,
            senderName: senderName,
            senderId: userId,
            timestamp: Date.now()
        };
        // Check for bad words if moderator
        if (isModerator()) {
            db.ref('moderation/badWords').get().then(snap => {
                if (snap.exists()) {
                    const badWords = Object.keys(snap.val());
                    const hasBadWord = badWords.some(word => 
                        message.toLowerCase().includes(word.toLowerCase())
                    );
                    if (hasBadWord) {
                        db.ref('flaggedMessages').push(newMessage);
                        setAlert('Mesajınız yasaklı kelime içerdiği için incelenmek üzere işaretlendi.');
                        return;
                    }
                }
                db.ref('chat').push(newMessage);
            });
        } else {
            db.ref('chat').push(newMessage);
        }
        input.value = '';
    }
    /* ============ Çevrimiçi Durum ============ */
    function setupPresence() {
        const userId = currentStudent || currentTeacherId;
        const userName = currentStudentName || currentTeacherName;
        if (!userId || !userName) return;
        const userStatusRef = db.ref('status/' + userId);
        const connectedRef = db.ref('.info/connected');
        connectedRef.on('value', snap => {
            if (snap.val() === true) {
                userStatusRef.set({
                    state: 'online',
                    name: userName,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
                userStatusRef.onDisconnect().set({
                    state: 'offline',
                    name: userName,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
    }
    /* ============ Bildirim Sistemi ============ */
    function listenForNotifications() {
        if (!currentStudent) return;
        if (notificationListener) notificationListener.off();
        notificationListener = db.ref(`notifications/${currentStudent}`).orderByChild('timestamp').limitToLast(10).on('value', snap => {
            if (!snap.exists()) return;
            const notifications = [];
            snap.forEach(child => {
                const notif = child.val();
                notifications.push({ id: child.key, ...notif });
            });
            notifications.sort((a, b) => b.timestamp - a.timestamp);
            notifications.forEach(notif => {
                if (!notif.read) {
                    showNotificationPopup(notif.message);
                    db.ref(`notifications/${currentStudent}/${notif.id}/read`).set(true);
                }
            });
        });
    }
    function showNotificationPopup(message) {
        const overlay = document.getElementById('notificationOverlay');
        const messageEl = document.getElementById('notificationMessage');
        if (overlay && messageEl) {
            messageEl.textContent = message;
            overlay.style.display = 'flex';
        }
    }
    function closeNotificationPopup() {
        document.getElementById('notificationOverlay').style.display = 'none';
    }
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadClassesForRegistration();
        try {
            const remembered = localStorage.getItem('rememberedStudent');
            if (remembered) {
                const { num, pass } = JSON.parse(remembered);
                if (num && pass) {
                    db.ref("students/"+num).get().then(snap=>{
                        if(snap.exists() && snap.val().pass===pass){
                            currentStudent = num;
                            showRoleChoice(snap.val());
                        } else {
                            localStorage.removeItem('rememberedStudent');
                        }
                    }).catch(() => {
                        localStorage.removeItem('rememberedStudent');
                    });
                }
            }
        } catch(e) {
            try { localStorage.removeItem('rememberedStudent'); } catch(e2){}
        }
        // Setup number buttons
        setTimeout(() => {
            setupNumberButtons();
        }, 500);
        // Add event listener for form reset
        const form = document.getElementById('lessonForm');
        if (form) {
            form.addEventListener('reset', function() {
                // Reset progress bars and totals
                setTimeout(() => {
                    ['Turkce', 'Sosyal', 'Din', 'Ingilizce', 'Matematik', 'Fen'].forEach(lesson => {
                        updateProgress(lesson);
                    });
                    updateGlobalTotal();
                }, 100);
            });
        }
    });
</script>
</body>
</html>

