<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ÖĞRENCİ TAKİP PROGRAMI</title>
<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2canvas & jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
    :root{
      --bg:#0f172a; --panel:#1e293b; --muted:#334155; --text:#e2e8f0;
      --accent1:#3b82f6; --accent2:#06b6d4; --warn:#f97316; --ok:#10b981; --danger:#ef4444;
      --export-bg:#0b1427; --export-head:#93c5fd;
      --card:#0b1427; --cardBorder:#263247;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .header{padding:22px;text-align:center;}
    .main-title{font-size:22px;font-weight:800;color:#93c5fd;text-transform:uppercase}
    .subtitle{font-size:16px;font-weight:500;color:#a5b4fc;margin-top:4px}
    .subheader{font-size:16px;color:#cbd5e1;margin-top:4px;font-weight:600;}

    .tabs{display:flex;gap:8px;justify-content:center;max-width:1080px;margin:0 auto 12px;padding:8px;background:var(--panel);border-radius:12px;flex-wrap:wrap}
    .tabs button{flex:1;min-width:160px;padding:12px;border:0;border-radius:10px;background:transparent;color:#cbd5e1;font-weight:700;cursor:pointer}
    .tabs button.active{background:var(--ok);color:#fff}

    .tabs button:focus,
    .pill:focus,
    .classPick:focus,
    .dayBtn:focus,
    .weekBtn:focus,
    .studentNameBtn:focus,
    .delStuBtn:focus,
    .delStuFloat:focus,
    .delFloat:focus,
    button.action:focus{
      outline:3px solid rgba(16,185,129,.55);
      outline-offset:2px;
    }

    .container{max-width:1080px;margin:16px auto;background:var(--panel);border-radius:16px;padding:22px}
    h3{margin:0 0 14px}
    input,select{width:100%;padding:12px;border:0;border-radius:10px;background:var(--bg);color:#e2e8f0;margin:8px 0}
    button.action{width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:800;cursor:pointer;min-height:48px}
    button.logout{background:var(--warn)}
    table{width:100%;border-collapse:collapse;margin:10px 0}
    th,td{border:1px solid var(--muted);padding:10px;text-align:center}
    .row{display:flex;gap:10px;align-items:center}
    .row>.grow{flex:1}

    .classGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:14px;
      margin-top:12px;
    }
    .classCard{
      position:relative;
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      padding:14px 14px 48px;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .classCard:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .className{ font-weight:900; font-size:20px; letter-spacing:.3px; margin-bottom:8px; }
    .classPick{
      position:absolute; left:14px; right:14px; bottom:14px;
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      color:#fff; font-weight:800;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    .classPick.active{ outline:3px solid rgba(16,185,129,.40) }

    .delFloat{
      position:absolute; top:10px; right:10px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delFloat img.trashIcon{ width:22px; height:22px; display:block; image-rendering: auto; filter: drop-shadow(0 1px 2px rgba(0,0,0,.35)); transition: transform .15s ease, filter .15s ease, opacity .15s ease;}
    .delFloat:hover{ transform:translateY(-1px); }
    .delFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delFloat:hover::before{ opacity:1; }
    .delFloat:hover img.trashIcon { transform: scale(1.12); filter: drop-shadow(0 0 8px rgba(239,68,68,.75)); }

    .studentItem{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;background:#0b1427;margin:6px 0;border-radius:10px; position:relative;}
    .studentItem.hasDel{ padding-right:48px; } 
    .delStuFloat{
      position:absolute; top:8px; right:8px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delStuFloat img.trashIcon{ width:18px; height:18px; display:block; }
    .delStuFloat:hover{ transform:translateY(-1px); }
    .delStuFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delStuFloat:hover::before{ opacity:1; }
    .delStuFloat:hover img.trashIcon { transform: scale(1.12); filter: drop-shadow(0 0 8px rgba(239,68,68,.75)); }

    .delStuBtn{
      background:linear-gradient(180deg,#ef4444,#dc2626);
      border:1px solid #7f1d1d;
      color:#fff; font-weight:800;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      display:flex; align-items:center; gap:6px;
      box-shadow:0 6px 16px rgba(239,68,68,.25), inset 0 1px 0 rgba(255,255,255,.08);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .delStuBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(239,68,68,.35); }
    .delStuBtn:active{ transform:translateY(0); box-shadow:0 4px 12px rgba(239,68,68,.3); }
    .delStuBtn img.trashIcon{ width:16px; height:16px; filter:brightness(10); }

    .pill{padding:10px 16px;border:0;border-radius:999px;background:#334155;color:#e5e7eb;font-weight:800;cursor:pointer;transition:.2s}
    .pill.active{background:linear-gradient(90deg,var(--accent1),var(--accent2)); box-shadow:0 0 0 3px rgba(16,185,129,.35);}
    .pill:hover{filter:brightness(1.05)}
    .delBtn{padding:8px 10px;border:0;border-radius:10px;background:linear-gradient(90deg,#fb7185,#f43f5e);color:#fff;font-weight:800;cursor:pointer}

    .list{margin-top:14px;background:var(--bg);border-radius:12px;padding:12px}
    .leftGroup{display:flex;align-items:center;gap:8px}
    .studentNameBtn{border:0;background:transparent;color:#e2e8f0;font-weight:800;cursor:pointer;text-align:left}
    .starBtn{border:0;background:transparent;font-size:20px;cursor:pointer;color:#f59e0b}
    .starBtn.off{color:#64748b}
    .sectionTitle{margin:12px 0 6px;font-weight:800;opacity:.9}
    .twoCol{display:grid;grid-template-columns: 300px 1fr; gap:14px}
    .dayBtn,.weekBtn{display:block;width:100%;text-align:left;padding:10px;border:0;border-radius:10px;background:#334155;color:#fff;cursor:pointer;margin-top:8px;min-height:44px}
    .empty{opacity:.7;padding:12px;text-align:center}
    .editBtn{padding:6px 12px;border:0;border-radius:6px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
    .smallRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ghost{opacity:.6}

    #alert{max-width:1080px;margin:0 auto 8px;padding:10px 14px;border-radius:10px;background:#0b1427;color:#ffd6a5;display:none}
    #weekChartWrap{background:#0b1427;border-radius:12px;padding:12px;margin-top:10px}
    #pdfBtns{display:flex;gap:10px;flex-wrap:wrap}

    #exportArea{
      width:1240px; padding:40px 48px 48px;
      background:var(--export-bg); color:#e5e7eb; font-family:Arial, Helvetica, sans-serif;
    }
    #exportArea h1{margin:0 0 6px;font-size:28px;color:var(--export-head)}
    #exportArea h2{margin:0 0 18px;font-size:18px;font-weight:700;color:#c7d2fe}
    #exportHead{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
    .exportCard{background:#0f1a31;border:1px solid #21314f;border-radius:12px;padding:14px}
    #exportTable table{width:100%;border-collapse:collapse}
    #exportTable th,#exportTable td{border:1px solid #21314f;padding:10px;text-align:center}
    #exportLegend{font-size:12px;opacity:.8;margin-top:6px}

    #loginPanel h3{font-size:22px}
    #loginPanel .tabs button{font-size:16px;padding:14px;min-height:48px}
    #loginPanel input,#loginPanel select{font-size:16px;min-height:48px}
    #loginPanel button.action{font-size:16px;min-height:52px}
    @media (max-width: 768px){
      .header{font-size:20px}
      .subheader{font-size:14px}
      #loginPanel .container{padding:18px}
      #loginPanel h3{font-size:24px}
      #loginPanel .tabs{gap:6px}
      #loginPanel .tabs button{font-size:17px;padding:14px 12px}
      #loginPanel input,#loginPanel select{font-size:17px}
      #loginPanel button.action{font-size:17px}
      .twoCol{grid-template-columns:1fr}
    }
    @media (max-width: 480px){
      .header{font-size:18px;padding:18px}
      .subheader{font-size:12px}
      #loginPanel .tabs{padding:6px}
      #loginPanel .tabs button{font-size:18px;min-width:130px;padding:12px}
      #loginPanel h3{font-size:22px;margin-bottom:10px}
      #loginPanel input,#loginPanel select{font-size:18px;padding:14px;min-height:52px}
      #loginPanel button.action{font-size:18px;padding:14px;min-height:56px}
      .container{margin:12px}
    }
    .teacherWelcome{opacity:.8;margin:0 0 10px}
    .favBlock{background:#0b1427;border-radius:12px;padding:10px;margin-top:8px}
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: 3px solid rgba(34,197,94,.65);
      outline-offset: 2px;
      border-color: rgba(34,197,94,.65);
      box-shadow: 0 0 0 3px rgba(34,197,94,.25);
    }
    
    .roleGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:14px;
      margin-top:8px;
    }
    .roleCard{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:22px 16px;
      border:1px solid var(--cardBorder);
      border-radius:14px;
      background:var(--card);
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      text-align:center;
      color:var(--text);
    }
    .roleCard:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .roleCard:focus{
      outline:3px solid rgba(16,185,129,.55);
      outline-offset:2px;
    }
    .roleIcon{
      width:68px; height:68px; display:grid; place-items:center;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(59,130,246,.12), rgba(6,182,212,.12));
      color:#93c5fd;
    }
    .roleIcon svg{ width:36px; height:36px; display:block; }
    .roleCard.parent .roleIcon{ color:#34d399; background:linear-gradient(135deg, rgba(52,211,153,.12), rgba(6,182,212,.12)); }
    .roleTitle{ font-weight:900; letter-spacing:.2px; }

.smallRow .pill {
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
}
.smallRow .pill.account {
  background: #facc15; 
  border: none;
  color: #111;
}
.smallRow .pill.account:hover {
  background: #eab308;
}
.smallRow .pill.exit {
  background: #ef4444; 
  border: none;
  color: #fff;
}
.smallRow .pill.exit:hover {
  background: #dc2626;
}

@media (max-width: 768px) {
  .roleGrid { grid-template-columns: 1fr; gap: 12px; }
  .roleCard { padding: 18px 14px; }
  .roleIcon { width: 60px; height: 60px; }
  .roleIcon svg { width: 30px; height: 30px; }
  .roleTitle { font-size: 18px; }
  .smallRow { justify-content: center; }
  .smallRow .pill { width: 100%; max-width: 240px; }
}
@media (max-width: 480px) {
  .roleCard { padding: 16px 12px; }
  .roleIcon { width: 54px; height: 54px; }
  .roleIcon svg { width: 28px; height: 28px; }
  .roleTitle { font-size: 17px; }
}

    .calendarWrap{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .calHeader{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
    }
    .calTitle{font-weight:900;letter-spacing:.2px;text-transform:capitalize}
    .calNav{display:flex;gap:8px;}
    .calBtn{
      border:0;border-radius:10px;background:#0f1a31;color:#e2e8f0;
      padding:8px 10px;cursor:pointer;font-weight:800;
    }
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
    .calWd{opacity:.75;font-size:12px;text-align:center;margin-bottom:2px}
    .calCell{
      position:relative;min-height:42px;border:1px solid #23324a;border-radius:10px;
      display:flex;align-items:flex-start;justify-content:flex-end;padding:8px;cursor:pointer;background:#0f1a31;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .calCell:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .calCell.muted{opacity:.5}
    .calDay{font-weight:800}
    .calDot{
      position:absolute;left:8px;bottom:8px;width:8px;height:8px;border-radius:999px;background:#ef4444;
      box-shadow:0 0 0 2px rgba(239,68,68,.15);
    }
    .calCell.today{outline:2px dashed rgba(59,130,246,.6); outline-offset:2px;}
    .calCell.selected{box-shadow:0 0 0 3px rgba(16,185,129,.45) inset;border-color:#16a34a;}
    @media (max-width:560px){
      .calCell{min-height:38px;padding:6px}
      .calTitle{font-size:14px}
    }

    .calHeader{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(11,20,39,.95), rgba(11,20,39,.88)); backdrop-filter:saturate(1.2) blur(4px); border-radius:12px 12px 0 0; padding:8px; }
    .calBtnToday{
      border:0;border-radius:10px;background:#14532d;color:#e2e8f0;
      padding:8px 12px;cursor:pointer;font-weight:900;
    }
    .calBtn:disabled,.calBtnToday:disabled{opacity:.5;cursor:default}
    .calendarWrap{ position:relative; }
    .calFab{
      position:sticky; bottom:8px; left:100%; transform:translateX(-100%);
      margin-top:8px; display:none;
    }
    .calFab button{
      border:0; border-radius:999px; padding:10px 14px; font-weight:900; background:#14532d; color:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,.35);
    }
    .calCell{ min-height:48px; }
    @media (max-width:600px){
      .calGrid{ gap:4px; }
      .calWd{ font-size:11px; }
      .calCell{ min-height:44px; padding:6px; }
      .calTitle{ font-size:15px; }
      .calNav .calBtn{ padding:8px 10px; }
      .calFab{ display:block; }
    }


  .student-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:12px 0 6px; }
  .densityToggle{
    background: var(--card); color: var(--text); border: 1px solid var(--cardBorder);
    border-radius: 10px; padding: 8px 12px; cursor:pointer;
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    border-radius:999px; padding:6px 10px; font-weight:800; font-size:12px;
    background:var(--card); border:1px solid var(--cardBorder);
  }
  .chip .dot{ width:10px; height:10px; border-radius:999px; }
  .chip.turkce .dot{ background:#fb923c; }
  .chip.sosyal .dot{ background:#6366f1; }
  .chip.din .dot{ background:#22c55e; }
  .chip.ing .dot{ background:#0ea5e9; }
  .chip.mat .dot{ background:#f43f5e; }
  .chip.fen .dot{ background:#14b8a6; }

  .lessonList.dense{ display:flex; flex-direction:column; gap:8px; margin:10px 0; }
  
  .lessonRow.dense {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--cardBorder);
    border-radius: 12px;
    padding: 12px;
    transition: border-color .15s ease, box-shadow .15s ease;
  }
  .lessonRow.dense > .chip {
    justify-self: start;
  }
  .lessonRow.dense:hover { border-color:#3b4b6a; box-shadow:0 8px 18px rgba(0,0,0,.22); }


  .lessonControls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    align-items: center;
    width: 100%;
  }
  .lessonControls input[type=number]{
    width:100px; min-height:34px; font-size:14px;
    background:var(--bg); color:var(--text); border:0; border-radius:10px; padding:8px 10px;
  }
  .lessonControls input[type=number]::-webkit-outer-spin-button,
  .lessonControls input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .lessonControls input[type=number]{ -moz-appearance:textfield; }
  .numBtn{
    width:34px; height:34px; display:grid; place-items:center; border:0; border-radius:10px;
    background:#334155; color:#fff; font-weight:900; font-size:15px; cursor:pointer;
    transition: transform .08s ease, filter .12s ease;
  }
  .numBtn:hover{ filter:brightness(1.06); }
  .numBtn:active{ transform: translateY(1px); }

  .countWrap{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 6px; border-radius:999px;
    background: rgba(99,102,241,.10);
    border:1px solid rgba(99,102,241,.35);
    box-shadow: inset 0 0 0 1px rgba(99,102,241,.12);
    width: 100%;
    justify-content: space-between;
  }
  .countWrap:focus-within{ box-shadow: 0 0 0 3px rgba(99,102,241,.25); }
  .countWrap .numBtn{ background:#4f46e5; }
  .countWrap input[type=number]{ background:transparent; }

  .goalWrap{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 6px; border-radius:999px;
    background: rgba(14,165,233,.10);
    border:1px solid rgba(14,165,233,.35);
    box-shadow: inset 0 0 0 1px rgba(14,165,233,.12);
    width: 100%;
    justify-content: space-between;
  }
  .goalWrap:focus-within{ box-shadow: 0 0 0 3px rgba(14,165,233,.25); }
  .goalIcon{ font-size:16px; line-height:1; width:18px; height:18px; display:grid; place-items:center;
  cursor: pointer;}
  .goalInput{
    width:64px; min-height:30px; font-size:14px; border:0; outline:none;
    background:transparent; color:var(--text); text-align:center;
  }

  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

  .rowFooter{ display:flex; align-items:center; gap:12px; width:100%; }
  .progressWrap{ position:relative; flex:1 1 auto; min-width:0; height:6px; background:var(--cardBorder);
    border-radius:999px; overflow:hidden; }
  .progressBar{ position:absolute; top:0; left:0; height:100%; width:0%;
    background:linear-gradient(90deg,#22c55e,#0ea5e9); transition: width .15s ease; }
  .pctBadge{
    min-width: 50px;
    height: 26px;
    display:grid; place-items:center;
    padding:0 12px;
    border-radius:999px; font-weight:900;
    font-size:13px;
    background:#0b9444; color:#fff; margin-left:auto;
    flex-shrink: 0; 
  }
  .pctBadge.low{ background:#eab308; }
  .pctBadge.zero{ background:#6b7280; }

  .totalBar{ display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:8px; font-weight:800; }
  .totalBadge{ min-width:56px; text-align:center; background:#0ea5e9; color:white; border-radius:10px; padding:8px 10px; }

  @media (max-width: 560px){
    .lessonControls{ 
      grid-template-columns: 1fr;
    }
    .countWrap input[type=number] {
      width: 60px;
    }
    .goalWrap .goalInput {
      width: 50px;
    }
  }

    .teacherTopbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0 8px;}
    button.exitSmall{border:0;border-radius:10px;padding:6px 10px;min-height:32px;background:#ef4444;color:#fff;font-weight:800;cursor:pointer}
    button.exitSmall:hover{background:#dc2626}
    button.exitSmall:focus{outline:3px solid rgba(16,185,129,.55);outline-offset:2px;}

button.exitSmall{padding:8px 12px;min-height:38px;font-size:14px;display:inline-flex;align-items:center;gap:8px}
button.exitSmall .icon{width:16px;height:16px;line-height:0;display:inline-flex}
button.exitSmall .icon svg{display:block}
button.exitSmall .label{line-height:1}

#repTab-daily .calendarWrap{
  background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.92));
  border: 1px solid var(--cardBorder, #1e293b);
  border-radius: 16px;
  box-shadow: 0 20px 50px rgba(0,0,0,.45);
  padding: 16px;
}

#repTab-daily .calHeader{
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom: 12px;
}
#repTab-daily .calTitle{ font-weight:800; letter-spacing:.2px; }
#repTab-daily .calNav .calBtn{
  border:1px solid rgba(148,163,184,.25);
  background: rgba(148,163,184,.06);
  border-radius:10px; padding:6px 8px; min-height:32px;
  cursor:pointer; transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
#repTab-daily .calNav .calBtn:hover{ transform: translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); }
#repTab-daily .calBtnToday{
  background: linear-gradient(180deg, #22c55e, #16a34a);
  color:#fff; font-weight:900; border:0;
  border-radius:12px; padding:6px 12px; min-height:32px;
}

#repTab-daily .calGrid{ gap: 10px; }
#repTab-daily .calWd{ opacity:.9; font-weight:700; }
#repTab-daily .calCell{
  position:relative;
  min-height:56px;
  border:1px solid #23324a;
  border-radius:14px;
  background:#0f1a31;
  display:flex; align-items:flex-start; justify-content:flex-end;
  padding:10px;
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
#repTab-daily .calCell:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
#repTab-daily .calCell.today{ outline:2px dashed rgba(59,130,246,.6); outline-offset:2px; }
#repTab-daily .calCell.selected{
  outline: 2px dashed rgba(16,185,129,.55);
  outline-offset: -4px;
  box-shadow: 0 0 0 3px rgba(16,185,129,.25) inset;
  border-color:#16a34a;
}
#repTab-daily .calDay{ font-weight:800; opacity:.95; }
#repTab-daily .calDot{
  position:absolute; left:10px; top:10px;
  width:7px; height:7px; border-radius:9999px; background:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.15);
}

#repTab-daily #selDayBlock{
  margin-top:14px;
  background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.92));
  border:1px solid var(--cardBorder,#1e293b);
  border-radius:14px;
  box-shadow: 0 20px 50px rgba(0,0,0,.45);
  padding: 16px;
}
#repTab-daily #selDayBlock .sectionTitle{
  font-weight:800; margin-bottom:10px;
}

#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable table{ width:100%; border-collapse:separate; border-spacing:0; }
#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable th,
#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable td{
  padding:12px 14px;
  border-bottom:1px solid #23324a;
}
#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable thead th{
  text-align:left; font-weight:700; background:#0d1628;
}
#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable tr:last-child td{ border-bottom:0; }

#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable .editBtn{
  border:0; border-radius:10px; padding:6px 12px; min-height:32px;
  background: linear-gradient(180deg, #3b82f6, #06b6d4);
  color:#fff; font-weight:800; cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable .editBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.25); filter:saturate(1.05); }
#repTab-daily #stuDayTable, #repTab-daily #tsdDayTable .editBtn:focus{ outline:3px solid rgba(16,185,129,.45); outline-offset:2px; }

@media (max-width: 560px){
  #repTab-daily .calGrid{ gap:8px; }
  #repTab-daily .calCell{ min-height:44px; padding:8px; }
  #repTab-daily #selDayBlock{ padding:12px; }
  #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable th, #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable td{ padding:10px 12px; }
}

#repTab-weekly #weekControls{ display:flex; align-items:center; gap:12px; }
#repTab-weekly .weekDropdown{ position:relative; display:inline-block; }
#repTab-weekly .wdToggle{
  border:0; border-radius:12px; padding:8px 12px; min-height:36px;
  background: linear-gradient(180deg, #3b82f6, #06b6d4);
  color:#fff; font-weight:900; cursor:pointer;
  display:flex; align-items:center; gap:10px;
}
#repTab-weekly .wdToggle .chev{ font-weight:900; opacity:.9; }
#repTab-weekly .wdMenu{
  position:absolute; top:calc(100% + 6px); left:0; z-index:50;
  background:#0f1a31; border:1px solid #23324a; border-radius:12px; padding:8px;
  box-shadow:0 20px 50px rgba(0,0,0,.45); min-width:320px; max-height:280px; overflow:auto;
  display:none;
}
#repTab-weekly .wdMenu.open{ display:block; }
#repTab-weekly .wdItem{
  display:block; width:100%; text-align:left; border:0; background:transparent; color:inherit;
  padding:8px 10px; border-radius:8px; cursor:pointer;
}
#repTab-weekly .wdItem:hover{ background:rgba(148,163,184,.08); }
#repTab-weekly .wdItem.active{ background:rgba(34,197,94,.15); outline:1px dashed rgba(16,185,129,.45); }
@media (max-width:560px){
  #repTab-weekly .wdMenu{ min-width:260px; }
}

.studentWelcomeBanner{
  margin:10px 0 12px;
  padding:12px 14px;
  border-radius:12px;
  background: linear-gradient(180deg, rgba(34,197,94,.16), rgba(6,182,212,.10));
  border:1px solid rgba(34,197,94,.35);
  font-weight:800;
  color:#d1fae5;
  text-align:center;
  box-shadow: 0 10px 26px rgba(0,0,0,.25), inset 0 0 0 1px rgba(34,197,94,.15);
}

.targetBtn{
  border:none;background:transparent;cursor:pointer;font-size:20px;line-height:1;
  filter: drop-shadow(0 1px 1px rgba(0,0,0,.4));
}
.targetBtn:hover{ transform: scale(1.05); }
.targetInfo{
  margin:6px 0 10px; padding:8px 10px; border-radius:10px;
  background: rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.25);
  font-weight:600; display:flex; gap:8px; align-items:center; justify-content:space-between;
}
.targetInfo small{opacity:.9}

.targetFloat{
  position:absolute; top:8px; right:52px; 
  display:grid; place-items:center;
  width:36px; height:36px; padding:0;
  border:0; border-radius:999px;
  background:transparent;
  cursor:pointer;
  transition:transform .12s ease, opacity .12s ease;
  z-index:2;
}
.targetFloat:hover{ transform:translateY(-1px); }

#reportOverlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);z-index:9998;}
#teacherStudentDetail.asModal{position:fixed;inset:auto auto 5% 50%;transform:translateX(-50%);width:min(920px,92vw);max-height:88vh;overflow:auto;
  background:var(--card,#0b1427);border:1px solid var(--cardBorder,#1e293b);border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.45);padding:16px;z-index:9999;}
.modalHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;position:sticky;top:0;background:inherit;padding-bottom:8px;}
.modalTabs{display:flex;gap:8px;align-items:center;}
.modalTabs .pill{cursor:pointer;}
.modalClose{margin-left:auto}
#repTab-daily,#repTab-weekly,#repTab-monthly{display:none;}
#repTab-daily.active,#repTab-weekly.active,#repTab-monthly.active{display:block;}
@media (max-width:720px){
  #teacherStudentDetail.asModal{inset:auto auto 2% 50%; width:96vw; }
}

@media (max-width: 600px){
  #goalsPage .gp-title{ display: none !important; }

  .header .header-goals-title{
    display: block;
    margin-top: 6px;
    font-weight: 800;
    font-size: clamp(18px, 5vw, 22px);
    line-height: 1.15;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}

#teacherStudentDetail #repTabMonthlyBtn,
#teacherStudentDetail #repTab-monthly{ display:none !important; }

#goalsPage .gp-title{ display: none !important; }
.header .header-goals-title{
  display: block;
  margin-top: 6px;
  font-weight: 800;
  font-size: clamp(18px, 2.2vw, 24px);
  line-height: 1.15;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#favoritesSection .editBtn{ display: none !important; }

#goalsPage{
  padding: 8px 12px 20px;
}
#goalsPage .gp-header{
  position: sticky; top: 0; z-index: 30;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 0;
  background: linear-gradient(180deg, rgba(11,20,39,.92), rgba(11,20,39,.86));
  border-bottom: 1px solid var(--cardBorder);
  backdrop-filter: saturate(1.1) blur(6px);
}
#goalsPage .gp-left{ display:flex; align-items:center; gap:10px; }
#goalsPage .gp-title{ font-weight:900; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
#goalsPage .gp-actions{ display:flex; align-items:center; gap:8px; }

.gp-btn{ display:inline-flex; align-items:center; gap:8px; }
.gp-btn .icon{ width:16px; height:16px; line-height:0; display:inline-flex; }
.gp-btn .icon svg{ width:16px; height:16px; display:block; }

.gp-table{
  max-width: 760px; margin: 0 auto;
  background: var(--card);
  border: 1px solid var(--cardBorder);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 16px 40px rgba(0,0,0,.35);
}
.gp-row{
  display: grid; grid-template-columns: 1fr 140px;
  align-items: center; gap: 12px;
  padding: 12px 14px;
  border-top: 1px solid var(--cardBorder);
}
.gp-row:first-child{ border-top:0; }
.gp-row:nth-child(odd){ background: rgba(148,163,184,.05); }

.gp-label{
  display:flex; align-items:center; gap:10px; font-weight:800;
}
.gp-label .dot{ width:10px; height:10px; border-radius:999px; }
.gp-label.turkce   .dot{ background:#fb923c; }
.gp-label.sosyal   .dot{ background:#6366f1; }
.gp-label.din      .dot{ background:#22c55e; }
.gp-label.ing      .dot{ background:#0ea5e9; }
.gp-label.matematik .dot{ background:#f43f5e; }
.gp-label.fen      .dot{ background:#14b8a6; }

.gp-input{
  width:100%;
  min-height:42px; font-size:16px; text-align:center; font-weight:700;
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--cardBorder);
  border-radius: 12px;
  padding: 10px 12px;
}
.gp-input::-webkit-outer-spin-button,
.gp-input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
.gp-input{ -moz-appearance: textfield; }

#goalsPage .gp-note{
  max-width:760px; margin:8px auto 0; opacity:.8;
}

@media (max-width: 560px){
  .gp-row{ grid-template-columns: 1fr 110px; padding: 10px 12px; }
  .gp-input{ min-height:38px; font-size:15px; }
}

#goalsPage .gp-header .gp-btn{
  min-height: 40px;
  min-width: 120px;
  padding: 8px 14px;
  border-radius: 12px;
  font-weight: 900;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
#goalsPage .gp-header .gp-btn .icon{ width:16px; height:16px; }

#goalsPage .gp-header .gp-back{
  background: linear-gradient(180deg,#ef4444,#dc2626) !important;
  color:#fff !important;
  border:1px solid #7f1d1d;
  box-shadow:0 6px 16px rgba(239,68,68,.25), inset 0 1px 0 rgba(255,255,255,.08);
}

#goalsPage .gp-header .gp-clear{
  background: linear-gradient(180deg,#10b981,#059669) !important;
  color:#fff !important;
  border:1px solid #065f46;
  box-shadow:0 6px 16px rgba(16,185,129,.25), inset 0 1px 0 rgba(255,255,255,.08);
}

#goalsPage .gp-header{ position: relative; }
#goalsPage .gp-header .gp-title{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  font-weight: 800;
}
#goalsPage .gp-header .gp-title{
  position: static !important;
  left: auto !important;
  transform: none !important;
  text-align: left !important;
  font-size: 1.5rem !important;
  line-height: 1.3 !important;
}

body[data-role="parent"] #studentTab-entry #lessonForm { display:none !important; }
body[data-role="parent"] #studentTab-entry .totalBar { display:none !important; }
body[data-role="parent"] #studentTab-entry .addBtn { display:none !important; }
body[data-role="parent"] #studentTab-entry .student-toolbar { margin-bottom: 8px; }

</style>
</head>
<body>
<div id="reportOverlay" onclick="closeReportModal()"></div>
<div class="header">
  <div class="main-title">ÖĞRENCİ TAKİP PROGRAMI</div>
  <div class="subtitle">Alparslan Ortaokulu</div>
</div>
<div id="alert"></div>
<!-- Giriş Alanı -->
<div id="loginPanel">
<div class="tabs">
<button class="active" id="tabRegister" onclick="showTab('register')" type="button">Öğrenci Kayıt</button>
<button id="tabStudent" onclick="showTab('studentLogin')" type="button">Öğrenci-Veli Giriş</button>
<button id="tabTeacher" onclick="showTab('teacherLogin')" type="button">Öğretmen Giriş</button>
</div>
<!-- Öğrenci Kayıt -->
<div class="container" id="register">
<h3>Öğrenci Kayıt</h3>
<input autocomplete="off" id="rName" placeholder="Ad Soyad" type="text"/>
<select id="rClass"><option value="">Sınıf Seçin</option></select>
<input autocomplete="off" id="rNumber" placeholder="Okul Numarası" type="text"/>
<input autocomplete="new-password" id="rPass" placeholder="Şifre" type="password"/>
<!-- YENİ: Şifre Tekrar -->
<input autocomplete="new-password" id="rPass2" placeholder="Şifre (Tekrar)" type="password"/>
<small id="passMismatchError" style="display:none;color:#ef4444;font-weight:600;">Şifreler eşleşmiyor</small>
<button class="action" id="registerBtn" onclick="studentRegister()" type="button">Kayıt</button>
</div>
<!-- Öğrenci-Veli Giriş -->
<div class="container" id="studentLogin" style="display:none">
<h3>Öğrenci-Veli Giriş</h3>
<input autocomplete="off" id="lNumber" placeholder="Okul Numarası" type="text"/>
<input autocomplete="current-password" id="lPass" placeholder="Şifre" type="password"/>
<button class="action" onclick="studentLogin()" type="button">Giriş Yap</button>
</div>
<!-- Giriş Türü Seçimi -->
<div class="container" id="roleChoice" style="display:none">
<h3>Giriş Türünü Seçin</h3>
<div class="teacherWelcome" id="roleChoiceHello"></div>
<div class="roleGrid">
<button aria-label="Öğrenci Girişi" class="roleCard" onclick="enterAsStudent()" type="button">
<div aria-hidden="true" class="roleIcon">
<!-- Tek kişi ikonu -->
<svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 12c2.761 0 5-2.686 5-6s-2.239-6-5-6-5 2.686-5 6 2.239 6 5 6Zm0 2c-4.418 0-8 2.686-8 6v2h16v-2c0-3.314-3.582-6-8-6Z"></path>
</svg>
</div>
<div class="roleTitle">Öğrenci Girişi</div>
</button>
<button aria-label="Veli Girişi" class="roleCard parent" onclick="enterAsParent()" type="button">
<div aria-hidden="true" class="roleIcon">
<!-- İki kişi ikonu -->
<svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M16 11c2.209 0 4-2.239 4-5s-1.791-5-4-5-4 2.239-4 5 1.791 5 4 5Zm-8 0c2.209 0 4-2.239 4-5S10.209 1 8 1 4 3.239 4 6s1.791 5 4 5Zm8 2c-2.761 0-5.2.937-6.64 2.378C7.409 14.855 5.132 14 3 14c-1.657 0-3 1.567-3 3.5V21h10v-2c0-1.252.467-2.393 1.256-3.33C12.466 14.646 14.066 14 16 14c3.866 0 7 2.015 7 4.5V21h-8v-1.5c0-2.485-1.79-4.5-4-4.5Z"></path>
</svg>
</div>
<div class="roleTitle">Veli Girişi</div>
</button>
</div>
<div class="smallRow" style="margin-top:10px">
<button aria-label="Geri" class="pill exit" onclick="exitToHome()" type="button"><span aria-hidden="true" class="backIcon">←</span> Geri</button>
</div>
</div>
<!-- Öğretmen Giriş -->
<div class="container" id="teacherLogin" style="display:none">
<h3>Öğretmen Giriş</h3>
<input autocomplete="name" id="tName" placeholder="Ad Soyad" type="text"/>
<input id="tCode" placeholder="Kod" type="password"/>
<button class="action" onclick="teacherLogin()" type="button">Giriş Yap</button>
</div>
</div>
<!-- ÖĞRENCİ PANELİ -->
<div class="container" id="studentPanel" style="display:none">
<h3 id="studentPanelTitle">Öğrenci Paneli</h3>
<div class="studentWelcomeBanner" id="studentWelcome" style="display:none"></div>
<div class="pillTabs" id="studentTabs">
<button class="pill active" id="stuTabEntryBtn" onclick="showStudentTab('entry')">Soru Girişi</button>
<button class="pill" id="stuTabWeekBtn" onclick="showStudentTab('week')">Haftalık Rapor</button>
<button class="pill" id="stuTabMonthBtn" onclick="showStudentTab('month')">Aylık Rapor</button>
</div>
<div id="studentTab-entry">
<div class="student-toolbar">
<div style="display:flex; gap:8px; align-items:center;">
<strong id="studentPanelToolbarTitle">Öğrenci Paneli</strong>
<span class="chip"><span class="dot" style="background:transparent;border:1px solid var(--cardBorder)"></span>Liste v5.4</span>
</div>
<div style="display:flex; gap:8px;">
<button class="densityToggle" id="densityToggleBtn" title="Yoğun Mod" type="button">Yoğun Mod</button>
</div>
<div class="targetInfo" id="studentTargetInfo" style="display:none">
<div><small>Günlük Hedef</small> <span id="studentTargetValue">—</span> soru</div>
<div>
<button class="pill" onclick="openTargetForCurrent()" type="button">Düzenle</button>
</div>
</div>
</div>
<form id="lessonForm">
<ul class="lessonList dense" role="list">
<li class="lessonRow dense">
<span class="chip turkce"><span class="dot"></span>Türkçe</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Türkçe azalt" class="numBtn" data-step="-1" data-target="Turkce" type="button">−</button>
<input id="Turkce" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Türkçe artır" class="numBtn" data-step="1" data-target="Turkce" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Turkce">Türkçe hedef</label>
<input class="goalInput" id="goal-Turkce" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Turkce"></div></div>
<span class="pctBadge zero" data-pct-for="Turkce">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip sosyal"><span class="dot"></span>Sosyal Bilgiler</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Sosyal Bilgiler azalt" class="numBtn" data-step="-1" data-target="Sosyal" type="button">−</button>
<input id="Sosyal" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Sosyal Bilgiler artır" class="numBtn" data-step="1" data-target="Sosyal" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Sosyal">Sosyal Bilgiler hedef</label>
<input class="goalInput" id="goal-Sosyal" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Sosyal"></div></div>
<span class="pctBadge zero" data-pct-for="Sosyal">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip din"><span class="dot"></span>Din Kültürü</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Din Kültürü azalt" class="numBtn" data-step="-1" data-target="Din" type="button">−</button>
<input id="Din" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Din Kültürü artır" class="numBtn" data-step="1" data-target="Din" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Din">Din Kültürü hedef</label>
<input class="goalInput" id="goal-Din" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Din"></div></div>
<span class="pctBadge zero" data-pct-for="Din">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip ing"><span class="dot"></span>İngilizce</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="İngilizce azalt" class="numBtn" data-step="-1" data-target="Ingilizce" type="button">−</button>
<input id="Ingilizce" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="İngilizce artır" class="numBtn" data-step="1" data-target="Ingilizce" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Ingilizce">İngilizce hedef</label>
<input class="goalInput" id="goal-Ingilizce" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Ingilizce"></div></div>
<span class="pctBadge zero" data-pct-for="Ingilizce">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip mat"><span class="dot"></span>Matematik</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Matematik azalt" class="numBtn" data-step="-1" data-target="Matematik" type="button">−</button>
<input id="Matematik" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Matematik artır" class="numBtn" data-step="1" data-target="Matematik" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Matematik">Matematik hedef</label>
<input class="goalInput" id="goal-Matematik" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Matematik"></div></div>
<span class="pctBadge zero" data-pct-for="Matematik">0%</span>
</div>
</li>
<li class="lessonRow dense">
<span class="chip fen"><span class="dot"></span>Fen Bilimleri</span>
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap">
<button aria-label="Fen Bilimleri azalt" class="numBtn" data-step="-1" data-target="Fen" type="button">−</button>
<input id="Fen" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Fen Bilimleri artır" class="numBtn" data-step="1" data-target="Fen" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Fen">Fen Bilimleri hedef</label>
<input class="goalInput" id="goal-Fen" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Fen"></div></div>
<span class="pctBadge zero" data-pct-for="Fen">0%</span>
</div>
</li>
</ul>
<div class="totalBar">
<span>Genel Toplam:</span>
<span class="totalBadge" id="globalTotal">0</span>
</div>
<button class="action addBtn" onclick="addAll()" type="button">Ekle</button>
</form>
<div class="list" id="studentRecords"></div>
</div> <!-- /studentTab-entry -->
<!-- === STUDENT WEEKLY REPORT TAB === -->
<div id="studentTab-week" style="display:none">
<div class="sectionTitle">Hafta Seç</div>
<select id="stuWeekSelect" onchange="selectStuWeek(this.value)" style="width:100%;max-width:420px;"></select>
<div id="stuWeekChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="stuWeekChart"></canvas>
</div>
<div class="exportCard" id="stuWeekMatrix" style="margin-top:10px"></div>
</div>
<!-- === STUDENT MONTHLY REPORT TAB === -->
<div id="studentTab-month" style="display:none">
<div class="sectionTitle">Ay Seç</div>
<select id="stuMonthSelect" onchange="selectStuMonth(this.value)" style="width:100%;max-width:420px;"></select>
<div id="stuMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="stuMonthChart"></canvas>
</div>
<div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
<div class="exportCard" id="stuMonthTotals"></div>
</div>
<div class="smallRow" style="margin-top:16px; justify-content:center; gap: 12px;">
    <button type="button" class="pill exit" onclick="backToRoleChoice()">Geri</button>
    <button type="button" class="action logout" style="width: auto; padding: 10px 20px;" onclick="logout()">Çıkış Yap</button>
</div>
</div>
<!-- ÖĞRETMEN PANELİ -->
<div class="container" id="teacherPanel" style="display:none">
<p class="teacherWelcome" id="teacherWelcome"></p>
<div class="teacherTopbar">
<h3 style="margin:0">Öğretmen Paneli</h3>
<button aria-label="Çıkış" class="exitSmall" onclick="logout()" title="Çıkış" type="button"><span aria-hidden="true" class="icon">
<svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16">
<!-- Simple logout icon: arrow left + door -->
<path d="M14 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2"></path>
<path d="M9 12h11"></path>
<path d="M13 8l-4 4l4 4"></path>
</svg>
</span>
<span class="label">Çıkış</span></button>
</div>
<div class="pillTabs" id="teacherTopTabs">
<button class="pill active" id="tabClasses" onclick="showTeacherSection('classes')">Sınıflar</button>
<button class="pill" id="tabFavorites" onclick="showTeacherSection('favorites')">Favorilerim</button>
</div>
<!-- Sınıflar -->
<div id="classesSection">
<div class="row" style="margin-top:10px; margin-bottom:6px">
<input autocomplete="off" class="grow" id="newClass" placeholder="örn: 8/A" type="text"/>
<button class="action" onclick="addClass()" style="max-width:220px" type="button">Sınıf Ekle</button>
</div>
<div class="classGrid" id="classGrid"></div>
<div class="list" id="classStudents" style="display:none">
    <div class="sectionTitle" style="display:flex; justify-content:space-between; align-items:center;">
        <span>Öğrenciler</span>
        <button class="pill exit" style="font-size: 12px; padding: 6px 10px;" onclick="backToClasses()">Sınıflara Geri Dön</button>
    </div>
    <div id="studentsContainer"></div>
</div>
</div>
<!-- Favoriler -->
<div id="favoritesSection" style="display:none; margin-top:14px">
<div class="list">
<div class="sectionTitle">Favori Öğrencilerim</div>
<div id="favoritesList"></div>
</div>
</div>
<!-- ÖĞRENCİ DETAY + HAFTALIK -->
<div class="list asModal" id="teacherStudentDetail" style="display:none;">
<div class="modalHead">
<div class="modalTabs">
<button class="pill active" id="repTabDailyBtn" onclick="showReportTab('daily')">Günlük</button>
<button class="pill" id="repTabWeeklyBtn" onclick="showReportTab('weekly')">Haftalık</button>
<button class="pill" id="repTabMonthlyBtn" onclick="showReportTab('monthly')">Aylık</button>
</div>
<button class="pill modalClose" onclick="closeReportModal()">Kapat ×</button>
</div>
<div class="active" id="repTab-daily">
<div class="sectionTitle" id="tsdTitle"></div>
<!-- Takvim (tsdDays içinde üretilecek) -->
<div id="tsdDays"></div>
<!-- Seçilen Gün Kartı -->
<div id="selDayBlock" style="margin-top:12px">
<div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
<div id="tsdDayTable"></div>
</div>
<!-- Genel Toplam -->
<div class="sectionTitle" style="margin-top:12px">Genel Toplam (Ders Bazlı)</div>
<div id="tsdTotals"></div>
</div><div id="repTab-weekly">
<div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
<div class="smallRow" id="weekControls">
<div class="smallRow" id="weekList"></div>
<div id="pdfBtns" style="margin-left:auto">
<button class="action" disabled="" id="btnExportPDF" onclick="exportSelectedWeekPDF()" style="max-width:220px">PDF Dışa Aktar</button>
</div>
</div>
<div id="weekChartWrap"><canvas height="140" id="weekChart"></canvas></div>
<div class="exportCard" id="weekMatrix" style="margin-top:10px"></div>
<div class="ghost" id="weekHint" style="margin-top:6px">Haftalar pazartesiden başlayarak pazartesi–pazar aralığına göre numaralandırılır.</div>
</div>
<div id="repTab-monthly">
<div class="sectionTitle">Ay Seç</div>
<select id="tMonthSelect" onchange="selectTeacherMonth(this.value)" style="width:100%;max-width:420px;"></select>
<div id="tMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="tMonthChart"></canvas>
</div>
<div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
<div class="exportCard" id="tMonthTotals"></div>
</div>
</div>
<!-- PDF için görünmeyen export alanı -->
<div id="exportArea" style="position:absolute; left:-99999px; top:-99999px">
<div id="exportHead">
<h1>Haftalık Gelişim Raporu</h1>
<span id="exportRange" style="color:#a5b4fc;font-weight:700;"></span>
</div>
<h2 id="exportStudent"></h2>
<div class="exportCard" style="margin-bottom:10px">
<canvas height="260" id="exportChart"></canvas>
</div>
<div class="exportCard" id="exportTable"></div>
<div id="exportLegend">Ders × Gün matrisi (Pzt–Paz). Renkler ve tipografi PDF için optimize edilmiştir.</div>
</div>
<!-- === Goals Full Page (Student/Teacher) — MODERN === -->
<div id="goalsPage" style="display:none">
<div class="gp-header">
<div class="gp-left">
<button class="pill gp-btn gp-back" onclick="backFromGoalsPage()" title="Geri Dön" type="button">
<span aria-hidden="true" class="icon">
<!-- back -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path><path d="M21 12H9"></path></svg>
</span>
        Geri
      </button>
<div class="gp-title">🎯 Ders Soru Sayısı Hedefleri</div>
</div>
<div class="gp-actions">
<button class="pill gp-btn gp-clear" onclick="resetGoalsInputs()" type="button">
<span aria-hidden="true" class="icon">
<!-- temizle (broom) -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24"><path d="M3 20l1-5 11-11 3 3L7 18l-4 2z"></path><path d="M14 6l4 4"></path></svg>
</span>
        Temizle
      </button>
<button class="action gp-btn" onclick="saveLessonGoals()" type="button">
<span aria-hidden="true" class="icon">
<!-- kaydet (check) -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
</span>
        Kaydet
      </button>
</div>
</div>
<!-- Tablo kutusu -->
<div class="gp-table">
<div class="gp-row">
<label class="gp-label turkce"><span class="dot"></span>Türkçe</label>
<input class="gp-input" id="lg-Turkce" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label sosyal"><span class="dot"></span>Sosyal Bilgiler</label>
<input class="gp-input" id="lg-Sosyal" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label din"><span class="dot"></span>Din Kültürü</label>
<input class="gp-input" id="lg-Din" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label ing"><span class="dot"></span>İngilizce</label>
<input class="gp-input" id="lg-Ingilizce" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label matematik"><span class="dot"></span>Matematik</label>
<input class="gp-input" id="lg-Matematik" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label fen"><span class="dot"></span>Fen Bilimleri</label>
<input class="gp-input" id="lg-Fen" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
</div>
<p class="gp-note">Not: Kaydet ile eski hedefler silinir, girilen son hedefler saklanır.</p>
</div>

<script>
    /* ============ Firebase Config ============ */
    const firebaseConfig = {
      apiKey: "AIzaSyD-D-Jp8GDuoc2b-My7cOpSViRyrcAypX0",
      authDomain: "kocluksistemi-69e89.firebaseapp.com",
      databaseURL: "https://sorutakipsistemi-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "kocluksistemi-69e89",
      storageBucket: "kocluksistemi-69e89.appspot.com",
      messagingSenderId: "1025155254767",
      appId: "1:1025155254767:web:492d53b2d6f36d0ea88e1a",
      measurementId: "G-PZMLQHZP2L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ============ Global Durum ============ */
    let currentStudent=null;
    let currentStudentName=null; 
    let currentTeacherId=null, currentTeacherName=null;
    let stuWeekChart=null, stuMonthChart=null, _stuWeeks=[], _stuMonths=[];
    let favoritesCache={}, classesMap={}, activeClassName=null, currentDetailNum=null;
    let currentDetailLessons=null, currentWeeks=[], selectedWeekKey=null, weekChart=null;
    let currentTargetEditNum = null;
    let selectClassRenderToken = 0;
    let favRef = null;
    let classesRef = null;
    window._MAIN_PANELS = ['teacherPanel','studentPanel','loginPanel','goalsPage'];
    window.activeRole = 'student';

    const TRASH_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZWY0NDQ0Ij4KICA8cGF0aCBkPSJNOSAyaDZ2Mmg1djJINFY0aDVWMnptLTMgNmgxMmwtMSAxMmEyIDIgMCAwIDEtMiAySDlhMiAyIDAgMCAxLTItMkw2IDh6bTQgM3Y3aDJ2LTdoLTJ6bTQgMHY3aDJ2LTdoLTJ6Ii8+Cjwvc3ZnPg==";
    const PARENT_PORTAL_URL = "veli.html"; 
    
    /* ============ YARDIMCI FONKSİYONLAR ============ */
    function setAlert(msg){
      const a=document.getElementById('alert');
      if(!msg){ a.style.display='none'; a.textContent=''; return; }
      a.textContent=msg; a.style.display='block';
      setTimeout(()=>{ a.style.display='none'; }, 3500);
    }

    function showTab(tab){
      const rc = document.getElementById('roleChoice');
      if (rc) rc.style.display = 'none';
      if (typeof currentStudent !== 'undefined') currentStudent = null;
      ["register","studentLogin","teacherLogin"].forEach(id=>{
        document.getElementById(id).style.display = (id===tab) ? "block" : "none";
      });
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
      if(tab==="register") document.getElementById("tabRegister").classList.add("active");
      if(tab==="studentLogin") document.getElementById("tabStudent").classList.add("active");
      if(tab==="teacherLogin") document.getElementById("tabTeacher").classList.add("active");
    }

    function normalizeId(str){
      if(!str) return "";
      const map={'ç':'c','ğ':'g','ı':'i','i':'i','ö':'o','ş':'s','ü':'u','Ç':'c','Ğ':'g','İ':'i','I':'i','Ö':'o','Ş':'s','Ü':'u'};
      return str.trim().toLowerCase()
        .replace(/[çğıİiöşüÇĞIÖŞÜ]/g, m=>map[m]||m)
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'');
    }

    function escHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function escAttr(s){ return escHTML(s); }

    function toTitleCaseTR(str){
      if(!str) return "";
      return String(str).toLocaleLowerCase('tr-TR')
        .split(/\s+/).map(part=>{
          return part.split('-').map(seg=>{
            if(!seg) return seg;
            return seg.charAt(0).toLocaleUpperCase('tr-TR') + seg.slice(1);
          }).join('-');
        }).join(' ');
    }

    function isPrivilegedTeacher(){
      if(!currentTeacherName) return false;
      const low = s=>s.trim().toLocaleLowerCase('tr-TR');
      return low(currentTeacherName) === low("Uğur Yaşayan");
    }
    
    function parseTRDateStr(dstr){ const [dd,mm,yy]=dstr.split('.').map(x=>parseInt(x,10)); return new Date(yy, mm-1, dd); }
    function formatTR(d){ return d.toLocaleDateString("tr-TR"); }
    function mondayOf(date){ const d=new Date(date.getFullYear(),date.getMonth(),date.getDate()); const day=d.getDay(); const diff=(day===0?-6:1-day); d.setDate(d.getDate()+diff); d.setHours(0,0,0,0); return d; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

    /* ============ GİRİŞ & OTURUM YÖNETİMİ ============ */
    function studentRegister(){
      const name=document.getElementById("rName").value.trim();
      const sclass=document.getElementById("rClass").value;
      const num=document.getElementById("rNumber").value.trim();
      const pass=document.getElementById("rPass").value;
      const pass2=document.getElementById("rPass2").value;

      if(!name||!sclass||!num||!pass||!pass2){
        setAlert("Tüm alanları doldurun."); return;
      }
      if(pass!==pass2){
        setAlert("Şifreler eşleşmiyor. Lütfen şifreyi iki kez aynı girin."); return;
      }
      db.ref("students/"+num).get().then(snap=>{
        if(snap.exists()){
          setAlert("Bu okul numarası zaten kayıtlı.");
          return Promise.reject("duplicate");
        }
        return db.ref("students/"+num).set({name: toTitleCaseTR(name),sclass,num,pass});
      }).then(()=>{
        setAlert("Kayıt başarılı! Giriş yapabilirsiniz.");
        showTab("studentLogin");
      }).catch(e=>{
        if(e!=="duplicate") setAlert("Hata: "+e.message);
      });
    }

    function studentLogin(){
      const num=document.getElementById("lNumber").value.trim();
      const pass=document.getElementById("lPass").value;
      db.ref("students/"+num).get().then(snap=>{
        if(snap.exists() && snap.val().pass===pass){
          currentStudent = num;
          document.getElementById("lPass").value="";
          showRoleChoice(snap.val());
        }else{
          setAlert("Numara veya şifre hatalı.");
        }
      });
    }

    function teacherLogin(){
      const name=document.getElementById("tName").value.trim();
      const code=document.getElementById("tCode").value;
      if(!name || !code){ setAlert("Ad Soyad ve kod gerekli."); return; }
      if(code!=="703504"){ setAlert("Kod hatalı."); return; }
      currentTeacherName = name;
      currentTeacherId = normalizeId(name);
      if(!currentTeacherId){ setAlert("Geçerli bir ad giriniz."); return; }

      db.ref("teachers/"+currentTeacherId).set({ name: currentTeacherName, createdAt: firebase.database.ServerValue.TIMESTAMP }).catch(()=>{});
      document.getElementById("teacherWelcome").textContent = `Hoş geldiniz, ${toTitleCaseTR(currentTeacherName)}`;
      document.getElementById("loginPanel").style.display="none";
      document.getElementById("teacherPanel").style.display="block";

      listenClasses();
      listenFavorites();
    }
    
    function logout(){
      const rc=document.getElementById('roleChoice'); if(rc) rc.style.display='none';
      if(classesRef){ classesRef.off(); classesRef=null; }
      if(favRef){ favRef.off(); favRef=null; }

      currentStudent=null; currentDetailNum=null; currentStudentName=null;
      try{ var b=document.getElementById('studentWelcome'); if(b){ b.style.display='none'; b.textContent=''; } }catch(_){ }
      try{ setStudentTargetInfo(null); }catch(_){ }
      currentTeacherId=null; currentTeacherName=null; favoritesCache={};
      ["rName","rNumber","rPass","rPass2","lNumber","lPass","tName","tCode","newClass"].forEach(id=>{const el=document.getElementById(id); if(el) el.value="";});
      ["studentPanel","teacherPanel","teacherStudentDetail", "goalsPage"].forEach(id=>document.getElementById(id).style.display="none");
      document.getElementById("loginPanel").style.display="block";
      showTab("studentLogin");
      destroyWeekChart();
      activeRole = 'student';
      applyRoleUi();
    }
    
    function exitToHome(){
      logout();
    }

    /* ============ ROL SEÇİMİ (ÖĞRENCİ/VELİ) ============ */
    function showRoleChoice(student){
      try{ currentStudentName = (student && student.name) ? student.name : null; }catch(_){}
      const reg=document.getElementById("register");
      const stu=document.getElementById("studentLogin");
      const tea=document.getElementById("teacherLogin");
      const rc =document.getElementById("roleChoice");
      if(reg) reg.style.display="none";
      if(stu) stu.style.display="none";
      if(tea) tea.style.display="none";
      if(rc)  rc.style.display="block";
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
      const prettyName = toTitleCaseTR((student && student.name) ? student.name : "");
      const hello = document.getElementById("roleChoiceHello");
      if(hello){
        if(prettyName){
          hello.textContent = `${prettyName} (${student.num}) olarak giriş yaptınız. Lütfen devam edin.`;
        }else{
          hello.textContent = "Giriş başarılı. Lütfen devam edin.";
        }
      }
    }

    function enterAsStudent(){
      activeRole = 'student';
      document.getElementById("roleChoice").style.display="none";
      document.getElementById("loginPanel").style.display="none";
      document.getElementById("studentPanel").style.display="block";
      setWelcomeStudentBanner();
      loadStudentTarget();
      try{ loadLessonGoals(); }catch(_){}
      showStudentTab('entry');
      loadStudentData();
      applyRoleUi();
    }

    function enterAsParent(){
      activeRole = 'parent';
      var rc = document.getElementById('roleChoice'); if(rc) rc.style.display='none';
      var lp = document.getElementById('loginPanel'); if(lp) lp.style.display='none';
      var sp = document.getElementById('studentPanel'); if(sp) sp.style.display='block';
      try{ window.showStudentTab('entry'); }catch(_){}
      try{ window.loadStudentData(); }catch(_){}
      applyRoleUi();
    }
    
    function backToRoleChoice() {
        document.getElementById("studentPanel").style.display = "none";
        db.ref("students/"+currentStudent).get().then(snap=>{
            if(snap.exists()){
                showRoleChoice(snap.val());
            } else {
                logout(); 
            }
        });
    }
    
    function setWelcomeStudentBanner(){
      try{
        var box = document.getElementById('studentWelcome');
        if(!box) return;
        var name = currentStudentName;
        function apply(nm){
          var pretty = toTitleCaseTR(nm||'').trim();
          if(pretty){
            box.textContent = 'Sayfana hoş geldin ' + pretty + '.';
            box.style.display = 'block';
          }else{
            box.style.display = 'none';
          }
        }
        if(name){ apply(name); return; }
        if(currentStudent){
          firebase.database().ref('students/' + currentStudent).get().then(function(snap){
            if(snap && snap.exists()){
              currentStudentName = (snap.val() && snap.val().name) ? snap.val().name : null;
              apply(currentStudentName);
            }else{
              box.style.display='none';
            }
          }).catch(function(){ box.style.display='none'; });
        }else{
          box.style.display='none';
        }
      }catch(e){ /* no-op */ }
    }
    
    function applyRoleUi() {
        try {
            var isParent = (window.activeRole === 'parent');
            var title = document.getElementById('studentPanelTitle');
            var barTitle = document.getElementById('studentPanelToolbarTitle');
            if (title) title.textContent = isParent ? 'Veli Paneli' : 'Öğrenci Paneli';
            if (barTitle) barTitle.textContent = isParent ? 'Veli Paneli' : 'Öğrenci Paneli';
            var entryBtn = document.getElementById('stuTabEntryBtn');
            if (entryBtn) {
                entryBtn.textContent = isParent ? 'Günlük Rapor' : 'Soru Girişi';
            }
            document.body.setAttribute('data-role', isParent ? 'parent' : 'student');
        } catch (_) {}
    }


    /* ============ HEDEFLER (Soru Sayısı) ============ */
    function openTargetModal(num, name){
      currentTargetEditNum = String(num||"");
      showMainPanel('goalsPage');
      const titleEl = document.querySelector('#goalsPage .gp-title');
      if (titleEl) titleEl.textContent = `🎯 ${toTitleCaseTR(name)} - Ders Hedefleri`;
      loadLessonGoals(num);
    }
    
    function backFromGoalsPage(){ 
        showMainPanel(currentTeacherId ? 'teacherPanel' : 'studentPanel'); 
    }

    function resetGoalsInputs(){
      ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
        var modal = document.getElementById('lg-' + id);
        if(modal) modal.value = "";
      });
    }

    function saveLessonGoals(){
      const numToSave = currentTargetEditNum || currentStudent;
      if (!numToSave) { setAlert("Hedef kaydedilecek öğrenci bulunamadı."); return; }
      
      var payload = {};
      ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
        var v = parseInt((document.getElementById('lg-' + id)?.value || "0"), 10);
        if(isNaN(v) || v <= 0) v = 0;
        payload[id] = v;
        var main = document.getElementById('goal-' + id);
        if(main){ main.value = v > 0 ? v : ""; }
      });
      try { if (typeof updateGlobalAndProgress === 'function') updateGlobalAndProgress(); } catch(_){}

      var ref = db.ref('students/' + numToSave + '/lessonGoals');
      ref.set(payload)
        .then(function(){
          setAlert('Ders hedefleri kaydedildi.');
          backFromGoalsPage();
        })
        .catch(function(e){
          setAlert('Kayıt hatası: ' + e.message);
        });
    }

    function loadLessonGoals(studentNum){
        const numToLoad = studentNum || currentStudent;
        if(!numToLoad) return;
        
        db.ref('students/' + numToLoad + '/lessonGoals').get().then(function(snap){
            const data = snap.exists() ? snap.val() : {};
            ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
              var v = Number(data[id] || 0);
              var main = document.getElementById('goal-' + id);
              if(main){ main.value = v > 0 ? v : ""; }
              var modal = document.getElementById('lg-' + id);
              if(modal){ modal.value = v > 0 ? v : ""; }
            });
            try { if (typeof updateGlobalAndProgress === 'function') updateGlobalAndProgress(); } catch(_){}
      });
    }

    function openTargetForCurrent(){
      if(!currentStudent){ setAlert("Öğrenci oturumu yok."); return; }
      db.ref("students/"+currentStudent).get().then(s=>{
        const name=(s.exists() && s.val().name) ? s.val().name : "";
        openTargetModal(currentStudent, name);
      }).catch(()=> openTargetModal(currentStudent, ""));
    }
    
    function showMainPanel(id){
        window._MAIN_PANELS.forEach(function(pid){
            var el = document.getElementById(pid);
            if(el){ el.style.display = (pid === id) ? 'block' : 'none'; }
        });
    }
    
    function loadStudentTarget(){
      if(!currentStudent) { setStudentTargetInfo(null); return; }
      db.ref("students/"+currentStudent+"/dailyTarget").get().then(snap=>{
        setStudentTargetInfo(snap.exists()? Number(snap.val())||0 : null);
      }).catch(()=> setStudentTargetInfo(null));
    }
    
    function setStudentTargetInfo(val){
      const box = document.getElementById('studentTargetInfo');
      const span = document.getElementById('studentTargetValue');
      if(!box || !span) return;
      if(val===null || val===undefined || isNaN(Number(val)) || val <= 0){
        box.style.display='none'; span.textContent='—';
      }else{
        span.textContent = String(val);
        box.style.display='flex';
      }
    }


    /* ============ ÖĞRENCİ PANELİ ============ */
    function addAll(){
      if(!currentStudent){ setAlert("Oturum bulunamadı."); return; }
      const map={"Türkçe":"Turkce","Sosyal Bilgiler":"Sosyal","Din Kültürü":"Din","İngilizce":"Ingilizce","Matematik":"Matematik","Fen Bilimleri":"Fen"};
      const now=new Date();
      const timeStr=now.toLocaleDateString("tr-TR")+" "+now.toLocaleTimeString("tr-TR");
      let totalAdded = 0;
      for(const lesson in map){
        let v=parseInt(document.getElementById(map[lesson]).value);
        if(!isNaN(v) && v > 0){
          db.ref("students/"+currentStudent+"/lessons/"+lesson).push({count:v,time:timeStr});
          totalAdded += v;
        }
      }
      if (totalAdded > 0) {
        setAlert(totalAdded + " soru eklendi!");
        document.getElementById("lessonForm").reset();
        updateGlobalAndProgress();
        loadStudentData();
      } else {
        setAlert("Lütfen en az bir derse soru sayısı girin.");
      }
    }
    
    function loadStudentData(){
      const box=document.getElementById("studentRecords");
      box.innerHTML="Yükleniyor...";
      db.ref("students/"+currentStudent+"/lessons").get().then(snap=>{
        const grouped={}; // gün -> { totalPerLesson:{}, keysPerLesson:{} }
        if(snap.exists()){
          const data=snap.val();
          for(const lesson in data){
            for(const key in data[lesson]){
              const e=data[lesson][key];
              const day=(e.time||"").split(" ")[0]||"Bilinmeyen";
              if(!grouped[day]) grouped[day]={ totalPerLesson:{}, keysPerLesson:{} };
              grouped[day].totalPerLesson[lesson]=(grouped[day].totalPerLesson[lesson]||0) + (Number(e.count)||0);
              (grouped[day].keysPerLesson[lesson] ||= []).push(key);
            }
          }
        }

        box.innerHTML = `
          <div id="calendarWrap" class="calendarWrap"></div>
          <div id="selDayBlock" style="margin-top:12px">
            <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
            <div id="stuDayTable"></div>
          </div>
        `;

        const allDays = Object.keys(grouped).map(parseTRDateStr).filter(d=>!isNaN(d));
        const latest = allDays.length ? allDays.sort((a,b)=>a-b)[allDays.length-1] : new Date();
        window._calCtx = {
          grouped,
          selectedDate: latest,
          viewMonthStart: new Date(latest.getFullYear(), latest.getMonth(), 1),
          hasSet: new Set(Object.keys(grouped))
        };

        renderStudentCalendar();
        const dayStr = formatTR(latest);
        if(grouped[dayStr]) showDay(dayStr);
        else document.getElementById("stuDayTable").innerHTML = "<div class='empty'>Henüz veri yok.</div>";

      window._studentLessons = snap.exists() ? (snap.val() || {}) : {};
      prepareStudentReports(window._studentLessons);

      });
    }
    
    function showDay(day){
      const detailsObj = (window._calCtx.grouped && window._calCtx.grouped[day]) ? window._calCtx.grouped[day].totalPerLesson : {};
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html="<table><tr><th>Ders</th><th>O Gün Toplam</th><th>İşlem</th></tr>";
      dersSirasi.forEach(lesson=>{
        const total = detailsObj[lesson] || 0;
        html += `<tr>
          <td>${lesson}</td>
          <td>${total}</td>
          <td><button type="button" class="editBtn" onclick="editAggregated('${day}','${lesson}',${total})">Düzenle</button></td>
        </tr>`;
      });
      html+="</table>";
      document.getElementById("stuDayTable").innerHTML=html;
    }
    
    function editAggregated(day, lesson, oldTotal){
      let nv = prompt(`${day} günü "${lesson}" dersi için yeni toplam değeri girin:`, oldTotal);
      if(nv===null) return;
      nv = parseInt(nv,10);
      if(isNaN(nv)){ setAlert("Geçersiz sayı."); return; }

      const infoAgg = (window._calCtx.grouped && window._calCtx.grouped[day] && window._calCtx.grouped[day].keysPerLesson && window._calCtx.grouped[day].keysPerLesson[lesson])
                      ? window._calCtx.grouped[day].keysPerLesson[lesson] : [];
      const updates = {};
      infoAgg.forEach(key=>{
        updates[`students/${currentStudent}/lessons/${lesson}/${key}`] = null;
      });
      if (nv > 0) {
        const fakeTime = `${day} 12:00:00`;
        const newKey = db.ref().child(`students/${currentStudent}/lessons/${lesson}`).push().key;
        updates[`students/${currentStudent}/lessons/${lesson}/${newKey}`] = {count:nv, time:fakeTime};
      }

      db.ref().update(updates).then(()=>{
        setAlert("Güncellendi.");
        loadStudentData(); 
      }).catch(e=>setAlert("Hata: "+e.message));
    }
    
    /* ============ ÖĞRETMEN PANELİ ============ */
    function addClass(){
      const cls=document.getElementById("newClass").value.trim();
      if(!cls){ setAlert("Sınıf adı girin (örn: 8/A)."); return; }
      db.ref("classes").orderByChild("name").equalTo(cls).get().then(s=>{
        if(s.exists()){ setAlert("Bu sınıf zaten ekli."); return; }
        return db.ref("classes").push({name:cls,createdAt:firebase.database.ServerValue.TIMESTAMP});
      }).then(()=>{ document.getElementById("newClass").value=""; });
    }

    function deleteClassByName(name){
      if(!isPrivilegedTeacher()){
        setAlert("Bu işlemi yapma yetkiniz yok.");
        return;
      }
      const classId = classesMap[name];
      if(!classId){ setAlert("Sınıf id bulunamadı."); return; }
      if(!confirm(`"${name}" sınıfını silmek istiyor musunuz?`)) return;
      db.ref("classes/"+classId).remove()
        .then(()=>{ setAlert("Sınıf silindi."); if(activeClassName===name){ activeClassName=null; document.getElementById("classStudents").style.display="none"; document.getElementById("teacherStudentDetail").style.display="none"; } })
        .catch(e=>setAlert("Silme hatası: "+e.message));
    }

    function listenClasses(){
      if(classesRef){ classesRef.off(); }
      classesRef = db.ref("classes");
      classesRef.on("value",snap=>{
        classesMap = {};
        const names=[]; 
        snap.forEach(ch=>{const v=ch.val(); if(v&&v.name){ names.push(v.name); classesMap[v.name]=ch.key; }});

        const grid=document.getElementById("classGrid"); grid.innerHTML="";
        if(!names.length){ grid.innerHTML="<div class='empty' style='grid-column:1/-1'>Henüz sınıf yok.</div>"; document.getElementById("classStudents").style.display="none"; }

        names.sort().forEach(name=>{
          const card=document.createElement("div"); card.className="classCard";

          const title=document.createElement("div"); title.className="className"; title.textContent=name;
          const pick=document.createElement("button"); pick.className="classPick"; pick.textContent="Öğrencileri Gör";
          pick.onclick=()=>{
            activeClassName=name;
            document.querySelectorAll(".classPick").forEach(b=>b.classList.remove("active"));
            pick.classList.add("active");
            selectClass(name);
          };

          if(isPrivilegedTeacher()){
            const del=document.createElement("button"); 
            del.className="delFloat"; 
            del.setAttribute("title","Sınıfı Sil");
            del.setAttribute("aria-label","Sınıfı Sil");
            del.innerHTML=`<img class="trashIcon" src="${TRASH_ICON}" alt="">`;
            del.onclick=(e)=>{ e.stopPropagation(); deleteClassByName(name); };
            card.appendChild(del);
          }

          card.appendChild(title); 
          card.appendChild(pick);
          grid.appendChild(card);
        });

        const sel=document.getElementById("rClass"); const keep=sel.value;
        sel.innerHTML="<option value=''>Sınıf Seçin</option>";
        names.forEach(n=>{const o=document.createElement("option"); o.value=n; o.text=n; sel.add(o);});
        if(names.includes(keep)) sel.value=keep;

        if(activeClassName){
          const btn=[...document.querySelectorAll(".classPick")].find(b=>b.parentElement.querySelector(".className").textContent===activeClassName);
          if(btn){ btn.classList.add("active"); selectClass(activeClassName); }
        }
      });
    }
    
    function backToClasses() {
        document.getElementById("classStudents").style.display = "none";
        document.querySelectorAll(".classPick").forEach(b => b.classList.remove("active"));
        activeClassName = null;
    }

    function selectClass(name){
      const list=document.getElementById("studentsContainer");
      document.getElementById("classStudents").style.display="block";

      const myToken = ++selectClassRenderToken;
      list.innerHTML = "<div class='empty'>Yükleniyor...</div>";

      db.ref("students").get().then(snap=>{
        if(myToken !== selectClassRenderToken) return;
        if(!snap.exists()){
          list.innerHTML="<div class='empty'>Kayıtlı öğrenci yok.</div>";
          return;
        }

        const uniqByNum = {};
        snap.forEach(ch=>{
          const s=ch.val();
          if(s && s.sclass===name && s.num){
            uniqByNum[String(s.num)] = {name:s.name,num:String(s.num),sclass:s.sclass};
          }
        });

        const nums = Object.keys(uniqByNum)
          .sort((a,b)=> (uniqByNum[a].name||"").localeCompare(uniqByNum[b].name||""));

        if(!nums.length){
          list.innerHTML=`<div class='empty'>${escHTML(name)} sınıfında öğrenci yok.</div>`;
          return;
        }

        let html = "";
        nums.forEach(n=>{
          const s=uniqByNum[n];
          const isFav=!!favoritesCache[s.num];
          const prettyName = toTitleCaseTR(s.name||"");
          html += `
          <div class="studentItem hasDel" id="stu-row-${escAttr(n)}">
            <div class="leftGroup">
              <button class="studentNameBtn" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)}</button>
              <button class="starBtn ${isFav ? "" : "off"}"
                      title="${isFav ? "Favoriden çıkar" : "Favoriye ekle"}"
                      data-role="fav"
                      data-num="${escAttr(s.num)}"
                      data-name="${escAttr(prettyName)}"
                      data-sclass="${escAttr(s.sclass||"")}">${isFav ? "★" : "☆"}</button>
            </div>
            <button class="targetFloat" title="Hedef belirle" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
            <button class="delStuFloat"
                    title="Öğrenciyi Sil"
                    aria-label="Öğrenciyi Sil"
                    data-role="delStudent"
                    data-num="${escAttr(s.num)}"
                    data-name="${escAttr(prettyName)}">
              <img class="trashIcon" src="${TRASH_ICON}" alt="">
            </button>
          </div>`;
        });
        if(myToken === selectClassRenderToken){
          list.innerHTML = html;
        }
      });
    }

    /* ============ FAVORİLER (Öğretmen) ============ */
    function favPath(){ return currentTeacherId ? "teacherData/"+currentTeacherId+"/favorites" : null; }
    
    function listenFavorites(){
      const path=favPath(); if(!path) return;

      if(favRef){ favRef.off(); }
      favRef = db.ref(path);

      favRef.on("value",(snap)=>{
        const uniqueFavorites = new Map();
        const list=[];
        snap.forEach(ch=>{
          const v=ch.val();
          if(!v || !v.num) return;
          const numStr = String(v.num);
          uniqueFavorites.set(numStr, {num:numStr, name:v.name, sclass:v.sclass});
        });
        uniqueFavorites.forEach((value) => { list.push(value); });
        favoritesCache={}; 
        list.forEach(v=> favoritesCache[v.num]=true);
        renderFavorites(list);
        if(activeClassName){
          selectClass(activeClassName);
        }
      });
    }

    document.addEventListener("click",function(e){
      const el = e.target.closest("[data-role]");
      if(!el) return;
      const role = el.dataset.role;
      if(role==="fav"){ const {num,name,sclass}=el.dataset; toggleFavorite(num,name,sclass); }
      if(role==="target"){ const {num,name}=el.dataset; openTargetModal(num,name); }
      if(role==="delStudent"){ const {num,name}=el.dataset; deleteStudent(num,name); }
    });

    function toggleFavorite(num,name,sclass){
      const path=favPath(); if(!path){ setAlert("Öğretmen oturumu yok."); return; }
      const ref=db.ref(path+"/"+num);
      if(favoritesCache[num]) ref.remove().catch(e=>setAlert("Favoriden çıkarma hatası: "+e.message));
      else ref.set({num,name,sclass,createdAt:firebase.database.ServerValue.TIMESTAMP})
              .catch(e=>setAlert("Favoriye ekleme hatası: "+e.message));
    }

    function deleteStudent(num,name){
      if(!confirm(`"${name} (${num})" öğrencisini silmek istiyor musunuz?`)) return;
      const updates={}; updates["students/"+num]=null;
      db.ref("teacherData").get().then(snap=>{
        if(snap.exists()){ snap.forEach(t=>{ updates[`teacherData/${t.key}/favorites/${num}`]=null; }); }
        return db.ref().update(updates);
      }).then(()=>{
        setAlert("Öğrenci silindi.");
        if(currentDetailNum===num){ currentDetailNum=null; document.getElementById("teacherStudentDetail").style.display="none"; }
        if(activeClassName){
          selectClass(activeClassName);
        }
      }).catch(e=>setAlert("Öğrenci silme hatası: "+e.message));
    }

    function renderFavorites(items){
      const box=document.getElementById("favoritesList");
      if(!items || !items.length){ box.innerHTML="<div class='empty'>Henüz favori yok.</div>"; return; }
      
      const uniqueMap = new Map();
      items.forEach(item => {
        if (item && item.num) uniqueMap.set(String(item.num), item);
      });
      const uniq = Array.from(uniqueMap.values());
      
      uniq.sort((a,b)=> (a.sclass||"").localeCompare(b.sclass||"") || (a.name||"").localeCompare(b.name||""));
      box.innerHTML = uniq.map(s=>{
        const prettyName = toTitleCaseTR(s.name||"");
        return `
        <div class="studentItem" id="fav-row-${escAttr(s.num)}">
          <div class="leftGroup">
            <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)} – <span style="opacity:.8">${escHTML(s.sclass||'')}</span></button>
            <button class="starBtn" title="Favoriden çıkar" data-role="fav" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}" data-sclass="${escAttr(s.sclass||'')}">★</button>
            <button class="targetBtn" title="Hedef belirle" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
          </div>
        </div>`;
      }).join("");
    }
    
    function showTeacherSection(sec){
      const tabClasses = document.getElementById('tabClasses');
      const tabFavorites = document.getElementById('tabFavorites');
      const classesSection = document.getElementById('classesSection');
      const favoritesSection = document.getElementById('favoritesSection');
      if(sec==='classes'){
        classesSection.style.display='block'; favoritesSection.style.display='none';
        tabClasses.classList.add('active'); tabFavorites.classList.remove('active');
      }else{
        classesSection.style.display='none'; favoritesSection.style.display='block';
        tabFavorites.classList.add('active'); tabClasses.classList.remove('active');
      }
    }

    /* ============ RAPORLAMA (Öğrenci & Öğretmen) ============ */
    
    function teacherShowStudent(num){
      openReportModal();
      currentDetailNum=num;
      destroyWeekChart();
      db.ref("students/"+num).get().then(snap=>{
        if(!snap.exists()){ setAlert("Öğrenci bulunamadı."); return; }
        const s=snap.val();
        const prettyName = toTitleCaseTR(s.name||"");
        document.getElementById("tsdTitle").textContent = `${prettyName} (${s.num}) – ${s.sclass}`;
        const lessons=s.lessons||{};
        currentDetailLessons = lessons;

        const dayMap={}, totals={};
        for(const l in lessons){
          for(const k in lessons[l]){
            const e=lessons[l][k]; const d=(e.time||"").split(" ")[0]||"";
            if(!dayMap[d]) dayMap[d]={}; if(!dayMap[d][l]) dayMap[d][l]=0; dayMap[d][l]+=Number(e.count)||0;
            if(!totals[l]) totals[l]=0; totals[l]+=Number(e.count)||0;
          }
        }
        
        tsdBuildCtxFromLessons(dayMap);
        renderTeacherCalendar();
        const dayKeys = Object.keys(dayMap||{}).sort((a,b)=> parseTRDateStr(a) - parseTRDateStr(b) );
        if(dayKeys.length){
            tsdSelectDate(dayKeys[dayKeys.length-1]);
        }else{
            const t = document.getElementById("tsdDayTable");
            if(t) t.innerHTML = "<div class='empty'>Gün bulunamadı.</div>";
        }
    
        renderTotalsTable(totals,"tsdTotals");

        currentWeeks = buildWeeksFromLessons(lessons);
        renderWeekList(currentWeeks);
        if(currentWeeks.length){ selectWeek(currentWeeks[currentWeeks.length-1].key); } else { clearWeekArea(); }
        buildTeacherMonths(lessons);
      });
    }

    function renderTotalsTable(totals,targetId){
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html="<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
      dersSirasi.forEach(l => {
        const value = totals[l] || 0;
        html += `<tr><td>${l}</td><td>${value}</td></tr>`;
      });
      html+="</table>";
      document.getElementById(targetId).innerHTML=html;
    }

    function teacherShowStudentDay(num,day){
        let perLesson={};
        const data = currentDetailLessons || {};
        for(const l in data){
            for(const k in data[l]){
              const e=data[l][k]; const d=(e.time||"").split(" ")[0]||"";
              if(d===day){ if(!perLesson[l]) perLesson[l]=0; perLesson[l]+=Number(e.count)||0; }
            }
        }
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        let html="<table><thead><tr><th>Ders</th><th>O Gün Çözülen</th></tr></thead><tbody>";
        dersSirasi.forEach(l => {
          const value = perLesson[l] || 0;
          html += `<tr><td>${l}</td><td>${value}</td></tr>`;
        });
        html+="</tbody></table>";
        document.getElementById("tsdDayTable").innerHTML=html;
    }

    function buildWeeksFromLessons(lessons){
      let minDate=null, maxDate=null;
      for(const l in lessons){
        for(const k in lessons[l]){
          const e=lessons[l][k];
          const d=parseTRDateStr((e.time||"").split(" ")[0]||"");
          if(isNaN(d)) continue;
          if(!minDate||d<minDate) minDate=d;
          if(!maxDate||d>maxDate) maxDate=d;
        }
      }
      if(!minDate) return [];
      let curStart=mondayOf(minDate);
      const lastStart=mondayOf(new Date()); 
      const out=[];
      while(curStart<=lastStart){
        const curEnd=addDays(curStart,6);
        out.push({ key: curStart.toISOString().slice(0,10), start: new Date(curStart), end: curEnd, label:"" });
        curStart=addDays(curStart,7);
      }
      out.forEach((w,i)=>{ w.label=`${i+1}. Hafta (${formatTR(w.start)} - ${formatTR(w.end)})`; });
      return out;
    }
    
    function aggregateWeekDetailed(lessons, week){
      const dayLabels=["Pzt","Sal","Çar","Per","Cum","Cmt","Paz"];
      const daily=[0,0,0,0,0,0,0];
      const perLessonPerDay = {};
      const allLessons = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      allLessons.forEach(l=>perLessonPerDay[l]=[0,0,0,0,0,0,0]);
      if(!lessons) return {dayLabels,daily,perLessonPerDay};
      for(const l in lessons){
        for(const k in lessons[l]){
          const e=lessons[l][k];
          const dStr=(e.time||"").split(" ")[0]||"";
          if(!dStr) continue;
          const d=parseTRDateStr(dStr);
          if(isNaN(d)) continue;
          if(d>=week.start && d<=week.end){
            const dow=(d.getDay()+6)%7;
            const cnt=Number(e.count)||0;
            daily[dow]+=cnt;
            if(!perLessonPerDay[l]) perLessonPerDay[l]=[0,0,0,0,0,0,0];
            perLessonPerDay[l][dow]+=cnt;
          }
        }
      }
      return {dayLabels,daily,perLessonPerDay};
    }
    
    function buildMatrixTableHTML(perLessonPerDay, dayLabels){
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html = `<div class="sectionTitle" style="margin:0 0 6px">Ders × Gün Matrisi</div>`;
      html += `<table><thead><tr><th>Ders</th>${dayLabels.map(d=>`<th>${d}</th>`).join("")}</tr></thead><tbody>`;
      dersSirasi.forEach(lesson=>{
        const row=perLessonPerDay[lesson] || [0,0,0,0,0,0,0];
        html += `<tr><td>${lesson}</td>${row.map(v=>`<td>${v}</td>`).join("")}</tr>`;
      });
      html += `</tbody></table>`;
      return html;
    }
    
    function renderWeekList(weeks){
        const wrap = document.getElementById("weekList");
        if(!wrap){ return; }
        if(!weeks || !weeks.length){
          wrap.innerHTML = "<span class='empty'>Hafta bulunamadı.</span>";
          const pdfBtn = document.getElementById("btnExportPDF");
          if(pdfBtn) pdfBtn.disabled = true;
          return;
        }
        const sorted = weeks.slice().sort((a,b)=> b.start - a.start);
        wrap.innerHTML = `
          <div class="weekDropdown" id="weekDropdown">
            <button type="button" class="wdToggle" id="weekToggle" aria-expanded="false">
              <span class="label">Hafta Seç</span>
              <span class="chev">▾</span>
            </button>
            <div class="wdMenu" id="weekMenu" hidden></div>
          </div>
        `;
        const menu = document.getElementById("weekMenu");
        const toggle = document.getElementById("weekToggle");
        menu.innerHTML = sorted.map(w=>`<button type="button" class="wdItem" data-key="${w.key}">${w.label}</button>`).join("");
        function closeMenu(){
          if(!menu.classList.contains('open')) return;
          menu.classList.remove('open'); menu.setAttribute('hidden','');
          toggle.setAttribute('aria-expanded','false');
          if(window._wkOutside){ document.removeEventListener('click', window._wkOutside); window._wkOutside = null; }
        }
        function openMenu(){
          if(menu.classList.contains('open')) return;
          menu.classList.add('open'); menu.removeAttribute('hidden');
          toggle.setAttribute('aria-expanded','true');
          window._wkOutside = function(ev){ if(!wrap.contains(ev.target)){ closeMenu(); } };
          document.addEventListener('click', window._wkOutside);
        }
        toggle.onclick = ()=>{ (menu.classList.contains('open') ? closeMenu() : openMenu()); };
        menu.addEventListener('click', (ev)=>{
          const btn = ev.target.closest('.wdItem');
          if(!btn) return;
          const key = btn.dataset.key;
          selectWeek(key);
          const wk = sorted.find(w=>w.key===key);
          const lab = toggle.querySelector('.label'); if(lab && wk) lab.textContent = wk.label;
          menu.querySelectorAll('.wdItem').forEach(x=>x.classList.toggle('active', x===btn));
          closeMenu();
        });
        const latest = sorted[0];
        if(latest){
          const lab = toggle.querySelector('.label'); if(lab) lab.textContent = latest.label;
          const firstBtn = menu.querySelector('.wdItem');
          if(firstBtn) firstBtn.classList.add('active');
        }
    }

    function selectWeek(weekKey){
      selectedWeekKey=weekKey;
      document.getElementById("btnExportPDF").disabled=false;
      drawWeek(currentDetailLessons, currentWeeks.find(w=>w.key===weekKey));
    }

    function clearWeekArea(){
      destroyWeekChart();
      document.getElementById("weekMatrix").innerHTML="";
      const ctx=document.getElementById("weekChart").getContext('2d'); ctx.clearRect(0,0,9999,9999);
      document.getElementById("btnExportPDF").disabled=true;
    }

    function drawWeek(lessons, week){
      if(!week){ clearWeekArea(); return; }
      const {dayLabels,daily,perLessonPerDay}=aggregateWeekDetailed(lessons, week);

      destroyWeekChart();
      const ctx=document.getElementById("weekChart").getContext("2d");
      weekChart=new Chart(ctx,{
        type:"line",
        data:{ labels:dayLabels, datasets:[{ label:`${week.label} Günlük Toplam`, data:daily, tension:0.35, pointRadius:3, borderWidth:2, fill:false }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ labels:{ color:"#e2e8f0" } } } }
      });

      const matDiv=document.getElementById("weekMatrix");
      matDiv.innerHTML = buildMatrixTableHTML(perLessonPerDay, dayLabels);

      prepareExportDOM(week, dayLabels, daily, perLessonPerDay);
    }
    
    function destroyWeekChart(){ if(weekChart){ weekChart.destroy(); weekChart=null; } }

    function prepareExportDOM(week, dayLabels, daily, perLessonPerDay){
      const title=document.getElementById("tsdTitle").textContent;
      document.getElementById("exportStudent").textContent = title;
      document.getElementById("exportRange").textContent = week.label;

      const ctx=document.getElementById("exportChart").getContext("2d");
      if(window._exportChart) { window._exportChart.destroy(); }
      window._exportChart = new Chart(ctx,{
        type:"line",
        data:{ labels:dayLabels, datasets:[{ label:`${week.label} Günlük Toplam`, data:daily, tension:0.35, pointRadius:3, borderWidth:2, fill:false }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ labels:{ color:"#e2e8f0" } } } }
      });

      document.getElementById("exportTable").innerHTML = buildMatrixTableHTML(perLessonPerDay, dayLabels);
    }
    async function exportSelectedWeekPDF(){
      if(!currentDetailNum || !selectedWeekKey) return;
      const { jsPDF } = window.jspdf;
      const exportEl=document.getElementById("exportArea");
      const canvas=await html2canvas(exportEl, { backgroundColor:null, scale:2 });
      const img=canvas.toDataURL("image/png",1.0);
      const pdf=new jsPDF({orientation:"portrait", unit:"pt", format:"a4"});
      const pageW=pdf.internal.pageSize.getWidth();
      const margin=18;
      const drawW=pageW - margin*2;
      const drawH=drawW * (canvas.height/canvas.width);
      pdf.addImage(img,"PNG", margin, 12, drawW, drawH);
      const safeName = (document.getElementById("tsdTitle").textContent || "Rapor").replace(/[^\wğüşöçıİĞÜŞÖÇ\s\-().]/g,"").slice(0,60);
      pdf.save(`${safeName} - ${document.getElementById("exportRange").textContent}.pdf`);
    }
    
    function showStudentTab(tab){
      const tabs = ['entry','week','month'];
      tabs.forEach(t=>{
        const el = document.getElementById('studentTab-' + t);
        if(el) el.style.display = (t===tab) ? 'block' : 'none';
      });
      const btns = {
        entry: document.getElementById('stuTabEntryBtn'),
        week:  document.getElementById('stuTabWeekBtn'),
        month: document.getElementById('stuTabMonthBtn')
      };
      Object.keys(btns).forEach(k=>{
        if(btns[k]) btns[k].classList.toggle('active', k===tab);
      });
      if(tab==='week' && (!_stuWeeks || !_stuWeeks.length) && window._studentLessons){
        prepareStudentReports(window._studentLessons);
      }
      if(tab==='month' && (!_stuMonths || !_stuMonths.length) && window._studentLessons){
        prepareStudentReports(window._studentLessons);
      }
    }

    function prepareStudentReports(lessons){
      _stuWeeks = buildWeeksFromLessons(lessons || {});
      renderStuWeekList(_stuWeeks);
      if(_stuWeeks.length){
        selectStuWeek(_stuWeeks[_stuWeeks.length-1].key);
      }else{
        destroyStuWeekChart();
        const m = document.getElementById('stuWeekMatrix');
        if(m) m.innerHTML = "<div class='empty'>Haftalık veri yok.</div>";
      }

      _stuMonths = buildMonthsFromLessons(lessons || {});
      renderStuMonthList(_stuMonths);
      if(_stuMonths.length){
        selectStuMonth(_stuMonths[_stuMonths.length-1].key);
      }else{
        destroyStuMonthChart();
        const mt = document.getElementById('stuMonthTotals');
        if(mt) mt.innerHTML = "<div class='empty'>Aylık veri yok.</div>";
        try{ const ctx = document.getElementById('stuMonthChart').getContext('2d'); ctx.clearRect(0,0,9999,9999);}catch(_){}
      }
    }

    function renderStuWeekList(weeks){
      const sel = document.getElementById('stuWeekSelect');
      if(!sel) return;
      sel.innerHTML = '';
      weeks.slice().reverse().forEach((w)=>{
        const opt = document.createElement('option');
        opt.value = w.key;
        opt.textContent = w.label;
        sel.add(opt);
      });
      if(weeks.length){ sel.value = weeks[weeks.length-1].key; }
    }

    function selectStuWeek(weekKey){
      const week = (_stuWeeks||[]).find(w=>w.key===weekKey);
      if(!week){ destroyStuWeekChart(); const m=document.getElementById('stuWeekMatrix'); if(m) m.innerHTML=''; return; }
      drawStuWeek(window._studentLessons, week);
    }
    function destroyStuWeekChart(){ if(stuWeekChart){ try{stuWeekChart.destroy();}catch(_){ } stuWeekChart=null; } }

    function drawStuWeek(lessons, week){
      const {dayLabels,daily,perLessonPerDay} = aggregateWeekDetailed(lessons, week);
      destroyStuWeekChart();
      try{
        const ctx = document.getElementById('stuWeekChart').getContext('2d');
        stuWeekChart = new Chart(ctx, {
          type: 'line',
          data: { labels: dayLabels, datasets: [ { label: `${week.label} – Günlük Toplam`, data: daily, tension: 0.35, pointRadius: 3, borderWidth: 2, fill:false } ] },
          options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ labels:{ color:'#e2e8f0' } } } }
        });
      }catch(_){}
      const mat = document.getElementById('stuWeekMatrix');
      if(mat) mat.innerHTML = buildMatrixTableHTML(perLessonPerDay, dayLabels);
    }
    
    function buildMonthsFromLessons(lessons){
      let minDate=null, maxDate=null;
      for(const l in (lessons||{})){
        for(const k in lessons[l]){
          const e = lessons[l][k];
          const d = parseTRDateStr((e.time||'').split(' ')[0]||'');
          if(isNaN(d)) continue;
          if(!minDate || d<minDate) minDate=d;
          if(!maxDate || d>maxDate) maxDate=d;
        }
      }
      if(!minDate) return [];
      const out=[];
      let cur = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
      const end = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
      let idx=0;
      while(cur <= end){
        idx++;
        const start = new Date(cur.getFullYear(), cur.getMonth(), 1);
        const endOf = new Date(cur.getFullYear(), cur.getMonth()+1, 0);
        const key = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
        const label = start.toLocaleDateString('tr-TR', { month:'long', year:'numeric' });
        out.push({ key, start, end: endOf, label, index: idx });
        cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1);
      }
      return out;
    }

    function renderStuMonthList(months){
      const sel = document.getElementById('stuMonthSelect');
      if(!sel) return;
      sel.innerHTML='';
      months.slice().reverse().forEach(m=>{
        const opt = document.createElement('option');
        opt.value = m.key;
        opt.textContent = `${m.index}. Ay (${m.label})`;
        sel.add(opt);
      });
      if(months.length){ sel.value = months[months.length-1].key; }
    }

    function selectStuMonth(key){
      const month = (_stuMonths||[]).find(m=>m.key===key);
      if(!month){ destroyStuMonthChart(); const t=document.getElementById('stuMonthTotals'); if(t) t.innerHTML=''; return; }
      drawStuMonth(window._studentLessons, month);
    }
    function destroyStuMonthChart(){ if(stuMonthChart){ try{stuMonthChart.destroy();}catch(_){ } stuMonthChart=null; } }
    
    function aggregateMonthDaily(lessons, month){
      const daysIn = new Date(month.start.getFullYear(), month.start.getMonth()+1, 0).getDate();
      const labels = Array.from({length:daysIn}, (_,i)=> String(i+1));
      const daily = Array.from({length:daysIn}, ()=>0);
      const totals = {"Türkçe":0,"Sosyal Bilgiler":0,"Din Kültürü":0,"İngilizce":0,"Matematik":0,"Fen Bilimleri":0};
      for(const l in (lessons||{})){
        for(const k in lessons[l]){
          const e = lessons[l][k];
          const dStr = (e.time||'').split(' ')[0]||'';
          if(!dStr) continue;
          const d = parseTRDateStr(dStr);
          if(isNaN(d)) continue;
          if(d >= month.start && d <= month.end){
            const idx = d.getDate()-1;
            const cnt = Number(e.count)||0;
            daily[idx] += cnt;
            if(typeof totals[l] === 'number') totals[l] += cnt;
            else totals[l] = (totals[l]||0) + cnt;
          }
        }
      }
      return { labels, daily, totals };
    }

    function drawStuMonth(lessons, month){
      const { labels, daily, totals } = aggregateMonthDaily(lessons, month);
      destroyStuMonthChart();
      try{
        const ctx = document.getElementById('stuMonthChart').getContext('2d');
        stuMonthChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [ { label: `${month.index}. Ay (${month.label}) – Günlük Toplam`, data: daily, tension: 0.35, pointRadius: 3, borderWidth: 2, fill:false } ] },
          options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ labels:{ color:'#e2e8f0' } } } }
        });
      }catch(_){}
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html = "<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
      dersSirasi.forEach(d=>{
        const v = totals[d] || 0;
        html += `<tr><td>${d}</td><td>${v}</td></tr>`;
      });
      html += "</table>";
      const tgt = document.getElementById('stuMonthTotals');
      if(tgt) tgt.innerHTML = html;
    }
    
    function getGoalFor(id){
      const el = document.getElementById('goal-' + id);
      let g = parseInt(el && el.value ? el.value : '0', 10);
      if(isNaN(g) || g <= 0) g = 0;
      return g;
    }
    function updateRowPct(id, pct){
      const badge = document.querySelector(`[data-pct-for="${id}"]`);
      if(!badge) return;
      badge.textContent = pct + "%";
      badge.classList.remove('zero','low');
      if(pct === 0) badge.classList.add('zero');
      else if(pct < 50) badge.classList.add('low');
    }
    function updateGlobalAndProgress(){
      const ids = ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"];
      let sum = 0;
      ids.forEach(id => {
        const inp = document.getElementById(id);
        if(!inp) return;
        let val = parseInt(inp.value || "0", 10);
        if(isNaN(val) || val < 0){ val = 0; inp.value = 0; }
        sum += val;
        const goal = getGoalFor(id);
        const pct = goal > 0 ? Math.max(0, Math.min(100, Math.round((val/goal) * 100))) : 0;
        const bar = document.querySelector(`.progressBar[data-bar-for="${id}"]`);
        if(bar){ bar.style.width = pct + "%"; }
        updateRowPct(id, pct);
      });
      const badge = document.getElementById("globalTotal");
      if(badge) badge.textContent = sum;
    }

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.numBtn');
      if(!btn) return;
      const id = btn.getAttribute('data-target');
      const step = parseInt(btn.getAttribute('data-step') || '1', 10);
      const inp = document.getElementById(id);
      if(!inp) return;
      const cur = parseInt(inp.value || '0', 10);
      let nv = isNaN(cur) ? 0 : cur;
      nv = nv + step;
      if(nv < 0) nv = 0;
      inp.value = nv;
      try { inp.dispatchEvent(new Event('input', { bubbles:true })); } catch(_) {}
      updateGlobalAndProgress();
    });

    document.addEventListener('input', function(e){
      if(e.target && e.target.matches('#Turkce, #Sosyal, #Din, #Ingilizce, #Matematik, #Fen, #goal-Turkce, #goal-Sosyal, #goal-Din, #goal-Ingilizce, #goal-Matematik, #goal-Fen')){
        updateGlobalAndProgress();
      }
    });
    
    (function(){
      const denseKey = 'lesson-density-enabled';
      function setDense(enabled){
        const list = document.querySelector('.lessonList');
        if(!list) return;
        if(enabled){ list.classList.add('dense'); }
        else{ list.classList.remove('dense'); }
        try { localStorage.setItem(denseKey, enabled ? '1' : '0'); } catch(_) {}
      }
      const savedDense = (function(){ try { return localStorage.getItem(denseKey) !== '0'; } catch(_) { return true; } })(); // default on
      setDense(savedDense);
      document.getElementById('densityToggleBtn')?.addEventListener('click', function(){
        const list = document.querySelector('.lessonList');
        const enabled = !list?.classList.contains('dense');
        setDense(enabled);
      });
    })();
    
    (function(){
      function showPassError(show){
        var err = document.getElementById('passMismatchError');
        var btn = document.getElementById('registerBtn');
        if (err){ err.style.display = show ? 'block' : 'none'; }
        if (btn){ btn.disabled = !!show; btn.style.opacity = show ? '0.6' : ''; btn.style.cursor = show ? 'not-allowed' : ''; }
      }
      function checkPassMatch(){
        var p1 = document.getElementById('rPass');
        var p2 = document.getElementById('rPass2');
        if (!p1 || !p2) return;
        if (p2.value.length === 0){ showPassError(false); return; }
        if (p1.value !== p2.value){ showPassError(true); }
        else { showPassError(false); }
      }
      document.addEventListener('DOMContentLoaded', function(){
        var p1 = document.getElementById('rPass');
        var p2 = document.getElementById('rPass2');
        if (p1) p1.addEventListener('input', checkPassMatch);
        if (p2) p2.addEventListener('input', checkPassMatch);

        var btn = document.getElementById('registerBtn');
        if (btn){
          btn.addEventListener('click', function(ev){
            var p1 = document.getElementById('rPass');
            var p2 = document.getElementById('rPass2');
            if (p1 && p2 && p1.value !== p2.value){
              ev.preventDefault();
              checkPassMatch();
              try{ p2.focus(); }catch(_){}
              return false;
            }
          });
        }
      });
    })();

    function openReportModal(){
      var ov = document.getElementById('reportOverlay');
      var box = document.getElementById('teacherStudentDetail');
      if(ov) ov.style.display='block';
      if(box){ box.style.display='block'; showReportTab('weekly'); }
    }
    function closeReportModal(){
      try{ destroyWeekChart(); }catch(_){}
      try{ destroyTeacherMonthChart(); }catch(_){}
      var ov = document.getElementById('reportOverlay');
      var box = document.getElementById('teacherStudentDetail');
      if(box) box.style.display='none';
      if(ov) ov.style.display='none';
    }
    function showReportTab(tab){
      var tabs = ['daily','weekly','monthly'];
      tabs.forEach(function(t){
        var el = document.getElementById('repTab-' + t);
        if(el) el.style.display = (t === tab ? 'block' : 'none');
        var btn = document.getElementById('repTab' + t.charAt(0).toUpperCase() + t.slice(1) + 'Btn');
        if(btn) btn.classList.toggle('active', t === tab);
      });
      if(tab==='monthly' && window.currentDetailLessons){
        buildTeacherMonths(window.currentDetailLessons);
      }
    }

    (function(){
      function ensureGoalsTitle(){
        try{
          var header = document.querySelector('.header');
          var sub = header && header.querySelector('.subtitle');
          var srcTitle = document.querySelector('#goalsPage .gp-title');
          if(!header || !sub || !srcTitle) return;

          var txt = (srcTitle.textContent || '').trim();
          var el = header.querySelector('.header-goals-title');
          if(!el){
            el = document.createElement('div');
            el.className = 'header-goals-title';
            sub.insertAdjacentElement('afterend', el);
          }
          if((el.textContent || '').trim() !== txt){ el.textContent = txt; }
          var gp = document.getElementById('goalsPage');
          var gpVisible = gp && window.getComputedStyle(gp).display !== 'none';
          el.style.display = gpVisible ? '' : 'none';
        }catch(e){}
      }
      document.addEventListener('DOMContentLoaded', function(){ setTimeout(ensureGoalsTitle, 50); });
      var mo = new MutationObserver(function(){ setTimeout(ensureGoalsTitle, 50); });
      mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:['style','class']});
      window.addEventListener('resize', function(){ setTimeout(ensureGoalsTitle, 100); }, {passive:true});
    })();
    
    document.addEventListener('DOMContentLoaded', function(){
        try{
            var btn = document.getElementById('repTabMonthlyBtn'); if(btn) btn.remove();
            var pane = document.getElementById('repTab-monthly'); if(pane) pane.remove();
        }catch(e){}

        try {
            var h3 = document.querySelector('#studentPanel h3');
            if(h3 && !h3.id && h3.textContent.trim().toUpperCase().includes('ÖĞRENCİ')){ h3.id = 'studentPanelTitle'; }
            var strong = document.querySelector('#studentTab-entry .student-toolbar strong');
            if(strong && !strong.id && strong.textContent.trim().toUpperCase().includes('ÖĞRENCİ')){ strong.id = 'studentPanelToolbarTitle'; }
        }catch(_){}

        setBodyRoleAttr();
        applyRoleUi();
        updateGlobalAndProgress();
    });

    function setBodyRoleAttr(){
        try{ document.body.setAttribute('data-role', (window.activeRole==='parent'?'parent':'student')); }catch(_){}
    }

</script>
</body>
</html>

