<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>ÖĞRENCİ TAKİP PROGRAMI</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --muted: #334155;
      --text: #e2e8f0;
      --accent1: #3b82f6;
      --accent2: #06b6d4;
      --warn: #f97316;
      --ok: #10b981;
      --danger: #ef4444;
      --export-bg: #0b1427;
      --export-head: #93c5fd;
      --card: #0b1427;
      --cardBorder: #263247;
    }
    * { box-sizing: border-box }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Arial, Helvetica, sans-serif
    }
    .header {
      padding: 22px;
      text-align: center;
      font-size: 22px;
      font-weight: 800;
      color: #93c5fd;
      text-transform: uppercase
    }
    .subheader {
      font-size: 16px;
      color: #cbd5e1;
      margin-top: 4px;
      font-weight: 600;
    }
    .tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      max-width: 1080px;
      margin: 0 auto 12px;
      padding: 8px;
      background: var(--panel);
      border-radius: 12px;
      flex-wrap: wrap
    }
    .tabs button {
      flex: 1;
      min-width: 160px;
      padding: 12px;
      border: 0;
      border-radius: 10px;
      background: transparent;
      color: #cbd5e1;
      font-weight: 700;
      cursor: pointer
    }
    .tabs button.active { background: var(--ok); color: #fff }
    .tabs button:focus, .pill:focus, .classPick:focus, .dayBtn:focus, .weekBtn:focus,
    .studentNameBtn:focus, .delStuBtn:focus, .delStuFloat:focus, .delFloat:focus,
    button.action:focus {
      outline: 3px solid rgba(16, 185, 129, .55);
      outline-offset: 2px;
    }
    .container {
      max-width: 1080px;
      margin: 16px auto;
      background: var(--panel);
      border-radius: 16px;
      padding: 22px
    }
    h3 { margin: 0 0 14px }
    input, select {
      width: 100%;
      padding: 12px;
      border: 0;
      border-radius: 10px;
      background: var(--bg);
      color: #e2e8f0;
      margin: 8px 0
    }
    button.action {
      width: 100%;
      padding: 12px;
      border: 0;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      min-height: 48px
    }
    button.logout { background: var(--warn) }
    table { width: 100%; border-collapse: collapse; margin: 10px 0 }
    th, td { border: 1px solid var(--muted); padding: 10px; text-align: center }
    .row { display: flex; gap: 10px; align-items: center }
    .row > .grow { flex: 1 }
    .classGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    .classCard {
      position: relative;
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      padding: 14px 14px 48px;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .classCard:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, .25);
      border-color: #3b4b6a;
    }
    .className { font-weight: 900; font-size: 20px; letter-spacing: .3px; margin-bottom: 8px; }
    .classPick {
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      color: #fff;
      font-weight: 800;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
    }
    .classPick.active { outline: 3px solid rgba(16, 185, 129, .40) }
    .delFloat {
      position: absolute;
      top: 10px;
      right: 10px;
      display: grid;
      place-items: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border: 0;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
      z-index: 2;
    }
    .delFloat img.trashIcon { width: 20px; height: 20px; display: block; }
    .delFloat:hover { transform: translateY(-1px); }
    .delFloat::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(239, 68, 68, .26);
      filter: blur(8px);
      opacity: 0;
      transition: opacity .12s ease;
      z-index: -1;
    }
    .delFloat:hover::before { opacity: 1; }
    .studentItem {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
      padding: 10px;
      background: #0b1427;
      margin: 6px 0;
      border-radius: 10px;
      position: relative;
    }
    .studentItem .leftGroup {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
    }
    .delStuFloat {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      display: grid;
      place-items: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border: 0;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
      z-index: 2;
    }
    .delStuFloat img.trashIcon { width: 18px; height: 18px; display: block; }
    .delStuFloat:hover { transform: translateY(-51%); }
    .delStuFloat::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(239, 68, 68, .26);
      filter: blur(8px);
      opacity: 0;
      transition: opacity .12s ease;
      z-index: -1;
    }
    .delStuFloat:hover::before { opacity: 1; }
    .studentNameBtn {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: left;
      font-weight: 600;
      background: transparent;
      border: none;
      color: #e2e8f0;
      cursor: pointer;
      padding: 0;
      font-size: 15px;
    }
    .studentNameBtn:hover { text-decoration: underline; }
    .starBtn, .targetBtn {
      background: transparent;
      border: none;
      cursor: pointer;
      line-height: 1;
      padding: 4px;
    }
    .starBtn { font-size: 20px; color: #3b82f6; }
    .targetBtn { font-size: 18px; color: #10b981; }
    .editBtn {
      background: var(--muted);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 12px;
      font-weight: 600;
      color: #e2e8f0;
    }
    .pillTabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .pill {
      border: none;
      border-radius: 8px;
      background: var(--muted);
      color: #e2e8f0;
      padding: 6px 12px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .pill.active { background: var(--ok); color: #fff; }
    .pill.exit { background: var(--danger); }
    .exitSmall {
      background: transparent; border: none; cursor: pointer;
      padding: 4px 8px; color: #cbd5e1; display: flex;
      align-items: center; gap: 4px; font-size: 14px;
    }
    .exitSmall .icon { display: inline-block; line-height: 0; }
    .exitSmall .label { display: none; }
    @media(min-width: 768px) { .exitSmall .label { display: inline; } }
    .sectionTitle { font-weight: 800; margin: 16px 0 8px; font-size: 16px; }
    .chip {
      display: inline-block; background: #1e293b; border-radius: 999px;
      padding: 2px 10px; font-size: 12px; font-weight: 600;
      color: #93c5fd; margin-left: 4px;
    }
    .smallRow { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .ghost { opacity: .65; font-size: 13px; }
    .calendarWrap { overflow-x: auto; }
    .calendar { border-collapse: collapse; width: 100%; min-width: 620px; }
    .calendar th, .calendar td {
      border: 1px solid var(--cardBorder);
      padding: 4px; text-align: center; font-size: 12px;
    }
    .calendar th { background: #0b1427; position: sticky; top: 0; z-index: 1; }
    .calendar td.empty { background: #0b1427; }
    .calendar td.current { background: var(--accent1); }
    .calendar td.selected { outline: 2px solid #fff; outline-offset: -2px; }
    .asModal {
      display: none; position: fixed; inset: 0; z-index: 100;
      background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px);
      overflow-y: auto; padding: 20px; max-width: 100%;
      border-radius: 0;
    }
    .modalHead { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modalTabs { display: flex; gap: 8px; }
    /* Hedef Belirleme Modalı */
    .modalOverlay {
        display: none; position: fixed; inset: 0; z-index: 200;
        background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px);
        align-items: center; justify-content: center;
    }
    .modalContent {
        background: var(--panel); border-radius: 16px; padding: 22px;
        width: 100%; max-width: 400px; margin: 16px;
    }
    .modalTitle { font-size: 18px; font-weight: 800; margin: 0 0 14px; }
    .modalActions { display: flex; gap: 10px; margin-top: 16px; }
    .modalActions button { flex: 1; }

    /* Medya sorguları */
    @media(max-width: 768px) {
      .roleGrid { grid-template-columns: 1fr; gap: 12px; }
      .roleCard { padding: 18px 14px; }
      #teacherPanel .classCard { padding-bottom: 76px; }
      #teacherPanel .classPick { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-height: 40px; }
      #teacherPanel .className { margin-bottom: 10px; line-height: 1.15; overflow-wrap: anywhere; }
    }
  </style>
</head>
<body>
  <div class="header">ÖĞRENCİ TAKİP PROGRAMI
    <div class="subheader">Alparslan Ortaokulu</div>
  </div>
  <div id="alert"></div>

  <div id="loginPanel">
    <div class="tabs">
      <button class="active" id="tabRegister" onclick="showTab('register')" type="button">Öğrenci Kayıt</button>
      <button id="tabStudent" onclick="showTab('studentLogin')" type="button">Öğrenci-Veli Giriş</button>
      <button id="tabTeacher" onclick="showTab('teacherLogin')" type="button">Öğretmen Giriş</button>
    </div>
    <div class="container" id="register">
      <h3>Öğrenci Kayıt</h3>
      <input autocomplete="off" id="rName" placeholder="Ad Soyad" type="text" />
      <select id="rClass"><option value="">Sınıf Seçin</option></select>
      <input autocomplete="off" id="rNumber" placeholder="Okul Numarası" type="text" />
      <input autocomplete="new-password" id="rPass" placeholder="Şifre" type="password" />
      <input autocomplete="new-password" id="rPass2" placeholder="Şifre (Tekrar)" type="password" />
      <small id="passMismatchError" style="display:none;color:#ef4444;font-weight:600;">Şifreler eşleşmiyor</small>
      <button class="action" id="registerBtn" onclick="studentRegister()" type="button">Kayıt</button>
    </div>
    <div class="container" id="studentLogin" style="display:none">
      <h3>Öğrenci-Veli Giriş</h3>
      <input autocomplete="off" id="lNumber" placeholder="Okul Numarası" type="text" />
      <input autocomplete="current-password" id="lPass" placeholder="Şifre" type="password" />
      <button class="action" onclick="studentLogin()" type="button">Giriş Yap</button>
    </div>
    <div class="container" id="teacherLogin" style="display:none">
      <h3>Öğretmen Giriş</h3>
      <input autocomplete="name" id="tName" placeholder="Ad Soyad" type="text" />
      <input id="tCode" placeholder="Kod" type="password" />
      <button class="action" onclick="teacherLogin()" type="button">Giriş Yap</button>
    </div>
  </div>

  <div id="studentPanel" style="display:none">
      <div class="container">
          <div class="studentWelcomeBanner" id="studentWelcome" style="display:none; font-size:18px; font-weight:bold; margin-bottom: 16px;"></div>
          <div class="pillTabs" id="studentTabs">
              <button class="pill active" id="stuTabEntryBtn" onclick="showStudentTab('entry')">Soru Girişi</button>
              <button class="pill" id="stuTabWeekBtn" onclick="showStudentTab('week')">Haftalık Rapor</button>
              <button class="pill" id="stuTabMonthBtn" onclick="showStudentTab('month')">Aylık Rapor</button>
          </div>
          <div id="studentTab-entry">
              <div class="targetInfo" id="studentTargetInfo" style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:10px; border-radius:10px; margin:12px 0;">
                  <div><small>Günlük Hedef</small> <span id="studentTargetValue" style="font-weight:bold;">—</span> soru</div>
                  <div><button class="pill" onclick="openTargetForCurrent()" type="button">🎯 Hedef Belirle</button></div>
              </div>
              <form id="lessonForm">
                  <div class="list" style="margin-top:10px">
                      <div class="sectionTitle">Soru Girişi</div>
                      <div class="smallRow" style="margin-bottom:6px">
                          <div class="smallRow grow"><b>Dersler</b></div>
                          <div style="margin-left:auto;"><small style="opacity:.8;">(Adet)</small></div>
                      </div>
                      <div class="smallRow"><div class="smallRow grow">Türkçe</div><input id="Turkce" pattern="[0-9]*" style="max-width:80px;" type="number" /></div>
                      <div class="smallRow"><div class="smallRow grow">Sosyal Bilgiler</div><input id="Sosyal" pattern="[0-9]*" style="max-width:80px;" type="number" /></div>
                      <div class="smallRow"><div class="smallRow grow">Din Kültürü</div><input id="Din" pattern="[0-9]*" style="max-width:80px;" type="number" /></div>
                      <div class="smallRow"><div class="smallRow grow">İngilizce</div><input id="Ingilizce" pattern="[0-9]*" style="max-width:80px;" type="number" /></div>
                      <div class="smallRow"><div class="smallRow grow">Matematik</div><input id="Matematik" pattern="[0-9]*" style="max-width:80px;" type="number" /></div>
                      <div class="smallRow"><div class="smallRow grow">Fen Bilimleri</div><input id="Fen" pattern="[0-9]*" style="max-width:80px;" type="number" /></div>
                  </div>
                  <button class="action" onclick="addAll()" style="margin-top:10px" type="button">Ekle</button>
              </form>
              <div class="list" id="studentRecords" style="margin-top:10px"></div>
          </div>
          <div id="studentTab-week" style="display:none">
              <div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
              <div id="stuWeekChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px"><canvas height="140" id="stuWeekChart"></canvas></div>
              <div class="exportCard" id="stuWeekMatrix" style="margin-top:10px"></div>
              <div class="ghost" style="margin-top:6px">Haftalar pazartesiden başlayarak pazartesi–pazar aralığına göre numaralandırılır.</div>
          </div>
          <div id="studentTab-month" style="display:none">
              <div class="sectionTitle">Ay Seç</div>
              <select id="stuMonthSelect" onchange="selectStudentMonth(this.value)" style="width:100%;max-width:420px;"></select>
              <div id="stuMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px"><canvas height="160" id="stuMonthChart"></canvas></div>
              <div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
              <div class="exportCard" id="stuMonthTotals"></div>
          </div>
          <button class="action logout" onclick="logout()" type="button" style="margin-top:20px;">Çıkış Yap</button>
      </div>
  </div>

  <div id="teacherPanel" style="display:none">
      <div class="container">
          <p class="teacherWelcome" id="teacherWelcome"></p>
          <div class="teacherTopbar" style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0">Öğretmen Paneli</h3>
              <button aria-label="Çıkış" class="exitSmall" onclick="logout()" title="Çıkış" type="button">
                  <span aria-hidden="true" class="icon"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></span>
                  <span class="label">Çıkış</span>
              </button>
          </div>
          <div class="pillTabs" id="teacherTopTabs">
              <button class="pill active" id="tabClasses" onclick="showTeacherSection('classes')">Sınıflar</button>
              <button class="pill" id="tabFavorites" onclick="showTeacherSection('favorites')">Favorilerim</button>
          </div>
          <div id="classesSection">
              <div class="row" style="margin-top:10px; margin-bottom:6px">
                  <input autocomplete="off" class="grow" id="newClass" placeholder="örn: 8/A" type="text" />
                  <button class="action" onclick="addClass()" style="max-width:220px" type="button">Sınıf Ekle</button>
              </div>
              <div class="classGrid" id="classGrid"></div>
              <div class="list" id="classStudents" style="display:none">
                  <div class="sectionTitle">Öğrenciler</div>
                  <div id="studentsContainer"></div>
              </div>
          </div>
          <div id="favoritesSection" style="display:none; margin-top:14px">
              <div class="list">
                  <div class="sectionTitle">Favori Öğrencilerim</div>
                  <div id="favoritesList"></div>
              </div>
          </div>
      </div>
  </div>

  <div class="asModal" id="teacherStudentDetail">
      <div class="modalHead">
          <div class="modalTabs">
              <button class="pill active" id="repTabDailyBtn" onclick="showReportTab('daily')">Günlük</button>
              <button class="pill" id="repTabWeeklyBtn" onclick="showReportTab('weekly')">Haftalık</button>
              <button class="pill" id="repTabMonthlyBtn" onclick="showReportTab('monthly')">Aylık</button>
          </div>
          <button class="pill exit" onclick="closeReportModal()">Kapat ×</button>
      </div>
      <div class="sectionTitle" id="tsdTitle"></div>
      
      <div class="active" id="repTab-daily">
          <div id="tsdDays" class="calendarWrap"></div>
          <div id="selDayBlock" style="margin-top:12px">
              <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
              <div id="tsdDayTable"></div>
          </div>
          <div class="sectionTitle" style="margin-top:12px">Genel Toplam (Ders Bazlı)</div>
          <div id="tsdTotals"></div>
      </div>
      <div id="repTab-weekly" style="display:none;">
          <div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
          <div class="smallRow" id="weekControls">
              <div class="smallRow pillTabs" id="weekList"></div>
              <div id="pdfBtns" style="margin-left:auto">
                  <button class="action" disabled id="btnExportPDF" onclick="exportSelectedWeekPDF()" style="max-width:220px">PDF Dışa Aktar</button>
              </div>
          </div>
          <div id="weekChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px"><canvas height="140" id="weekChart"></canvas></div>
          <div class="exportCard" id="weekMatrix" style="margin-top:10px"></div>
          <div class="ghost" style="margin-top:6px">Haftalar pazartesiden başlayarak pazartesi–pazar aralığına göre numaralandırılır.</div>
      </div>
      <div id="repTab-monthly" style="display:none;">
          <div class="sectionTitle">Ay Seç</div>
          <select id="tMonthSelect" onchange="selectTeacherMonth(this.value)" style="width:100%;max-width:420px;"></select>
          <div id="tMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px"><canvas height="160" id="tMonthChart"></canvas></div>
          <div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
          <div class="exportCard" id="tMonthTotals"></div>
      </div>
  </div>

  <div class="modalOverlay" id="targetModal">
    <div class="modalContent">
      <div class="modalTitle" id="targetModalTitle">Hedef Belirle</div>
      <input id="targetInput" placeholder="Günlük Soru Hedefi" type="number" pattern="[0-9]*" />
      <div class="modalActions">
        <button class="action" onclick="saveTarget()">Kaydet</button>
        <button class="action logout" onclick="closeTargetModal()">İptal</button>
      </div>
    </div>
  </div>

  <div id="exportArea" style="position:absolute; left:-99999px; top:-99999px; width:800px; background:var(--export-bg); padding:20px; color:var(--text);">
    <div id="exportHead" style="text-align:center; margin-bottom: 20px;">
      <h1 style="color:var(--export-head);">Haftalık Gelişim Raporu</h1>
      <span id="exportRange" style="color:#a5b4fc;font-weight:700;"></span>
    </div>
    <h2 id="exportStudent" style="text-align:center; margin-bottom: 15px;"></h2>
    <div class="exportCard" style="margin-bottom:10px">
      <canvas height="260" id="exportChart"></canvas>
    </div>
    <div class="exportCard" id="exportTable"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-D-Jp8GDuoc2b-My7cOpSViRyrcAypX0",
      authDomain: "kocluksistemi-69e89.firebaseapp.com",
      databaseURL: "https://kocluksistemi-69e89-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kocluksistemi-69e89",
      storageBucket: "kocluksistemi-69e89.firebasestorage.app",
      messagingSenderId: "1025155254767",
      appId: "1:1025155254767:web:492d53b2d6f36d0ea88e1a",
      measurementId: "G-PZMLQHZP2L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ============ Global Durum ============ */
    const TRASH_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2Y4NzE3MSI+PHBhdGggZD0iTTMgNmgxOHYyaC0yLjM0bC0xLjY3IDEyLjVBNCA0IDAgMCAxIDEzIDE0aC0yYTQgNCAwIDAgMS0zLjk5LTMuNUwxMS4zNCA4SDlWNkg2djJINXptMTAgMkg4bDEuNSAxMS4yNUEyIDIgMCAwIDAgMTEuNSAydjJoMWEyIDIgMCAwIDAgMS45OS0xLjc1TDggNnoiLz48L3N2Zz4=';
    const DERSLER = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
    const DERS_IDS = { "Türkçe": "Turkce", "Sosyal Bilgiler": "Sosyal", "Din Kültürü": "Din", "İngilizce": "Ingilizce", "Matematik": "Matematik", "Fen Bilimleri": "Fen" };
    
    let currentStudent = null, currentStudentName = null;
    let currentTeacherId = null, currentTeacherName = null;
    let currentTargetEditNum = null;
    let stuWeekChart = null, stuMonthChart = null;
    let favoritesCache = {}, classesMap = {}, activeClassName = null, currentDetailNum = null;
    let currentDetailLessons = null, currentWeeks = [], selectedWeekKey = null, weekChart = null;
    let selectClassRenderToken = 0;
    let favRef = null, classesRef = null;

    /* ============ Yardımcılar ============ */
    function setAlert(msg, isError = false) {
      const a = document.getElementById('alert');
      if (!msg) {
        a.style.display = 'none'; a.textContent = ''; return;
      }
      a.textContent = msg;
      a.style.background = isError ? 'var(--danger)' : 'var(--ok)';
      a.style.display = 'block';
      setTimeout(() => { a.style.display = 'none'; }, 3500);
    }

    function showTab(tab) {
      ["register", "studentLogin", "teacherLogin"].forEach(id => {
        document.getElementById(id).style.display = (id === tab) ? "block" : "none";
      });
      document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
      if (tab === "register") document.getElementById("tabRegister").classList.add("active");
      if (tab === "studentLogin") document.getElementById("tabStudent").classList.add("active");
      if (tab === "teacherLogin") document.getElementById("tabTeacher").classList.add("active");
    }

    function normalizeId(str) {
      if (!str) return "";
      const map = { 'ç': 'c', 'ğ': 'g', 'ı': 'i', 'ö': 'o', 'ş': 's', 'ü': 'u', 'Ç': 'C', 'Ğ': 'G', 'İ': 'I', 'Ö': 'O', 'Ş': 'S', 'Ü': 'U' };
      return str.replace(/[çğıöşüÇĞİÖŞÜ]/g, m => map[m]).replace(/[^a-zA-Z0-9 -]/g, '').trim().replace(/\s+/g, '-');
    }

    function escHTML(s) { return String(s || "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
    function escAttr(s) { return escHTML(s); }

    function toTitleCaseTR(str) {
      if (!str) return "";
      return str.toLowerCase().split(' ').map(word => word.charAt(0).toLocaleUpperCase('tr-TR') + word.slice(1)).join(' ');
    }
    
    function isPrivilegedTeacher() {
      return currentTeacherName && currentTeacherName.trim().toLowerCase() === "emre demirbaş";
    }

    document.addEventListener('DOMContentLoaded', () => {
        const pass1 = document.getElementById('rPass');
        const pass2 = document.getElementById('rPass2');
        const errorMsg = document.getElementById('passMismatchError');
        const checkPasswords = () => {
            if (pass1.value && pass2.value && pass1.value !== pass2.value) {
                errorMsg.style.display = 'block';
            } else {
                errorMsg.style.display = 'none';
            }
        };
        pass1.addEventListener('input', checkPasswords);
        pass2.addEventListener('input', checkPasswords);
    });

    /* ============ Öğrenci Kayıt & Giriş ============ */
    function studentRegister() {
      const name = document.getElementById("rName").value.trim();
      const sclass = document.getElementById("rClass").value;
      const num = document.getElementById("rNumber").value.trim();
      const pass = document.getElementById("rPass").value;
      const pass2 = document.getElementById("rPass2").value;

      if (!name || !sclass || !num || !pass || !pass2) return setAlert("Tüm alanları doldurun.", true);
      if (pass !== pass2) return setAlert("Şifreler eşleşmiyor.", true);
      
      db.ref("students/" + num).get().then(snap => {
        if (snap.exists()) {
          setAlert("Bu okul numarası zaten kayıtlı.", true);
          return Promise.reject("duplicate");
        }
        return db.ref("students/" + num).set({ name, sclass, num, pass });
      }).then(() => {
        setAlert("Kayıt başarılı! Şimdi giriş yapabilirsiniz.");
        showTab("studentLogin");
      }).catch(e => {
        if (e !== "duplicate") setAlert("Hata: " + e.message, true);
      });
    }

    function studentLogin() {
      const num = document.getElementById("lNumber").value.trim();
      const pass = document.getElementById("lPass").value;
      if (!num || !pass) return setAlert("Numara ve şifre gerekli.", true);
      
      db.ref("students/" + num).get().then(snap => {
        if (snap.exists() && snap.val().pass === pass) {
          currentStudent = num;
          currentStudentName = snap.val().name;
          document.getElementById("lPass").value = "";
          enterAsStudent();
        } else {
          setAlert("Numara veya şifre hatalı.", true);
        }
      });
    }

    function enterAsStudent() {
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("studentPanel").style.display = "block";
      setWelcomeStudentBanner();
      loadStudentTarget();
      loadStudentDashboardData();
      showStudentTab('entry');
    }
    
    function setWelcomeStudentBanner() {
        const box = document.getElementById('studentWelcome');
        if (!box) return;
        const prettyName = toTitleCaseTR(currentStudentName || '');
        if (prettyName) {
            box.textContent = `Sayfana hoş geldin ${prettyName}.`;
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    }

    function logout() {
      if (classesRef) classesRef.off();
      if (favRef) favRef.off();
      
      currentStudent = currentStudentName = currentTeacherId = currentTeacherName = currentDetailNum = null;
      favoritesCache = {};
      
      ["rName", "rNumber", "rPass", "rPass2", "lNumber", "lPass", "tName", "tCode", "newClass"]
        .forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });

      ["studentPanel", "teacherPanel", "teacherStudentDetail"].forEach(id => document.getElementById(id).style.display = "none");
      document.getElementById("loginPanel").style.display = "block";
      showTab("studentLogin");
      if (weekChart) weekChart.destroy();
      if (stuWeekChart) stuWeekChart.destroy();
      if (stuMonthChart) stuMonthChart.destroy();
    }

    /* ============ Öğrenci Paneli ============ */
    function addAll() {
      if (!currentStudent) return setAlert("Oturum bulunamadı.", true);
      
      const now = new Date();
      const timeStr = now.toLocaleDateString("tr-TR") + " " + now.toLocaleTimeString("tr-TR");
      const updates = {};
      let hasValue = false;
      
      DERSLER.forEach(ders => {
        const value = parseInt(document.getElementById(DERS_IDS[ders]).value, 10);
        if (!isNaN(value) && value > 0) {
          hasValue = true;
          const newKey = db.ref().child('students/' + currentStudent + '/lessons/' + ders).push().key;
          updates['/students/' + currentStudent + '/lessons/' + ders + '/' + newKey] = { count: value, time: timeStr };
        }
      });

      if (!hasValue) return setAlert("Lütfen en az bir derse soru sayısı girin.", true);

      db.ref().update(updates).then(() => {
        setAlert("Kayıtlar eklendi!");
        document.getElementById("lessonForm").reset();
        loadStudentDashboardData(); 
      }).catch(e => setAlert("Hata: " + e.message, true));
    }

    function loadStudentDashboardData() {
        if (!currentStudent) return;
        db.ref("students/" + currentStudent + "/lessons").get().then(snap => {
            const lessons = snap.exists() ? snap.val() : {};
            renderStudentDailyView(lessons);
            prepareStudentReports(lessons);
        });
    }

    function renderStudentDailyView(lessons) {
        const box = document.getElementById("studentRecords");
        box.innerHTML = `<div id="calendarWrap" class="calendarWrap"></div>
                         <div id="selDayBlock" style="margin-top:12px">
                             <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
                             <div id="stuDayTable"></div>
                         </div>`;

        const { dayMap, sortedDays } = groupLessonsByDay(lessons);
        window._calCtx = { dayMap }; // Global context for calendar clicks

        renderCalendar("calendarWrap", dayMap, (dayStr) => {
            selectStudentDay(dayStr, dayMap);
            document.querySelectorAll('#calendarWrap td[data-day]').forEach(td => {
                td.classList.toggle('selected', td.dataset.day === dayStr);
            });
        });

        if (sortedDays.length > 0) {
            const lastDay = sortedDays[sortedDays.length - 1];
            selectStudentDay(lastDay, dayMap);
            setTimeout(() => { // DOM'un güncellenmesini bekle
                 const firstCell = document.querySelector(`#calendarWrap td[data-day="${lastDay}"]`);
                 if(firstCell) firstCell.classList.add('selected');
            }, 0);
        } else {
            document.getElementById("stuDayTable").innerHTML = "<div class='empty'>Henüz veri girişi yapılmamış.</div>";
        }
    }

    function selectStudentDay(day, dayMap) {
        const table = document.getElementById("stuDayTable");
        const dayData = dayMap[day];
        if (!dayData) {
            table.innerHTML = "<div class='empty'>Seçilen gün için veri yok.</div>";
            return;
        }
        let html = "<table><tr><th>Ders</th><th>Toplam</th></tr>";
        DERSLER.forEach(l => {
            html += `<tr><td>${l}</td><td>${dayData[l] || 0}</td></tr>`;
        });
        html += "</table>";
        table.innerHTML = html;
    }
    
    /* ============ Raporlama (Öğrenci & Öğretmen Ortak) ============ */
    function groupLessonsByDay(lessons) {
        const dayMap = {};
        for (const lesson in lessons) {
            for (const key in lessons[lesson]) {
                const entry = lessons[lesson][key];
                const day = (entry.time || "").split(" ")[0] || "Bilinmeyen";
                if (!dayMap[day]) dayMap[day] = {};
                dayMap[day][lesson] = (dayMap[day][lesson] || 0) + (Number(entry.count) || 0);
            }
        }
        const sortedDays = Object.keys(dayMap).sort((a, b) => parseTRDateStr(a) - parseTRDateStr(b));
        return { dayMap, sortedDays };
    }

    function prepareStudentReports(lessons) {
        // Haftalık Rapor
        const weeks = buildWeeksFromLessons(lessons);
        if (weeks.length > 0) {
            const lastWeek = weeks[weeks.length-1];
            renderWeekChart(lastWeek, 'stuWeekChart', (chart) => { stuWeekChart = chart; });
            renderWeekTable(lastWeek, 'stuWeekMatrix');
        }

        // Aylık Rapor
        const monthsData = buildMonthsFromLessons(lessons);
        window._studentMonths = monthsData.months; // selectStudentMonth'ın erişmesi için
        const monthSelect = document.getElementById('stuMonthSelect');
        monthSelect.innerHTML = monthsData.sortedKeys.map(key => `<option value="${key}">${key}</option>`).join('');
        if (monthsData.sortedKeys.length > 0) {
            selectStudentMonth(monthsData.sortedKeys[monthsData.sortedKeys.length - 1]);
        }
    }
    
    function showStudentTab(tab) {
      ['entry', 'week', 'month'].forEach(t => {
        document.getElementById('studentTab-' + t).style.display = (t === tab) ? 'block' : 'none';
        document.getElementById('stuTab' + t.charAt(0).toUpperCase() + t.slice(1) + 'Btn').classList.toggle('active', t === tab);
      });
    }

    function selectStudentMonth(key) {
      if (!window._studentMonths) return;
      const data = window._studentMonths[key];
      if (!data) return;
      
      if (stuMonthChart) stuMonthChart.destroy();
      stuMonthChart = new Chart(document.getElementById('stuMonthChart'), data.chartConfig);
      renderTotalsTable(data.totals, 'stuMonthTotals');
    }

    /* ============ Öğretmen Paneli ============ */
    function teacherLogin() {
      const name = document.getElementById("tName").value.trim();
      const code = document.getElementById("tCode").value;
      if (!name || !code) return setAlert("Ad Soyad ve kod gerekli.", true);
      if (code !== "703504") return setAlert("Kod hatalı.", true);
      
      currentTeacherName = name;
      currentTeacherId = normalizeId(name);
      
      db.ref("teachers/" + currentTeacherId).set({ name: currentTeacherName, createdAt: firebase.database.ServerValue.TIMESTAMP });
      
      document.getElementById("teacherWelcome").textContent = `Hoş geldiniz, ${toTitleCaseTR(currentTeacherName)}`;
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("teacherPanel").style.display = "block";
      showTeacherSection('classes');
      listenClasses();
      listenFavorites();
    }
    
    function showTeacherSection(sec) {
        document.getElementById('classesSection').style.display = (sec === 'classes') ? 'block' : 'none';
        document.getElementById('favoritesSection').style.display = (sec === 'favorites') ? 'none' : 'block';
        document.getElementById('tabClasses').classList.toggle('active', sec === 'classes');
        document.getElementById('tabFavorites').classList.toggle('active', sec !== 'classes');
    }

    function addClass() {
      const cls = document.getElementById("newClass").value.trim();
      if (!cls) return setAlert("Sınıf adı girin.", true);
      
      db.ref("classes").orderByChild("name").equalTo(cls).get().then(s => {
        if (s.exists()) return setAlert("Bu sınıf zaten ekli.", true);
        db.ref("classes").push({ name: cls, createdAt: firebase.database.ServerValue.TIMESTAMP });
        document.getElementById("newClass").value = "";
      });
    }
    
    function deleteClassByName(name) {
      if (!isPrivilegedTeacher()) return setAlert("Bu işlemi yapma yetkiniz yok.", true);
      const classId = Object.keys(classesMap).find(key => classesMap[key] === name);
      if (!classId) return setAlert("Sınıf bulunamadı.", true);
      if (!confirm(`"${name}" sınıfını silmek istiyor musunuz?`)) return;
      
      db.ref("classes/" + classId).remove().then(() => {
        setAlert("Sınıf silindi.");
        if (activeClassName === name) {
          activeClassName = null;
          document.getElementById("classStudents").style.display = "none";
        }
      });
    }

    function listenClasses() {
      if (classesRef) classesRef.off();
      classesRef = db.ref("classes");
      classesRef.on("value", snap => {
        const grid = document.getElementById("classGrid");
        grid.innerHTML = "";
        classesMap = snap.val() || {};
        const names = Object.values(classesMap).map(c => c.name).sort();
        
        if (names.length === 0) {
            grid.innerHTML = "<div class='empty'>Henüz sınıf yok.</div>";
        }

        names.forEach(name => {
          const card = document.createElement("div");
          card.className = "classCard";
          card.innerHTML = `<div class="className">${escHTML(name)}</div>
                            <button class="classPick">Öğrencileri Gör</button>
                            ${isPrivilegedTeacher() ? `<button class="delFloat" title="Sınıfı Sil"><img class="trashIcon" src="${TRASH_ICON}" alt=""></button>` : ''}`;
          card.querySelector('.classPick').onclick = () => {
            activeClassName = name;
            document.querySelectorAll(".classPick.active").forEach(b => b.classList.remove("active"));
            card.querySelector('.classPick').classList.add("active");
            selectClass(name);
          };
          if(isPrivilegedTeacher()){
            card.querySelector('.delFloat').onclick = (e) => { e.stopPropagation(); deleteClassByName(name); };
          }
          grid.appendChild(card);
        });

        const sel = document.getElementById("rClass");
        const keep = sel.value;
        sel.innerHTML = "<option value=''>Sınıf Seçin</option>" + names.map(n => `<option value="${escAttr(n)}">${escHTML(n)}</option>`).join('');
        if (names.includes(keep)) sel.value = keep;
      });
    }

    function selectClass(name) {
      const list = document.getElementById("studentsContainer");
      document.getElementById("classStudents").style.display = "block";
      const myToken = ++selectClassRenderToken;
      list.innerHTML = "<div class='empty'>Yükleniyor...</div>";
      
      db.ref("students").orderByChild("sclass").equalTo(name).get().then(snap => {
        if (myToken !== selectClassRenderToken) return;
        if (!snap.exists()) {
          list.innerHTML = `<div class='empty'>${escHTML(name)} sınıfında öğrenci yok.</div>`;
          return;
        }
        
        const students = [];
        snap.forEach(ch => { students.push({ ...ch.val(), num: ch.key }); });
        students.sort((a,b) => (a.name || "").localeCompare(b.name || "", 'tr'));

        list.innerHTML = students.map(s => {
          const isFav = !!favoritesCache[s.num];
          const prettyName = toTitleCaseTR(s.name || "");
          return `<div class="studentItem">
            <div class="leftGroup">
              <button class="starBtn" title="${isFav ? 'Favoriden çıkar' : 'Favorilere ekle'}" data-role="fav" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}" data-sclass="${escAttr(s.sclass || '')}">${isFav ? '★' : '☆'}</button>
              <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)}</button>
            </div>
            <button class="targetBtn" title="Hedef belirle" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
            ${isPrivilegedTeacher() ? `<button class="delStuFloat" title="Öğrenciyi sil" data-role="delStudent" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}"><img class="trashIcon" src="${TRASH_ICON}" alt=""></button>` : ''}
          </div>`;
        }).join("");
      });
    }

    document.addEventListener("click", function(e) {
      const el = e.target.closest("[data-role]");
      if (!el) return;
      const { role, num, name, sclass } = el.dataset;
      if (role === "fav") toggleFavorite(num, name, sclass);
      if (role === "target") openTargetModal(num, name);
      if (role === "delStudent") deleteStudent(num, name);
    });

    function toggleFavorite(num, name, sclass) {
      if (!currentTeacherId) return setAlert("Öğretmen oturumu yok.", true);
      const ref = db.ref(`teacherData/${currentTeacherId}/favorites/${num}`);
      if (favoritesCache[num]) {
        ref.remove();
      } else {
        ref.set({ num, name, sclass, createdAt: firebase.database.ServerValue.TIMESTAMP });
      }
    }

    function deleteStudent(num, name) {
      if (!isPrivilegedTeacher()) return setAlert("Bu işlemi yapma yetkiniz yok.", true);
      if (!confirm(`"${name} (${num})" öğrencisini silmek istiyor musunuz? Bu işlem geri alınamaz.`)) return;

      const updates = {};
      updates[`students/${num}`] = null;
      db.ref("teacherData").get().then(snap => {
        if (snap.exists()) {
          snap.forEach(t => { updates[`teacherData/${t.key}/favorites/${num}`] = null; });
        }
        return db.ref().update(updates);
      }).then(() => {
        setAlert("Öğrenci silindi.");
        if (currentDetailNum === num) closeReportModal();
      }).catch(e => setAlert("Silme hatası: " + e.message, true));
    }

    function listenFavorites() {
      if (!currentTeacherId) return;
      if (favRef) favRef.off();
      favRef = db.ref(`teacherData/${currentTeacherId}/favorites`);
      favRef.on("value", snap => {
        favoritesCache = snap.val() || {};
        renderFavorites(Object.values(favoritesCache));
        if (activeClassName) selectClass(activeClassName);
      });
    }

    function renderFavorites(items) {
      const box = document.getElementById("favoritesList");
      if (!items || !items.length) {
        box.innerHTML = "<div class='empty'>Henüz favori öğrenciniz yok.</div>";
        return;
      }
      items.sort((a, b) => (a.sclass || "").localeCompare(b.sclass || "") || (a.name || "").localeCompare(b.name || "", 'tr'));
      box.innerHTML = items.map(s => {
        const prettyName = toTitleCaseTR(s.name || "");
        return `<div class="studentItem">
          <div class="leftGroup">
            <button class="starBtn" title="Favoriden çıkar" data-role="fav" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}" data-sclass="${escAttr(s.sclass || '')}">★</button>
            <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)} – <span style="opacity:.8">${escHTML(s.sclass || '')}</span></button>
          </div>
          <button class="targetBtn" title="Hedef belirle" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
          ${isPrivilegedTeacher() ? `<button class="delStuFloat" title="Öğrenciyi sil" data-role="delStudent" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}"><img class="trashIcon" src="${TRASH_ICON}" alt=""></button>` : ''}
        </div>`;
      }).join("");
    }
    
    /* ============ Öğrenci Detay Modalı ============ */
    function teacherShowStudent(num) {
        currentDetailNum = num;
        document.getElementById("teacherStudentDetail").style.display = "block";
        if (weekChart) weekChart.destroy();

        db.ref("students/" + num).get().then(snap => {
            if (!snap.exists()) return setAlert("Öğrenci bulunamadı.", true);
            
            const s = snap.val();
            document.getElementById("tsdTitle").textContent = `${toTitleCaseTR(s.name || "")} (${s.num}) – ${s.sclass}`;
            
            const lessons = s.lessons || {};
            currentDetailLessons = lessons;

            // --- Günlük Tab ---
            const { dayMap, sortedDays } = groupLessonsByDay(lessons);
            renderCalendar("tsdDays", dayMap, (dayStr) => {
                teacherShowStudentDay(dayStr, dayMap);
                document.querySelectorAll('#tsdDays td[data-day]').forEach(td => {
                    td.classList.toggle('selected', td.dataset.day === dayStr);
                });
            });
            if (sortedDays.length > 0) {
                const lastDay = sortedDays[sortedDays.length - 1];
                teacherShowStudentDay(lastDay, dayMap);
                 setTimeout(() => {
                    const firstCell = document.querySelector(`#tsdDays td[data-day="${lastDay}"]`);
                    if(firstCell) firstCell.classList.add('selected');
                }, 0);
            } else {
                 document.getElementById("tsdDayTable").innerHTML = "<div class='empty'>Veri yok.</div>";
            }
            const totals = Object.values(dayMap).reduce((acc, day) => {
                DERSLER.forEach(l => { acc[l] = (acc[l] || 0) + (day[l] || 0); });
                return acc;
            }, {});
            renderTotalsTable(totals, "tsdTotals");

            // --- Haftalık Tab ---
            currentWeeks = buildWeeksFromLessons(lessons);
            renderWeekList(currentWeeks);
            if (currentWeeks.length > 0) {
                selectWeek(currentWeeks[currentWeeks.length - 1].key);
            } else {
                clearWeekArea();
            }

            // --- Aylık Tab ---
            const monthsData = buildMonthsFromLessons(lessons);
            window._teacherMonths = monthsData.months;
            const monthSelect = document.getElementById('tMonthSelect');
            monthSelect.innerHTML = monthsData.sortedKeys.map(key => `<option value="${key}">${key}</option>`).join('');
            if (monthsData.sortedKeys.length > 0) {
                selectTeacherMonth(monthsData.sortedKeys[monthsData.sortedKeys.length - 1]);
            }
            
            showReportTab('daily');
        });
    }

    function teacherShowStudentDay(day, dayMap) {
        const dayData = dayMap[day] || {};
        let html = "<table><tr><th>Ders</th><th>O Gün Çözülen</th></tr>";
        DERSLER.forEach(l => {
            html += `<tr><td>${l}</td><td>${dayData[l] || 0}</td></tr>`;
        });
        html += "</table>";
        document.getElementById("tsdDayTable").innerHTML = html;
    }
    
    function closeReportModal() {
        document.getElementById("teacherStudentDetail").style.display = "none";
        currentDetailNum = null;
    }

    function showReportTab(tab) {
        ['daily', 'weekly', 'monthly'].forEach(t => {
            document.getElementById('repTab-' + t).style.display = (t === tab) ? 'block' : 'none';
            document.getElementById('repTab' + t.charAt(0).toUpperCase() + t.slice(1) + 'Btn').classList.toggle('active', t === tab);
        });
    }
    
    function selectTeacherMonth(key) {
        if (!window._teacherMonths) return;
        const data = window._teacherMonths[key];
        if (!data) return;
        
        if (window.tMonthChart) window.tMonthChart.destroy();
        window.tMonthChart = new Chart(document.getElementById('tMonthChart'), data.chartConfig);
        renderTotalsTable(data.totals, 'tMonthTotals');
    }

    /* ============ Hedef Yönetimi ============ */
    function openTargetModal(num, name) {
        currentTargetEditNum = num;
        document.getElementById('targetModalTitle').textContent = `${toTitleCaseTR(name)} için Hedef Belirle`;
        const input = document.getElementById('targetInput');
        db.ref(`students/${num}/dailyTarget`).get().then(snap => {
            input.value = snap.exists() ? snap.val() : '';
        });
        document.getElementById('targetModal').style.display = 'flex';
        input.focus();
    }

    function closeTargetModal() {
        document.getElementById('targetModal').style.display = 'none';
    }

    function saveTarget() {
        const val = parseInt(document.getElementById('targetInput').value, 10);
        if (!currentTargetEditNum || isNaN(val) || val < 0) {
            return setAlert("Geçerli bir hedef sayısı girin.", true);
        }
        db.ref(`students/${currentTargetEditNum}/dailyTarget`).set(val).then(() => {
            setAlert("Hedef güncellendi.");
            if (currentStudent && String(currentStudent) === String(currentTargetEditNum)) {
                setStudentTargetInfo(val);
            }
            closeTargetModal();
        }).catch(e => setAlert("Kayıt hatası: " + e.message, true));
    }

    function setStudentTargetInfo(val) {
        const box = document.getElementById('studentTargetInfo');
        const span = document.getElementById('studentTargetValue');
        if (!box || !span) return;
        if (val === null || val === undefined) {
            span.textContent = '—';
        } else {
            span.textContent = String(val);
        }
    }

    function loadStudentTarget() {
        if (!currentStudent) return setStudentTargetInfo(null);
        db.ref(`students/${currentStudent}/dailyTarget`).get()
            .then(snap => setStudentTargetInfo(snap.exists() ? snap.val() : null))
            .catch(() => setStudentTargetInfo(null));
    }

    function openTargetForCurrent() {
        if (!currentStudent) return setAlert("Öğrenci oturumu yok.", true);
        openTargetModal(currentStudent, currentStudentName);
    }
    
    /* ============ Takvim Render ============ */
    function renderCalendar(containerId, dayMap, onDayClick) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const allDates = Object.keys(dayMap).map(parseTRDateStr).filter(d => !isNaN(d));
        if (!allDates.length) {
            container.innerHTML = "<div class='empty'>Kayıt bulunamadı.</div>";
            return;
        }

        const minDate = new Date(Math.min(...allDates));
        const maxDate = new Date(Math.max(...allDates));
        const currentDate = new Date();
        let html = "";
        
        for (let d = new Date(minDate.getFullYear(), minDate.getMonth(), 1); d <= maxDate; d.setMonth(d.getMonth() + 1)) {
            const year = d.getFullYear();
            const month = d.getMonth();
            const weeks = buildCalendarWeeks(year, month);
            html += `<div class="monthBlock"><div class="sectionTitle">${year} – ${month + 1}. Ay</div>`;
            html += `<table class="calendar"><thead><tr><th>Pzt</th><th>Sal</th><th>Çar</th><th>Per</th><th>Cum</th><th>Cts</th><th>Paz</th></tr></thead><tbody>`;
            weeks.forEach(week => {
                html += "<tr>";
                week.forEach(date => {
                    const dayStr = formatTR(date);
                    const isEmpty = date.getMonth() !== month;
                    const hasData = dayMap[dayStr];
                    const isCurrent = date.toDateString() === currentDate.toDateString();
                    let classes = isEmpty ? "empty" : (hasData ? "has-data" : "");
                    if(isCurrent) classes += " current";

                    html += `<td class="${classes}" ${!isEmpty && hasData ? `onclick="(${onDayClick.toString()})('${dayStr}')" data-day="${dayStr}"` : ""}>${date.getDate()}</td>`;
                });
                html += "</tr>";
            });
            html += "</tbody></table></div>";
        }
        container.innerHTML = html;
    }

    function buildCalendarWeeks(year, month) {
        const weeks = [];
        let day = new Date(year, month, 1);
        day.setDate(day.getDate() - (day.getDay() === 0 ? 6 : day.getDay() - 1));
        
        const lastDayOfMonth = new Date(year, month + 1, 0);
        let lastDayOfCalendar = new Date(lastDayOfMonth);
        lastDayOfCalendar.setDate(lastDayOfCalendar.getDate() + (7 - (lastDayOfCalendar.getDay() === 0 ? 7 : lastDayOfCalendar.getDay())));
        
        while (day <= lastDayOfCalendar) {
            const week = [];
            for (let i = 0; i < 7; i++) {
                week.push(new Date(day));
                day.setDate(day.getDate() + 1);
            }
            weeks.push(week);
        }
        return weeks;
    }

    /* ============ Haftalık & Aylık Raporlama Fonksiyonları ============ */
    function parseTRDateStr(dstr) {
      const [dd, mm, yy] = (dstr || '').split('.').map(Number);
      return new Date(yy, mm - 1, dd);
    }
    function formatTR(d) { return d.toLocaleDateString("tr-TR"); }
    function mondayOf(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }
    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x; }

    function buildWeeksFromLessons(lessons) {
        const weeksMap = {};
        const { dayMap } = groupLessonsByDay(lessons);
        for (const dayStr in dayMap) {
            const monday = mondayOf(parseTRDateStr(dayStr));
            const mondayStr = formatTR(monday);
            if (!weeksMap[mondayStr]) weeksMap[mondayStr] = {};
            weeksMap[mondayStr][dayStr] = dayMap[dayStr];
        }
        
        return Object.keys(weeksMap).sort((a,b)=>parseTRDateStr(a)-parseTRDateStr(b)).map(mondayStr => ({ key: mondayStr, dayData: weeksMap[mondayStr] }));
    }

    function renderWeekList(weeks) {
      document.getElementById("weekList").innerHTML = weeks.map(week =>
        `<button class="pill weekBtn" onclick="selectWeek('${week.key}')">${week.key}</button>`
      ).join("");
    }
    
    function selectWeek(key) {
      selectedWeekKey = key;
      document.querySelectorAll("#weekList .weekBtn").forEach(b => b.classList.toggle('active', b.textContent === key));
      
      const weekData = currentWeeks.find(w => w.key === key);
      if (!weekData) return;
      
      renderWeekChart(weekData, 'weekChart', (chart) => { if(weekChart) weekChart.destroy(); weekChart = chart; });
      renderWeekTable(weekData, 'weekMatrix');
      document.getElementById("btnExportPDF").removeAttribute("disabled");
    }

    function renderWeekChart(weekData, canvasId, chartInstanceCallback) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Array.from({ length: 7 }, (_, i) => formatTR(addDays(parseTRDateStr(weekData.key), i)));
        const datasets = DERSLER.map((lesson, idx) => ({
            label: lesson,
            data: labels.map(dayStr => {
                const dayLessonData = weekData.dayData[dayStr];
                return dayLessonData ? (dayLessonData[lesson] || 0) : 0;
            }),
            borderColor: ["#3b82f6", "#06b6d4", "#a855f7", "#eab308", "#ef4444", "#10b981"][idx],
            tension: 0.1
        }));
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: { responsive: true, plugins: { legend: { position: 'top' }}, scales: { y: { beginAtZero: true }}}
        });
        chartInstanceCallback(chart);
    }
    
    function renderWeekTable(weekData, tableId) {
        const labels = Array.from({ length: 7 }, (_, i) => formatTR(addDays(parseTRDateStr(weekData.key), i)));
        let html = "<table><thead><tr><th>Ders</th><th>Pzt</th><th>Sal</th><th>Çar</th><th>Per</th><th>Cum</th><th>Cts</th><th>Paz</th></tr></thead><tbody>";
        DERSLER.forEach(l => {
            html += `<tr><td>${l}</td>` + labels.map(dayStr => `<td>${weekData.dayData[dayStr]?.[l] || 0}</td>`).join('') + "</tr>";
        });
        html += "</tbody></table>";
        document.getElementById(tableId).innerHTML = html;
    }

    function buildMonthsFromLessons(lessons) {
        const { dayMap } = groupLessonsByDay(lessons);
        const months = {};
        Object.keys(dayMap).forEach(dayStr => {
            const date = parseTRDateStr(dayStr);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!months[key]) months[key] = {};
            DERSLER.forEach(l => {
                months[key][l] = (months[key][l] || 0) + (dayMap[dayStr][l] || 0);
            });
        });
        
        const sortedKeys = Object.keys(months).sort();
        const fullMonthData = {};
        sortedKeys.forEach(key => {
            const totals = months[key];
            fullMonthData[key] = {
                totals,
                chartConfig: {
                    type: 'bar',
                    data: { labels: DERSLER, datasets: [{ label: 'Toplam Soru', data: DERSLER.map(l => totals[l] || 0), backgroundColor: "#3b82f6" }] },
                    options: { responsive: true, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true }}}
                }
            };
        });
        return { months: fullMonthData, sortedKeys };
    }

    function renderTotalsTable(totals, targetId) {
      let html = "<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
      DERSLER.forEach(l => { html += `<tr><td>${l}</td><td>${totals[l] || 0}</td></tr>`; });
      html += "</table>";
      document.getElementById(targetId).innerHTML = html;
    }
    
    function clearWeekArea() {
      document.getElementById("weekMatrix").innerHTML = "";
      document.getElementById("weekChartWrap").innerHTML = "<canvas height='140' id='weekChart'></canvas>";
      document.getElementById("btnExportPDF").setAttribute("disabled", "");
    }

    function exportSelectedWeekPDF() {
      if (!selectedWeekKey || !weekChart) return setAlert("Önce bir hafta seçin.", true);
      
      const studentName = document.getElementById("tsdTitle").textContent;
      document.getElementById("exportStudent").textContent = studentName;
      document.getElementById("exportRange").textContent = `${selectedWeekKey} – ${formatTR(addDays(parseTRDateStr(selectedWeekKey), 6))}`;
      document.getElementById("exportTable").innerHTML = document.getElementById("weekMatrix").innerHTML;
      
      const exportChartCanvas = document.getElementById("exportChart");
      const exportCtx = exportChartCanvas.getContext('2d');
      exportCtx.canvas.width = 800; // Genişlik sabit
      exportCtx.canvas.height = 400; // Yükseklik sabit
      exportCtx.fillStyle = 'var(--export-bg)'; // Arka plan rengi
      exportCtx.fillRect(0, 0, 800, 400);
      exportCtx.drawImage(weekChart.canvas, 0, 0, 800, 400); // Boyutlandırarak çiz
      
      html2canvas(document.getElementById("exportArea")).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20; // Kenar boşlukları
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        pdf.save(`${studentName.split('(')[0].trim()}-HaftalikRapor.pdf`);
        setAlert("PDF indiriliyor...");
      }).catch(e => setAlert("PDF oluşturma hatası: " + e.message, true));
    }
  </script>
</body>
</html>
