<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ÖĞRENCİ TAKİP PROGRAMI</title>
<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2canvas & jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
    :root{
      --bg:#0f172a; --panel:#1e293b; --muted:#334155; --text:#e2e8f0;
      --accent1:#3b82f6; --accent2:#06b6d4; --warn:#f97316; --ok:#10b981; --danger:#ef4444;
      --export-bg:#0b1427; --export-head:#93c5fd;
      --card:#0b1427; --cardBorder:#263247;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .header{padding:22px;text-align:center;font-size:22px;font-weight:800;color:#93c5fd;text-transform:uppercase}
    .subheader{font-size:16px;color:#cbd5e1;margin-top:4px;font-weight:600;}
    .tabs{display:flex;gap:8px;justify-content:center;max-width:1080px;margin:0 auto 12px;padding:8px;background:var(--panel);border-radius:12px;flex-wrap:wrap}
    .tabs button{flex:1;min-width:160px;padding:12px;border:0;border-radius:10px;background:transparent;color:#cbd5e1;font-weight:700;cursor:pointer}
    .tabs button.active{background:var(--ok);color:#fff}
    /* Odak halkalarını yeşil yap */
    .tabs button:focus,
    .pill:focus,
    .classPick:focus,
    .dayBtn:focus,
    .weekBtn:focus,
    .studentNameBtn:focus,
    .delStuBtn:focus,
    .delStuFloat:focus,
    .delFloat:focus,
    button.action:focus{
      outline:3px solid rgba(16,185,129,.55);
      outline-offset:2px;
    }
    .container{max-width:1080px;margin:16px auto;background:var(--panel);border-radius:16px;padding:22px}
    h3{margin:0 0 14px}
    input,select{width:100%;padding:12px;border:0;border-radius:10px;background:var(--bg);color:#e2e8f0;margin:8px 0}
    button.action{width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:800;cursor:pointer;min-height:48px}
    button.logout{background:var(--warn)}
    table{width:100%;border-collapse:collapse;margin:10px 0}
    th,td{border:1px solid var(--muted);padding:10px;text-align:center}
    .row{display:flex;gap:10px;align-items:center}
    .row>.grow{flex:1}
    /* ---- Sınıf kartları ---- */
    .classGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:14px;
      margin-top:12px;
    }
    .classCard{
      position:relative;
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      padding:14px 14px 48px;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .classCard:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .className{ font-weight:900; font-size:20px; letter-spacing:.3px; margin-bottom:8px; }
    .classPick{
      position:absolute; left:14px; right:14px; bottom:14px;
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      color:#fff; font-weight:800;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    .classPick.active{ outline:3px solid rgba(16,185,129,.40) }
    /* --- Sınıf silme ikonu (zemin üstünde, hover'da flu kırmızı) --- */
    .delFloat{
      position:absolute; top:10px; right:10px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delFloat img.trashIcon{ width:20px; height:20px; display:block; }
    .delFloat:hover{ transform:translateY(-1px); }
    .delFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delFloat:hover::before{ opacity:1; }
    /* --- Öğrenci silme: tuş yerine zeminde çöp kovası simgesi --- */
    .studentItem{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;background:#0b1427;margin:6px 0;border-radius:10px; position:relative;}
    .studentItem.hasDel{ padding-right:48px; } /* sağ üstteki ikon için yer aç */
    .delStuFloat{
      position:absolute; top:8px; right:8px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delStuFloat img.trashIcon{ width:18px; height:18px; display:block; }
    .delStuFloat:hover{ transform:translateY(-1px); }
    .delStuFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delStuFloat:hover::before{ opacity:1; }
    /* ==== Liste Görünümü V5.4: Soru Sayısı & Hedef Bölgesi Renkli ==== */
    .student-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:12px 0 6px; }
    .densityToggle{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--cardBorder); border:1px solid var(--muted);
      padding:4px 8px; border-radius:999px;
    }
    .densityToggle span{ font-size:13px; }
    .densityToggle input{ margin:0; }
    .densityToggle label{ padding-top:2px; cursor:pointer; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border-radius:999px; padding:6px 10px; font-weight:800; font-size:12px;
      background:var(--card); border:1px solid var(--cardBorder);
    }
    .chip .dot{ width:10px; height:10px; border-radius:999px; }
    .chip.turkce .dot{ background:#fb923c; }
    .chip.sosyal .dot{ background:#6366f1; }
    .chip.din .dot{ background:#22c55e; }
    .chip.ing .dot{ background:#0ea5e9; }
    .chip.mat .dot{ background:#f43f5e; }
    .chip.fen .dot{ background:#14b8a6; }
    .subjLabel{
        display:inline-flex;
        align-items:center;
        gap:6px;
        font-weight:800;
        font-size:12px;
    }
    .subjLabel .dot{
        width:10px;
        height:10px;
        border-radius:999px;
    }
    .subjLabel.turkce .dot{ background:#fb923c; }
    .subjLabel.sosyal .dot{ background:#6366f1; }
    .subjLabel.din .dot{ background:#22c55e; }
    .subjLabel.ing .dot{ background:#0ea5e9; }
    .subjLabel.mat .dot{ background:#f43f5e; }
    .subjLabel.fen .dot{ background:#14b8a6; }
    .lessonList.dense{ display:flex; flex-direction:column; gap:8px; margin:10px 0; }
    .lessonRow.dense{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background:var(--card); border:1px solid var(--cardBorder);
      border-radius:12px; padding:6px 10px;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .lessonRow.dense:hover{ border-color:#3b4b6a; box-shadow:0 8px 18px rgba(0,0,0,.22); }
    .lessonControls{ display:flex; align-items:center; gap:8px; }
    .lessonControls input[type=number]{
      width:100px; min-height:34px; font-size:14px;
      background:var(--bg); color:var(--text); border:0; border-radius:10px; padding:8px 10px;
    }
    .lessonControls input[type=number]::-webkit-outer-spin-button,
    .lessonControls input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .lessonControls input[type=number]{ -moz-appearance:textfield; }
    .numBtn{
      width:34px; height:34px; display:grid; place-items:center; border:0; border-radius:10px;
      background:#334155; color:#fff; font-weight:900; font-size:15px; cursor:pointer;
      transition: transform .08s ease, filter .12s ease;
    }
    .numBtn:hover{ filter:brightness(1.06); }
    .numBtn:active{ transform: translateY(1px); }
    /* === Renkli bölgeler === */
    /* Soru sayısı bölgesi: indigo ton */
    .countWrap{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 6px; border-radius:999px;
      background: rgba(99,102,241,.10);           /* indigo-500 @10% */
      border:1px solid rgba(99,102,241,.35);
      box-shadow: inset 0 0 0 1px rgba(99,102,241,.12);
    }
    .countWrap:focus-within{ box-shadow: 0 0 0 3px rgba(99,102,241,.25); }
    .countWrap .numBtn{ background:#4f46e5; }     /* indigo-600 */
    .countWrap input[type=number]{ background:transparent; }
    /* Hedef bölgesi: sky ton */
    .goalWrap{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 6px; border-radius:999px;
      background: rgba(14,165,233,.10);           /* sky-500 @10% */
      border:1px solid rgba(14,165,233,.35);
      box-shadow: inset 0 0 0 1px rgba(14,165,233,.12);
    }
    .goalWrap:focus-within{ box-shadow: 0 0 0 3px rgba(14,165,233,.25); }
    .goalIcon{ font-size:16px; line-height:1; width:18px; height:18px; display:grid; place-items:center;
      cursor: pointer;}
    .goalInput{
      width:64px; min-height:30px; font-size:14px; border:0; outline:none;
      background:transparent; color:var(--text); text-align:center;
    }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    /* Footer: progress + % badge sağda */
    .rowFooter{ display:flex; align-items:center; gap:8px; width:100%; padding-top:6px; }
    .progressWrap{ position:relative; flex:1 1 auto; min-width:0; height:6px; background:var(--cardBorder);
      border-radius:999px; overflow:hidden; }
    .progressBar{ position:absolute; top:0; left:0; height:100%; width:0%;
      background:linear-gradient(90deg,#22c55e,#0ea5e9); transition: width .15s ease; }
    .pctBadge{
      min-width:44px; height:24px; display:grid; place-items:center;
      padding:0 8px; border-radius:999px; font-weight:800; font-size:12px;
      background:#0b9444; color:#fff; margin-left:auto;
    }
    .pctBadge.low{ background:#eab308; }
    .pctBadge.zero{ background:#6b7280; }
    .totalBar{ display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:8px; font-weight:800; }
    .totalBadge{ min-width:56px; text-align:center; background:#0ea5e9; color:white; border-radius:10px; padding:8px 10px; }
    @media (max-width: 560px){
        .lessonControls{ width:100%; flex-wrap:wrap; gap:6px; }
        .lessonControls .countWrap, .lessonControls .goalWrap{ width:100%; }
    }
    /* === Öğretmen Üst Çubuğu ve Küçük Çıkış Düğmesi === */
    .teacherTopbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0 8px;}
    button.exitSmall{border:0;border-radius:10px;padding:6px 10px;min-height:32px;background:#ef4444;color:#fff;font-weight:800;cursor:pointer}
    button.exitSmall:hover{background:#dc2626}
    button.exitSmall:focus{outline:3px solid rgba(16,185,129,.55);outline-offset:2px;}
    /* === Update: Larger Exit Button + Icon === */
    button.exitSmall{padding:8px 12px;min-height:38px;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    button.exitSmall .icon{width:16px;height:16px;line-height:0;display:inline-flex}
    button.exitSmall .icon svg{display:block}
    button.exitSmall .label{line-height:1}
    /* ====== Günlük Rapor Tasarımı (Calendar + Table) — 2025-10-03 ====== */
    /* Kapsamı yalnızca Günlük sekmesine uygula */
    #repTab-daily .calendarWrap{
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.92));
      border: 1px solid var(--cardBorder, #1e293b);
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      text-align: center;
    }
    #repTab-daily .calendarWrap .calDayName{
      font-size: 11px;
      font-weight: 800;
      color: #93c5fd;
      margin-bottom: 4px;
    }
    #repTab-daily .calendarWrap .calDate{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 72px; height: 72px;
      border-radius: 999px;
      background: var(--card, #0b1427);
      border: 2px solid var(--cardBorder, #263247);
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .5px;
    }
    #repTab-daily .calendarWrap .calDate.today{
      background: linear-gradient(90deg,var(--accent1, #3b82f6), var(--accent2, #06b6d4));
      color: white;
    }
    #repTab-daily .calendarWrap .calDate.missing{
      border-color: var(--warn, #f97316);
      filter: opacity(.6);
    }
    #repTab-daily .repChartWrap{
      position: relative;
      max-width: 360px;
      margin-top: 8px;
    }
    #repTab-daily .chartjs-size-monitor, #repTab-daily .chartjs-size-monitor-expand, #repTab-daily .chartjs-size-monitor-shrink{
      display: none !important;
    }
    #repTab-daily .repTable{
      width: 100%;
      border: 1px solid var(--cardBorder, #263247);
      border-radius: 8px;
      margin-top: 10px;
      overflow: hidden;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      background: var(--card, #0b1427);
    }
    #repTab-daily .repTable table{ width:100%; border-collapse: collapse; }
    #repTab-daily .repTable thead{
      background: #0b1427;
      border-bottom: 1px solid var(--cardBorder, #263247);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    #repTab-daily .repTable th, #repTab-daily .repTable td{
      font-size: 12px;
      padding: 4px 6px;
      text-align: center;
    }
    #repTab-daily .repTable td{
      padding: 6px;
    }
    #repTab-daily .repTable tbody tr:nth-child(2n){
      background: #111b2e;
    }
    #repTab-daily .repTable tfoot{
      font-weight: 800;
    }
    #repTab-daily .repTable tfoot td{
      border-top: 1px solid var(--cardBorder, #263247);
      padding-top: 4px;
    }
    #repTab-daily .calFootNote{
      font-size: 11px;
      margin-top: 4px;
      text-align: center;
      color: #94a3b8;
    }
</style>
</head>
<body>
<div class="header">ÖĞRENCİ TAKİP PROGRAMI
<div class="subheader">Yavuz Selim Ortaokulu</div>
</div>
<div id="alert"></div>
<!-- Giriş Alanı -->
<div class="container" id="loginPanel">
<h3>Öğrenci Takip Sistemi</h3>
<p>Lütfen giriş kodunuzu girin:</p>
<input id="codeInput" placeholder="Öğretmen kodu veya öğrenci numarası" type="number"/>
<button class="action" onclick="submitCode()" type="button">Giriş Yap</button>
</div>
<!-- Öğretmen Paneli -->
<div class="container" id="teacherPanel" style="display:none">
<div class="teacherTopbar">
<strong>Öğretmen Paneli</strong>
<button class="exitSmall" onclick="logout()" type="button">
<span aria-hidden="true" class="icon">
<!-- çıkış simgesi -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21h6"></path><path d="M12 17v4"></path><path d="M8 15H2V3h12v4"></path><path d="M22 7h-6"></path><path d="M12 3v4"></path><path d="M16 5H8"></path><path d="M18 17h4V7h-4"></path></svg>
</span>
<span class="label">Çıkış</span>
</button>
</div>
<!-- Sınıf Listesi -->
<h3>Şube Listesi</h3>
<p class="densityToggle"><input id="densityToggle" type="checkbox"/> <label for="densityToggle">Dar liste görünümü</label></p>
<div id="classListContainer">
<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
<strong>Öğrenci Paneli</strong>
<span class="chip"><span class="dot" style="background:transparent;border:1px solid var(--cardBorder);"></span><span id="studentName" style="font-weight:600"></span></span>
</div>
<ul class="classGrid">
<!-- Sınıf kartları buraya eklenecek -->
</ul>
</div>
<!-- Öğrenci Listesi -->
<div style="display:none" id="studentPanel">
<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
<button class="pill" onclick="backToClasses()" title="Sınıf Listesine Dön" type="button">
<span aria-hidden="true" class="icon">
<!-- geri -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path><path d="M21 12H9"></path></svg>
</span>
<span class="label">Geri</span>
</button>
<strong id="studentPanelTitle">Öğrenci Paneli</strong>
<span style="height:32px"></span>
</div>
<div class="tabs" id="studentTabs">
<button class="pill active" id="stuTabEntryBtn" onclick="showStudentTab('entry')">Soru Girişi</button>
<button class="pill" id="stuTabWeekBtn" onclick="showStudentTab('week')">Haftalık Rapor</button>
<button class="pill" id="stuTabMonthBtn" onclick="showStudentTab('month')">Aylık Rapor</button>
</div>
<!-- Öğrenci Soru Girişi -->
<div id="entryTab">
<ul class="lessonList dense" role="list">
<li class="lessonRow dense">
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap"><span class="subjLabel turkce"><span class="dot"></span>Türkçe</span>
<button aria-label="Türkçe azalt" class="numBtn" data-step="-1" data-target="Turkce" type="button">−</button>
<input id="Turkce" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Türkçe artır" class="numBtn" data-step="1" data-target="Turkce" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Turkce">Türkçe hedef</label>
<input class="goalInput" id="goal-Turkce" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Turkce"></div></div>
<span class="pctBadge zero" data-pct-for="Turkce">0%</span>
</div>
</li>
<li class="lessonRow dense">
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap"><span class="subjLabel sosyal"><span class="dot"></span>Sosyal Bilgiler</span>
<button aria-label="Sosyal Bilgiler azalt" class="numBtn" data-step="-1" data-target="Sosyal" type="button">−</button>
<input id="Sosyal" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Sosyal Bilgiler artır" class="numBtn" data-step="1" data-target="Sosyal" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Sosyal">Sosyal Bilgiler hedef</label>
<input class="goalInput" id="goal-Sosyal" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Sosyal"></div></div>
<span class="pctBadge zero" data-pct-for="Sosyal">0%</span>
</div>
</li>
<li class="lessonRow dense">
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap"><span class="subjLabel din"><span class="dot"></span>Din Kültürü</span>
<button aria-label="Din Kültürü azalt" class="numBtn" data-step="-1" data-target="Din" type="button">−</button>
<input id="Din" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Din Kültürü artır" class="numBtn" data-step="1" data-target="Din" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Din">Din Kültürü hedef</label>
<input class="goalInput" id="goal-Din" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Din"></div></div>
<span class="pctBadge zero" data-pct-for="Din">0%</span>
</div>
</li>
<li class="lessonRow dense">
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap"><span class="subjLabel ing"><span class="dot"></span>İngilizce</span>
<button aria-label="İngilizce azalt" class="numBtn" data-step="-1" data-target="Ingilizce" type="button">−</button>
<input id="Ingilizce" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="İngilizce artır" class="numBtn" data-step="1" data-target="Ingilizce" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Ingilizce">İngilizce hedef</label>
<input class="goalInput" id="goal-Ingilizce" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Ingilizce"></div></div>
<span class="pctBadge zero" data-pct-for="Ingilizce">0%</span>
</div>
</li>
<li class="lessonRow dense">
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap"><span class="subjLabel mat"><span class="dot"></span>Matematik</span>
<button aria-label="Matematik azalt" class="numBtn" data-step="-1" data-target="Matematik" type="button">−</button>
<input id="Matematik" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Matematik artır" class="numBtn" data-step="1" data-target="Matematik" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Matematik">Matematik hedef</label>
<input class="goalInput" id="goal-Matematik" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Matematik"></div></div>
<span class="pctBadge zero" data-pct-for="Matematik">0%</span>
</div>
</li>
<li class="lessonRow dense">
<div class="lessonControls">
<span aria-label="Soru sayısı" class="countWrap"><span class="subjLabel fen"><span class="dot"></span>Fen Bilimleri</span>
<button aria-label="Fen Bilimleri azalt" class="numBtn" data-step="-1" data-target="Fen" type="button">−</button>
<input id="Fen" inputmode="numeric" min="0" placeholder="0" type="number"/>
<button aria-label="Fen Bilimleri artır" class="numBtn" data-step="1" data-target="Fen" type="button">+</button>
</span>
<span class="goalWrap" title="Hedef">
<span aria-hidden="true" class="goalIcon">🎯</span>
<label class="sr-only" for="goal-Fen">Fen Bilimleri hedef</label>
<input class="goalInput" id="goal-Fen" inputmode="numeric" min="1" placeholder="50" type="number" value="50"/>
</span>
</div>
<div class="rowFooter">
<div class="progressWrap"><div class="progressBar" data-bar-for="Fen"></div></div>
<span class="pctBadge zero" data-pct-for="Fen">0%</span>
</div>
</li>
</ul>
<!-- Haftalık Rapor -->
<div id="weekTab" style="display:none">
<div style="display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:6px;margin-bottom:8px">
<button class="pill weekBtn" data-week-offset="0" onclick="setWeek(this)" type="button">Bu Hafta</button>
<button class="pill weekBtn" data-week-offset="-1" onclick="setWeek(this)" type="button">Geçen Hafta</button>
<button class="pill weekBtn" data-week-offset="-2" onclick="setWeek(this)" type="button">2 Hafta Önce</button>
</div>
<div id="weekChartContainer">
<canvas id="weekChart"></canvas>
</div>
<div id="weekTable" style="overflow-x:auto"></div>
</div>
<!-- Aylık Rapor -->
<div id="monthTab" style="display:none">
<div style="display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:6px;margin-bottom:8px">
<button class="pill monthBtn" data-month-offset="0" onclick="setMonth(this)" type="button">Bu Ay</button>
<button class="pill monthBtn" data-month-offset="-1" onclick="setMonth(this)" type="button">Geçen Ay</button>
<button class="pill monthBtn" data-month-offset="-2" onclick="setMonth(this)" type="button">2 Ay Önce</button>
</div>
<div id="monthChartContainer">
<canvas id="monthChart"></canvas>
</div>
<div id="monthTable" style="overflow-x:auto"></div>
</div>
</div>
<!-- Hedef Soru Modalı -->
<div class="list asModal" id="targetModal" style="display:none; max-width:420px">
<div class="modalHead">
<div class="modalTabs">
<strong>🎯 Öğrenci Hedefi</strong>
</div>
<button class="pill modalClose" onclick="closeTargetModal()">Kapat ×</button>
</div>
<div style="display:flex; flex-direction:column; gap:10px; padding:8px">
<div id="targetStudentName" style="font-weight:700"></div>
<label>Günlük hedef soru sayısı:</label>
<input id="targetInput" inputmode="numeric" min="0" placeholder="örn. 100" step="1" type="number"/>
<button class="action" onclick="saveTarget()" type="button">Kaydet</button>
</div>
</div></div>
<!-- === Goals Full Page (Student/Teacher) — MODERN === -->
<div id="goalsPage" style="display:none">
<div class="gp-header">
<div class="gp-left">
<button class="pill gp-btn gp-back" onclick="backFromGoalsPage()" title="Öğrenci Paneline Dön" type="button">
<span aria-hidden="true" class="icon">
<!-- back -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path><path d="M21 12H9"></path></svg>
</span>
        Geri
      </button>
<div class="gp-title">🎯 Ders Soru sayısı Hedefleri</div>
</div>
<div class="gp-actions">
<button class="pill gp-btn gp-clear" onclick="resetGoalsInputs()" type="button">
<span aria-hidden="true" class="icon">
<!-- temizle (broom) -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M3 20l1-5 11-11 3 3L7 18l-4 2z"></path><path d="M14 6l4 4"></path></svg>
</span>
        Temizle
      </button>
<button class="action gp-btn" onclick="saveLessonGoals()" type="button">
<span aria-hidden="true" class="icon">
<!-- kaydet (check) -->
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
</span>
        Kaydet
      </button>
</div>
</div>
<!-- Tablo kutusu -->
<div class="gp-table">
<div class="gp-row">
<label class="gp-label turkce"><span class="dot"></span>Türkçe</label>
<input class="gp-input" id="lg-Turkce" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label sosyal"><span class="dot"></span>Sosyal Bilgiler</label>
<input class="gp-input" id="lg-Sosyal" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label din"><span class="dot"></span>Din Kültürü</label>
<input class="gp-input" id="lg-Din" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label ing"><span class="dot"></span>İngilizce</label>
<input class="gp-input" id="lg-Ingilizce" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label matematik"><span class="dot"></span>Matematik</label>
<input class="gp-input" id="lg-Matematik" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
<div class="gp-row">
<label class="gp-label fen"><span class="dot"></span>Fen Bilimleri</label>
<input class="gp-input" id="lg-Fen" inputmode="numeric" min="1" placeholder="örn. 50" type="number"/>
</div>
</div>
<p class="gp-note">Not: Kaydet ile eski hedefler silinir, girilen son hedefler saklanır.</p>
</div>
<script>
(function(){
  // list of main panels to toggle between
  window._MAIN_PANELS = (window._MAIN_PANELS || ['teacherPanel','studentPanel','loginPanel','goalsPage']);
  function showMainPanel(id){
    (window._MAIN_PANELS || []).forEach(function(pid){
      var el = document.getElementById(pid);
      if(el){ el.style.display = (pid === id) ? 'block' : 'none'; }
    });
  }
  window.openLessonGoalsPage = function(){
    // Prefill from inline inputs if present
    try{
      ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
        var main = document.getElementById('goal-' + id);
        var modal = document.getElementById('lg-' + id);
        if(modal){ modal.value = main && main.value ? main.value : ""; }
      });
    }catch(_){}
    showMainPanel('goalsPage');
  };
  window.backFromGoalsPage = function(){ showMainPanel('teacherPanel'); };
  window.resetGoalsInputs = function(){
    ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
      var modal = document.getElementById('lg-' + id);
      if(modal) modal.value = "";
    });
  };
  // Save (last-write-wins): delete old then write new, optionally go back
  window.saveLessonGoals = function(goBack){
    goBack = false; var payload = {};
    ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
      var v = parseInt((document.getElementById('lg-' + id)?.value || "0"), 10);
      if(isNaN(v) || v <= 0) v = 0;
      payload[id] = v;
    });
    try { 
      if (typeof firebase !== 'undefined'){
        const ref = firebase.database().ref("goals/" + (window._IS_TEACHER ? "teacher" : "student") + "/" + window._CLASS_ID + (window._IS_TEACHER ? "" : ("/" + window._STUDENT_ID)));
        ref.remove().then(function(){
          ref.set(payload).then(function(){
            try { if (typeof setAlert === 'function') setAlert('Hedef soru sayısı kaydedildi.'); } catch(_){}
          })
          .catch(function(e){
            try { if (typeof setAlert === 'function') setAlert('Kayıt hatası: ' + (e.message || e)); } catch(_){}
          });
        });
      }
    }catch(_){}
    if(goBack) backFromGoalsPage();
  };
})();
</script>
<script>
(function(){
  var panels = ["loginPanel","teacherPanel","studentPanel"];
  function setPanel(panelName){
    panels.forEach(function(name){
      var panel = document.getElementById(name);
      if(panel) panel.style.display = (name === panelName) ? "block" : "none";
    });
  }
  window.setDense = function(enabled){
    try{
      const list = document.querySelector('.lessonList');
      if(!list) return;
      if(enabled){ list.classList.add('dense'); }
      else{ list.classList.remove('dense'); }
      localStorage.setItem("dense", enabled ? "1" : "");
    }catch(_){}
  };
  document.getElementById('densityToggle')?.addEventListener('change', function(){
    const list = document.querySelector('.lessonList');
    const enabled = !list?.classList.contains('dense');
    setDense(enabled);
  });
  // Turn off pinch-zoom for input elements (esp. iOS)
  document.addEventListener('touchstart', function(e){
    if(e.target && (e.target.matches('input[type=number]') || e.target.matches('.goalInput'))){
      try{ e.target.setAttribute('autocomplete','off'); }catch(_){}
    }
  }, {passive:true});
  // Student/Teacher login flow
  window.submitCode = function(){
    var code = document.getElementById('codeInput');
    if(!code) return;
    code = code.value.trim();
    if(!code){ alert("Lütfen bir kod girin."); return; }
    window._IS_TEACHER = (code.length === 6);
    window._CLASS_ID = null;
    window._STUDENT_ID = null;
    // Öğretmen girişi (6 haneli kod, harf yok)
    if(window._IS_TEACHER){
      // Karakter kontrol: Sadece 6 hane rakam ya da Admin
      if( !/^\d{6}$/.test(code) && code.toLowerCase() !== "admin" ){
        alert("Geçersiz öğretmen kodu"); return;
      }
      // (HACK: admin code doesn't require Firebase)
      if(code.toLowerCase() === "admin"){
        window._TEACHER_MODE = true;
        setPanel("teacherPanel");
        return;
      }
      // Confirm with Firebase
      try{
        firebase.database().ref("teachers/" + code).get().then(function(snapshot){
          if(snapshot.exists()){
            window._TEACHER_MODE = true;
            setPanel("teacherPanel");
          } else{
            alert("Geçersiz öğretmen kodu");
          }
        }).catch(function(e){ console.log(e); alert("Hata: " + e.message); });
      }catch(e){ console.log(e); alert("Hata: " + e.message); }
      return;
    }
    // Öğrenci girişi (classID-studentID şeklinde)
    var parts = code.split("-");
    if(parts.length !== 2 || !parts[0] || !parts[1]){ alert("Geçersiz öğrenci kodu"); return; }
    window._CLASS_ID = parts[0]; window._STUDENT_ID = parts[1];
    try{
      firebase.database().ref("students/" + window._CLASS_ID + "/" + window._STUDENT_ID).get().then(function(snapshot){
        if(snapshot.exists()){
          // Kod geçerli: Öğrenci verisini al ve paneli göster
          var data = snapshot.val() || {};
          // Ad soyad gösterimi
          document.getElementById("studentName").textContent = data.name || (window._STUDENT_ID + " nolu öğrenci");
          window._TEACHER_MODE = false;
          setPanel("studentPanel");
          // Eğer hedef değer varsa ve henüz kaydedilmemişse, hedef giriş kutusunu doldur
          try{
            firebase.database().ref("goals/student/" + window._CLASS_ID + "/" + window._STUDENT_ID).get().then(function(snap){
              if(snap.exists()){
                var goals = snap.val();
                ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].forEach(function(id){
                  if(goals[id]){ 
                    var el = document.getElementById('goal-' + id);
                    if(el && !el.value){ el.value = goals[id]; }
                  }
                });
              }
            });
          }catch(_){}
        } else{
          alert("Geçersiz öğrenci kodu");
        }
      }).catch(function(e){ console.log(e); alert("Hata: " + e.message); });
    }catch(e){ console.log(e); alert("Hata: " + e.message); }
  };
  window.backToClasses = function(){
    document.getElementById("studentPanelTitle").textContent = "Öğrenci Paneli";
    document.querySelectorAll('.lessonList li').forEach(function(li){ li.remove(); });
    setPanel("teacherPanel");
  };
  // Soru girişindeki sekmeler (Tek öğrenci görünümü için gizle)
  window.showStudentTab = function(tab){
    const tabs = ['entry','week','month'];
    tabs.forEach(t=>{
      document.getElementById(t+'Tab')?.setAttribute('style', 'display:' + (t===tab ? 'block' : 'none'));
      document.getElementById('stuTab'+ (t.charAt(0).toUpperCase()+t.slice(1) ) +'Btn')?.classList.toggle('active', t===tab);
    });
    if(tab === 'entry'){ try{ updateGlobalAndProgress(); }catch(_){} }
    if(tab === 'week' && typeof loadWeekChart === 'function'){ loadWeekChart(); }
    if(tab === 'month' && typeof loadMonthChart === 'function'){ loadMonthChart(); }
  };
  // Hedef modal aç
  window.openTargetForCurrent = function(name){
    var entryBtn = document.getElementById('stuTabEntryBtn');
    if(entryBtn){
      entryBtn.textContent = 'Soru Girişi';
      entryBtn.classList.add('active');
    }
    document.getElementById('targetStudentName').textContent = name || document.getElementById('studentName').textContent;
    document.getElementById('targetInput').value = document.getElementById('targetInput').getAttribute('min') || 0;
    // clear previous entry before open
    document.getElementById('targetModal')?.querySelectorAll('input').forEach(i=>{ i.value = ""; });
    showMainPanel('targetModal');
  };
  window.closeTargetModal = function(){
    document.getElementById('targetModal').style.display = 'none';
    document.getElementById('studentPanel').style.display = 'block';
  };
  // Yeni öğrenci (Firebase ile)
  window.addStudent = function(){
    var name = prompt("Öğrenci adı:");
    if(!name) return;
    name = name.trim();
    if(!name) return;
    if(window._CLASS_ID && window._TEACHER_MODE){
      try{
        firebase.database().ref("students/" + window._CLASS_ID).push({
          name: name
        }).then(function(){
          try { if (typeof setAlert === 'function') setAlert('Öğrenci eklendi: ' + name); } catch(_){}
        }).catch(function(e){ console.log(e); alert("Hata: " + e.message); });
      }catch(e){ console.log(e); alert("Hata: " + e.message); }
    }
  };
  // Sınıf sil (Firebase ile)
  window.deleteClass = function(classId){
    if(!confirm("Bu sınıfı silmek istediğinize emin misiniz?")) return;
    try{
      firebase.database().ref("students/" + classId).remove().then(function(){
        document.getElementById('classCard-'+classId)?.remove();
      });
    }catch(e){ console.log(e); alert("Hata: " + e.message); }
  };
  // Öğrenci sil (Firebase ile)
  window.deleteStudent = function(studentId, el){
    if(!confirm("Bu öğrenciyi silmek istediğinize emin misiniz?")) return;
    if(window._CLASS_ID && window._TEACHER_MODE){
      try{
        firebase.database().ref("students/" + window._CLASS_ID + "/" + studentId).remove().then(function(){
          el.closest('.studentItem')?.remove();
        });
      }catch(e){ console.log(e); alert("Hata: " + e.message); }
    }
  };
})();
</script>
<script>
(function(){
  // Artır/Azalt butonları (Veriyi ve ekranı güncelle)
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('numBtn')){
      try{
        var step = parseInt(e.target.getAttribute('data-step'), 10) || 0;
        var target = e.target.getAttribute('data-target');
        if(target){
          var input = document.getElementById(target);
          if(input){
            var newVal = (parseInt(input.value||"0", 10) || 0) + step;
            if(newVal < 0) newVal = 0;
            input.value = newVal;
            // Blur event ile progress update oluyor, ama elle de tetikleyelim
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
      }catch(_){}
    }
  });
  // Her input değişiminde global toplam ve ilerleme çubuklarını güncelle
  function updateRowPct(id, pct){
    var badge = document.querySelector(`.pctBadge[data-pct-for="${id}"]`);
    if(badge){
      badge.textContent = (pct|0) + "%";
      badge.classList.toggle('zero', pct === 0);
      badge.classList.toggle('low', pct > 0 && pct < 100);
    }
  }
  window.updateGlobalAndProgress = function(){
      const ids = ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"];
      let sum = 0;
      ids.forEach(id => {
        const input = document.getElementById(id);
        const goalInput = document.getElementById('goal-' + id);
        const count = parseInt((input?.value || "0"), 10) || 0;
        const goal = parseInt((goalInput?.value || "0"), 10) || 0;
        if(!isNaN(count)){ sum += count; }
        const pct = (!isNaN(count) && !isNaN(goal) && goal > 0) ? (count*100/goal) : 0;
        const bar = document.querySelector(`.progressBar[data-bar-for="${id}"]`);
        if(bar){ bar.style.width = pct + "%"; }
        updateRowPct(id, pct);
      });
      // If teacher mode, also update global sum
      if(window._TEACHER_MODE){
        document.querySelectorAll('.totalBadge').forEach(function(el){
          el.textContent = sum;
        });
      }
  };
  // Input alanlarında her değişimde ilerlemeyi güncelle
  document.addEventListener('input', function(e){
    if(e.target && (e.target.matches('.lessonControls input[type=number]') || e.target.matches('.goalInput')) ){
      // Sadece student paneldeki inputlar
      if(document.getElementById('studentPanel')?.style.display !== 'none'){
        updateGlobalAndProgress();
      }
    }
  });
  // İlk yüklemede progress barları sıfırla
  document.addEventListener('DOMContentLoaded', updateGlobalAndProgress);
})();
</script>
<script>
(function(){
  // Chart.js bar chart configs for week and month
  // Renk paleti (Türkçe, Sosyal, Din, İngilizce, Matematik, Fen)
  const chartColors = ['#fb923c','#6366f1','#22c55e','#0ea5e9','#f43f5e','#14b8a6'];
  window.loadWeekChart = function(data){
    try{
      if(!data){
        const now = new Date();
        const curWeek = now.getWeekId();
        const classId = window._CLASS_ID;
        const studentId = window._STUDENT_ID;
        if(!classId || !studentId) return;
        firebase.database().ref("weekly/" + classId + "/" + studentId + "/" + curWeek).get().then(function(snapshot){
          const data = snapshot.val();
          window.loadWeekChart(data);
        });
        return;
      }
    }catch(_){}
    // Veriler yoksa boş bırak
    if(!data){ 
      document.getElementById('weekTable').innerHTML = "<p style='text-align:center;opacity:.8'>Veri yok</p>";
      return;
    }
    // Veriyi haftalık toplamlara dönüştür
    const totals = {};
    Object.keys(data).forEach(day => {
      const daily = data[day];
      Object.keys(daily).forEach(subject => {
        totals[subject] = (totals[subject] || 0) + (parseInt(daily[subject], 10)||0);
      });
    });
    // Grafiği kur
    try{
      const ctx = document.getElementById('weekChart');
      if(ctx){
        ctx.height=200;
        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ["Türkçe","Sosyal","Din","İngilizce","Matematik","Fen"],
            datasets: [{
              label: 'Haftalık Soru Sayısı',
              data: ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].map(d=> totals[d] || 0),
              backgroundColor: chartColors
            }]
          },
          options: { responsive:true, maintainAspectRatio:false }
        });
      }
    }catch(_){}
    // Tabloyu oluştur
    let html="<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
    dersSirasi.forEach(l => {
      const value = totals[l] || 0;
      html += `<tr><td>${l}</td><td>${value}</td></tr>`;
    });
    html += "</table>";
    document.getElementById('weekTable').innerHTML = html;
  };
  window.loadMonthChart = function(data){
    try{
      if(!data){
        const now = new Date();
        const curMonth = now.getMonthId();
        const classId = window._CLASS_ID;
        const studentId = window._STUDENT_ID;
        if(!classId || !studentId) return;
        firebase.database().ref("monthly/" + classId + "/" + studentId + "/" + curMonth).get().then(function(snapshot){
          const data = snapshot.val();
          window.loadMonthChart(data);
        });
        return;
      }
    }catch(_){}
    if(!data){ 
      document.getElementById('monthTable').innerHTML = "<p style='text-align:center;opacity:.8'>Veri yok</p>";
      return;
    }
    // Veriyi aylık toplamlara dönüştür
    const totals = {};
    Object.keys(data).forEach(weekId => {
      const weekly = data[weekId];
      Object.keys(weekly).forEach(day => {
        const daily = weekly[day];
        Object.keys(daily).forEach(subject => {
          totals[subject] = (totals[subject] || 0) + (parseInt(daily[subject], 10)||0);
        });
      });
    });
    // Grafiği kur
    try{
      const ctx = document.getElementById('monthChart');
      if(ctx){
        ctx.height=200;
        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ["Türkçe","Sosyal","Din","İngilizce","Matematik","Fen"],
            datasets: [{
              label: 'Aylık Soru Sayısı',
              data: ["Turkce","Sosyal","Din","Ingilizce","Matematik","Fen"].map(d=> totals[d] || 0),
              backgroundColor: chartColors
            }]
          },
          options: { responsive:true, maintainAspectRatio:false }
        });
      }
    }catch(_){}
    // Tabloyu oluştur
    let html="<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
    dersSirasi.forEach(d=>{
      const v = totals[d] || 0;
      html += `<tr><td>${d}</td><td>${v}</td></tr>`;
    });
    html += "</table>";
    document.getElementById('monthTable').innerHTML = html;
  };
  // Haftalar ve aylar için id hesaplama fonksiyonları
  Date.prototype.getWeekId = function(){
    const jan1 = new Date(this.getFullYear(), 0, 1);
    const days = Math.floor((this - jan1) / (24 * 60 * 60 * 1000));
    const weekNumber = Math.ceil((days + jan1.getDay() + 1) / 7);
    return this.getFullYear() + "-H" + (weekNumber < 10 ? "0"+weekNumber : weekNumber);
  };
  Date.prototype.getMonthId = function(){
    return this.getFullYear() + "-" + ((this.getMonth()+1) < 10 ? "0"+(this.getMonth()+1) : (this.getMonth()+1));
  };
})();
</script>
<script>
(function(){
  // Chart.js global configuration (if needed)
  try{
    Chart.defaults.font.family = 'Arial, Helvetica, sans-serif';
  }catch(_){}
})();
</script>
</body>
</html>