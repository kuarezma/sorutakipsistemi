<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>ÖĞRENCİ TAKİP PROGRAMI</title>
  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- html2canvas & jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --muted: #334155;
      --text: #e2e8f0;
      --accent1: #3b82f6;
      --accent2: #06b6d4;
      --warn: #f97316;
      --ok: #10b981;
      --danger: #ef4444;
      --export-bg: #0b1427;
      --export-head: #93c5fd;
      --card: #0b1427;
      --cardBorder: #263247;
    }
    * {
      box-sizing: border-box
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Arial, Helvetica, sans-serif
    }
    .header {
      padding: 22px;
      text-align: center;
      font-size: 22px;
      font-weight: 800;
      color: #93c5fd;
      text-transform: uppercase
    }
    .subheader {
      font-size: 16px;
      color: #cbd5e1;
      margin-top: 4px;
      font-weight: 600;
    }
    .tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      max-width: 1080px;
      margin: 0 auto 12px;
      padding: 8px;
      background: var(--panel);
      border-radius: 12px;
      flex-wrap: wrap
    }
    .tabs button {
      flex: 1;
      min-width: 160px;
      padding: 12px;
      border: 0;
      border-radius: 10px;
      background: transparent;
      color: #cbd5e1;
      font-weight: 700;
      cursor: pointer
    }
    .tabs button.active {
      background: var(--ok);
      color: #fff
    }
    /* Odak halkalarını yeşil yap */
    .tabs button:focus,
    .pill:focus,
    .classPick:focus,
    .dayBtn:focus,
    .weekBtn:focus,
    .studentNameBtn:focus,
    .delStuBtn:focus,
    .delStuFloat:focus,
    .delFloat:focus,
    button.action:focus {
      outline: 3px solid rgba(16, 185, 129, .55);
      outline-offset: 2px;
    }
    .container {
      max-width: 1080px;
      margin: 16px auto;
      background: var(--panel);
      border-radius: 16px;
      padding: 22px
    }
    h3 {
      margin: 0 0 14px
    }
    input,
    select {
      width: 100%;
      padding: 12px;
      border: 0;
      border-radius: 10px;
      background: var(--bg);
      color: #e2e8f0;
      margin: 8px 0
    }
    button.action {
      width: 100%;
      padding: 12px;
      border: 0;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      min-height: 48px
    }
    button.logout {
      background: var(--warn)
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0
    }
    th,
    td {
      border: 1px solid var(--muted);
      padding: 10px;
      text-align: center
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center
    }
    .row>.grow {
      flex: 1
    }
    /* ---- Sınıf kartları ---- */
    .classGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    .classCard {
      position: relative;
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      padding: 14px 14px 48px;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .classCard:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, .25);
      border-color: #3b4b6a;
    }
    .className {
      font-weight: 900;
      font-size: 20px;
      letter-spacing: .3px;
      margin-bottom: 8px;
    }
    .classPick {
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      color: #fff;
      font-weight: 800;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
    }
    .classPick.active {
      outline: 3px solid rgba(16, 185, 129, .40)
    }
    /* --- Sınıf silme ikonu (zemin üstünde, hover'da flu kırmızı) --- */
    .delFloat {
      position: absolute;
      top: 10px;
      right: 10px;
      display: grid;
      place-items: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border: 0;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
      z-index: 2;
    }
    .delFloat img.trashIcon {
      width: 20px;
      height: 20px;
      display: block;
    }
    .delFloat:hover {
      transform: translateY(-1px);
    }
    .delFloat::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(239, 68, 68, .26);
      filter: blur(8px);
      opacity: 0;
      transition: opacity .12s ease;
      z-index: -1;
    }
    .delFloat:hover::before {
      opacity: 1;
    }
    /* --- Öğrenci silme: tuş yerine zeminde çöp kovası simgesi --- */
    .studentItem {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
      padding: 10px;
      background: #0b1427;
      margin: 6px 0;
      border-radius: 10px;
      position: relative;
    }
    .studentItem.hasDel {
      padding-right: 48px;
      /* sağ üstteki ikon için yer aç */
    }
    .delStuFloat {
      position: absolute;
      top: 8px;
      right: 8px;
      display: grid;
      place-items: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border: 0;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
      z-index: 2;
    }
    .delStuFloat img.trashIcon {
      width: 18px;
      height: 18px;
      display: block;
    }
    .delStuFloat:hover {
      transform: translateY(-1px);
    }
    .delStuFloat::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(239, 68, 68, .26);
      filter: blur(8px);
      opacity: 0;
      transition: opacity .12s ease;
      z-index: -1;
    }
    .delStuFloat:hover::before {
      opacity: 1;
    }
    /* --- Öğrenci listesinde favori ve hedef butonları --- */
    .studentNameBtn {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: left;
      font-weight: 600;
      background: transparent;
      border: none;
      color: #e2e8f0;
      cursor: pointer;
      padding: 0;
    }
    .studentNameBtn:hover {
      text-decoration: underline;
    }
    .starBtn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      color: #3b82f6;
    }
    .targetBtn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #10b981;
    }
    .editBtn {
      background: var(--muted);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 12px;
      font-weight: 600;
      color: #e2e8f0;
    }
    .pillTabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .pill {
      border: none;
      border-radius: 8px;
      background: var(--muted);
      color: #e2e8f0;
      padding: 6px 12px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .pill.active {
      background: var(--ok);
      color: #fff;
    }
    .pill.exit {
      background: var(--danger);
    }
    .exitSmall {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      color: #cbd5e1;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
    }
    .exitSmall .icon {
      display: inline-block;
      line-height: 0;
    }
    .exitSmall .label {
      display: none;
    }
    @media(min-width: 768px) {
      .exitSmall .label {
        display: inline;
      }
    }
    .sectionTitle {
      font-weight: 800;
      margin: 16px 0 8px;
      font-size: 16px;
    }
    .chip {
      display: inline-block;
      background: #1e293b;
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: 600;
      color: #93c5fd;
      margin-left: 4px;
    }
    .smallRow {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .ghost {
      opacity: .65;
      font-size: 13px;
    }
    .densityToggle {
      background: transparent;
      border: none;
      color: #cbd5e1;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 13px;
    }
    .calendarWrap {
      overflow-x: auto;
    }
    .calendar {
      border-collapse: collapse;
      width: 100%;
      min-width: 620px;
    }
    .calendar th,
    .calendar td {
      border: 1px solid var(--cardBorder);
      padding: 4px;
      text-align: center;
      font-size: 12px;
    }
    .calendar th {
      background: #0b1427;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .calendar td.empty {
      background: #0b1427;
    }
    .calendar td.current {
      background: var(--accent1);
    }
    .calendar td.selected {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }
  </style>
</head>
<body>
  <div class="header">ÖĞRENCİ TAKİP PROGRAMI
    <div class="subheader">Alparslan Ortaokulu</div>
  </div>
  <div id="alert"></div>
  <!-- Giriş Alanı -->
  <div id="loginPanel">
    <div class="tabs">
      <button class="active" id="tabRegister" onclick="showTab('register')" type="button">Öğrenci Kayıt</button>
      <button id="tabStudent" onclick="showTab('studentLogin')" type="button">Öğrenci-Veli Giriş</button>
      <button id="tabTeacher" onclick="showTab('teacherLogin')" type="button">Öğretmen Giriş</button>
    </div>
    <!-- Öğrenci Kayıt -->
    <div class="container" id="register">
      <h3>Öğrenci Kayıt</h3>
      <input autocomplete="off" id="rName" placeholder="Ad Soyad" type="text" />
      <select id="rClass"><option value="">Sınıf Seçin</option></select>
      <input autocomplete="off" id="rNumber" placeholder="Okul Numarası" type="text" />
      <input autocomplete="new-password" id="rPass" placeholder="Şifre" type="password" />
      <!-- YENİ: Şifre Tekrar -->
      <input autocomplete="new-password" id="rPass2" placeholder="Şifre (Tekrar)" type="password" />
      <small id="passMismatchError" style="display:none;color:#ef4444;font-weight:600;">Şifreler eşleşmiyor</small>
      <button class="action" id="registerBtn" onclick="studentRegister()" type="button">Kayıt</button>
    </div>
    <!-- Öğrenci-Veli Giriş -->
    <div class="container" id="studentLogin" style="display:none">
      <h3>Öğrenci-Veli Giriş</h3>
      <input autocomplete="off" id="lNumber" placeholder="Okul Numarası" type="text" />
      <input autocomplete="current-password" id="lPass" placeholder="Şifre" type="password" />
      <button class="action" onclick="studentLogin()" type="button">Giriş Yap</button>
    </div>
    <!-- Giriş Türü Seçimi -->
    <div class="container" id="roleChoice" style="display:none">
      <h3>Giriş Türünü Seçin</h3>
      <div class="teacherWelcome" id="roleChoiceHello"></div>
      <div class="roleGrid">
        <button aria-label="Öğrenci Girişi" class="roleCard" onclick="enterAsStudent()" type="button">
          <div aria-hidden="true" class="roleIcon">
            <!-- Tek kişi ikonu -->
            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 12c2.761 0 5-2.686 5-6s-2.239-6-5-6-5 2.686-5 6 2.239 6 5 6Zm0 2c-4.418 0-8 2.686-8 6v2h16v-2c0-3.314-3.582-6-8-6Z"></path>
            </svg>
          </div>
          <div class="roleTitle">Öğrenci Girişi</div>
        </button>
        <button aria-label="Veli Girişi" class="roleCard parent" onclick="enterAsParent()" type="button">
          <div aria-hidden="true" class="roleIcon">
            <!-- İki kişi ikonu -->
            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 11c2.209 0 4-2.239 4-5s-1.791-5-4-5-4 2.239-4 5 1.791 5 4 5Zm-8 0c2.209 0 4-2.239 4-5S10.209 1 8 1 4 3.239 4 6s1.791 5 4 5Zm8 2c-2.761 0-5.2.937-6.64 2.378C7.409 14.855 5.132 14 3 14c-1.657 0-3 1.567-3 3.5V21h10v-2c0-1.252.467-2.393 1.256-3.33C12.466 14.646 14.066 14 16 14c3.866 0 7 2.015 7 4.5V21h-8v-1.5c0-2.485-1.79-4.5-4-4.5Z"></path>
          </svg>
          </div>
          <div class="roleTitle">Veli Girişi</div>
        </button>
      </div>
      <div class="smallRow" style="margin-top:10px">
        <button aria-label="Geri" class="pill exit" onclick="exitToHome()" type="button"><span aria-hidden="true" class="backIcon">←</span> Geri</button>
      </div>
    </div>
    <!-- Öğretmen Giriş -->
    <div class="container" id="teacherLogin" style="display:none">
      <h3>Öğretmen Giriş</h3>
      <input autocomplete="name" id="tName" placeholder="Ad Soyad" type="text" />
      <input id="tCode" placeholder="Kod" type="password" />
      <button class="action" onclick="teacherLogin()" type="button">Giriş Yap</button>
    </div>
  </div>
  <!-- ÖĞRENCİ PANELİ -->
  <div class="container" id="studentPanel" style="display:none">
    <h3>Öğrenci Paneli</h3>
    <div class="studentWelcomeBanner" id="studentWelcome" style="display:none"></div>
    <div class="pillTabs" id="studentTabs">
      <button class="pill active" id="stuTabEntryBtn" onclick="showStudentTab('entry')">Soru Girişi</button>
      <button class="pill" id="stuTabWeekBtn" onclick="showStudentTab('week')">Haftalık Rapor</button>
      <button class="pill" id="stuTabMonthBtn" onclick="showStudentTab('month')">Aylık Rapor</button>
    </div>
    <div id="studentTab-entry">
      <div class="student-toolbar">
        <div style="display:flex; gap:8px; align-items:center;">
          <strong>Öğrenci Paneli</strong>
          <span class="chip"><span class="dot" style="background:transparent;border:1px solid var(--cardBorder)"></span>Liste v5.4</span>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="densityToggle" id="densityToggleBtn" title="Yoğun Mod" type="button">Yoğun Mod</button>
        </div>
        <div class="targetInfo" id="studentTargetInfo" style="display:none">
          <div><small>Günlük Hedef</small> <span id="studentTargetValue">—</span> soru</div>
          <div>
            <button class="pill" onclick="openTargetForCurrent()" type="button">🎯 Hedef Belirle</button>
          </div>
        </div>
      </div>
      <form id="lessonForm">
        <div class="list" style="margin-top:10px">
          <div class="sectionTitle">Soru Girişi</div>
          <div class="smallRow" style="margin-bottom:6px">
            <div class="smallRow grow"><b>Dersler</b></div>
            <div style="margin-left:auto;"><small style="opacity:.8;">(Adet)</small></div>
          </div>
          <div class="smallRow">
            <div class="smallRow grow">Türkçe</div>
            <input id="Turkce" pattern="[0-9]*" style="max-width:80px;" type="text" />
          </div>
          <div class="smallRow">
            <div class="smallRow grow">Sosyal Bilgiler</div>
            <input id="Sosyal" pattern="[0-9]*" style="max-width:80px;" type="text" />
          </div>
          <div class="smallRow">
            <div class="smallRow grow">Din Kültürü</div>
            <input id="Din" pattern="[0-9]*" style="max-width:80px;" type="text" />
          </div>
          <div class="smallRow">
            <div class="smallRow grow">İngilizce</div>
            <input id="Ingilizce" pattern="[0-9]*" style="max-width:80px;" type="text" />
          </div>
          <div class="smallRow">
            <div class="smallRow grow">Matematik</div>
            <input id="Matematik" pattern="[0-9]*" style="max-width:80px;" type="text" />
          </div>
          <div class="smallRow">
            <div class="smallRow grow">Fen Bilimleri</div>
            <input id="Fen" pattern="[0-9]*" style="max-width:80px;" type="text" />
          </div>
        </div>
        <button class="action" onclick="addAll()" style="margin-top:10px" type="button">Ekle</button>
      </form>
      <div class="list" id="studentRecords" style="margin-top:10px">
        <!-- İçerik JavaScript ile doldurulacak -->
      </div>
      <button class="action logout" onclick="logout()" type="button">Çıkış Yap</button>
    </div>
    <div id="studentTab-week" style="display:none">
      <div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
      <div id="stuWeekChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
        <canvas height="140" id="stuWeekChart"></canvas>
      </div>
      <div class="exportCard" id="stuWeekMatrix" style="margin-top:10px"></div>
      <div class="ghost" id="stuWeekHint" style="margin-top:6px">Haftalar pazartesiden başlayarak pazartesi–pazar aralığına göre numaralandırılır.</div>
    </div>
    <div id="studentTab-month" style="display:none">
      <div class="sectionTitle">Ay Seç</div>
      <select id="stuMonthSelect" onchange="selectStudentMonth(this.value)" style="width:100%;max-width:420px;"></select>
      <div id="stuMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
        <canvas height="160" id="stuMonthChart"></canvas>
      </div>
      <div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
      <div class="exportCard" id="stuMonthTotals"></div>
    </div>
  </div>
  <!-- ÖĞRETMEN PANELİ -->
  <div class="container" id="teacherPanel" style="display:none">
    <p class="teacherWelcome" id="teacherWelcome"></p>
    <div class="teacherTopbar">
      <h3 style="margin:0">Öğretmen Paneli</h3>
      <button aria-label="Çıkış" class="exitSmall" onclick="logout()" title="Çıkış" type="button">
        <span aria-hidden="true" class="icon">
          <svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16">
            <!-- Simple logout icon: arrow left + door -->
            <path d="M14 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2"></path>
            <path d="M9 12h11"></path>
            <path d="M13 8l-4 4 4 4"></path>
          </svg>
        </span>
        <span class="label">Çıkış</span>
      </button>
    </div>
    <div class="pillTabs" id="teacherTopTabs">
      <button class="pill active" id="tabClasses" onclick="showTeacherSection('classes')">Sınıflar</button>
      <button class="pill" id="tabFavorites" onclick="showTeacherSection('favorites')">Favorilerim</button>
    </div>
    <!-- Sınıflar -->
    <div id="classesSection">
      <div class="row" style="margin-top:10px; margin-bottom:6px">
        <input autocomplete="off" class="grow" id="newClass" placeholder="örn: 8/A" type="text" />
        <button class="action" onclick="addClass()" style="max-width:220px" type="button">Sınıf Ekle</button>
      </div>
      <div class="classGrid" id="classGrid"></div>
      <div class="list" id="classStudents" style="display:none">
        <div class="sectionTitle">Öğrenciler</div>
        <div id="studentsContainer"></div>
      </div>
    </div>
    <!-- Favoriler -->
    <div id="favoritesSection" style="display:none; margin-top:14px">
      <div class="list">
        <div class="sectionTitle">Favori Öğrencilerim</div>
        <div id="favoritesList"></div>
      </div>
      <button class="action logout" onclick="logout()" style="margin:18px auto 8px; display:block; max-width:220px" type="button">Çıkış Yap</button>
    </div>
    <!-- ÖĞRENCİ DETAY + HAFTALIK -->
    <div class="list asModal" id="teacherStudentDetail" style="display:none;">
      <div class="modalHead">
        <div class="modalTabs">
          <button class="pill active" id="repTabDailyBtn" onclick="showReportTab('daily')">Günlük</button>
          <button class="pill" id="repTabWeeklyBtn" onclick="showReportTab('weekly')">Haftalık</button>
          <button class="pill" id="repTabMonthlyBtn" onclick="showReportTab('monthly')">Aylık</button>
        </div>
        <button class="pill modalClose" onclick="closeReportModal()">Kapat ×</button>
      </div>
      <div class="active" id="repTab-daily">
        <div class="sectionTitle" id="tsdTitle"></div>
        <!-- Takvim (tsdDays içinde üretilecek) -->
        <div id="tsdDays"></div>
        <!-- Seçilen Gün Kartı -->
        <div id="selDayBlock" style="margin-top:12px">
          <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
          <div id="tsdDayTable"></div>
        </div>
        <!-- Genel Toplam -->
        <div class="sectionTitle" style="margin-top:12px">Genel Toplam (Ders Bazlı)</div>
        <div id="tsdTotals"></div>
      </div>
      <div id="repTab-weekly">
        <div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
        <div class="smallRow" id="weekControls">
          <div class="smallRow" id="weekList"></div>
          <div id="pdfBtns" style="margin-left:auto">
            <button class="action" disabled id="btnExportPDF" onclick="exportSelectedWeekPDF()" style="max-width:220px">PDF Dışa Aktar</button>
          </div>
        </div>
        <div id="weekChartWrap">
          <canvas height="140" id="weekChart"></canvas>
        </div>
        <div class="exportCard" id="weekMatrix" style="margin-top:10px"></div>
        <div class="ghost" id="weekHint" style="margin-top:6px">Haftalar pazartesiden başlayarak pazartesi–pazar aralığına göre numaralandırılır.</div>
      </div>
      <div id="repTab-monthly">
        <div class="sectionTitle">Ay Seç</div>
        <select id="tMonthSelect" onchange="selectTeacherMonth(this.value)" style="width:100%;max-width:420px;"></select>
        <div id="tMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
          <canvas height="160" id="tMonthChart"></canvas>
        </div>
        <div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
        <div class="exportCard" id="tMonthTotals"></div>
      </div>
    </div>
    <!-- PDF için görünmeyen export alanı -->
    <div id="exportArea" style="position:absolute; left:-99999px; top:-99999px">
      <div id="exportHead">
        <h1>Haftalık Gelişim Raporu</h1>
        <span id="exportRange" style="color:#a5b4fc;font-weight:700;"></span>
      </div>
      <h2 id="exportStudent"></h2>
      <div class="exportCard" style="margin-bottom:10px">
        <canvas height="260" id="exportChart"></canvas>
      </div>
      <div class="exportCard" id="exportTable"></div>
    </div>
  </div>
  <script>
    // Firebase realtime database bağlantısı
    const firebaseConfig = {
      apiKey: "AIzaSyD-D-Jp8GDuoc2b-My7cOpSViRyrcAypX0",
      authDomain: "kocluksistemi-69e89.firebaseapp.com",
      databaseURL: "https://kocluksistemi-69e89-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kocluksistemi-69e89",
      storageBucket: "kocluksistemi-69e89.firebasestorage.app",
      messagingSenderId: "1025155254767",
      appId: "1:1025155254767:web:492d53b2d6f36d0ea88e1a",
      measurementId: "G-PZMLQHZP2L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ============ Global Durum ============ */
    /* === Günlük hedef (student daily target) === */
    let currentTargetEditNum = null;

    function openTargetModal(num, name) {
      try {
        currentTargetEditNum = String(num || "");
      } catch (_) {}
      try {
        currentStudent = String(num || "");
      } catch (_) {}
      // Öğrenci sayfasına geç ve Ders Hedefleri sayfasını aç
      try {
        enterAsStudent();
      } catch (_) {}
      try {
        if (typeof openLessonGoalsPage === 'function') openLessonGoalsPage();
      } catch (_) {}
    }

    function closeTargetModal() {
      try { /* no-op: legacy */ } catch (_) {}
    }

    function saveTarget() {
      try { /* no-op: legacy */ } catch (_) {}
    }

    function closeTargetModal() {
      const m = document.getElementById('targetModal');
      if (m) m.style.display = 'none';
    }

    function saveTarget() {
      const input = document.getElementById('targetInput');
      const val = Number(input && input.value ? input.value : 0);
      if (!currentTargetEditNum) {
        setAlert("Öğrenci bulunamadı.");
        return;
      }
      db.ref("students/" + currentTargetEditNum + "/dailyTarget").set(val).then(() => {
        setAlert("Hedef güncellendi.");
        // Eğer güncellediğimiz mevcut öğrenci ise ekranda göster
        if (currentStudent && String(currentStudent) === String(currentTargetEditNum)) {
          setStudentTargetInfo(val);
        }
        closeTargetModal();
      }).catch(e => setAlert("Kayıt hatası: " + e.message));
    }

    function setStudentTargetInfo(val) {
      const box = document.getElementById('studentTargetInfo');
      const span = document.getElementById('studentTargetValue');
      if (!box || !span) return;
      if (val === null || val === undefined || isNaN(Number(val))) {
        box.style.display = 'none';
        span.textContent = '—';
      } else {
        span.textContent = String(val);
        box.style.display = 'flex';
      }
    }

    function loadStudentTarget() {
      if (!currentStudent) {
        setStudentTargetInfo(null);
        return;
      }
      db.ref("students/" + currentStudent + "/dailyTarget").get().then(snap => {
        setStudentTargetInfo(snap.exists() ? Number(snap.val()) || 0 : null);
      }).catch(() => setStudentTargetInfo(null));
    }

    function openTargetForCurrent() {
      if (!currentStudent) {
        setAlert("Öğrenci oturumu yok.");
        return;
      }
      // Öğrenci adını başlık için al
      db.ref("students/" + currentStudent).get().then(s => {
        const name = (s.exists() && s.val().name) ? s.val().name : currentStudentName || "";
        openTargetModal(currentStudent, name);
      }).catch(() => openTargetModal(currentStudent, currentStudentName || ""));
    }

    function setWelcomeStudentBanner() {
      try {
        var box = document.getElementById('studentWelcome');
        if (!box) return;
        var name = currentStudentName;

        function apply(nm) {
          var pretty = toTitleCaseTR(nm || '').trim();
          if (pretty) {
            box.textContent = 'Sayfana hoş geldin ' + pretty + '.';
            box.style.display = 'block';
          } else {
            box.style.display = 'none';
          }
        }
        if (name) {
          apply(name);
          return;
        }
        // Eğer isim henüz yoksa, öğrenciyi DB'den çek
        if (currentStudent) {
          firebase.database().ref('students/' + currentStudent).get().then(function(snap) {
            if (snap && snap.exists()) {
              currentStudentName = (snap.val() && snap.val().name) ? snap.val().name : null;
              apply(currentStudentName);
            } else {
              box.style.display = 'none';
            }
          }).catch(function() {
            box.style.display = 'none';
          });
        } else {
          box.style.display = 'none';
        }
      } catch (e) { /* no-op */ }
    }

    let currentStudent = null;
    let currentStudentName = null; // Öğrenci adı (hoşgeldin için)
    let currentTeacherId = null,
      currentTeacherName = null;
    let stuWeekChart = null,
      stuMonthChart = null,
      _stuWeeks = [],
      _stuMonths = [];
    let favoritesCache = {},
      classesMap = {},
      activeClassName = null,
      currentDetailNum = null;
    let currentDetailLessons = null,
      currentWeeks = [],
      selectedWeekKey = null,
      weekChart = null;
    // --- Yeni: render çakışmalarını engellemek için ---
    let selectClassRenderToken = 0;
    // --- Yeni: dinleyicileri kapatmak için referanslar ---
    let favRef = null;
    let classesRef = null;

    /* ============ Yardımcılar ============ */
    function setAlert(msg) {
      const a = document.getElementById('alert');
      if (!msg) {
        a.style.display = 'none';
        a.textContent = '';
        return;
      }
      a.textContent = msg;
      a.style.display = 'block';
      setTimeout(() => {
        a.style.display = 'none';
      }, 3500);
    }

    function showTab(tab) {
      // Sekme değiştirirken 'Giriş Türünü Seçin' panelini kapat ve öğrenci oturumunu sıfırla
      const rc = document.getElementById('roleChoice');
      if (rc) rc.style.display = 'none';
      // Öğrenci oturumunu sıfırla (numara bilgisini temizle)
      if (typeof currentStudent !== 'undefined') currentStudent = null;
      ["register", "studentLogin", "teacherLogin"].forEach(id => {
        document.getElementById(id).style.display = (id === tab) ? "block" : "none";
      });
      document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
      if (tab === "register") document.getElementById("tabRegister").classList.add("active");
      if (tab === "studentLogin") document.getElementById("tabStudent").classList.add("active");
      if (tab === "teacherLogin") document.getElementById("tabTeacher").classList.add("active");
    }

    function normalizeId(str) {
      if (!str) return "";
      const map = {
        'ç': 'c',
        'ğ': 'g',
        'ı': 'i',
        'i': 'i',
        'ö': 'o',
        'ş': 's',
        'ü': 'u',
        'Ç': 'c',
        'Ğ': 'g',
        'İ': 'i',
        'I': 'i',
        'Ö': 'o',
        'Ş': 's',
        'Ü': 'u'
      };
      return str.trim().toLowerCase()
        .replace(/[çğıİiöşüÇĞIÖŞÜ]/g, m => map[m] || m)
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    // Basit HTML kaçışları (güvenli veri yazımı için)
    function escHTML(s) {
      return String(s || "").replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    function escAttr(s) {
      return escHTML(s);
    }

    // Türkçe baş harfleri büyüt (Ad Soyad -> Ad Soyad)
    function toTitleCaseTR(str) {
      if (!str) return "";
      return String(str).toLocaleLowerCase('tr-TR')
        .split(/\s+/).map(part => {
          return part.split('-').map(seg => {
            if (!seg) return seg;
            return seg.charAt(0).toLocaleUpperCase('tr-TR') + seg.slice(1);
          }).join('-');
        }).join(' ');
    }

    function isPrivilegedTeacher() {
      if (!currentTeacherName) return false;
      const low = s => s.trim().toLocaleLowerCase('tr-TR');
      return low(currentTeacherName) === low("Emre Demirbaş");
    }

    /* ============ Öğrenci kayıt & giriş ============ */
    function studentRegister() {
      const name = document.getElementById("rName").value.trim();
      const sclass = document.getElementById("rClass").value;
      const num = document.getElementById("rNumber").value.trim();
      const pass = document.getElementById("rPass").value;
      const pass2 = document.getElementById("rPass2").value;
      if (!name || !sclass || !num || !pass || !pass2) {
        setAlert("Tüm alanları doldurun.");
        return;
      }
      if (pass !== pass2) {
        setAlert("Şifreler eşleşmiyor. Lütfen şifreyi iki kez aynı girin.");
        return;
      }
      // Aynı numara ile ikinci kayıt engeli
      db.ref("students/" + num).get().then(snap => {
        if (snap.exists()) {
          setAlert("Bu üye sisteme kayıtlıdır");
          return Promise.reject("duplicate");
        }
        return db.ref("students/" + num).set({
          name,
          sclass,
          num,
          pass
        });
      }).then(() => {
        setAlert("Kayıt başarılı!");
        showTab("studentLogin");
      }).catch(e => {
        if (e !== "duplicate") setAlert("Hata: " + e.message);
      });
    }

    function studentLogin() {
      const num = document.getElementById("lNumber").value.trim();
      const pass = document.getElementById("lPass").value;
      if (!num || !pass) {
        setAlert("Numara ve şifre gerekli.");
        return;
      }
      db.ref("students/" + num).get().then(snap => {
        if (snap.exists() && snap.val().pass === pass) {
          currentStudent = num;
          document.getElementById("lPass").value = "";
          showRoleChoice(snap.val());
        } else {
          setAlert("Numara veya şifre hatalı.");
        }
      });
    }

    // Giriş başarılı ise tür seçimi panelini göster
    function showRoleChoice(student) {
      try {
        currentStudentName = (student && student.name) ? student.name : null;
      } catch (_) {}
      // Kayıt ve diğer giriş panellerini gizle, sadece seçim panelini göster
      const reg = document.getElementById("register");
      const stu = document.getElementById("studentLogin");
      const tea = document.getElementById("teacherLogin");
      const rc = document.getElementById("roleChoice");
      if (reg) reg.style.display = "none";
      if (stu) stu.style.display = "none";
      if (tea) tea.style.display = "none";
      if (rc) rc.style.display = "block";
      // Sekmelerde aktiflik kaldır
      document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
      // Selamlama
      const prettyName = toTitleCaseTR((student && student.name) ? student.name : "");
      const hello = document.getElementById("roleChoiceHello");
      if (hello) {
        if (prettyName) {
          hello.textContent = `${prettyName} (${student.num}) olarak giriş yaptınız. Lütfen devam edin.`;
        } else {
          hello.textContent = "Giriş başarılı. Lütfen devam edin.";
        }
      }
    }

    // Öğrenci olarak devam et – mevcut sayfadaki öğrenci paneli
    function enterAsStudent() {
      document.getElementById("roleChoice").style.display = "none";
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("studentPanel").style.display = "block";
      setWelcomeStudentBanner();
      loadStudentTarget();
      try {
        loadLessonGoals();
      } catch (_) {}
      showStudentTab('entry');
      loadStudentData();
    }

    // Veli olarak devam et – farklı sayfaya yönlendir
    function enterAsParent() {
      const base = (typeof PARENT_PORTAL_URL === 'string' && PARENT_PORTAL_URL) ? PARENT_PORTAL_URL : "veli.html";
      const target = currentStudent ? (base + (base.includes('?') ? '&' : '?') + 'num=' + encodeURIComponent(currentStudent)) : base;
      window.location.href = target;
    }

    // Seçim ekranından geri dön
    function backToLogin() {
      currentStudent = null;
      const rc = document.getElementById('roleChoice');
      if (rc) rc.style.display = 'none';
      showTab("studentLogin");
    }

    function logout() {
      const rc = document.getElementById('roleChoice');
      if (rc) rc.style.display = 'none';
      if (classesRef) {
        classesRef.off();
        classesRef = null;
      }
      if (favRef) {
        favRef.off();
        favRef = null;
      }
      currentStudent = null;
      currentDetailNum = null;
      currentStudentName = null;
      try {
        var b = document.getElementById('studentWelcome');
        if (b) {
          b.style.display = 'none';
          b.textContent = '';
        }
      } catch (_) {}
      try {
        setStudentTargetInfo(null);
      } catch (_) {}
      currentTeacherId = null;
      currentTeacherName = null;
      favoritesCache = {};
      ["rName", "rNumber", "rPass", "rPass2", "lNumber", "lPass", "tName", "tCode", "newClass"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      ["studentPanel", "teacherPanel", "teacherStudentDetail"].forEach(id => document.getElementById(id).style.display = "none");
      document.getElementById("loginPanel").style.display = "block";
      showTab("studentLogin");
      destroyWeekChart();
    }

    /* ============ Öğrenci Paneli ============ */
    function addAll() {
      if (!currentStudent) {
        setAlert("Oturum bulunamadı.");
        return;
      }
      const map = {
        "Türkçe": "Turkce",
        "Sosyal Bilgiler": "Sosyal",
        "Din Kültürü": "Din",
        "İngilizce": "Ingilizce",
        "Matematik": "Matematik",
        "Fen Bilimleri": "Fen"
      };
      const now = new Date();
      const timeStr = now.toLocaleDateString("tr-TR") + " " + now.toLocaleTimeString("tr-TR");
      for (const lesson in map) {
        let v = parseInt(document.getElementById(map[lesson]).value);
        if (isNaN(v)) v = 0;
        db.ref("students/" + currentStudent + "/lessons/" + lesson).push({
          count: v,
          time: timeStr
        });
      }
      setAlert("Kayıt eklendi!");
      document.getElementById("lessonForm").reset();
      loadStudentData();
    }

    // Gün × ders bazında toplamları ve anahtar listesini hazırla
    function loadStudentData() {
      const box = document.getElementById("studentRecords");
      box.innerHTML = "Yükleniyor...";
      db.ref("students/" + currentStudent + "/lessons").get().then(snap => {
        const grouped = {};
        // gün -> { totalPerLesson:{}, keysPerLesson:{} }
        if (snap.exists()) {
          const data = snap.val();
          for (const lesson in data) {
            for (const key in data[lesson]) {
              const e = data[lesson][key];
              const day = (e.time || "").split(" ")[0] || "Bilinmeyen";
              if (!grouped[day]) grouped[day] = {
                totalPerLesson: {},
                keysPerLesson: {}
              };
              grouped[day].totalPerLesson[lesson] = (grouped[day].totalPerLesson[lesson] || 0) + (Number(e.count) || 0);
              (grouped[day].keysPerLesson[lesson] ||= []).push(key);
            }
          }
        }
        // Kapsayıcıyı hazırla: takvim + gün tablosu
        box.innerHTML = `
          <div id="calendarWrap" class="calendarWrap"></div>
          <div id="selDayBlock" style="margin-top:12px">
            <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
            <div id="stuDayTable"></div>
          </div>
        `;
        // takvim bağlamını kur
        const allDays = Object.keys(grouped).sort((a, b) => a.split('.').reverse().join('').localeCompare(b.split('.').reverse().join(''))).reverse();
        window._calCtx = {
          grouped
        };
        renderStudentCalendar();
        // İlk seçili gün (varsa) tabloyu doldur
        if (allDays.length) {
          selectDay(allDays[0]);
        }
      });
    }

    function selectDay(day) {
      if (!window._calCtx || !window._calCtx.grouped) return;
      const table = document.getElementById("stuDayTable");
      const grouped = window._calCtx.grouped;
      if (!grouped[day]) {
        if (table) table.innerHTML = "<div class='empty'>Gün bulunamadı.</div>";
        return;
      }
      const lessons = grouped[day].totalPerLesson;
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html = "<table><tr><th>Ders</th><th>Toplam</th></tr>";
      dersSirasi.forEach(l => {
        const value = lessons[l] || 0;
        html += `<tr><td>${l}</td><td>${value}</td></tr>`;
      });
      html += "</table>";
      if (table) table.innerHTML = html;
    }

    // ========== TAKVİM RENDER (Öğrenci) =============
    function buildCalendarWeeks(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const weeks = [];
      let currentWeek = [];
      // Hafta başlangıcını Pazartesi olarak al
      let day = new Date(firstDay);
      day.setDate(day.getDate() - ((day.getDay() + 6) % 7));
      while (day <= lastDay) {
        const weekStart = new Date(day);
        const week = [];
        for (let i = 0; i < 7; i++) {
          week.push(new Date(day));
          day.setDate(day.getDate() + 1);
        }
        weeks.push(week);
      }
      return weeks;
    }

    function renderStudentCalendar() {
      const wrap = document.getElementById("calendarWrap");
      if (!wrap || !window._calCtx) return;
      const grouped = window._calCtx.grouped || {};
      const allDates = Object.keys(grouped).map(parseTRDateStr).filter(d => !isNaN(d));
      if (!allDates.length) {
        wrap.innerHTML = "<div class='empty'>Kayıt bulunamadı.</div>";
        return;
      }
      const minDate = new Date(Math.min(...allDates));
      const maxDate = new Date(Math.max(...allDates));
      const startYear = minDate.getFullYear();
      const startMonth = minDate.getMonth();
      const endYear = maxDate.getFullYear();
      const endMonth = maxDate.getMonth();
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth();
      let html = "";
      for (let year = startYear; year <= endYear; year++) {
        let monthStart = (year === startYear) ? startMonth : 0;
        let monthEnd = (year === endYear) ? endMonth : 11;
        for (let month = monthStart; month <= monthEnd; month++) {
          const weeks = buildCalendarWeeks(year, month);
          html += `<div class="monthBlock"><div class="sectionTitle">${year} – ${month+1}. Ay</div>`;
          html += `<table class="calendar"><thead><tr><th>Pzt</th><th>Sal</th><th>Çar</th><th>Per</th><th>Cum</th><th>Cts</th><th>Paz</th></tr></thead><tbody>`;
          weeks.forEach(week => {
            html += "<tr>";
            week.forEach(date => {
              const dayStr = formatTR(date);
              const isEmpty = (date.getMonth() !== month);
              const isCurrent = (date.toDateString() === currentDate.toDateString());
              const isSelected = (selectedWeekKey && currentWeeks.find(w => w.key === selectedWeekKey && w.days.find(d => d.toDateString() === date.toDateString())));
              let classes = "";
              if (isEmpty) classes += " empty";
              if (isCurrent) classes += " current";
              if (isSelected) classes += " selected";
              html += `<td class="${classes}" ${!isEmpty ? `onclick="selectDay('${dayStr}')"` : ""}>${date.getDate()}</td>`;
            });
            html += "</tr>";
          });
          html += "</tbody></table></div>";
        }
      }
      wrap.innerHTML = html;
    }

    function selectStudentMonth(key) {
      if (!window._studentMonths) return;
      const data = window._studentMonths[key];
      if (!data) return;
      // Aylık grafiği çiz
      if (stuMonthChart) stuMonthChart.destroy();
      stuMonthChart = new Chart(document.getElementById('stuMonthChart'), data.chartConfig);
      // Aylık toplam tablosunu oluştur
      const totals = data.totals;
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html = "<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
      dersSirasi.forEach(l => {
        const value = totals[l] || 0;
        html += `<tr><td>${l}</td><td>${value}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("stuMonthTotals").innerHTML = html;
    }

    /* ===== Öğrenci Sekmeleri (Soru Girişi / Haftalık / Aylık) ===== */
    function showStudentTab(tab) {
      const tabs = ['entry', 'week', 'month'];
      tabs.forEach(t => {
        const panel = document.getElementById('studentTab-' + t);
        const btn = document.getElementById('stuTab' + (t.charAt(0).toUpperCase() + t.slice(1) + 'Btn'));
        if (panel) panel.style.display = (t === tab) ? 'block' : 'none';
        if (btn) {
          if (t === tab) btn.classList.add('active');
          else btn.classList.remove('active');
        }
      });
      // İlk gösterimde grafikleri hazırla
      if (tab === 'week' && (!_stuWeeks || !_stuWeeks.length) && window._studentLessons) {
        prepareStudentReports(window._studentLessons);
      }
      if (tab === 'month' && (!_stuMonths || !_stuMonths.length) && window._studentLessons) {
        prepareStudentReports(window._studentLessons);
      }
    }

    function destroyWeekChart() {
      try {
        if (weekChart) weekChart.destroy();
      } catch (_) {}
    }

    /* ============ Öğretmen Giriş ============ */
    function teacherLogin() {
      const name = document.getElementById("tName").value.trim();
      const code = document.getElementById("tCode").value;
      if (!name || !code) {
        setAlert("Ad Soyad ve kod gerekli.");
        return;
      }
      if (code !== "703504") {
        setAlert("Kod hatalı.");
        return;
      }
      currentTeacherName = name;
      currentTeacherId = normalizeId(name);
      if (!currentTeacherId) {
        setAlert("Geçerli bir ad giriniz.");
        return;
      }
      db.ref("teachers/" + currentTeacherId).set({
        name: currentTeacherName,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      }).catch(() => {});
      document.getElementById("teacherWelcome").textContent = `Hoş geldiniz, ${toTitleCaseTR(currentTeacherName)}`;
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("teacherPanel").style.display = "block";
      showTeacherSection('classes');
      listenClasses();
      listenFavorites();
    }

    /* ============ Sınıflar (ortak) ============ */
    function addClass() {
      const cls = document.getElementById("newClass").value.trim();
      if (!cls) {
        setAlert("Sınıf adı girin (örn: 8/A).");
        return;
      }
      db.ref("classes").orderByChild("name").equalTo(cls).get().then(s => {
        if (s.exists()) {
          setAlert("Bu sınıf zaten ekli.");
          return;
        }
        return db.ref("classes").push({
          name: cls,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
      }).then(() => {
        document.getElementById("newClass").value = "";
      });
    }

    function deleteClassByName(name) {
      // Güvenlik: sadece Emre Demirbaş silebilir
      if (!isPrivilegedTeacher()) {
        setAlert("Bu işlemi yapma yetkiniz yok.");
        return;
      }
      const classId = classesMap[name];
      if (!classId) {
        setAlert("Sınıf id bulunamadı.");
        return;
      }
      if (!confirm(`"${name}" sınıfını silmek istiyor musunuz?`)) return;
      db.ref("classes/" + classId).remove()
        .then(() => {
          setAlert("Sınıf silindi.");
          if (activeClassName === name) {
            activeClassName = null;
            document.getElementById("classStudents").style.display = "none";
            document.getElementById("teacherStudentDetail").style.display = "none";
          }
        })
        .catch(e => setAlert("Silme hatası: " + e.message));
    }

    function listenClasses() {
      if (classesRef) {
        classesRef.off();
      }
      classesRef = db.ref("classes");
      classesRef.on("value", snap => {
        classesMap = {};
        const names = [];
        snap.forEach(ch => {
          const v = ch.val();
          if (v && v.name) {
            names.push(v.name);
            classesMap[v.name] = ch.key;
          }
        });
        const grid = document.getElementById("classGrid");
        grid.innerHTML = "";
        if (!names.length) {
          grid.innerHTML = "<div class='empty' style='grid-column:1/-1'>Henüz sınıf yok.</div>";
          document.getElementById("classStudents").style.display = "none";
        }
        names.sort().forEach(name => {
          const card = document.createElement("div");
          card.className = "classCard";
          const title = document.createElement("div");
          title.className = "className";
          title.textContent = name;
          const pick = document.createElement("button");
          pick.className = "classPick";
          pick.textContent = "Öğrencileri Gör";
          pick.onclick = () => {
            activeClassName = name;
            document.querySelectorAll(".classPick").forEach(b => b.classList.remove("active"));
            pick.classList.add("active");
            selectClass(name);
          };
          // Sınıf silme ikonu: yalnızca Emre Demirbaş görsün
          if (isPrivilegedTeacher()) {
            const del = document.createElement("button");
            del.className = "delFloat";
            del.setAttribute("title", "Sınıfı Sil");
            del.setAttribute("aria-label", "Sınıfı Sil");
            del.innerHTML = `<img class="trashIcon" src="${TRASH_ICON}" alt="">`;
            del.onclick = (e) => {
              e.stopPropagation();
              deleteClassByName(name);
            };
            card.appendChild(del);
          }
          card.appendChild(title);
          card.appendChild(pick);
          grid.appendChild(card);
        });
        const sel = document.getElementById("rClass");
        const keep = sel.value;
        sel.innerHTML = "<option value='Sınıf Seçin'>Sınıf Seçin</option>";
        names.forEach(n => {
          const o = document.createElement("option");
          o.value = n;
          o.text = n;
          sel.add(o);
        });
        if (names.includes(keep)) sel.value = keep;
        if (activeClassName) {
          const btn = [...document.querySelectorAll(".classPick")].find(b => b.parentElement.querySelector(".className").textContent === activeClassName);
          if (btn) {
            btn.classList.add("active");
            selectClass(activeClassName);
          }
        }
      });
    }

    function clearChildren(node) {
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    // --- Öğrenciler listesi tekilleştirme + race guard ---
    function selectClass(name) {
      const list = document.getElementById("studentsContainer");
      document.getElementById("classStudents").style.display = "block";
      const myToken = ++selectClassRenderToken;
      list.innerHTML = "<div class='empty'>Yükleniyor...</div>";
      db.ref("students").get().then(snap => {
        if (myToken !== selectClassRenderToken) return;
        if (!snap.exists()) {
          list.innerHTML = "<div class='empty'>Kayıtlı öğrenci yok.</div>";
          return;
        }
        const uniqByNum = {};
        snap.forEach(ch => {
          const s = ch.val();
          if (s && s.sclass === name && s.num) {
            uniqByNum[String(s.num)] = {
              name: s.name,
              num: String(s.num),
              sclass: s.sclass
            };
          }
        });
        const nums = Object.keys(uniqByNum)
          .sort((a, b) => (uniqByNum[a].name || "").localeCompare(uniqByNum[b].name || ""));
        if (!nums.length) {
          list.innerHTML = `<div class='empty'>${escHTML(name)} sınıfına öğrenci yok.</div>`;
          return;
        }
        let html = "";
        nums.forEach(n => {
          const s = uniqByNum[n];
          const isFav = !!favoritesCache[s.num];
          const prettyName = toTitleCaseTR(s.name || "");
          html += `
            <div class="studentItem${isFav ? ' hasDel' : ''}">
              <div class="leftGroup">
                <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)} – <span style="opacity:.8">${escHTML(s.sclass || '')}</span></button>
                <button class="starBtn" title="${isFav ? 'Favoriden çıkar' : 'Favorilere ekle'}" data-role="fav" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}" data-sclass="${escAttr(s.sclass || '')}">★</button>
                <button class="targetBtn" title="Hedef belirle" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
              </div>
              ${isFav ? `<button class="delStuFloat" title="Öğrenciyi sil" data-role="delStudent" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">
                <img class="trashIcon" src="${TRASH_ICON}" alt="">
              </button>` : `<button class="editBtn" style="min-width:100px" onclick="toggleFavInline('${escAttr(s.num)}')">Göster</button>`}
            </div>
            ${isFav ? '' : `<div id="fav-block-${escAttr(s.num)}" class="favBlock" style="display:none">
              <div class="smallRow"><b>Günler</b></div>
              <div id="fav-days-${escAttr(s.num)}" class="smallRow" style="margin-top:6px"></div>
              <div class="sectionTitle" style="margin-top:10px">Seçilen Gün – Ders Tablosu</div>
              <div id="fav-table-${escAttr(s.num)}"></div>
            </div>`}
          `;
        });
        list.innerHTML = html;
      });
    }

    /* ============ Favoriler (öğretmene özel, tekilleştirme) ============ */
    function favPath() {
      return currentTeacherId ? "teacherData/" + currentTeacherId + "/favorites" : null;
    }

    function listenFavorites() {
      const path = favPath();
      if (!path) return;
      if (favRef) {
        favRef.off();
      }
      favRef = db.ref(path);
      favRef.on("value", (snap) => {
        const uniqueFavorites = new Map();
        const list = [];
        snap.forEach(ch => {
          const v = ch.val();
          if (!v || !v.num) return;
          const numStr = String(v.num);
          uniqueFavorites.set(numStr, {
            num: numStr,
            name: v.name,
            sclass: v.sclass
          });
        });
        uniqueFavorites.forEach((value) => {
          list.push(value);
        });
        favoritesCache = {};
        list.forEach(v => favoritesCache[v.num] = true);
        renderFavorites(list);
        if (activeClassName) {
          selectClass(activeClassName);
        }
      });
    }

    // Daha sağlam event yakalama (ikon içine tıklamalar dahil)
    document.addEventListener("click", function(e) {
      const el = e.target.closest("[data-role]");
      if (!el) return;
      const role = el.dataset.role;
      if (role === "fav") {
        const {
          num,
          name,
          sclass
        } = el.dataset;
        toggleFavorite(num, name, sclass);
      }
      if (role === "target") {
        const {
          num,
          name
        } = el.dataset;
        openTargetModal(num, name);
      }
      if (role === "delStudent") {
        const {
          num,
          name
        } = el.dataset;
        deleteStudent(num, name);
      }
    });

    function toggleFavorite(num, name, sclass) {
      const path = favPath();
      if (!path) {
        setAlert("Öğretmen oturumu yok.");
        return;
      }
      const ref = db.ref(path + "/" + num);
      if (favoritesCache[num]) ref.remove().catch(e => setAlert("Favoriden çıkarma hatası: " + e.message));
      else ref.set({
        num,
        name,
        sclass,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      }).catch(e => setAlert("Favoriye ekleme hatası: " + e.message));
    }

    function deleteStudent(num, name) {
      if (!confirm(`"${name} (${num})" öğrencisini silmek istiyor musunuz?`)) return;
      const updates = {};
      updates["students/" + num] = null;
      db.ref("teacherData").get().then(snap => {
        if (snap.exists()) {
          snap.forEach(t => {
            updates["teacherData/" + t.key + "/favorites/" + num] = null;
          });
        }
        return db.ref().update(updates);
      }).then(() => {
        setAlert("Öğrenci silindi.");
        if (currentDetailNum === num) {
          currentDetailNum = null;
          document.getElementById("teacherStudentDetail").style.display = "none";
        }
        if (activeClassName) {
          selectClass(activeClassName);
        }
      }).catch(e => setAlert("Öğrenci silme hatası: " + e.message));
    }

    function renderFavorites(items) {
      const box = document.getElementById("favoritesList");
      if (!items || !items.length) {
        box.innerHTML = "<div class='empty'>Henüz favori yok.</div>";
        return;
      }
      const uniqueMap = new Map();
      items.forEach(item => {
        if (item && item.num) uniqueMap.set(String(item.num), item);
      });
      const uniq = Array.from(uniqueMap.values());
      uniq.sort((a, b) => (a.sclass || "").localeCompare(b.sclass || "") || (a.name || "").localeCompare(b.name || ""));
      box.innerHTML = uniq.map(s => {
        const prettyName = toTitleCaseTR(s.name || "");
        return `
        <div class="studentItem" id="fav-row-${escAttr(s.num)}">
          <div class="leftGroup">
            <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${escAttr(s.num)}')">${escHTML(s.num)} – ${escHTML(prettyName)} – <span style="opacity:.8">${escHTML(s.sclass || '')}</span></button>
            <button class="starBtn" title="Favoriden çıkar" data-role="fav" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}" data-sclass="${escAttr(s.sclass || '')}">★</button>
            <button class="targetBtn" title="Hedef belirle" data-role="target" data-num="${escAttr(s.num)}" data-name="${escAttr(prettyName)}">🎯</button>
          </div>
          <button class="editBtn" style="min-width:100px" onclick="toggleFavInline('${escAttr(s.num)}')">Göster</button>
        </div>
        <div id="fav-block-${escAttr(s.num)}" class="favBlock" style="display:none">
          <div class="smallRow"><b>Günler</b></div>
          <div id="fav-days-${escAttr(s.num)}" class="smallRow" style="margin-top:6px"></div>
          <div class="sectionTitle" style="margin-top:10px">Seçilen Gün – Ders Tablosu</div>
          <div id="fav-table-${escAttr(s.num)}"></div>
        </div>
      `;
      }).join("");
    }

    function toggleFavInline(num) {
      const block = document.getElementById("fav-block-" + num);
      const shown = block.style.display === "block";
      if (shown) {
        block.style.display = "none";
        const row = document.getElementById("fav-row-" + num);
        if (row) {
          const btn = row.querySelector(".editBtn");
          if (btn) btn.textContent = "Göster";
        }
        return;
      }
      block.style.display = "block";
      const row = document.getElementById("fav-row-" + num);
      if (row) {
        const btn = row.querySelector(".editBtn");
        if (btn) btn.textContent = "Gizle";
      }
      db.ref("students/" + num + "/lessons").get().then(snap => {
        const daysDiv = document.getElementById("fav-days-" + num);
        const tableDiv = document.getElementById("fav-table-" + num);
        if (!snap.exists()) {
          daysDiv.innerHTML = "<div class='empty'>Veri yok</div>";
          tableDiv.innerHTML = "";
          return;
        }
        const data = snap.val();
        const dayMap = {};
        for (const l in data) {
          for (const k in data[l]) {
            const e = data[l][k];
            const d = (e.time || "").split(" ")[0] || "";
            if (!d) continue;
            if (!dayMap[d]) dayMap[d] = {};
            if (!dayMap[d][l]) dayMap[d][l] = 0;
            dayMap[d][l] += Number(e.count) || 0;
          }
        }
        const dayNames = Object.keys(dayMap).sort((a, b) => a.split('.').reverse().join('').localeCompare(b.split('.').reverse().join(''))).reverse();
        daysDiv.innerHTML = dayNames.length ? dayNames.map(d => `<button class="dayBtn" onclick="renderFavDay('${num}','${d}')">${d}</button>`).join("") : "<div class='empty'>Gün yok</div>";
        if (dayNames.length) renderFavDay(num, dayNames[0]);
      });
    }

    function renderFavDay(num, day) {
      db.ref("students/" + num + "/lessons").get().then(snap => {
        const tableDiv = document.getElementById("fav-table-" + num);
        let perLesson = {};
        if (snap.exists()) {
          const data = snap.val();
          for (const l in data) {
            for (const k in data[l]) {
              const e = data[l][k];
              const d = (e.time || "").split(" ")[0] || "";
              if (d === day) {
                if (!perLesson[l]) perLesson[l] = 0;
                perLesson[l] += Number(e.count) || 0;
              }
            }
          }
        }
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        let html = "<table><tr><th>Ders</th><th>O Gün Çözülen</th></tr>";
        dersSirasi.forEach(l => {
          const value = perLesson[l] || 0;
          html += `<tr><td>${l}</td><td>${value}</td></tr>`;
        });
        html += "</table>";
        tableDiv.innerHTML = html;
      });
    }

    /* ============ Sekme geçişleri ============ */
    function showTeacherSection(sec) {
      const tabClasses = document.getElementById('tabClasses');
      const tabFavorites = document.getElementById('tabFavorites');
      const classesSection = document.getElementById('classesSection');
      const favoritesSection = document.getElementById('favoritesSection');
      if (sec === 'classes') {
        classesSection.style.display = 'block';
        favoritesSection.style.display = 'none';
        tabClasses.classList.add('active');
        tabFavorites.classList.remove('active');
      } else {
        classesSection.style.display = 'none';
        favoritesSection.style.display = 'block';
        tabFavorites.classList.add('active');
        tabClasses.classList.remove('active');
      }
    }

    /* ============ Öğrenci Detay + Haftalık ============ */
    function teacherShowStudent(num) {
      currentDetailNum = num;
      document.getElementById("teacherStudentDetail").style.display = "block";
      destroyWeekChart();
      db.ref("students/" + num).get().then(snap => {
        if (!snap.exists()) {
          setAlert("Öğrenci bulunamadı.");
          return;
        }
        const s = snap.val();
        const prettyName = toTitleCaseTR(s.name || "");
        document.getElementById("tsdTitle").textContent = `${prettyName} (${s.num}) – ${s.sclass}`;
        const lessons = s.lessons || {};
        currentDetailLessons = lessons;
        const dayMap = {},
          totals = {};
        for (const l in lessons) {
          for (const k in lessons[l]) {
            const e = lessons[l][k];
            const d = (e.time || "").split(" ")[0] || "";
            if (!dayMap[d]) dayMap[d] = {};
            if (!dayMap[d][l]) dayMap[d][l] = 0;
            dayMap[d][l] += Number(e.count) || 0;
            if (!totals[l]) totals[l] = 0;
            totals[l] += Number(e.count) || 0;
          }
        }
        const daysBox = document.getElementById("tsdDays");
        const dayNames = Object.keys(dayMap).sort((a, b) => a.split('.').reverse().join('').localeCompare(b.split('.').reverse().join(''))).reverse();
        daysBox.innerHTML = dayNames.length ? dayNames.map(d => `<button class="dayBtn" onclick="teacherShowStudentDay('${num}','${d}')">${d}</button>`).join("") : "<div class='empty'>Gün bulunamadı.</div>";
        // === UI override: Günlük liste yerine takvim render et ===
        try {
          tsdBuildCtxFromLessons(dayMap);
          renderTeacherCalendar();
          // İlk seçili gün (varsa) tabloyu doldur
          const dayKeys = Object.keys(dayMap || {}).sort((a, b) => a.split('.').reverse().join('').localeCompare(b.split('.').reverse().join('')));
          if (dayKeys.length) {
            tsdSelectDate(dayKeys[dayKeys.length - 1]);
          } else {
            const t = document.getElementById("tsdDayTable");
            if (t) t.innerHTML = "<div class='empty'>Gün bulunamadı.</div>";
          }
        } catch (_) { /* no-op */ }
        // === /override ===
        renderTotalsTable(totals, "tsdTotals");
        if (dayNames.length) teacherShowStudentDay(num, dayNames[0]);
        else document.getElementById("tsdDayTable").innerHTML = "<div class='empty'>Gün seçiniz.</div>";
        currentWeeks = buildWeeksFromLessons(lessons);
        renderWeekList(currentWeeks);
        if (currentWeeks.length) {
          selectWeek(currentWeeks[currentWeeks.length - 1].key);
        } else {
          clearWeekArea();
        }
      });
    }

    function renderTotalsTable(totals, targetId) {
      const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      let html = "<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
      dersSirasi.forEach(l => {
        const value = totals[l] || 0;
        html += `<tr><td>${l}</td><td>${value}</td></tr>`;
      });
      html += "</table>";
      document.getElementById(targetId).innerHTML = html;
    }

    function teacherShowStudentDay(num, day) {
      db.ref("students/" + num + "/lessons").get().then(snap => {
        let perLesson = {};
        if (snap.exists()) {
          const data = snap.val();
          for (const l in data) {
            for (const k in data[l]) {
              const e = data[l][k];
              const d = (e.time || "").split(" ")[0] || "";
              if (d === day) {
                if (!perLesson[l]) perLesson[l] = 0;
                perLesson[l] += Number(e.count) || 0;
              }
            }
          }
        }
        const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
        let html = "<table><tr><th>Ders</th><th>O Gün Çözülen</th></tr>";
        dersSirasi.forEach(l => {
          const value = perLesson[l] || 0;
          html += `<tr><td>${l}</td><td>${value}</td></tr>`;
        });
        html += "</table>";
        document.getElementById("tsdDayTable").innerHTML = html;
      });
    }

    /* ===== Haftalık çizgi grafiği + PDF ===== */
    function parseTRDateStr(dstr) {
      const [dd, mm, yy] = dstr.split('.').map(x => parseInt(x, 10));
      return new Date(yy, mm - 1, dd);
    }

    function formatTR(d) {
      return d.toLocaleDateString("tr-TR");
    }

    function mondayOf(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function addDays(d, n) {
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }

    // === Takvim yardımcıları ve denetimleri (Eklendi) ===
    function stuAddMonths(d, n) {
      return new Date(d.getFullYear(), d.getMonth() + n, 1);
    }

    function buildWeeksFromLessons(lessons) {
      const weeksMap = {};
      for (const l in lessons) {
        for (const k in lessons[l]) {
          const e = lessons[l][k];
          const d = (e.time || "").split(" ")[0] || "";
          if (!d) continue;
          const monday = formatTR(mondayOf(parseTRDateStr(d)));
          if (!weeksMap[monday]) weeksMap[monday] = {};
          if (!weeksMap[monday][l]) weeksMap[monday][l] = 0;
          weeksMap[monday][l] += Number(e.count) || 0;
        }
      }
      const sortedKeys = Object.keys(weeksMap).sort((a, b) => parseTRDateStr(a) - parseTRDateStr(b));
      const result = [];
      sortedKeys.forEach(key => {
        const totals = weeksMap[key];
        const chartConfig = {
          type: 'line',
          data: {
            labels: ["Pzt", "Sal", "Çar", "Per", "Cum", "Cts", "Paz"],
            datasets: []
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              },
              title: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        };
        const days = [];
        for (let i = 0; i < 7; i++) {
          const day = addDays(mondayOf(parseTRDateStr(key)), i);
          days.push(day);
          const dateStr = formatTR(day);
          // Boş günler için 0 değer
          if (!weeksMap[key] || !weeksMap[key][dateStr]) {
            continue;
          }
        }
        result.push({
          key,
          days,
          totals,
          chartConfig
        });
      });
      return result;
    }

    function renderWeekList(weeks) {
      const container = document.getElementById("weekList");
      if (!container) return;
      container.innerHTML = "";
      weeks.forEach((week, index) => {
        const button = document.createElement("button");
        button.textContent = `${week.key} - ${formatTR(addDays(parseTRDateStr(week.key), 6))}`;
        button.className = "weekBtn";
        button.onclick = () => selectWeek(week.key);
        container.appendChild(button);
        // Son eklenen haftayı seçili yap
        if (index === weeks.length - 1) {
          button.classList.add("active");
        }
      });
    }

    function selectWeek(key) {
      selectedWeekKey = key;
      // Haftalık grafiği hazırla
      const weekData = currentWeeks.find(w => w.key === key);
      if (!weekData) return;
      const config = weekData.chartConfig;
      const totals = weekData.totals;
      if (weekChart) weekChart.destroy();
      const ctx = document.getElementById('weekChart').getContext('2d');
      const lessons = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      const colors = ["#3b82f6", "#06b6d4", "#a855f7", "#eab308", "#ef4444", "#10b981"];
      lessons.forEach((lesson, idx) => {
        const dataset = {
          label: lesson,
          data: [],
          borderColor: colors[idx],
          backgroundColor: colors[idx] + '33', // semi-transparent fill
          fill: true
        };
        // 7 güne ait değerleri dataset'e ekle
        const weekStart = mondayOf(parseTRDateStr(key));
        for (let i = 0; i < 7; i++) {
          const day = addDays(weekStart, i);
          const dayStr = formatTR(day);
          const count = (totals && totals[lesson] && totals[lesson][dayStr]) ? totals[lesson][dayStr] : 0;
          dataset.data.push(count || 0);
        }
        config.data.datasets.push(dataset);
      });
      weekChart = new Chart(ctx, config);
      // Tabloyu hazırla
      const table = document.getElementById("weekMatrix");
      let html = "<table><tr><th>Ders</th><th>Pzt</th><th>Sal</th><th>Çar</th><th>Per</th><th>Cum</th><th>Cts</th><th>Paz</th></tr>";
      const lessonsList = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
      lessonsList.forEach(l => {
        html += `<tr><td>${l}</td>`;
        const weekStart = mondayOf(parseTRDateStr(key));
        for (let i = 0; i < 7; i++) {
          const day = addDays(weekStart, i);
          const dayStr = formatTR(day);
          const count = (totals && totals[l] && totals[l][dayStr]) ? totals[l][dayStr] : 0;
          html += `<td>${count || 0}</td>`;
        }
        html += "</tr>";
      });
      html += "</table>";
      table.innerHTML = html;
    }

    function clearWeekArea() {
      const matrix = document.getElementById("weekMatrix");
      const chartWrap = document.getElementById("weekChartWrap");
      if (matrix) matrix.innerHTML = "";
      if (chartWrap) chartWrap.innerHTML = "<canvas height='140' id='weekChart'></canvas>";
      const pdfBtn = document.getElementById("btnExportPDF");
      if (pdfBtn) pdfBtn.setAttribute("disabled", "");
    }

    function exportSelectedWeekPDF() {
      // Haftalık raporu PDF olarak dışa aktarma
      if (!selectedWeekKey) return;
      const studentName = document.getElementById("tsdTitle") ? document.getElementById("tsdTitle").textContent : "";
      document.getElementById("exportStudent").textContent = studentName;
      const range = `${selectedWeekKey} – ${formatTR(addDays(parseTRDateStr(selectedWeekKey), 6))}`;
      document.getElementById("exportRange").textContent = range;
      // Grafiği ve tabloyu doldur
      const exportChartCanvas = document.getElementById("exportChart");
      const exportTable = document.getElementById("exportTable");
      if (weekChart) {
        // Grafiğin kopyasını oluştur
        const exportCtx = exportChartCanvas.getContext('2d');
        exportCtx.canvas.width = weekChart.width;
        exportCtx.canvas.height = weekChart.height;
        exportCtx.drawImage(weekChart.canvas, 0, 0);
      }
      if (document.getElementById("weekMatrix")) {
        exportTable.innerHTML = document.getElementById("weekMatrix").innerHTML;
      }
      // PDF oluştur ve indir
      html2canvas(document.getElementById("exportArea")).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('HaftalikRapor.pdf');
        setAlert("PDF indirildi.");
      }).catch(e => setAlert("PDF oluşturma hatası: " + e.message));
    }

    // === Takvim (öğretmen detay) ===
    function tsdBuildCtxFromLessons(dayMap) {
      // dayMap: { "dd.mm.yyyy": { perLesson... } }
      const keys = Object.keys(dayMap || {}).map(parseTRDateStr).filter(d => !isNaN(d));
      if (!keys.length) {
        window._tsdCalCtx = null;
        return;
      }
      const min = new Date(Math.min(...keys));
      const max = new Date(Math.max(...keys));
      const year = min.getFullYear();
      const month = min.getMonth();
      const endYear = max.getFullYear();
      const endMonth = max.getMonth();
      const grouped = {};
      for (let y = year; y <= endYear; y++) {
        grouped[y] = {};
        const startM = (y === year) ? month : 0;
        const endM = (y === endYear) ? endMonth : 11;
        for (let m = startM; m <= endM; m++) {
          grouped[y][m] = {
            weeks: buildCalendarWeeks(y, m)
          };
        }
      }
      window._tsdCalCtx = {
        grouped,
        dayMap
      };
    }

    function renderTeacherCalendar() {
      const wrapBox = document.getElementById("tsdDays");
      if (!wrapBox) return;
      const ctx = window._tsdCalCtx;
      if (!ctx || !ctx.grouped || !ctx.dayMap) return;
      const grouped = ctx.grouped;
      const dayMap = ctx.dayMap;
      let html = "";
      Object.keys(grouped).forEach(year => {
        Object.keys(grouped[year]).forEach(month => {
          const weeks = grouped[year][month].weeks;
          html += `<div class="monthBlock"><div class="sectionTitle">${year} – ${Number(month)+1}. Ay</div>`;
          html += `<table class="calendar"><thead><tr><th>Pzt</th><th>Sal</th><th>Çar</th><th>Per</th><th>Cum</th><th>Cts</th><th>Paz</th></tr></thead><tbody>`;
          weeks.forEach(week => {
            html += "<tr>";
            week.forEach(date => {
              const dayStr = formatTR(date);
              const isEmpty = (date.getMonth() !== Number(month));
              const isSelected = false; // (belirli bir seçim yok, tıklamayla eklenecek)
              let classes = "";
              if (isEmpty) classes += " empty";
              if (isSelected) classes += " selected";
              html += `<td class="${classes}" ${!isEmpty ? `onclick="tsdSelectDate('${dayStr}')"` : ""}>${date.getDate()}</td>`;
            });
            html += "</tr>";
          });
          html += "</tbody></table></div>`;
        });
      });
      wrapBox.innerHTML = html;
    }

    function tsdSelectDate(dayStr) {
      const days = document.querySelectorAll("#tsdDays .dayBtn");
      days.forEach(d => {
        if (d.textContent === dayStr) d.classList.add("active");
        else d.classList.remove("active");
      });
      teacherShowStudentDay(currentDetailNum, dayStr);
    }

    function renderWeekSelectorOptions() {
      const select = document.getElementById("tWeekSelect");
      if (!select || !currentWeeks.length) return;
      select.innerHTML = currentWeeks.map(w => `<option value="${w.key}">${w.key}</option>`).join("");
    }

    function openLessonGoalsPage() {
      // Hedef belirleme sayfasını aç (öğrenci paneli altında modal)
      const modal = document.getElementById('targetModal');
      if (modal) {
        modal.style.display = 'block';
        document.getElementById('targetInput').focus();
      }
    }

    function closeLessonGoalsPage() {
      const modal = document.getElementById('targetModal');
      if (modal) modal.style.display = 'none';
    }

    // --- PDF buton etkinleştirme (öğretmen detay haftalık) ---
    document.addEventListener("change", function(e) {
      const sel = e.target.closest("#weekList select");
      if (!sel) return;
      const btn = document.getElementById("btnExportPDF");
      if (btn) btn.removeAttribute("disabled");
    });
    // --- Mobil optimizasyon (bazı grid ayarları) ---
    @media(max-width: 768px) {
      .roleGrid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .roleCard {
        padding: 18px 14px;
      }
      #teacherPanel .studentItem.hasDel {
        padding-right: 100px;
        /* (trash + target) için yer */
      }
      #teacherPanel .leftGroup {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
      }
      #teacherPanel .studentNameBtn {
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #teacherPanel .starBtn,
      #teacherPanel .delStuFloat,
      #teacherPanel .targetFloat {
        width: 36px;
        height: 36px;
      }
      /* Sınıflar: alt alta olmasın; 2 kolon */
      #teacherPanel .classGrid {}
      #teacherPanel .classCard {
        min-width: 0;
      }
      /* Sınıf adı buton altında kalmasın */
      #teacherPanel .classCard {
        padding-bottom: 76px !important;
      }
      #teacherPanel .classPick {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 40px;
      }
      #teacherPanel .className {
        margin-bottom: 10px;
        line-height: 1.15;
        overflow-wrap: anywhere;
      }
      #teacherPanel .asModal {
        position: fixed !important;
        inset: 0 !important;
        left: 0 !important;
        right: 0 !important;
      }
    }
  </script>
</body>
</html>