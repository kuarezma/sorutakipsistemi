<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ÖĞRENCİ TAKİP PROGRAMI</title>
<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2canvas & jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
    :root{
      --bg:#0f172a; --panel:#1e293b; --muted:#334155; --text:#e2e8f0;
      --accent1:#3b82f6; --accent2:#06b6d4; --warn:#f97316; --ok:#10b981; --danger:#ef4444;
      --export-bg:#0b1427; --export-head:#93c5fd;
      --card:#0b1427; --cardBorder:#263247;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .header{padding:22px;text-align:center;font-size:22px;font-weight:800;color:#93c5fd;text-transform:uppercase}
    .subheader{font-size:16px;color:#cbd5e1;margin-top:4px;font-weight:600;}
    .tabs{display:flex;gap:8px;justify-content:center;max-width:1080px;margin:0 auto 12px;padding:8px;background:var(--panel);border-radius:12px;flex-wrap:wrap}
    .tabs button{flex:1;min-width:160px;padding:12px;border:0;border-radius:10px;background:transparent;color:#cbd5e1;font-weight:700;cursor:pointer}
    .tabs button.active{background:var(--ok);color:#fff}
    /* Odak halkalarını yeşil yap */
    .tabs button:focus,
    .pill:focus,
    .classPick:focus,
    .dayBtn:focus,
    .weekBtn:focus,
    .studentNameBtn:focus,
    .delStuBtn:focus,
    .delStuFloat:focus,
    .delFloat:focus,
    button.action:focus{
      outline:3px solid rgba(16,185,129,.55);
      outline-offset:2px;
    }
    .container{max-width:1080px;margin:16px auto;background:var(--panel);border-radius:16px;padding:22px}
    h3{margin:0 0 14px}
    input,select{width:100%;padding:12px;border:0;border-radius:10px;background:var(--bg);color:#e2e8f0;margin:8px 0}
    button.action{width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:800;cursor:pointer;min-height:48px}
    button.logout{background:var(--warn)}
    table{width:100%;border-collapse:collapse;margin:10px 0}
    th,td{border:1px solid var(--muted);padding:10px;text-align:center}
    .row{display:flex;gap:10px;align-items:center}
    .row>.grow{flex:1}
    /* ---- Sınıf kartları ---- */
    .classGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:14px;
      margin-top:12px;
    }
    .classCard{
      position:relative;
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      padding:14px 14px 48px;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .classCard:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .className{ font-weight:900; font-size:20px; letter-spacing:.3px; margin-bottom:8px; }
    .classPick{
      position:absolute; left:14px; right:14px; bottom:14px;
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      color:#fff; font-weight:800;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    .classPick.active{ outline:3px solid rgba(16,185,129,.40) }
    /* --- Sınıf silme ikonu (zemin üstünde, hover'da flu kırmızı) --- */
    .delFloat{
      position:absolute; top:10px; right:10px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delFloat img.trashIcon{ width:20px; height:20px; display:block; }
    .delFloat:hover{ transform:translateY(-1px); }
    .delFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delFloat:hover::before{ opacity:1; }
    /* --- Öğrenci silme: tuş yerine zeminde çöp kovası simgesi --- */
    .studentItem{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;background:#0b1427;margin:6px 0;border-radius:10px; position:relative;}
    .studentItem.hasDel{ padding-right:48px; } /* sağ üstteki ikon için yer aç */
    .delStuFloat{
      position:absolute; top:8px; right:8px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .delStuFloat img.trashIcon{ width:18px; height:18px; display:block; }
    .delStuFloat:hover{ transform:translateY(-1px); }
    .delStuFloat::before{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:rgba(239,68,68,.26);
      filter:blur(8px);
      opacity:0; transition:opacity .12s ease;
      z-index:-1;
    }
    .delStuFloat:hover::before{ opacity:1; }
    /* (Eski) Öğrenci silme butonu – geriye dönük stil, artık kullanılmıyor */
    .delStuBtn{
      background:linear-gradient(180deg,#ef4444,#dc2626);
      border:1px solid #7f1d1d;
      color:#fff; font-weight:800;
      border-radius:10px;
      padding:8px 12px;
      cursor:pointer;
      display:flex; align-items:center; gap:6px;
      box-shadow:0 6px 16px rgba(239,68,68,.25), inset 0 1px 0 rgba(255,255,255,.08);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .delStuBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(239,68,68,.35); }
    .delStuBtn:active{ transform:translateY(0); box-shadow:0 4px 12px rgba(239,68,68,.3); }
    .delStuBtn img.trashIcon{ width:16px; height:16px; filter:brightness(10); }
    /* Eski küçük pill stilleri bazı yerlerde hâlâ kullanılıyor */
    .pill{padding:10px 16px;border:0;border-radius:999px;background:#334155;color:#e5e7eb;font-weight:800;cursor:pointer;transition:.2s}
    .pill.active{background:linear-gradient(90deg,var(--accent1),var(--accent2)); box-shadow:0 0 0 3px rgba(16,185,129,.35);}
    .pill:hover{filter:brightness(1.05)}
    .delBtn{padding:8px 10px;border:0;border-radius:10px;background:linear-gradient(90deg,#fb7185,#f43f5e);color:#fff;font-weight:800;cursor:pointer}
    .list{margin-top:14px;background:var(--bg);border-radius:12px;padding:12px}
    .leftGroup{display:flex;align-items:center;gap:8px}
    .studentNameBtn{border:0;background:transparent;color:#e2e8f0;font-weight:800;cursor:pointer;text-align:left}
    .starBtn{border:0;background:transparent;font-size:20px;cursor:pointer;color:#f59e0b}
    .starBtn.off{color:#64748b}
    .sectionTitle{margin:12px 0 6px;font-weight:800;opacity:.9}
    .twoCol{display:grid;grid-template-columns: 300px 1fr; gap:14px}
    .dayBtn,.weekBtn{display:block;width:100%;text-align:left;padding:10px;border:0;border-radius:10px;background:#334155;color:#fff;cursor:pointer;margin-top:8px;min-height:44px}
    .empty{opacity:.7;padding:12px;text-align:center}
    .editBtn{padding:6px 12px;border:0;border-radius:6px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
    .smallRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ghost{opacity:.6}
    #alert{max-width:1080px;margin:0 auto 8px;padding:10px 14px;border-radius:10px;background:#0b1427;color:#ffd6a5;display:none}
    #weekChartWrap{background:#0b1427;border-radius:12px;padding:12px;margin-top:10px}
    #pdfBtns{display:flex;gap:10px;flex-wrap:wrap}
    /* EXPORT (PDF görünümü) */
    #exportArea{
      width:1240px; padding:40px 48px 48px;
      background:var(--export-bg); color:#e5e7eb; font-family:Arial, Helvetica, sans-serif;
    }
    #exportArea h1{margin:0 0 6px;font-size:28px;color:var(--export-head)}
    #exportArea h2{margin:0 0 18px;font-size:18px;font-weight:700;color:#c7d2fe}
    #exportHead{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
    .exportCard{background:#0f1a31;border:1px solid #21314f;border-radius:12px;padding:14px}
    #exportTable table{width:100%;border-collapse:collapse}
    #exportTable th,#exportTable td{border:1px solid #21314f;padding:10px;text-align:center}
    #exportLegend{font-size:12px;opacity:.8;margin-top:6px}
    /* ========= MODERN TAKVİM (Eklendi) ========= */
    .calendarWrap{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
    }
    .calHeader{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
    }
    .calTitle{font-weight:900;letter-spacing:.2px;text-transform:capitalize}
    .calNav{display:flex;gap:8px;}
    .calBtn{
      border:0;border-radius:10px;background:#0f1a31;color:#e2e8f0;
      padding:8px 10px;cursor:pointer;font-weight:800;
    }
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
    .calWd{opacity:.75;font-size:12px;text-align:center;margin-bottom:2px}
    .calCell{
      position:relative;min-height:42px;border:1px solid #23324a;border-radius:10px;
      display:flex;align-items:flex-start;justify-content:flex-end;padding:8px;cursor:pointer;background:#0f1a31;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .calCell:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); border-color:#3b4b6a; }
    .calCell.muted{opacity:.5}
    .calDay{font-weight:800}
    .calDot{
      position:absolute;left:8px;bottom:8px;width:8px;height:8px;border-radius:999px;background:#ef4444;
      box-shadow:0 0 0 2px rgba(239,68,68,.15);
    }
    /* ==== /Teacher Modal Takvim === */
    /* ===== Günlük Rapor Tasarımı ===== */
    #repTab-daily #selDayBlock .sectionTitle{
      font-weight:800; margin-bottom:10px;
    }
    /* Tablo görünümü */
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable table{ width:100%; border-collapse:separate; border-spacing:0; }
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable th,
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable td{
      padding:12px 14px;
      border-bottom:1px solid #23324a;
    }
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable thead th{
      text-align:left; font-weight:700; background:#0d1628;
    }
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable tr:last-child td{ border-bottom:0; }
    /* Düzenle düğmesi */
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable .editBtn{
      border:0; border-radius:10px; padding:6px 12px; min-height:32px;
      background: linear-gradient(180deg, #3b82f6, #06b6d4);
      color:#fff; font-weight:800; cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable .editBtn:hover{
      transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.25);
      filter:saturate(1.05);
    }
    #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable .editBtn:focus{
      outline:3px solid rgba(16,185,129,.45); outline-offset:2px;
    }
    /* Küçük ekran ayarı */
    @media (max-width: 560px){
      #repTab-daily .calGrid{ gap:8px; }
      #repTab-daily .calCell{ min-height:44px; padding:8px; }
      #repTab-daily #selDayBlock{ padding:12px; }
      #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable th, #repTab-daily #stuDayTable, #repTab-daily #tsdDayTable td{ padding:10px 12px; }
    }
    /* ====== /Günlük Rapor Tasarımı ====== */
    /* === Haftalık Sekme: Açılır Hafta Listesi (Dropdown) === */
    #repTab-weekly #weekControls{ display:flex; align-items:center; gap:12px; }
    #repTab-weekly .weekDropdown{ position:relative; display:inline-block; }
    #repTab-weekly .wdToggle{
      border:0; border-radius:12px; padding:8px 12px; min-height:36px;
      background: linear-gradient(180deg, #3b82f6, #06b6d4);
      color:#fff; font-weight:900; cursor:pointer;
      display:flex; align-items:center; gap:10px;
    }
    #repTab-weekly .wdToggle .chev{ font-weight:900; opacity:.9; }
    #repTab-weekly .wdMenu{
      position:absolute; top:calc(100% + 6px); left:0; z-index:50;
      background:#0f1a31; border:1px solid #23324a; border-radius:12px; padding:8px;
      box-shadow:0 20px 50px rgba(0,0,0,.45); min-width:320px; max-height:280px; overflow:auto;
      display:none;
    }
    #repTab-weekly .wdMenu.open{ display:block; }
    #repTab-weekly .wdItem{
      display:block; width:100%; text-align:left; border:0; background:transparent; color:inherit;
      padding:8px 10px; border-radius:8px; cursor:pointer;
    }
    #repTab-weekly .wdItem:hover{ background:rgba(148,163,184,.08); }
    #repTab-weekly .wdItem.active{ background:rgba(34,197,94,.15); outline:1px dashed rgba(16,185,129,.45); }
    @media (max-width:560px){
      #repTab-weekly .wdMenu{ min-width:260px; }
    }
    /* === /Dropdown CSS === */
    /* === Öğrenci Hoşgeldin Bannerı === */
    .studentWelcomeBanner{
      margin:10px 0 12px;
      padding:12px 14px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(34,197,94,.16), rgba(6,182,212,.10));
      border:1px solid rgba(34,197,94,.35);
      font-weight:800;
      color:#d1fae5;
      text-align:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.25), inset 0 0 0 1px rgba(34,197,94,.15);
    }
    /* === Hedef (daily target) === */
    .targetBtn{
      border:none;background:transparent;cursor:pointer;font-size:20px;line-height:1;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.4));
    }
    .targetBtn:hover{ transform: scale(1.05); }
    .targetInfo{
      margin:6px 0 10px; padding:8px 10px; border-radius:10px;
      background: rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.25);
      font-weight:600; display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .targetInfo small{opacity:.9}
    /* Float target button next to trash */
    .targetFloat{
      position:absolute; top:8px; right:52px;
      display:grid; place-items:center;
      width:36px; height:36px; padding:0;
      border:0; border-radius:999px;
      background:transparent;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      z-index:2;
    }
    .targetFloat:hover{ transform:translateY(-1px); }
</style>
<style>
/* --- Açılır Pencere (Rapor Modal) --- */
#reportOverlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);z-index:9998;}
#teacherStudentDetail.asModal{position:fixed;inset:auto auto 5% 50%;transform:translateX(-50%);width:min(920px,92vw);max-height:88vh;overflow:auto;
  background:var(--card,#0b1427);border:1px solid var(--cardBorder,#1e293b);border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.45);padding:16px;z-index:9999;}
.modalHead{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;position:sticky;top:0;background:inherit;padding-bottom:8px;}
.modalTabs{display:flex;gap:8px;align-items:center;}
.modalTabs .pill{cursor:pointer;}
.modalClose{margin-left:auto}
#repTab-daily,#repTab-weekly,#repTab-monthly{display:none;}
#repTab-daily.active,#repTab-weekly.active,#repTab-monthly.active{display:block;}
@media (max-width: 720px){
  #teacherStudentDetail.asModal{inset:auto auto 2% 50%; width:96vw; }
}
</style>
<style>
/* === MOBILE OVERRIDES (dikey mod için) === */
* { min-width: 0; }
html, body { width: 100%; }
:root { --page-pad: 12px; }
/* Küçük ekranlar: 600px ve altı */
@media (max-width: 600px){
  body { font-size: 15px; line-height: 1.35; }
  /* Üst başlık ve alt başlık */
  .header { padding: 18px var(--page-pad); font-size: 20px; }
  .header .subheader { font-size: 12px; opacity: .9; }
  /* Sekmeler: taşmadan yatay kaydırılabilir */
  .tabs{
    display:flex; gap:8px; padding: 0 var(--page-pad);
    overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  .tabs::-webkit-scrollbar{ display:none; }
  .tabs > * { flex: 0 0 auto; }
  /* Kart/kutu düzenleri */
  .container, .list, #studentPanel, #teacherPanel, #goalsPage .gp-note{
    margin: 10px var(--page-pad); padding: 12px;
  }
  /* Form elemanları: parmak dostu */
  input, select, button, textarea { font-size: 16px; }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type="number"] { -moz-appearance: textfield; }
}
</style>
</head>
<body>
<div id="reportOverlay" onclick="closeReportModal()"></div>
<div class="header">ÖĞRENCİ TAKİP PROGRAMI
    <div class="subheader">Alparslan Ortaokulu</div>
</div>
<div id="alert"></div>
<!-- Giriş Alanı -->
<div id="loginPanel">
<div class="tabs">
<button class="active" id="tabRegister" onclick="showTab('register')" type="button">Öğrenci Kayıt</button>
<button id="tabStudent" onclick="showTab('studentLogin')" type="button">Öğrenci-Veli Giriş</button>
<button id="tabTeacher" onclick="showTab('teacherLogin')" type="button">Öğretmen Giriş</button>
</div>
<!-- Öğrenci Kayıt -->
<div class="container" id="register">
<h3>Öğrenci Kayıt</h3>
<input autocomplete="off" id="rName" placeholder="Ad Soyad" type="text"/>
<select id="rClass"><option value="">Sınıf Seçin</option></select>
<input autocomplete="off" id="rNumber" placeholder="Okul Numarası" type="text"/>
<input autocomplete="new-password" id="rPass" placeholder="Şifre" type="password"/>
<input autocomplete="new-password" id="rPass2" placeholder="Şifre (Tekrar)" type="password"/>
<small id="passMismatchError" style="display:none;color:#ef4444;font-weight:600;">Şifreler eşleşmiyor</small>
<button class="action" id="registerBtn" onclick="studentRegister()" type="button">Kayıt</button>
</div>
<!-- Öğrenci-Veli Giriş -->
<div class="container" id="studentLogin" style="display:none">
<h3>Öğrenci-Veli Giriş</h3>
<input autocomplete="off" id="lNumber" placeholder="Okul Numarası" type="text"/>
<input autocomplete="current-password" id="lPass" placeholder="Şifre" type="password"/>
<button class="action" onclick="studentLogin()" type="button">Giriş Yap</button>
</div>
<!-- Giriş Türü Seçimi -->
<div class="container" id="roleChoice" style="display:none">
<h3>Giriş Türünü Seçin</h3>
<div class="teacherWelcome" id="roleChoiceHello"></div>
<div class="roleGrid">
<button aria-label="Öğrenci Girişi" class="roleCard" onclick="enterAsStudent()" type="button">
<div aria-hidden="true" class="roleIcon">
<svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 12c2.761 0 5-2.686 5-6s-2.239-6-5-6-5 2.686-5 6 2.239 6 5 6Zm0 2c-4.418 0-8 2.686-8 6v2h16v-2c0-3.314-3.582-6-8-6Z"></path>
</svg>
</div>
<div class="roleTitle">Öğrenci Girişi</div>
</button>
<button aria-label="Veli Girişi" class="roleCard parent" onclick="enterAsParent()" type="button">
<div aria-hidden="true" class="roleIcon">
<svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M16 11c2.209 0 4-2.239 4-5s-1.791-5-4-5-4 2.239-4 5 1.791 5 4 5Zm-8 0c2.209 0 4-2.239 4-5S10.209 1 8 1 4 3.239 4 6s1.791 5 4 5Zm8 2c-2.761 0-5.2.937-6.64 2.378C7.409 14.855 5.132 14 3 14c-1.657 0-3 1.567-3 3.5V21h10v-2c0-1.252.467-2.393 1.256-3.33C12.466 14.646 14.066 14 16 14c3.866 0 7 2.015 7 4.5V21h-8v-1.5c0-2.485-1.79-4.5-4-4.5Z"></path>
</svg>
</div>
<div class="roleTitle">Veli Girişi</div>
</button>
</div>
<div class="smallRow" style="margin-top:10px">
<button aria-label="Geri" class="pill exit" onclick="exitToHome()" type="button"><span aria-hidden="true" class="backIcon">←</span> Geri</button>
</div>
</div>
<!-- Öğretmen Giriş -->
<div class="container" id="teacherLogin" style="display:none">
<h3>Öğretmen Giriş</h3>
<input autocomplete="name" id="tName" placeholder="Ad Soyad" type="text"/>
<input id="tCode" placeholder="Kod" type="password"/>
<button class="action" onclick="teacherLogin()" type="button">Giriş Yap</button>
</div>
</div>
<!-- ÖĞRENCİ PANELİ -->
<div class="container" id="studentPanel" style="display:none">
<h3>Öğrenci Paneli</h3>
<div class="studentWelcomeBanner" id="studentWelcome" style="display:none"></div>
<div class="pillTabs" id="studentTabs">
<button class="pill active" id="stuTabEntryBtn" onclick="showStudentTab('entry')">Soru Girişi</button>
<button class="pill" id="stuTabWeekBtn" onclick="showStudentTab('week')">Haftalık Rapor</button>
<button class="pill" id="stuTabMonthBtn" onclick="showStudentTab('month')">Aylık Rapor</button>
</div>
<div id="studentTab-entry">
<div class="sectionTitle">Soru Girişi</div>
<form id="lessonForm">
<table>
<tr><th>Ders</th><th>Çözülen Soru</th></tr>
<tr><td>Türkçe</td><td><input type="number" id="Turkce" inputmode="numeric"></td></tr>
<tr><td>Sosyal Bilgiler</td><td><input type="number" id="Sosyal" inputmode="numeric"></td></tr>
<tr><td>Din Kültürü</td><td><input type="number" id="Din" inputmode="numeric"></td></tr>
<tr><td>İngilizce</td><td><input type="number" id="Ingilizce" inputmode="numeric"></td></tr>
<tr><td>Matematik</td><td><input type="number" id="Matematik" inputmode="numeric"></td></tr>
<tr><td>Fen Bilimleri</td><td><input type="number" id="Fen" inputmode="numeric"></td></tr>
</table>
<button type="button" class="action" onclick="addAll()">Ekle</button>
</form>
<div id="studentRecords" class="list"></div>
</div>
<!-- === STUDENT WEEKLY REPORT TAB === -->
<div id="studentTab-week" style="display:none">
<div class="sectionTitle">Hafta Seç</div>
<select id="stuWeekSelect" onchange="selectStuWeek(this.value)" style="width:100%;max-width:420px;"></select>
<div id="stuWeekChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="stuWeekChart"></canvas>
</div>
<div class="exportCard" id="stuWeekMatrix" style="margin-top:10px"></div>
</div>
<!-- === STUDENT MONTHLY REPORT TAB === -->
<div id="studentTab-month" style="display:none">
<div class="sectionTitle">Ay Seç</div>
<select id="stuMonthSelect" onchange="selectStuMonth(this.value)" style="width:100%;max-width:420px;"></select>
<div id="stuMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="stuMonthChart"></canvas>
</div>
<div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
<div class="exportCard" id="stuMonthTotals"></div>
</div>
<button class="action logout" onclick="logout()" type="button">Çıkış Yap</button>
</div>
<!-- ÖĞRETMEN PANELİ -->
<div class="container" id="teacherPanel" style="display:none">
<p class="teacherWelcome" id="teacherWelcome"></p>
<div class="teacherTopbar">
<h3 style="margin:0">Öğretmen Paneli</h3>
<button aria-label="Çıkış" class="exitSmall" onclick="logout()" title="Çıkış" type="button"><span aria-hidden="true" class="icon"><svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M14 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2"></path><path d="M9 12h11"></path><path d="M13 8l-4 4 4 4"></path></svg></span><span class="label">Çıkış</span></button>
</div>
<div class="pillTabs" id="teacherTopTabs">
<button class="pill active" id="tabClasses" onclick="showTeacherSection('classes')">Sınıflar</button>
<button class="pill" id="tabFavorites" onclick="showTeacherSection('favorites')">Favorilerim</button>
</div>
<!-- Sınıflar -->
<div id="classesSection">
<div class="row" style="margin-top:10px; margin-bottom:6px">
<input autocomplete="off" class="grow" id="newClass" placeholder="örn: 8/A" type="text"/>
<button class="action" onclick="addClass()" style="max-width:220px" type="button">Sınıf Ekle</button>
</div>
<div class="classGrid" id="classGrid"></div>
<div class="list" id="classStudents" style="display:none">
<div class="sectionTitle">Öğrenciler</div>
<div id="studentsContainer"></div>
</div>
</div>
<!-- Favoriler -->
<div id="favoritesSection" style="display:none; margin-top:14px">
<div class="list">
<div class="sectionTitle">Favori Öğrencilerim</div>
<div id="favoritesList"></div>
</div>
<button class="action logout" onclick="logout()" style="margin:18px auto 8px; display:block; max-width:220px" type="button">Çıkış Yap</button>
</div>
<!-- ÖĞRENCİ DETAY + HAFTALIK -->
<div class="list asModal" id="teacherStudentDetail" style="display:none;">
<div class="modalHead">
<div class="modalTabs">
<button class="pill active" id="repTabDailyBtn" onclick="showReportTab('daily')">Günlük</button>
<button class="pill" id="repTabWeeklyBtn" onclick="showReportTab('weekly')">Haftalık</button>
<button class="pill" id="repTabMonthlyBtn" onclick="showReportTab('monthly')">Aylık</button>
</div>
<button class="pill modalClose" onclick="closeReportModal()">Kapat ×</button>
</div>
<div class="active" id="repTab-daily">
<div class="sectionTitle" id="tsdTitle"></div>
<div id="tsdDays"></div>
<div id="selDayBlock" style="margin-top:12px">
<div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
<div id="tsdDayTable"></div>
</div>
<div class="sectionTitle" style="margin-top:12px">Genel Toplam (Ders Bazlı)</div>
<div id="tsdTotals"></div>
</div>
<div id="repTab-weekly">
<div class="sectionTitle">Haftalık Gelişim (Pzt–Paz)</div>
<div class="smallRow" id="weekControls">
<div class="smallRow" id="weekList"></div>
<div id="pdfBtns" style="margin-left:auto">
<button class="action" disabled="" id="btnExportPDF" onclick="exportSelectedWeekPDF()" style="max-width:220px">PDF Dışa Aktar</button>
</div>
</div>
<div id="weekChartWrap"><canvas height="140" id="weekChart"></canvas></div>
<div class="exportCard" id="weekMatrix" style="margin-top:10px"></div>
<div class="ghost" id="weekHint" style="margin-top:6px">Haftalar pazartesiden başlayarak pazartesi–pazar aralığına göre numaralandırılır.</div>
</div>
<div id="repTab-monthly">
<div class="sectionTitle">Ay Seç</div>
<select id="tMonthSelect" onchange="selectTeacherMonth(this.value)" style="width:100%;max-width:420px;"></select>
<div id="tMonthChartWrap" style="background:#0b1427;border-radius:12px;padding:12px;margin-top:10px">
<canvas height="160" id="tMonthChart"></canvas>
</div>
<div class="sectionTitle" style="margin-top:10px">Aylık Toplam (Ders Bazlı)</div>
<div class="exportCard" id="tMonthTotals"></div>
</div>
</div>
<!-- PDF için görünmeyen export alanı -->
<div id="exportArea" style="position:absolute; left:-99999px; top:-99999px">
<div id="exportHead">
<h1>Haftalık Gelişim Raporu</h1>
<span id="exportRange" style="color:#a5b4fc;font-weight:700;"></span>
</div>
<h2 id="exportStudent"></h2>
<div class="exportCard" style="margin-bottom:10px">
<canvas height="260" id="exportChart"></canvas>
</div>
<div class="exportCard" id="exportTable"></div>
<div id="exportLegend">Ders × Gün matrisi (Pzt–Paz). Renkler ve tipografi PDF için optimize edilmiştir.</div>
</div>
<script>
    /* ============ Firebase Config ============ */
    const firebaseConfig = {
      apiKey: "AIzaSyD-D-Jp8GDuoc2b-My7cOpSViRyrcAypX0",
      authDomain: "kocluksistemi-69e89.firebaseapp.com",
      databaseURL: "https://sorutakipsistemi-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "kocluksistemi-69e89",
      storageBucket: "kocluksistemi-69e89.appspot.com",
      messagingSenderId: "1025155254767",
      appId: "1:1025155254767:web:492d53b2d6f36d0ea88e1a",
      measurementId: "G-PZMLQHZP2L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
/* ============ Global Durum ============ */
let currentTargetEditNum = null;
let currentStudent=null;
let currentStudentName=null;
let currentTeacherId=null, currentTeacherName=null;
let stuWeekChart=null, stuMonthChart=null, _stuWeeks=[], _stuMonths=[];
let favoritesCache={}, classesMap={}, activeClassName=null, currentDetailNum=null;
let currentDetailLessons=null, currentWeeks=[], selectedWeekKey=null, weekChart=null;
// --- Yeni: render çakışmalarını engellemek için ---
let selectClassRenderToken = 0;
// --- Yeni: dinleyicileri kapatmak için referanslar ---
let favRef = null;
let classesRef = null;

/* ============ Yardımcılar ============ */
function setAlert(msg){
  const a=document.getElementById('alert');
  if(!msg){ a.style.display='none'; a.textContent=''; return; }
  a.textContent=msg; a.style.display='block';
  setTimeout(()=>{ a.style.display='none'; }, 3500);
}
function showTab(tab){
  // Sekme değiştirirken 'Giriş Türünü Seçin' panelini kapat ve öğrenci oturumunu sıfırla
  const rc = document.getElementById('roleChoice');
  if (rc) rc.style.display = 'none';
  // Öğrenci oturumunu sıfırla (numara bilgisini temizle)
  if (typeof currentStudent !== 'undefined') currentStudent = null;
  ["register","studentLogin","teacherLogin"].forEach(id=>{
    document.getElementById(id).style.display = (id===tab) ? "block" : "none";
  });
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  if(tab==="register") document.getElementById("tabRegister").classList.add("active");
  if(tab==="studentLogin") document.getElementById("tabStudent").classList.add("active");
  if(tab==="teacherLogin") document.getElementById("tabTeacher").classList.add("active");
}
function normalizeId(str){
  if(!str) return "";
  const map={'ç':'c','ğ':'g','ı':'i','i':'i','ö':'o','ş':'s','ü':'u','Ç':'c','Ğ':'g','İ':'i','I':'i','Ö':'o','Ş':'s','Ü':'u'};
  return str.trim().toLowerCase()
    .replace(/[çğıİiöşüÇĞIÖŞÜ]/g, m=>map[m]||m)
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'');
}
function toTitleCaseTR(str){
  if(!str) return "";
  return String(str).toLocaleLowerCase('tr-TR')
    .split(/\s+/).map(part=>{
      return part.split('-').map(seg=>{
        if(!seg) return seg;
        return seg.charAt(0).toLocaleUpperCase('tr-TR') + seg.slice(1);
      }).join('-');
    }).join(' ');
}
function isPrivilegedTeacher(){
  if(!currentTeacherName) return false;
  const low = s=>s.trim().toLocaleLowerCase('tr-TR');
  return low(currentTeacherName) === low("Uğur Yaşayan");
}

/* ============ Öğrenci kayıt & giriş ============ */
function studentRegister(){
  const name=document.getElementById("rName").value.trim();
  const sclass=document.getElementById("rClass").value;
  const num=document.getElementById("rNumber").value.trim();
  const pass=document.getElementById("rPass").value;
  const pass2=document.getElementById("rPass2").value;
  if(!name||!sclass||!num||!pass||!pass2){
    setAlert("Tüm alanları doldurun."); return;
  }
  if(pass!==pass2){
    setAlert("Şifreler eşleşmiyor. Lütfen şifreyi iki kez aynı girin."); return;
  }
  db.ref("students/"+num).get().then(snap=>{
    if(snap.exists()){
      setAlert("Bu üye sisteme kayıtlıdır");
      return Promise.reject("duplicate");
    }
    return db.ref("students/"+num).set({name,sclass,num,pass});
  }).then(()=>{
    setAlert("Kayıt başarılı!");
    showTab("studentLogin");
  }).catch(e=>{
    if(e!=="duplicate") setAlert("Hata: "+e.message);
  });
}
function studentLogin(){
  const num=document.getElementById("lNumber").value.trim();
  const pass=document.getElementById("lPass").value;
  db.ref("students/"+num).get().then(snap=>{
    if(snap.exists() && snap.val().pass===pass){
      currentStudent = num;
      document.getElementById("lPass").value="";
      showRoleChoice(snap.val());
    }else{
      setAlert("Numara veya şifre hatalı.");
    }
  });
}
// Giriş başarılı ise tür seçimi panelini göster
function showRoleChoice(student){
  try{ currentStudentName = (student && student.name) ? student.name : null; }catch(_){}
  // Kayıt ve diğer giriş panellerini gizle, sadece seçim panelini göster
  const reg=document.getElementById("register");
  const stu=document.getElementById("studentLogin");
  const tea=document.getElementById("teacherLogin");
  const rc =document.getElementById("roleChoice");
  if(reg) reg.style.display="none";
  if(stu) stu.style.display="none";
  if(tea) tea.style.display="none";
  if(rc)  rc.style.display="block";
  // Sekmelerde aktiflik kaldır
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  // Selamlama
  const prettyName = toTitleCaseTR((student && student.name) ? student.name : "");
  const hello = document.getElementById("roleChoiceHello");
  if(hello){
    if(prettyName){
      hello.textContent = `${prettyName} (${student.num}) olarak giriş yaptınız. Lütfen devam edin.`;
    }else{
      hello.textContent = "Giriş başarılı. Lütfen devam edin.";
    }
  }
}
// Öğrenci olarak devam et – mevcut sayfadaki öğrenci paneli
function enterAsStudent(){
  document.getElementById("roleChoice").style.display="none";
  document.getElementById("loginPanel").style.display="none";
  document.getElementById("studentPanel").style.display="block";
  try{ setWelcomeStudentBanner(); }catch(_){}
  try{ loadStudentTarget(); }catch(_){}
  try{ loadLessonGoals(); }catch(_){}
  showStudentTab('entry');
  loadStudentData();
}
// Veli olarak devam et – farklı sayfaya yönlendir
function enterAsParent(){
  const base = (typeof PARENT_PORTAL_URL==='string' && PARENT_PORTAL_URL) ? PARENT_PORTAL_URL : "veli.html";
  const target = currentStudent ? (base + (base.includes('?')?'&':'?') + 'num=' + encodeURIComponent(currentStudent)) : base;
  window.location.href = target;
}
// Seçim ekranından geri dön
function backToLogin(){
  currentStudent = null;
  const rc=document.getElementById('roleChoice'); if(rc) rc.style.display='none';
  showTab("studentLogin");
}
function logout(){
  const rc=document.getElementById('roleChoice'); if(rc) rc.style.display='none';
  if(classesRef){ classesRef.off(); classesRef=null; }
  if(favRef){ favRef.off(); favRef=null; }
  currentStudent=null; currentDetailNum=null; currentStudentName=null;
  try{ var b=document.getElementById('studentWelcome'); if(b){ b.style.display='none'; b.textContent=''; } }catch(_){ }
  try{ setStudentTargetInfo(null); }catch(_){}
  currentTeacherId=null; currentTeacherName=null; favoritesCache={};
  ["rName","rNumber","rPass","rPass2","lNumber","lPass","tName","tCode","newClass"].forEach(id=>{const el=document.getElementById(id); if(el) el.value="";});
  ["studentPanel","teacherPanel","teacherStudentDetail"].forEach(id=>document.getElementById(id).style.display="none");
  document.getElementById("loginPanel").style.display="block";
  showTab("studentLogin");
  destroyWeekChart();
}

/* ============ Öğrenci Paneli ============ */
function setWelcomeStudentBanner(){
  try{
    var box = document.getElementById('studentWelcome');
    if(!box) return;
    var name = currentStudentName;
    function apply(nm){
      var pretty = toTitleCaseTR(nm||'').trim();
      if(pretty){
        box.textContent = 'Sayfana hoş geldin ' + pretty + '.';
        box.style.display = 'block';
      }else{
        box.style.display = 'none';
      }
    }
    if(name){ apply(name); return; }
    if(currentStudent){
      firebase.database().ref('students/' + currentStudent).get().then(function(snap){
        if(snap && snap.exists()){
          currentStudentName = (snap.val() && snap.val().name) ? snap.val().name : null;
          apply(currentStudentName);
        }else{
          box.style.display='none';
        }
      }).catch(function(){ box.style.display='none'; });
    }else{
      box.style.display='none';
    }
  }catch(e){ /* no-op */ }
}
function addAll(){
  if(!currentStudent){ setAlert("Oturum bulunamadı."); return; }
  const map={"Türkçe":"Turkce","Sosyal Bilgiler":"Sosyal","Din Kültürü":"Din","İngilizce":"Ingilizce","Matematik":"Matematik","Fen Bilimleri":"Fen"};
  const now=new Date();
  const timeStr=now.toLocaleDateString("tr-TR")+" "+now.toLocaleTimeString("tr-TR");
  for(const lesson in map){
    let v=parseInt(document.getElementById(map[lesson]).value);
    if(isNaN(v)) v=0;
    db.ref("students/"+currentStudent+"/lessons/"+lesson).push({count:v,time:timeStr});
  }
  setAlert("Kayıt eklendi!");
  document.getElementById("lessonForm").reset();
  loadStudentData();
}
function loadStudentData(){
  const box=document.getElementById("studentRecords");
  box.innerHTML="Yükleniyor...";
  db.ref("students/"+currentStudent+"/lessons").get().then(snap=>{
    const grouped={};
    if(snap.exists()){
      const data=snap.val();
      for(const lesson in data){
        for(const key in data[lesson]){
          const e=data[lesson][key];
          const day=(e.time||"").split(" ")[0]||"Bilinmeyen";
          if(!grouped[day]) grouped[day]={ totalPerLesson:{}, keysPerLesson:{} };
          grouped[day].totalPerLesson[lesson]=(grouped[day].totalPerLesson[lesson]||0) + (Number(e.count)||0);
          (grouped[day].keysPerLesson[lesson] ||= []).push(key);
        }
      }
    }
    box.innerHTML = `
      <div id="calendarWrap" class="calendarWrap"></div>
      <div id="selDayBlock" style="margin-top:12px">
        <div class="sectionTitle">Seçilen Gün – Ders Tablosu</div>
        <div id="stuDayTable"></div>
      </div>
    `;
    const allDays = Object.keys(grouped);
    window._calCtx = { grouped, selectedDate:new Date(), hasSet:new Set(allDays) };
    renderStudentCalendar();
  });
}
function renderStudentCalendar(){
  const wrap = document.getElementById("calendarWrap");
  if(!wrap) return;
  const ctx = window._calCtx;
  const monthLabel = ctx.selectedDate.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
  let html = `
    <div class="calHeader">
      <div class="calTitle">${monthLabel}</div>
      <div class="calNav">
        <button class="calBtn" type="button" onclick="stuCalPrevMonth()">‹</button>
        <button class="calBtnToday" type="button" id="btnToday" onclick="stuGoToday()">Bugün</button>
        <button class="calBtn" type="button" onclick="stuCalNextMonth()">›</button>
      </div>
    </div>
    <div class="calGrid">
      ${['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'].map(d=>`<div class="calWd">${d}</div>`).join('')}
  `;
  const startGrid = mondayOf(new Date(ctx.selectedDate.getFullYear(), ctx.selectedDate.getMonth(), 1));
  for(let i=0;i<42;i++){
    const d = addDays(startGrid, i);
    const inMonth = d.getMonth() === ctx.selectedDate.getMonth();
    const dayStr = formatTR(d);
    const hasData = ctx.hasSet.has(dayStr);
    const isToday = stuSameYMD(d, new Date());
    const isSelected = stuSameYMD(d, ctx.selectedDate);
    html += `
      <div class="calCell ${inMonth?'':'muted'} ${isToday?'today':''} ${isSelected?'selected':''}"
           onclick="stuSelectDate('${dayStr}')">
        <span class="calDay">${d.getDate()}</span>
        ${hasData ? '<span class="calDot" aria-hidden="true"></span>' : ''}
      </div>
    `;
  }
  html += `</div>`;
  wrap.innerHTML = html + `<div class='calFab'><button type='button' onclick='stuGoToday()'>Bugün</button></div>`;
  (function(){
    try{
      const td = new Date();
      const sameMonth = (td.getFullYear()===ctx.selectedDate.getFullYear()) && (td.getMonth()===ctx.selectedDate.getMonth());
      const sameDay = stuSameYMD(td, ctx.selectedDate);
      const dis = (sameMonth && sameDay);
      const b = wrap.querySelector('#btnToday');
      if(b){ b.disabled = dis; }
    }catch(_){}
  })();
}
function stuCalPrevMonth(){ _calCtx.selectedDate = stuAddMonths(_calCtx.selectedDate, -1); renderStudentCalendar(); }
function stuCalNextMonth(){ _calCtx.selectedDate = stuAddMonths(_calCtx.selectedDate,  1); renderStudentCalendar(); }
function stuSelectDate(dayStr){
  const d = parseTRDateStr(dayStr);
  if(!isNaN(d)) _calCtx.selectedDate = d;
  renderStudentCalendar();
  showDay(dayStr);
}
function stuGoToday(){
  const now = new Date();
  _calCtx.selectedDate = now;
  _calCtx.viewMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  renderStudentCalendar();
  const dayStr = formatTR(now);
}
function parseTRDateStr(dstr){ const [dd,mm,yy]=dstr.split('.').map(x=>parseInt(x,10)); return new Date(yy, mm-1, dd); }
function formatTR(d){ return d.toLocaleDateString("tr-TR"); }
function mondayOf(date){ const d=new Date(date.getFullYear(),date.getMonth(),date.getDate()); const day=d.getDay(); const diff=(day===0?-6:1-day); d.setDate(d.getDate()+diff); d.setHours(0,0,0,0); return d; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function stuAddMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
function stuSameYMD(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
function showDay(day){
  const detailsObj = (_calCtx.grouped && _calCtx.grouped[day]) ? _calCtx.grouped[day].totalPerLesson : {};
  const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
  let html="<table><tr><th>Ders</th><th>O Gün Toplam</th><th>İşlem</th></tr>";
  dersSirasi.forEach(lesson=>{
    const total = detailsObj[lesson] || 0;
    html += `<tr>
        <td>${lesson}</td>
        <td>${total}</td>
        <td><button type="button" class="editBtn" onclick="editAggregated('${day}','${lesson}',${total})">Düzenle</button></td>
      </tr>`;
  });
  html+="</table>";
  const el=document.getElementById("stuDayTable");
  el.innerHTML=html;
}
async function editAggregated(day, lesson, oldTotal){
  let nv = prompt(`${day} günü "${lesson}" dersi için yeni toplam değeri girin:`, oldTotal);
  if(nv===null) return;
  nv = parseInt(nv,10);
  if(isNaN(nv)){ setAlert("Geçersiz sayı."); return; }
  try {
    const infoAgg = (_calCtx.grouped && _calCtx.grouped[day] && _calCtx.grouped[day].keysPerLesson && _calCtx.grouped[day].keysPerLesson[lesson]) ? _calCtx.grouped[day].keysPerLesson[lesson] : [];
    const updates = {};
    infoAgg.forEach(key=>{
      updates[`students/${currentStudent}/lessons/${lesson}/${key}`] = null;
    });
    const fakeTime = `${day} 12:00:00`;
    const newKey = db.ref().child(`students/${currentStudent}/lessons/${lesson}`).push().key;
    updates[`students/${currentStudent}/lessons/${lesson}/${newKey}`] = {count:nv, time:fakeTime};
    await db.ref().update(updates);
    setAlert("Güncellendi.");
    loadStudentData();
  } catch(e) {
    setAlert("Hata: "+e.message);
  }
}

/* ============ Öğretmen Giriş ============ */
function teacherLogin(){
  const name=document.getElementById("tName").value.trim();
  const code=document.getElementById("tCode").value;
  if(!name || !code){ setAlert("Ad Soyad ve kod gerekli."); return; }
  if(code!=="703504"){ setAlert("Kod hatalı."); return; }
  currentTeacherName = name;
  currentTeacherId = normalizeId(name);
  if(!currentTeacherId){ setAlert("Geçerli bir ad giriniz."); return; }
  db.ref("teachers/"+currentTeacherId).set({ name: currentTeacherName, createdAt: firebase.database.ServerValue.TIMESTAMP }).catch(()=>{});
  document.getElementById("teacherWelcome").textContent = `Hoş geldiniz, ${toTitleCaseTR(currentTeacherName)}`;
  document.getElementById("loginPanel").style.display="none";
  document.getElementById("teacherPanel").style.display="block";
  listenClasses();
  listenFavorites();
}
/* ============ Sınıflar (ortak) ============ */
function addClass(){
  const cls=document.getElementById("newClass").value.trim();
  if(!cls){ setAlert("Sınıf adı girin (örn: 8/A)."); return; }
  db.ref("classes").orderByChild("name").equalTo(cls).get().then(s=>{
    if(s.exists()){ setAlert("Bu sınıf zaten ekli."); return; }
    return db.ref("classes").push({name:cls,createdAt:firebase.database.ServerValue.TIMESTAMP});
  }).then(()=>{ document.getElementById("newClass").value=""; });
}
function deleteClassByName(name){
  // Güvenlik: sadece Uğur Yaşayan silebilir
  if(!isPrivilegedTeacher()){
    setAlert("Bu işlemi yapma yetkiniz yok.");
    return;
  }
  const classId = classesMap[name];
  if(!classId){ setAlert("Sınıf id bulunamadı."); return; }
  if(!confirm(`"${name} (${classesMap[name]})" sınıfını silmek istiyor musunuz?`)) return;
  db.ref("classes/"+classId).remove()
    .then(()=>{ setAlert("Sınıf silindi."); if(activeClassName===name){ activeClassName=null; document.getElementById("classStudents").style.display="none"; document.getElementById("teacherStudentDetail").style.display="none"; } })
    .catch(e=>setAlert("Silme hatası: "+e.message));
}
function listenClasses(){
  if(classesRef){ classesRef.off(); }
  classesRef = db.ref("classes");
  classesRef.on("value",snap=>{
    classesMap = {};
    const names=[];
    snap.forEach(ch=>{const v=ch.val(); if(v&&v.name){ names.push(v.name); classesMap[v.name]=ch.key; }});
    const grid=document.getElementById("classGrid"); grid.innerHTML="";
    if(!names.length){ grid.innerHTML="<div class='empty' style='grid-column:1/-1'>Henüz sınıf yok.</div>"; document.getElementById("classStudents").style.display="none"; }
    names.sort().forEach(name=>{
      const card=document.createElement("div"); card.className="classCard";
      const title=document.createElement("div"); title.className="className"; title.textContent=name;
      const pick=document.createElement("button"); pick.className="classPick"; pick.textContent="Öğrencileri Gör";
      pick.onclick=()=>{
        activeClassName=name;
        document.querySelectorAll(".classPick").forEach(b=>b.classList.remove("active"));
        pick.classList.add("active");
        selectClass(name);
      };
      if(isPrivilegedTeacher()){
        const del=document.createElement("button");
        del.className="delFloat";
        del.setAttribute("title","Sınıfı Sil");
        del.setAttribute("aria-label","Sınıfı Sil");
        del.innerHTML=`<img class="trashIcon" src="${TRASH_ICON}" alt="">`;
        del.onclick=(e)=>{ e.stopPropagation(); deleteClassByName(name); };
        card.appendChild(del);
      }
      card.appendChild(title);
      card.appendChild(pick);
      grid.appendChild(card);
    });
    const sel=document.getElementById("rClass"); const keep=sel.value;
    sel.innerHTML="<option value=''>Sınıf Seçin</option>";
    names.sort().forEach(n=>{const o=document.createElement("option"); o.value=n; o.text=n; sel.add(o);});
    if(names.includes(keep)) sel.value=keep;
    if(activeClassName){
      const btn=[...document.querySelectorAll(".classPick")].find(b=>b.parentElement.querySelector(".className").textContent===activeClassName);
      if(btn){ btn.classList.add("active"); selectClass(activeClassName); }
    }
  });
}
function clearChildren(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function selectClass(name){
  const list=document.getElementById("studentsContainer");
  document.getElementById("classStudents").style.display="block";
  const myToken = ++selectClassRenderToken;
  list.innerHTML = "<div class='empty'>Yükleniyor...</div>";
  db.ref("students").get().then(snap=>{
    if(myToken !== selectClassRenderToken) return;
    if(!snap.exists()){
      list.innerHTML="<div class='empty'>Kayıtlı öğrenci yok.</div>";
      return;
    }
    const uniqByNum = {};
    snap.forEach(ch=>{
      const s=ch.val();
      if(s && s.sclass===name && s.num){
        uniqByNum[String(s.num)] = {name:s.name,num:String(s.num),sclass:s.sclass};
      }
    });
    const nums = Object.keys(uniqByNum).sort((a,b)=> (uniqByNum[a].name||"").localeCompare(uniqByNum[b].name||""));
    if(!nums.length){
      list.innerHTML=`<div class='empty'>${name} sınıfına öğrenci yok.</div>`;
      return;
    }
    let html = "";
    nums.forEach(n=>{
      const s=uniqByNum[n];
      const isFav=!!favoritesCache[s.num];
      const prettyName = toTitleCaseTR(s.name||"");
      html += `
      <div class="studentItem hasDel" id="stu-row-${n}">
        <div class="leftGroup">
          <button class="studentNameBtn" onclick="teacherShowStudent('${s.num}')">${s.num} – ${prettyName}</button>
          <button class="starBtn ${isFav ? "" : "off"}" title="${isFav ? "Favoriden çıkar" : "Favoriye ekle"}" data-role="fav" data-num="${s.num}" data-name="${prettyName}" data-sclass="${s.sclass||""}">${isFav ? "★" : "☆"}</button>
        </div>
        <!-- Yeni: Hedef butonu -->
        <button class="targetFloat" title="Hedef belirle" data-role="target" data-num="${s.num}" data-name="${prettyName}">🎯</button>
        <!-- Yeni: Silme tuşu yerine sağ üstte çöp kovası ikonu -->
        <button class="delStuFloat" title="Öğrenciyi Sil" aria-label="Öğrenciyi Sil" data-role="delStudent" data-num="${s.num}" data-name="${prettyName}">
          <img class="trashIcon" src="${TRASH_ICON}" alt="">
        </button>
      </div>`;
    });
    if(myToken === selectClassRenderToken){
      list.innerHTML = html;
    }
  });
}
function favPath(){ return currentTeacherId ? "teacherData/"+currentTeacherId+"/favorites" : null; }
function listenFavorites(){
  const path=favPath(); if(!path) return;
  if(favRef){ favRef.off(); }
  favRef = db.ref(path);
  favRef.on("value",(snap)=>{
    const uniqueFavorites = new Map();
    const list=[];
    snap.forEach(ch=>{
      const v=ch.val();
      if(!v || !v.num) return;
      const numStr = String(v.num);
      uniqueFavorites.set(numStr, {num:numStr, name:v.name, sclass:v.sclass});
    });
    uniqueFavorites.forEach((value) => { list.push(value); });
    favoritesCache={};
    list.forEach(v=> favoritesCache[v.num]=true);
    renderFavorites(list);
    if(activeClassName){
      selectClass(activeClassName);
    }
  });
}
document.addEventListener("click",function(e){
  const el = e.target.closest("[data-role]");
  if(!el) return;
  const role = el.dataset.role;
  if(role==="fav"){ const {num,name,sclass}=el.dataset; toggleFavorite(num,name,sclass); }
  if(role==="target"){ const {num,name}=el.dataset; openTargetModal(num,name); }
  if(role==="delStudent"){ const {num,name}=el.dataset; deleteStudent(num,name); }
});
function toggleFavorite(num,name,sclass){
  const path=favPath(); if(!path){ setAlert("Öğretmen oturumu yok."); return; }
  const ref=db.ref(path+"/"+num);
  if(favoritesCache[num]) ref.remove().catch(e=>setAlert("Favoriden çıkarma hatası: "+e.message));
  else ref.set({num,name,sclass,createdAt:firebase.database.ServerValue.TIMESTAMP}).catch(e=>setAlert("Favoriye ekleme hatası: "+e.message));
}
function deleteStudent(num,name){
  if(!confirm(`"${name} (${num})" öğrencisini silmek istiyor musunuz?`)) return;
  const updates={}; updates["students/"+num]=null;
  db.ref("teacherData").get().then(snap=>{
    if(snap.exists()){ snap.forEach(t=>{ updates["teacherData/"+t.key+"/favorites/"+num]=null; }); }
    return db.ref().update(updates);
  }).then(()=>{
    setAlert("Öğrenci silindi.");
    if(currentDetailNum===num){ currentDetailNum=null; document.getElementById("teacherStudentDetail").style.display="none"; }
    if(activeClassName){ selectClass(activeClassName); }
  }).catch(e=>setAlert("Öğrenci silme hatası: "+e.message));
}
function renderFavorites(items){
  const box=document.getElementById("favoritesList");
  if(!items || !items.length){ box.innerHTML="<div class='empty'>Henüz favori yok.</div>"; return; }
  const uniqueMap = new Map();
  items.forEach(item => {
    if (item && item.num) uniqueMap.set(String(item.num), item);
  });
  const uniq = Array.from(uniqueMap.values());
  uniq.sort((a,b)=> (a.sclass||"").localeCompare(b.sclass||"") || (a.name||"").localeCompare(b.name||""));
  box.innerHTML = uniq.map(s=>{
    const prettyName = toTitleCaseTR(s.name||"");
    return `
    <div class="studentItem" id="fav-row-${s.num}">
      <div class="leftGroup">
        <button class="studentNameBtn" title="Detay panelinde aç" onclick="teacherShowStudent('${s.num}')">${s.num} – ${prettyName} (${s.sclass||''})</button>
        <button class="starBtn" title="Favoriden çıkar" data-role="fav" data-num="${s.num}" data-name="${prettyName}" data-sclass="${s.sclass}">★</button>
      </div>
      <button class="editBtn" style="min-width:100px" onclick="teacherShowStudent('${s.num}')">Detay Gör</button>
    </div>
  `;
  }).join("");
}
function showTeacherSection(sec){
  const classesSection = document.getElementById('classesSection');
  const favoritesSection = document.getElementById('favoritesSection');
  const tabClasses = document.getElementById('tabClasses');
  const tabFavorites = document.getElementById('tabFavorites');
  hideStudentDetail();
  if(sec==='classes'){
    classesSection.style.display='block';
    favoritesSection.style.display='none';
    tabClasses.classList.add('active');
    tabFavorites.classList.remove('active');
  } else {
    classesSection.style.display='none';
    favoritesSection.style.display='block';
    tabClasses.classList.remove('active');
    tabFavorites.classList.add('active');
  }
}
function hideStudentDetail() {
  document.getElementById('teacherStudentDetail').style.display = 'none';
  currentDetailNum = null;
}
function teacherShowStudent(num){
  currentDetailNum=num;
  document.getElementById("teacherStudentDetail").style.display="block";
  destroyWeekChart();
  db.ref("students/"+num).get().then(snap=>{
    if(!snap.exists()){ setAlert("Öğrenci bulunamadı."); return; }
    const s=snap.val();
    const prettyName = toTitleCaseTR(s.name||"");
    document.getElementById("tsdTitle").textContent = `${prettyName} (${s.num}) – ${s.sclass}`;
    const lessons=s.lessons||{};
    currentDetailLessons = lessons;
    const dayMap={}, totals={};
    for(const l in lessons){
      for(const k in lessons[l]){
        const e=lessons[l][k]; const d=(e.time||"").split(" ")[0]||"";
        if(!dayMap[d]) dayMap[d]={}; if(!dayMap[d][l]) dayMap[d][l]=0; dayMap[d][l]+=Number(e.count)||0;
        if(!totals[l]) totals[l]=0; totals[l]+=Number(e.count)||0;
      }
    }
    const daysBox=document.getElementById("tsdDays");
    const dayNames=Object.keys(dayMap).sort((a,b)=> a.split('.').reverse().join('').localeCompare(b.split('.').reverse().join('')) ).reverse();
    daysBox.innerHTML = dayNames.length ? dayNames.map(d=>`<button class="dayBtn" onclick="teacherShowStudentDay('${num}','${d}')">${d}</button>`).join("") : "<div class='empty'>Gün bulunamadı.</div>";
    try{
      tsdBuildCtxFromLessons(dayMap);
      renderTeacherCalendar();
      const dayKeys = Object.keys(dayMap||{}).sort((a,b)=> a.split('.').reverse().join('').localeCompare(b.split('.').reverse().join('')) );
      if(dayKeys.length){
        tsdSelectDate(dayKeys[dayKeys.length-1]);
      }else{
        const t = document.getElementById("tsdDayTable");
        if(t) t.innerHTML = "<div class='empty'>Gün bulunamadı.</div>";
      }
    }catch(_){}
    renderTotalsTable(totals,"tsdTotals");
    if(dayNames.length) teacherShowStudentDay(num,dayNames[0]); else document.getElementById("tsdDayTable").innerHTML="<div class='empty'>Gün seçiniz.</div>";
    currentWeeks = buildWeeksFromLessons(lessons);
    renderWeekList(currentWeeks);
    if(currentWeeks.length){ selectWeek(currentWeeks[currentWeeks.length-1].key); } else { clearWeekArea(); }
  });
}
function renderTotalsTable(totals,targetId){
  const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
  let html="<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
  dersSirasi.forEach(l => {
    const value = totals[l] || 0;
    html += `<tr><td>${l}</td><td>${value}</td></tr>`;
  });
  html+="</table>";
  document.getElementById(targetId).innerHTML=html;
}
function teacherShowStudentDay(num,day){
  db.ref("students/"+num+"/lessons").get().then(snap=>{
    let perLesson={};
    if(snap.exists()){
      const data=snap.val();
      for(const l in data){
        for(const k in data[l]){
          const e=data[l][k]; const d=(e.time||"").split(" ")[0]||"";
          if(d===day){ if(!perLesson[l]) perLesson[l]=0; perLesson[l]+= Number(e.count)||0; }
        }
      }
    }
    const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
    let html="<table><tr><th>Ders</th><th>O Gün Çözülen</th></tr>";
    dersSirasi.forEach(l => {
      const value = perLesson[l] || 0;
      html += `<tr><td>${l}</td><td>${value}</td></tr>`;
    });
    html+="</table>";
    document.getElementById("tsdDayTable").innerHTML=html;
  });
}
/* ===== Haftalık çizgi grafiği + PDF ===== */
function destroyWeekChart(){ if(weekChart){ weekChart.destroy(); weekChart=null; } }
function buildWeeksFromLessons(lessons){
  let minDate=null;
  for(const l in lessons){
    for(const k in lessons[l]){
      const e=lessons[l][k];
      const d=parseTRDateStr((e.time||"").split(" ")[0]||"");
      if(isNaN(d)) continue;
      if(!minDate||d<minDate) minDate=d;
    }
  }
  if(!minDate) return [];
  let curStart=mondayOf(minDate);
  const lastStart=mondayOf(new Date());
  const out=[];
  while(curStart<=lastStart){
    const curEnd=addDays(curStart,6);
    out.push({ key: curStart.toISOString().slice(0,10), start: new Date(curStart), end: curEnd, label:"" });
    curStart=addDays(curStart,7);
  }
  out.forEach((w,i)=>{ w.label=`${i+1}. Hafta (${formatTR(w.start)} - ${formatTR(w.end)})`; });
  return out;
}
function renderWeekList(weeks){
  const wrap=document.getElementById("weekList");
  if(!weeks.length){ wrap.innerHTML="<span class='empty'>Haftalık veri yok.</span>"; document.getElementById("btnExportPDF").disabled=true; return; }
  wrap.innerHTML="";
  weeks.slice().reverse().forEach(w=>{
    const b=document.createElement("button");
    b.type="button"; b.className="weekBtn"; b.textContent=w.label;
    b.onclick=()=>selectWeek(w.key);
    wrap.appendChild(b);
  });
}
function selectWeek(weekKey){
  selectedWeekKey=weekKey;
  document.querySelectorAll("#weekList button").forEach(b => {
    const weekData = currentWeeks.find(w => w.key === weekKey);
    b.style.background = weekData && b.textContent.includes(formatTR(weekData.start)) ? 'var(--accent1)' : 'var(--muted)';
  });
  document.getElementById("btnExportPDF").disabled=false;
  drawWeek(currentDetailLessons, currentWeeks.find(w=>w.key===weekKey));
}
function clearWeekArea(){
  destroyWeekChart();
  document.getElementById("weekMatrix").innerHTML="";
  const ctx=document.getElementById("weekChart").getContext('2d'); ctx.clearRect(0,0,9999,9999);
  document.getElementById("btnExportPDF").disabled=true;
}
function aggregateWeekDetailed(lessons, week){
  const dayLabels=["Pzt","Sal","Çar","Per","Cum","Cmt","Paz"];
  const daily=[0,0,0,0,0,0,0];
  const perLessonPerDay = {};
  const allLessons=["Türkçe","Sosyal Bilgiler","Din Kültürü","İngilizce","Matematik","Fen Bilimleri"];
  allLessons.forEach(l=>perLessonPerDay[l]=[0,0,0,0,0,0,0]);
  if(!lessons) return {dayLabels,daily,perLessonPerDay};
  for(const l in lessons){
    for(const k in lessons[l]){
      const e=lessons[l][k];
      const dStr=(e.time||"").split(" ")[0]||"";
      if(!dStr) continue;
      const d=parseTRDateStr(dStr);
      if(isNaN(d)) continue;
      if(d>=week.start && d<=week.end){
        const dow=(d.getDay()+6)%7;
        const cnt=Number(e.count)||0;
        daily[dow]+=cnt;
        if(!perLessonPerDay[l]) perLessonPerDay[l]=[0,0,0,0,0,0,0];
        perLessonPerDay[l][dow]+=cnt;
      }
    }
  }
  return {dayLabels,daily,perLessonPerDay};
}
function drawWeek(lessons, week){
  if(!week){ clearWeekArea(); return; }
  const {dayLabels,daily,perLessonPerDay}=aggregateWeekDetailed(lessons, week);
  destroyWeekChart();
  const ctx=document.getElementById("weekChart").getContext("2d");
  weekChart=new Chart(ctx,{
    type:"line",
    data:{ labels:dayLabels, datasets:[{ label:`${week.label} Günlük Toplam`, data:daily, tension:0.35, pointRadius:3, borderWidth:2, fill:false }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ labels:{ color:"#e2e8f0" } } } }
  });
  const matDiv=document.getElementById("weekMatrix");
  matDiv.innerHTML = buildMatrixTableHTML(perLessonPerDay, dayLabels);
  prepareExportDOM(week, dayLabels, daily, perLessonPerDay);
}
function buildMatrixTableHTML(perLessonPerDay, dayLabels){
  const dersSirasi = ["Türkçe", "Sosyal Bilgiler", "Din Kültürü", "İngilizce", "Matematik", "Fen Bilimleri"];
  let html = `<div class="sectionTitle" style="margin:0 0 6px">Ders × Gün Matrisi</div>`;
  html += `<table><tr><th>Ders</th>${dayLabels.map(d=>`<th>${d}</th>`).join("")}</tr>`;
  dersSirasi.forEach(lesson=>{
    const row=perLessonPerDay[lesson] || [0,0,0,0,0,0,0];
    html += `<tr><td>${lesson}</td>${row.map(v=>`<td>${v}</td>`).join("")}</tr>`;
  });
  html += `</table>`;
  return html;
}
function prepareExportDOM(week, dayLabels, daily, perLessonPerDay){
  const title=document.getElementById("tsdTitle").textContent;
  document.getElementById("exportStudent").textContent = title;
  document.getElementById("exportRange").textContent = week.label;
  const ctx=document.getElementById("exportChart").getContext("2d");
  if(window._exportChart) { window._exportChart.destroy(); }
  window._exportChart = new Chart(ctx,{
    type:"line",
    data:{ labels:dayLabels, datasets:[{ label:`${week.label} Günlük Toplam`, data:daily, tension:0.35, pointRadius:3, borderWidth:2, fill:false }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ labels:{ color:"#e2e8f0" } } } }
  });
  document.getElementById("exportTable").innerHTML = buildMatrixTableHTML(perLessonPerDay, dayLabels);
}
async function exportSelectedWeekPDF(){
  if(!currentDetailNum || !selectedWeekKey) return;
  const { jsPDF } = window.jspdf;
  const exportEl=document.getElementById("exportArea");
  const canvas=await html2canvas(exportEl, { backgroundColor:null, scale:2 });
  const img=canvas.toDataURL("image/png",1.0);
  const pdf=new jsPDF({orientation:"portrait", unit:"pt", format:"a4"});
  const pageW=pdf.internal.pageSize.getWidth();
  const margin=18;
  const drawW=pageW - margin*2;
  const drawH=drawW * (canvas.height/canvas.width);
  pdf.addImage(img,"PNG", margin, 12, drawW, drawH);
  const safeName = (document.getElementById("tsdTitle").textContent || "Rapor").replace(/[^\wğüşöçıİĞÜŞÖÇ\s\-().]/g,"").slice(0,60);
  pdf.save(`${safeName} - ${document.getElementById("exportRange").textContent}.pdf`);
}
const TRASH_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZWY0NDQ0Ij4KICA8cGF0aCBkPSJNOSAyaDZ2Mmg1djJINFY0aDVWMnptLTMgNmgxMmwtMSAxMmEyIDIgMCAwIDEtMiAySDlhMiAyIDAgMCAxLTItMkw2IDh6bTQgM3Y3aDJ2LTdoLTJ6bTQgMHY3aDJ2LTdoLTJ6Ii8+Cjwvc3ZnPg==";
const PARENT_PORTAL_URL = "veli.html"; // Örn: "veli-panel.html" veya tam URL
function openReportModal(){
  var ov = document.getElementById('reportOverlay');
  var box = document.getElementById('teacherStudentDetail');
  if(ov) ov.style.display='block';
  if(box){ box.style.display='block'; showReportTab('daily'); }
}
function closeReportModal(){
  try{ destroyWeekChart(); }catch(_){}
  try{ destroyTeacherMonthChart(); }catch(_){}
  var ov = document.getElementById('reportOverlay');
  var box = document.getElementById('teacherStudentDetail');
  if(box) box.style.display='none';
  if(ov) ov.style.display='none';
}
function showReportTab(tab){
  var tabs = ['daily','weekly','monthly'];
  tabs.forEach(function(t){
    var el = document.getElementById('repTab-' + t);
    if(el) el.classList.toggle('active', t===tab);
    var btn = document.getElementById('repTab' + (t.charAt(0).toUpperCase()+t.slice(1)) + 'Btn');
    if(btn) btn.classList.toggle('active', t===tab);
  });
  if(tab==='weekly'){
    // Haftalar zaten teacherShowStudent içinde hesaplanıyor
  }
  if(tab==='monthly'){
    if(window.currentDetailLessons){
      buildTeacherMonths(window.currentDetailLessons);
    }
  }
}
if(typeof teacherShowStudent === 'function'){
  const _origTeacherShowStudent = teacherShowStudent;
  teacherShowStudent = function(num){
    _origTeacherShowStudent(num);
    openReportModal();
  };
}
var tMonthChart = null;
var _tMonths = [];
function destroyTeacherMonthChart(){ if(tMonthChart){ try{tMonthChart.destroy();}catch(_){ } tMonthChart=null; } }
function buildTeacherMonths(lessons){
  _tMonths = buildWeeksFromLessons(lessons || {});
  var sel = document.getElementById('tMonthSelect');
  if(!sel) return;
  sel.innerHTML = '';
  _tMonths.forEach(function(w){
    var opt = document.createElement('option');
    opt.value = w.key;
    opt.textContent = w.label;
    sel.add(opt);
  });
  if(_tMonths.length){
    sel.value = _tMonths[_tMonths.length-1].key;
    selectTeacherMonth(sel.value);
  }else{
    destroyTeacherMonthChart();
    var mt = document.getElementById('tMonthTotals');
    if(mt) mt.innerHTML = "<div class='empty'>Aylık veri yok.</div>";
    try{ var ctx = document.getElementById('tMonthChart').getContext('2d'); ctx.clearRect(0,0,9999,9999);}catch(_){}
  }
}
function selectTeacherMonth(key){
  var m = (_tMonths||[]).find(x=> x.key===key);
  if(!m){ destroyTeacherMonthChart(); var mt=document.getElementById('tMonthTotals'); if(mt) mt.innerHTML=''; return; }
  drawTeacherMonth(window.currentDetailLessons||{}, m);
}
function drawTeacherMonth(lessons, month){
  var res = aggregateWeekDetailed(lessons, month); /* reuse weekly aggregator for daily (month scope) */
  var labels = res.dayLabels, daily = res.daily, totals = {};
  ["Türkçe","Sosyal Bilgiler","Din Kültürü","İngilizce","Matematik","Fen Bilimleri"].forEach(d=> totals[d]=0);
  daily.forEach((val,i)=>{ Object.keys(res.perLessonPerDay).forEach(lesson=> totals[lesson] += res.perLessonPerDay[lesson][i]||0 ); });
  destroyTeacherMonthChart();
  try{
    var ctx = document.getElementById('tMonthChart').getContext('2d');
    tMonthChart = new Chart(ctx, {
      type: 'line',
      data: { labels: labels, datasets: [ { label: month.label + ' — Günlük Toplam', data: daily, tension: 0.35, pointRadius: 3, borderWidth: 2, fill:false } ] },
      options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#cbd5e1' }, grid:{ color:'rgba(148,163,184,.15)'} }, y:{ beginAtZero:true, ticks:{ color:'#cbd5e1' }, grid:{ color:'rgba(148,163,184,.12)'} } }, plugins:{ legend:{ labels:{ color:'#e2e8f0' } } } }
    });
  }catch(_){}
  var order = ["Türkçe","Sosyal Bilgiler","Din Kültürü","İngilizce","Matematik","Fen Bilimleri"];
  var html = "<table><tr><th>Ders</th><th>Toplam Soru</th></tr>";
  order.forEach(function(d){ var v = totals[d]||0; html += "<tr><td>"+d+"</td><td>"+v+"</td></tr>"; });
  html += "</table>";
  var mt = document.getElementById('tMonthTotals'); if(mt) mt.innerHTML = html;
}
</script>
<script>
(function(){
  // Track active role
  window.activeRole = window.activeRole || 'student';
  function setBodyRoleAttr(){
    try{ document.body.setAttribute('data-role', (window.activeRole==='parent'?'parent':'student')); }catch(_){}
  }
  // UI sync across roles
  window.applyRoleUi = (function(prev){
    return function(){
      try{
        var isParent = (window.activeRole === 'parent');
        // Titles
        var title = document.getElementById('studentPanelTitle');
        var barTitle = document.getElementById('studentPanelToolbarTitle');
        if(title) title.textContent = isParent ? 'Veli Paneli' : 'Öğrenci Paneli';
        if(barTitle) barTitle.textContent = isParent ? 'Veli Paneli' : 'Öğrenci Paneli';
        // Tab name: Soru Girişi -> Günlük Rapor (parent only)
        var entryBtn = document.getElementById('stuTabEntryBtn');
        if(entryBtn){
          entryBtn.textContent = isParent ? 'Günlük Rapor' : 'Soru Girişi';
        }
        // Ensure correct data-role on body
        setBodyRoleAttr();
      }catch(_){}
      try{ if(typeof prev === 'function') prev(); }catch(_){}
    };
  })(window.applyRoleUi);
  // Give IDs to existing titles if they aren't present
  try{
    var h3 = document.querySelector('#studentPanel h3');
    if(h3 && !h3.id && h3.textContent.trim().toUpperCase().includes('ÖĞRENCİ')){ h3.id = 'studentPanelTitle'; }
    var strong = document.querySelector('#studentTab-entry .student-toolbar strong');
    if(strong && !strong.id && strong.textContent.trim().toUpperCase().includes('ÖĞRENCİ')){ strong.id = 'studentPanelToolbarTitle'; }
  }catch(_){}
  // Wrap enterAsStudent to set role + update UI
  if (typeof window.enterAsStudent === 'function'){
    var __orig_enterAsStudent = window.enterAsStudent;
    window.enterAsStudent = function(){
      window.activeRole = 'student';
      __orig_enterAsStudent();
      window.applyRoleUi();
    };
  }
  // Parent entry mirrors student panel; keeps daily calendar & table
  window.enterAsParent = function(){
    window.activeRole = 'parent';
    var rc = document.getElementById('roleChoice'); if(rc) rc.style.display='none';
    var lp = document.getElementById('loginPanel'); if(lp) lp.style.display='none';
    var sp = document.getElementById('studentPanel'); if(sp) sp.style.display='block';
    try{ window.showStudentTab('entry'); }catch(_){}
    try{ window.loadStudentData(); }catch(_){}
    window.applyRoleUi();
  };
  // Ensure logout resets role back to student
  if (typeof window.logout === 'function'){
    var __orig_logout = window.logout;
    window.logout = function(){
      __orig_logout();
      window.activeRole = 'student';
      window.applyRoleUi();
    };
  }
  // Initialize
  setBodyRoleAttr();
  window.applyRoleUi();
})();
</script>
</body>
</html>
